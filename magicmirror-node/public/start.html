<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Queen's Academy &bull; Start Game</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Rajdhani:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBVO4ajDwkbcTGL33SVMxIoev4veB8itgI",
        authDomain: "queens-academy-icoding.firebaseapp.com",
        projectId: "queens-academy-icoding",
        storageBucket: "queens-academy-icoding.firebasestorage.app",
        messagingSenderId: "1048549258959",
        appId: "1:1048549258959:web:f8dc1c104bb170d7ff69ba",
        measurementId: "G-RJCXM1YL7E"
      };

      if (typeof firebase !== "undefined" && (!firebase.apps || !firebase.apps.length)) {
        firebase.initializeApp(firebaseConfig);
      }

      const BACKEND_URL = "https://firebase-upload-backend.onrender.com";
      const START_LOGIN_REDIRECT = "/elearn/worlds/calistung/index.html";
    </script>
    <style>
      :root {
        --primary: #ff3ff5;
        --primary-dark: #7a13ff;
        --secondary: #18f1ff;
        --text-light: #f4f7ff;
        --panel-bg: rgba(8, 8, 24, 0.75);
        --panel-border: rgba(255, 255, 255, 0.2);
        --glow: 0 0 25px rgba(255, 64, 246, 0.55);
        color-scheme: dark;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Rajdhani", "Segoe UI", sans-serif;
        color: var(--text-light);
        background: #050515;
        overflow: hidden;
      }

      body.intro-active {
        overflow: hidden;
      }

      .intro-overlay {
        position: fixed;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1.5rem;
        padding: clamp(1.5rem, 4vw, 3rem);
        background: radial-gradient(circle at 20% 20%, rgba(24, 241, 255, 0.18), transparent 65%),
          radial-gradient(circle at 80% 80%, rgba(255, 64, 246, 0.18), transparent 60%),
          rgba(4, 4, 16, 0.96);
        z-index: 20;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: opacity 320ms ease, visibility 320ms ease;
      }

      .intro-overlay.is-active {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
      }

      .intro-overlay.is-finished {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
      }

      .intro-overlay__skip {
        position: absolute;
        top: clamp(0.75rem, 3vw, 1.75rem);
        right: clamp(0.75rem, 3vw, 1.75rem);
        z-index: 2;
      }

      .skip-toggle {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 0.55rem;
        padding: 0.45rem 0.85rem 0.45rem 0.65rem;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: rgba(12, 12, 36, 0.72);
        color: var(--text-light);
        font-family: "Orbitron", sans-serif;
        font-size: clamp(0.68rem, 2vw, 0.8rem);
        letter-spacing: 0.14em;
        text-transform: uppercase;
        cursor: pointer;
        box-shadow: 0 12px 28px rgba(3, 6, 28, 0.55);
        transition: transform 180ms ease, box-shadow 180ms ease, border-color 180ms ease;
        --toggle-track-width: clamp(44px, 12vw, 52px);
        --toggle-thumb-size: clamp(18px, 5vw, 22px);
        --toggle-track-offset: clamp(2px, 1vw, 4px);
      }

      .skip-toggle:hover,
      .skip-toggle:focus-visible {
        transform: translateY(-2px) scale(1.01);
        box-shadow: 0 18px 36px rgba(24, 241, 255, 0.4);
        border-color: rgba(24, 241, 255, 0.45);
        outline: none;
      }

      .skip-toggle:disabled {
        opacity: 0.85;
        cursor: default;
        transform: none;
        box-shadow: 0 12px 28px rgba(3, 6, 28, 0.45);
      }

      .skip-toggle__track {
        position: relative;
        width: var(--toggle-track-width);
        height: calc(var(--toggle-thumb-size) + var(--toggle-track-offset));
        border-radius: 999px;
        background: linear-gradient(135deg, rgba(24, 241, 255, 0.35), rgba(255, 64, 246, 0.35));
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.25);
      }

      .skip-toggle__thumb {
        position: absolute;
        top: 50%;
        left: var(--toggle-track-offset);
        width: var(--toggle-thumb-size);
        height: var(--toggle-thumb-size);
        border-radius: 50%;
        background: linear-gradient(135deg, var(--secondary), var(--primary));
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.35);
        display: grid;
        place-items: center;
        font-size: clamp(0.75rem, 4vw, 0.95rem);
        transform: translate(0, -50%);
        transition: transform 220ms ease;
      }

      .skip-toggle__label {
        font-size: clamp(0.62rem, 2vw, 0.75rem);
        letter-spacing: 0.18em;
      }

      .skip-toggle--active .skip-toggle__thumb {
        transform: translate(
            calc(var(--toggle-track-width) - var(--toggle-thumb-size) - var(--toggle-track-offset) * 2),
            -50%
          )
          rotate(12deg);
      }

      .intro-overlay__interaction {
        display: flex;
        align-items: center;
        gap: 0.65rem;
        padding: 0.75rem 1rem;
        border-radius: 999px;
        background: rgba(10, 10, 36, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.25);
        box-shadow: 0 14px 32px rgba(3, 6, 28, 0.5);
        font-size: clamp(0.82rem, 3vw, 0.95rem);
        font-family: "Rajdhani", sans-serif;
        letter-spacing: 0.05em;
        opacity: 0;
        visibility: hidden;
        transform: translateY(18px);
        transition: opacity 240ms ease, visibility 240ms ease, transform 240ms ease;
        pointer-events: none;
        text-align: center;
        max-width: min(420px, 90vw);
      }

      .intro-overlay__interaction-icon {
        font-size: clamp(1.25rem, 4vw, 1.75rem);
        filter: drop-shadow(0 6px 12px rgba(24, 241, 255, 0.55));
      }

      .intro-overlay.needs-user-audio .intro-overlay__interaction {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
        pointer-events: auto;
      }

      .orientation-warning {
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 0.85rem;
        padding: clamp(1.5rem, 4vw, 2.5rem);
        border-radius: 28px;
        background: rgba(8, 8, 28, 0.88);
        border: 1px solid rgba(255, 255, 255, 0.22);
        box-shadow: 0 30px 55px rgba(3, 6, 28, 0.55);
        transition: opacity 320ms ease, transform 320ms ease;
      }

      .orientation-warning__emoji {
        font-size: clamp(2.5rem, 8vw, 3.5rem);
        filter: drop-shadow(0 6px 12px rgba(24, 241, 255, 0.55));
      }

      .orientation-warning__title {
        margin: 0;
        font-family: "Orbitron", sans-serif;
        font-size: clamp(1.15rem, 4vw, 1.6rem);
        letter-spacing: 0.12em;
        text-transform: uppercase;
      }

      .orientation-warning__subtitle {
        margin: 0;
        font-size: clamp(0.9rem, 3.5vw, 1.05rem);
        opacity: 0.85;
      }

      .orientation-warning__action {
        margin-top: 0.35rem;
        display: inline-flex;
        align-items: center;
        gap: 0.55rem;
        padding: 0.6rem 1.35rem;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.28);
        background: rgba(18, 18, 48, 0.85);
        color: var(--text-light);
        font-family: "Orbitron", sans-serif;
        font-size: clamp(0.75rem, 3vw, 0.92rem);
        letter-spacing: 0.1em;
        text-transform: uppercase;
        cursor: pointer;
        transition: transform 160ms ease, box-shadow 160ms ease, border-color 160ms ease;
      }

      .orientation-warning__action:hover,
      .orientation-warning__action:focus-visible {
        transform: translateY(-2px);
        box-shadow: 0 0 18px rgba(24, 241, 255, 0.45);
        border-color: rgba(24, 241, 255, 0.4);
        outline: none;
      }

      .orientation-warning__action:active {
        transform: translateY(0);
      }

      .orientation-warning__action[disabled] {
        opacity: 0.65;
        cursor: default;
        transform: none;
        box-shadow: none;
      }

      .orientation-warning__action-icon {
        font-size: clamp(1rem, 3vw, 1.25rem);
        filter: drop-shadow(0 6px 12px rgba(24, 241, 255, 0.55));
      }

      .orientation-warning__action-label {
        display: inline-block;
      }

      .intro-overlay.is-playing .orientation-warning {
        opacity: 0;
        transform: translateY(-24px) scale(0.96);
        pointer-events: none;
      }

      .intro-overlay__video {
        position: absolute;
        inset: 0;
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        border: none;
        background: #000;
        opacity: 0;
        transition: opacity 360ms ease;
      }

      .intro-overlay.is-playing .intro-overlay__video {
        opacity: 1;
      }

      @media (max-width: 620px) {
        .orientation-warning {
          border-radius: 22px;
          padding: 1.35rem 1.65rem;
        }
        .skip-toggle__label {
          letter-spacing: 0.12em;
        }
      }

      video.bg-video {
        position: fixed;
        top: 50%;
        left: 50%;
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        transform: translate(-50%, -50%);
        object-fit: cover;
        filter: saturate(1.2) contrast(1.05) brightness(0.95);
        z-index: 0;
        pointer-events: none;
      }

      .backdrop {
        position: fixed;
        inset: 0;
        background: linear-gradient(
            120deg,
            rgba(6, 6, 30, 0.45) 0%,
            rgba(20, 9, 40, 0.30) 45%,
            rgba(2, 11, 28, 0.40) 100%
          ),
          radial-gradient(circle at 20% 20%, rgba(52, 8, 135, 0.22), transparent 55%),
          radial-gradient(circle at 80% 70%, rgba(14, 112, 158, 0.22), transparent 50%);
        z-index: 1;
        transition: background 280ms ease, opacity 280ms ease;
        pointer-events: none;
      }
      .backdrop.video-ready {
        background: linear-gradient(
            120deg,
            rgba(6, 6, 30, 0.28) 0%,
            rgba(20, 9, 40, 0.18) 45%,
            rgba(2, 11, 28, 0.22) 100%
          ),
          radial-gradient(circle at 20% 20%, rgba(52, 8, 135, 0.15), transparent 55%),
          radial-gradient(circle at 80% 70%, rgba(14, 112, 158, 0.15), transparent 50%);
      }
      .backdrop.video-error {
        /* If video fails, keep darker overlay so text stays readable */
        background: linear-gradient(
            120deg,
            rgba(6, 6, 30, 0.70) 0%,
            rgba(20, 9, 40, 0.50) 45%,
            rgba(2, 11, 28, 0.65) 100%
          );
      }

      .content {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 2.5rem;
        min-height: 100vh;
        padding: 3rem 1.5rem;
        text-align: center;
      }
      .content { z-index: 2; }
      .settings-wrapper { z-index: 3; }
      .audio-prompt { z-index: 3; }

      .branding {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        align-items: center;
        max-width: 620px;
      }

      .branding h1 {
        margin: 0;
        font-family: "Orbitron", sans-serif;
        font-size: clamp(2.75rem, 6vw, 4.5rem);
        letter-spacing: 0.12em;
        text-transform: uppercase;
        text-shadow: 0 0 25px rgba(0, 0, 0, 0.75), 0 0 40px rgba(24, 241, 255, 0.6);
      }

      .branding p {
        margin: 0;
        font-size: clamp(1.05rem, 2.5vw, 1.45rem);
        line-height: 1.5;
        letter-spacing: 0.05em;
        opacity: 0.9;
      }

      .actions {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        width: min(420px, 100%);
      }

      @media (min-width: 640px) {
        .actions {
          flex-direction: row;
          justify-content: center;
        }
      }

      .cta-button {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.65rem;
        padding: 0.9rem 2.7rem;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: linear-gradient(120deg, var(--primary), var(--primary-dark));
        color: var(--text-light);
        font-family: "Orbitron", sans-serif;
        font-size: 1.05rem;
        font-weight: 700;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        text-decoration: none;
        box-shadow: var(--glow);
        cursor: pointer;
        appearance: none;
        transition: transform 180ms ease, box-shadow 180ms ease, filter 180ms ease;
      }

      .cta-button svg {
        width: 1.1rem;
        height: 1.1rem;
        fill: currentColor;
      }

      .cta-button:hover,
      .cta-button:focus-visible {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 0 35px rgba(255, 64, 246, 0.75);
        filter: saturate(1.1);
        outline: none;
      }

      .cta-button.secondary {
        background: linear-gradient(120deg, rgba(24, 241, 255, 0.9), rgba(76, 106, 255, 0.9));
        box-shadow: 0 0 22px rgba(24, 241, 255, 0.5);
      }

      .start-modal {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: clamp(1.5rem, 4vw, 3rem);
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: opacity 200ms ease, visibility 200ms ease;
        z-index: 40;
      }

      .start-modal.is-active {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
      }

      .start-modal__backdrop {
        position: absolute;
        inset: 0;
        background: rgba(4, 4, 16, 0.86);
        backdrop-filter: blur(6px);
      }

      .start-modal__panel {
        position: relative;
        width: min(520px, 100%);
        padding: clamp(1.75rem, 4vw, 2.5rem);
        border-radius: 28px;
        background: rgba(10, 10, 32, 0.96);
        border: 1px solid var(--panel-border);
        box-shadow: 0 28px 60px rgba(3, 6, 28, 0.55);
        display: flex;
        flex-direction: column;
        gap: 1.35rem;
      }

      .start-modal__close {
        position: absolute;
        top: clamp(0.75rem, 3vw, 1.25rem);
        right: clamp(0.75rem, 3vw, 1.25rem);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2.25rem;
        height: 2.25rem;
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: rgba(18, 18, 48, 0.85);
        color: var(--text-light);
        cursor: pointer;
        transition: transform 180ms ease, box-shadow 180ms ease, border-color 180ms ease;
      }

      .start-modal__close:hover,
      .start-modal__close:focus-visible {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 16px 28px rgba(24, 241, 255, 0.35);
        border-color: rgba(24, 241, 255, 0.45);
        outline: none;
      }

      .start-modal__heading {
        margin: 0;
        font-family: "Orbitron", sans-serif;
        font-size: clamp(1.35rem, 4vw, 1.7rem);
        letter-spacing: 0.12em;
        text-transform: uppercase;
        text-align: center;
      }

      .start-modal__description {
        margin: 0;
        font-size: clamp(0.95rem, 2.6vw, 1.1rem);
        line-height: 1.6;
        text-align: center;
        opacity: 0.85;
      }

      .start-modal__choices {
        display: grid;
        gap: 1rem;
      }

      .start-modal__choice {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        padding: 1.1rem 1.4rem;
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.22);
        background: linear-gradient(140deg, rgba(24, 241, 255, 0.14), rgba(255, 64, 246, 0.18));
        color: var(--text-light);
        text-decoration: none;
        transition: transform 180ms ease, box-shadow 180ms ease, border-color 180ms ease;
      }

      .start-modal__choice:hover,
      .start-modal__choice:focus-visible {
        transform: translateY(-3px);
        box-shadow: 0 18px 38px rgba(24, 241, 255, 0.35);
        border-color: rgba(24, 241, 255, 0.45);
        outline: none;
      }

      .start-modal__choice-title {
        font-family: "Orbitron", sans-serif;
        font-size: clamp(1.05rem, 3vw, 1.25rem);
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .start-modal__choice-desc {
        font-size: clamp(0.9rem, 2.4vw, 1rem);
        line-height: 1.5;
        opacity: 0.8;
      }

      .start-modal__choice--primary {
        background: linear-gradient(140deg, rgba(255, 64, 246, 0.32), rgba(24, 241, 255, 0.24));
        border-color: rgba(255, 255, 255, 0.28);
        box-shadow: 0 20px 44px rgba(255, 64, 246, 0.25);
      }

      .start-modal__choice--primary:hover,
      .start-modal__choice--primary:focus-visible {
        box-shadow: 0 24px 48px rgba(255, 64, 246, 0.38);
      }

      .settings-wrapper {
        position: absolute;
        top: 1.5rem;
        right: 1.5rem;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.75rem;
      }

      .watch-trailer-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
        padding: 0.45rem 0.85rem;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(10, 10, 36, 0.65);
        color: var(--text-light);
        font-family: "Rajdhani", sans-serif;
        font-size: 0.78rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        cursor: pointer;
        transition: transform 150ms ease, box-shadow 150ms ease, border-color 150ms ease;
      }

      .watch-trailer-button__icon {
        font-size: 0.95rem;
        filter: drop-shadow(0 4px 10px rgba(24, 241, 255, 0.45));
      }

      .watch-trailer-button:hover,
      .watch-trailer-button:focus-visible {
        transform: translateY(-1px);
        box-shadow: 0 0 18px rgba(24, 241, 255, 0.45);
        border-color: rgba(24, 241, 255, 0.4);
        outline: none;
      }

      .watch-trailer-button:active {
        transform: translateY(0);
      }

      .settings-toggle {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.75rem 1.25rem;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(10, 10, 40, 0.65);
        color: var(--text-light);
        font-family: "Orbitron", sans-serif;
        font-size: 0.85rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        cursor: pointer;
        transition: transform 150ms ease, box-shadow 150ms ease;
      }

      .settings-toggle svg {
        width: 1rem;
        height: 1rem;
        fill: currentColor;
      }

      .settings-toggle:hover,
      .settings-toggle:focus-visible {
        transform: translateY(-2px);
        box-shadow: 0 0 16px rgba(24, 241, 255, 0.55);
        outline: none;
      }

      .settings-menu {
        position: relative;
        padding: 1.25rem;
        width: min(240px, 90vw);
        border-radius: 18px;
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        backdrop-filter: blur(12px);
        display: none;
        flex-direction: column;
        gap: 1rem;
        box-shadow: 0 18px 45px rgba(3, 6, 28, 0.45);
      }

      .settings-menu.active {
        display: flex;
        animation: fadeIn 220ms ease;
      }

      .settings-menu h2 {
        margin: 0 0 0.5rem;
        font-family: "Orbitron", sans-serif;
        font-size: 0.95rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .toggle-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        padding: 0.6rem 0.75rem;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .toggle-row button {
        all: unset;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.35rem;
        padding: 0.45rem 0.75rem;
        border-radius: 999px;
        background: linear-gradient(135deg, rgba(24, 241, 255, 0.85), rgba(76, 106, 255, 0.85));
        color: var(--text-light);
        font-family: "Rajdhani", sans-serif;
        font-size: 0.85rem;
        letter-spacing: 0.05em;
        cursor: pointer;
        transition: transform 160ms ease, box-shadow 160ms ease;
      }

      .toggle-row button[aria-pressed="true"] {
        box-shadow: 0 0 18px rgba(24, 241, 255, 0.5);
      }

      .toggle-row button:hover,
      .toggle-row button:focus-visible {
        transform: translateY(-1px);
        box-shadow: 0 0 18px rgba(24, 241, 255, 0.65);
        outline: none;
      }

      .settings-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.65rem 0.85rem;
        border-radius: 12px;
        border: none;
        text-decoration: none;
        color: var(--text-light);
        font-family: "Rajdhani", sans-serif;
        font-size: 0.95rem;
        letter-spacing: 0.05em;
        background: linear-gradient(120deg, rgba(255, 64, 246, 0.85), rgba(116, 29, 255, 0.85));
        box-shadow: 0 0 20px rgba(255, 64, 246, 0.5);
        transition: transform 160ms ease, box-shadow 160ms ease;
        cursor: pointer;
      }

      .settings-link:hover,
      .settings-link:focus-visible {
        transform: translateY(-1px);
        box-shadow: 0 0 26px rgba(255, 64, 246, 0.7);
        outline: none;
      }

      .settings-link.signup-link {
        background: linear-gradient(135deg, rgba(24, 241, 255, 0.85), rgba(76, 106, 255, 0.85));
        box-shadow: 0 0 20px rgba(24, 241, 255, 0.45);
      }

      .settings-link.signup-link:hover,
      .settings-link.signup-link:focus-visible {
        box-shadow: 0 0 26px rgba(24, 241, 255, 0.65);
      }

      .audio-prompt {
        position: fixed;
        left: 50%;
        bottom: 2.5rem;
        transform: translateX(-50%);
        padding: 0.75rem 1.15rem;
        border-radius: 999px;
        background: rgba(10, 10, 30, 0.75);
        border: 1px solid rgba(24, 241, 255, 0.4);
        font-size: 0.95rem;
        letter-spacing: 0.04em;
        display: none;
        align-items: center;
        gap: 0.6rem;
        box-shadow: 0 12px 25px rgba(3, 6, 28, 0.45);
      }

      .audio-prompt.active {
        display: inline-flex;
      }

      .audio-prompt svg {
        width: 1.1rem;
        height: 1.1rem;
        fill: currentColor;
        color: var(--secondary);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 600px) {
        .settings-wrapper {
          top: 1rem;
          right: 1rem;
        }

        .branding h1 {
          letter-spacing: 0.08em;
        }

        /* Compact primary/secondary buttons on small screens */
        .actions { gap: 0.75rem; }
        .cta-button {
          padding: 0.7rem 1.2rem;
          font-size: 0.9rem;
          letter-spacing: 0.08em;
        }
        .cta-button svg { width: 0.95rem; height: 0.95rem; }

        /* Compact settings toggle and links */
        .settings-toggle { padding: 0.6rem 0.9rem; font-size: 0.75rem; }
        .settings-link { padding: 0.55rem 0.75rem; font-size: 0.85rem; }
        .watch-trailer-button {
          font-size: 0.72rem;
          padding: 0.4rem 0.75rem;
          letter-spacing: 0.06em;
        }

        .orientation-warning__action {
          padding: 0.55rem 1.05rem;
          font-size: 0.76rem;
          letter-spacing: 0.08em;
        }
      }
    </style>
  </head>
  <body>
    <div
      class="intro-overlay"
      id="introOverlay"
      role="dialog"
      aria-modal="true"
      aria-hidden="true"
    >
      <div class="intro-overlay__skip">
        <button class="skip-toggle" type="button" data-skip-intro>
          <span class="skip-toggle__track">
            <span class="skip-toggle__thumb" aria-hidden="true">üöÄ</span>
          </span>
          <span class="skip-toggle__label">Skip Intro</span>
        </button>
      </div>
      <div class="orientation-warning" id="orientationWarning" role="status">
        <div class="orientation-warning__emoji" aria-hidden="true">üì±‚Üª</div>
        <p class="orientation-warning__title">Rotate your phone or tablet to landscape</p>
        <p class="orientation-warning__subtitle">Our trailer plays best in widescreen. Sit back &amp; enjoy!</p>
        <button class="orientation-warning__action" type="button" data-orientation-action>
          <span class="orientation-warning__action-icon" aria-hidden="true">üîÅ</span>
          <span class="orientation-warning__action-label" data-orientation-action-label>Rotate &amp; Play</span>
        </button>
      </div>
      <div class="intro-overlay__interaction" id="introInteractionNotice" role="alert" aria-hidden="true">
        <span class="intro-overlay__interaction-icon" aria-hidden="true">üîä</span>
        <span>Tap once to hear the trailer with sound</span>
      </div>
      <video
        id="introVideo"
        class="intro-overlay__video"
        preload="auto"
        playsinline
        webkit-playsinline
        crossorigin="anonymous"
      >
        <source src="/elearn/worlds/kindercoder/thumbs/trailer.mp4" type="video/mp4" />
        Your browser does not support the intro video.
      </video>
    </div>
    <video
      id="bgVideo"
      class="bg-video"
      autoplay
      muted
      playsinline
      preload="auto"
      onerror="console.warn('[start.html] &lt;video&gt; element error: ', this.error)"
    >
      <!-- Prefer absolute paths to avoid relative-path issues -->
      <source src="/elearn/worlds/kindercoder/thumbs/start-bg-loop.mp4" type="video/mp4" />
      <source src="/elearn/worlds/kindercoder/thumbs/start-bg-loop.webm" type="video/webm" />
      Your browser does not support the background video.
    </video>
    <div class="backdrop" aria-hidden="true"></div>

    <div class="settings-wrapper">
      <button class="watch-trailer-button" type="button" data-rewatch-intro>
        <span class="watch-trailer-button__icon" aria-hidden="true">üé¨</span>
        <span>Play Trailer</span>
      </button>
      <button class="settings-toggle" type="button" data-settings-toggle>
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path
            d="M12 8.5a3.5 3.5 0 1 1 0 7 3.5 3.5 0 0 1 0-7Zm8.92 3.07-1.53-.88.05-.62a1.5 1.5 0 0 0-.74-1.4l-1.3-.75-.19-.59a1.5 1.5 0 0 0-1.43-1.04l-1.5.02-.45-.45a1.5 1.5 0 0 0-2.12 0l-.44.44-1.51-.02a1.5 1.5 0 0 0-1.44 1.04l-.18.6-1.3.75a1.5 1.5 0 0 0-.74 1.4l.05.62-1.53.88a1.5 1.5 0 0 0-.55 2.05l.75 1.3-.2.6a1.5 1.5 0 0 0 1.04 1.43l1.52.46.04.62a1.5 1.5 0 0 0 1.5 1.38h1.53l.44.44a1.5 1.5 0 0 0 2.12 0l.44-.44h1.54a1.5 1.5 0 0 0 1.5-1.38l.04-.62 1.52-.46a1.5 1.5 0 0 0 1.04-1.43l-.2-.6.75-1.3a1.5 1.5 0 0 0-.55-2.05Zm-2.54 3.05-.65 1.12.17.5c.05.16-.04.33-.2.38l-1.35.41-.04.54a.5.5 0 0 1-.5.46h-1.37l-.4.4a.5.5 0 0 1-.71 0l-.4-.4h-1.36a.5.5 0 0 1-.5-.46l-.04-.54-1.35-.41a.32.32 0 0 1-.2-.38l.17-.5-.65-1.13a.32.32 0 0 1 .12-.44l1.13-.65-.04-.54a.5.5 0 0 1 .25-.46l1.17-.68.16-.51a.5.5 0 0 1 .48-.35h1.37l.4-.4a.5.5 0 0 1 .71 0l.4.4h1.36a.5.5 0 0 1 .49.35l.16.51 1.17.68a.5.5 0 0 1 .25.46l-.04.54 1.13.65a.32.32 0 0 1 .12.44Z"
          ></path>
        </svg>
        Settings
      </button>
      <div class="settings-menu" data-settings-menu aria-hidden="true">
        <h2>Settings</h2>
        <div class="toggle-row">
          <span>Audio</span>
          <button type="button" data-sound-toggle aria-pressed="false">
            <span data-sound-icon aria-hidden="true">üîá</span>
            <span data-sound-label>Sound Off</span>
          </button>
        </div>
        <a class="settings-link login-link" href="../elearn/login.html" data-open-login="account">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path
              d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8Zm0 2c-2.67 0-8 1.34-8 4v1.5c0 .28.22.5.5.5h15c.28 0 .5-.22.5-.5V18c0-2.66-5.33-4-8-4Z"
            ></path>
          </svg>
          Login
        </button>
        <a class="settings-link signup-link" href="../elearn/daftar.html">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path
              d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8Zm0 2c-2.67 0-8 1.34-8 4v1.5c0 .28.22.5.5.5h7.5V17a1 1 0 0 1 1-1H21a1 1 0 0 1 0 2h-6.5v2h7c.28 0 .5-.22.5-.5V18c0-2.66-5.33-4-8-4Z"
            ></path>
            <path d="M19 8h-2V6a1 1 0 1 0-2 0v2h-2a1 1 0 1 0 0 2h2v2a1 1 0 1 0 2 0v-2h2a1 1 0 1 0 0-2Z"></path>
          </svg>
          Sign Up
        </a>
      </div>
    </div>

    <main class="content">
      <div class="branding">
        <h1>Queen's Academy</h1>
        <p>
          Embark on an intergalactic quest to master Calistung. Power up your
          skills and get ready to play!
        </p>
      </div>
      <div class="actions">
        <button class="cta-button" type="button" data-start-trigger>
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="m8 5 11 7-11 7V5Z"></path>
          </svg>
          Start Game
        </button>
        <button class="cta-button secondary" type="button" data-settings-toggle-secondary>
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path
              d="M12 8.5a3.5 3.5 0 1 1 0 7 3.5 3.5 0 0 1 0-7Zm8.92 3.07-1.53-.88.05-.62a1.5 1.5 0 0 0-.74-1.4l-1.3-.75-.19-.59a1.5 1.5 0 0 0-1.43-1.04l-1.5.02-.45-.45a1.5 1.5 0 0 0-2.12 0l-.44.44-1.51-.02a1.5 1.5 0 0 0-1.44 1.04l-.18.6-1.3.75a1.5 1.5 0 0 0-.74 1.4l.05.62-1.53.88a1.5 1.5 0 0 0-.55 2.05l.75 1.3-.2.6a1.5 1.5 0 0 0 1.04 1.43l1.52.46.04.62a1.5 1.5 0 0 0 1.5 1.38h1.53l.44.44a1.5 1.5 0 0 0 2.12 0l.44-.44h1.54a1.5 1.5 0 0 0 1.5-1.38l.04-.62 1.52-.46a1.5 1.5 0 0 0 1.04-1.43l-.2-.6.75-1.3a1.5 1.5 0 0 0-.55-2.05Z"
            ></path>
          </svg>
          Settings
        </button>
      </div>
    </main>

    <div class="start-modal" data-start-modal aria-hidden="true">
      <div class="start-modal__backdrop" data-start-modal-backdrop></div>
      <div
        class="start-modal__panel"
        role="dialog"
        aria-modal="true"
        aria-labelledby="startModalHeading"
        data-start-modal-panel
      >
        <button class="start-modal__close" type="button" data-start-modal-close aria-label="Tutup pilihan">
          √ó
        </button>
        <h2 class="start-modal__heading" id="startModalHeading">Pilih Cara Masuk</h2>
        <p class="start-modal__description">
          Mulai petualangannnmu sebagai tamu atau masuk menggunakan akun yang sudah terdaftar.
        </p>
        <div class="start-modal__choices">
          <a class="start-modal__choice" href="login.html" data-start-choice>
            <span class="start-modal__choice-title">Masuk sebagai Tamu</span>
            <span class="start-modal__choice-desc">Jelajahi Queen's Academy tanpa membuat akun baru.</span>
          </a>
          <a class="start-modal__choice start-modal__choice--primary" href="elearn/login.html" data-start-choice>
            <span class="start-modal__choice-title">Masuk dengan Akun Terdaftar</span>
            <span class="start-modal__choice-desc">Gunakan akun yang telah kamu daftarkan untuk menyimpan progres.</span>
          </a>
        </div>
      </div>
    </div>

    <div class="audio-prompt" id="audioPrompt" role="status">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path
          d="M12 3a1 1 0 0 1 .86.49l.08.16 1.53 3.46 3.79.33a1 1 0 0 1 .52 1.74l-.13.1-2.9 2.42.87 3.7a1 1 0 0 1-1.42 1.1l-.16-.08-3.04-1.84-3.04 1.84a1 1 0 0 1-1.48-1.02l.03-.16.87-3.7-2.9-2.41a1 1 0 0 1 .41-1.75l.16-.03 3.78-.33 1.54-3.46A1 1 0 0 1 12 3Z"
        ></path>
      </svg>
      Tap anywhere to enable sound
    </div>

    <audio id="themeAudio" src="../elearn/worlds/calistung/thumbs/theme-song.mp3" loop></audio>

    <script>
      (function () {
        const settingsButtons = document.querySelectorAll('[data-settings-toggle], [data-settings-toggle-secondary]');
        const settingsMenu = document.querySelector('[data-settings-menu]');
        const audioEl = document.getElementById('themeAudio');
        const audioToggle = document.querySelector('[data-sound-toggle]');
        const audioLabel = document.querySelector('[data-sound-label]');
        const audioIcon = document.querySelector('[data-sound-icon]');
        const audioPrompt = document.getElementById('audioPrompt');
        const bgVideo = document.querySelector('.bg-video');
        const backdropEl = document.querySelector('.backdrop');
        const introOverlay = document.getElementById('introOverlay');
        const introVideo = document.getElementById('introVideo');
        const orientationWarning = document.getElementById('orientationWarning');
        const introInteractionNotice = document.getElementById('introInteractionNotice');
        const skipIntroButton = document.querySelector('[data-skip-intro]');
        const skipIntroLabel = skipIntroButton?.querySelector('.skip-toggle__label') || null;
        const orientationActionButton = document.querySelector('[data-orientation-action]');
        const orientationActionLabel =
          orientationActionButton?.querySelector('[data-orientation-action-label]') || null;
        const rewatchIntroButton = document.querySelector('[data-rewatch-intro]');
        const bodyEl = document.body;
        const startModal = document.querySelector('[data-start-modal]');
        const startModalTrigger = document.querySelector('[data-start-trigger]');
        const startModalBackdrop = startModal?.querySelector('[data-start-modal-backdrop]') || null;
        const startModalCloseButtons = startModal
          ? startModal.querySelectorAll('[data-start-modal-close]')
          : [];
        const startModalPanel = startModal?.querySelector('[data-start-modal-panel]') || null;
        const startModalChoices = startModal ? startModal.querySelectorAll('[data-start-choice]') : [];
        let previousFocusBeforeStartModal = null;
        const INTRO_STORAGE_KEY = 'qaStartIntroSeen';
        const orientationDefaultLabel = orientationActionLabel?.textContent?.trim() || 'Rotate & Play';
        const isMobileDevice =
          /Android|webOS|iP(ad|hone|od)|BlackBerry|IEMobile|Opera Mini/i.test(
            navigator.userAgent || ''
          );
        let settingsOpen = false;
        let hasMainExperienceStarted = false;
        let introActive = false;
        let introCountdownId = null;
        let introAwaitingUserAudio = false;
        let shouldResumeThemeAfterIntro = false;
        let awaitingLandscapeBeforePlayback = false;
        let introHasStartedPlaying = false;
        let orientationLockInEffect = false;
        const BG_VIDEO_REVERSE_INTERVAL = 30;
        const BG_VIDEO_REVERSE_STEP = 0.04;
        const BG_VIDEO_REVERSE_THRESHOLD = 0.05;
        let shouldReverseBgVideoOnFirstEnd = true;
        let isBgVideoReversing = false;
        let bgVideoReverseTimerId = null;
        let bgVideoReverseRafId = null;
        let bgVideoLastReverseTime = null;

        const isLandscapeOrientation = () =>
          window.matchMedia('(orientation: landscape)').matches ||
          window.innerWidth > window.innerHeight;

        const focusFirstStartChoice = () => {
          if (!startModal) return;
          const focusTarget = startModalChoices?.[0] || startModalPanel?.querySelector('a, button');
          if (focusTarget) {
            window.requestAnimationFrame(() => focusTarget.focus());
          }
        };

        const openStartModal = () => {
          if (!startModal) return;
          previousFocusBeforeStartModal =
            document.activeElement instanceof HTMLElement ? document.activeElement : null;
          startModal.classList.add('is-active');
          startModal.setAttribute('aria-hidden', 'false');
          focusFirstStartChoice();
        };

        const closeStartModal = () => {
          if (!startModal) return;
          startModal.classList.remove('is-active');
          startModal.setAttribute('aria-hidden', 'true');
          if (previousFocusBeforeStartModal?.focus) {
            previousFocusBeforeStartModal.focus();
          }
        };

        if (startModalTrigger && startModal) {
          startModalTrigger.addEventListener('click', (event) => {
            event.preventDefault();
            openStartModal();
          });
        }

        startModalBackdrop?.addEventListener('click', closeStartModal);
        startModalCloseButtons.forEach((button) => {
          button.addEventListener('click', closeStartModal);
        });

        document.addEventListener('keydown', (event) => {
          if (!startModal?.classList.contains('is-active')) {
            return;
          }

          if (event.key === 'Escape') {
            closeStartModal();
            return;
          }

          if (event.key === 'Tab') {
            const focusableElements = startModal?.querySelectorAll(
              'a[href], button:not([disabled]), [tabindex]:not([tabindex="-1"])'
            );

            if (!focusableElements || !focusableElements.length) {
              return;
            }

            const focusable = Array.from(focusableElements);
            const firstElement = focusable[0];
            const lastElement = focusable[focusable.length - 1];

            if (event.shiftKey && document.activeElement === firstElement) {
              event.preventDefault();
              lastElement.focus();
            } else if (!event.shiftKey && document.activeElement === lastElement) {
              event.preventDefault();
              firstElement.focus();
            }
          }
        });

        const setOrientationActionState = (state) => {
          if (!orientationActionButton || !orientationActionLabel) {
            return;
          }
          orientationActionButton.dataset.state = state;
          if (state === 'working') {
            orientationActionLabel.textContent = 'Preparing...';
          } else if (state === 'done') {
            orientationActionLabel.textContent = 'Enjoy the trailer';
          } else {
            orientationActionLabel.textContent = orientationDefaultLabel;
          }
        };

        const requestIntroFullscreen = async ({ fromGesture = false } = {}) => {
          if (!introVideo) {
            return false;
          }
          if (document.fullscreenElement) {
            return true;
          }
          if (typeof introVideo.requestFullscreen === 'function') {
            try {
              await introVideo.requestFullscreen();
              return true;
            } catch (error) {
              if (fromGesture) {
                console.warn('Unable to open intro fullscreen', error);
              }
            }
          }
          const webkitFullscreen =
            introVideo.webkitEnterFullscreen ||
            introVideo.webkitRequestFullscreen ||
            introVideo.requestFullScreen;
          if (typeof webkitFullscreen === 'function') {
            try {
              webkitFullscreen.call(introVideo);
              return true;
            } catch (error) {
              if (fromGesture) {
                console.warn('Unable to open intro webkit fullscreen', error);
              }
            }
          }
          return false;
        };

        const lockOrientationLandscape = async ({ fromGesture = false } = {}) => {
          const screenObj = window.screen;
          if (!screenObj) {
            return false;
          }
          const orientation = screenObj.orientation;
          if (orientation && typeof orientation.lock === 'function') {
            try {
              await orientation.lock('landscape');
              orientationLockInEffect = true;
              return true;
            } catch (error) {
              if (fromGesture) {
                console.warn('Unable to lock orientation', error);
              }
            }
          }
          const legacyLock =
            screenObj.lockOrientation || screenObj.mozLockOrientation || screenObj.msLockOrientation;
          if (typeof legacyLock === 'function') {
            try {
              const legacyResult = legacyLock.call(screenObj, 'landscape');
              if (legacyResult && typeof legacyResult.then === 'function') {
                await legacyResult;
              }
              orientationLockInEffect = true;
              return true;
            } catch (error) {
              if (fromGesture) {
                console.warn('Unable to lock orientation (legacy)', error);
              }
            }
          }
          return false;
        };

        const unlockOrientation = () => {
          if (!orientationLockInEffect) {
            return;
          }
          const orientation = window.screen?.orientation;
          if (orientation && typeof orientation.unlock === 'function') {
            try {
              orientation.unlock();
            } catch (error) {
              console.warn('Unable to unlock orientation', error);
            }
          }
          orientationLockInEffect = false;
        };

        const exitIntroPresentation = () => {
          unlockOrientation();
          if (document.fullscreenElement && typeof document.exitFullscreen === 'function') {
            document.exitFullscreen().catch(() => {});
          }
          if (
            introVideo &&
            typeof introVideo.webkitSupportsFullscreen !== 'undefined' &&
            introVideo.webkitSupportsFullscreen &&
            introVideo.webkitDisplayingFullscreen &&
            typeof introVideo.webkitExitFullscreen === 'function'
          ) {
            try {
              introVideo.webkitExitFullscreen();
            } catch (error) {
              console.warn('Unable to exit intro webkit fullscreen', error);
            }
          }
        };

        const ensureBgVideoPlaying = () => {
          if (!bgVideo || isBgVideoReversing) {
            return;
          }
          bgVideo.defaultMuted = true;
          bgVideo.muted = true;
          if (bgVideo.readyState === 0 && !bgVideo.dataset.loadRequested) {
            bgVideo.dataset.loadRequested = 'true';
            bgVideo.load();
          }
          if (bgVideo.paused) {
            const playPromise = bgVideo.play();
            if (playPromise && typeof playPromise.then === 'function') {
              playPromise.catch(() => {});
            }
          }
        };

        const clearBgVideoReverseTimers = () => {
          if (bgVideoReverseTimerId !== null) {
            window.clearInterval(bgVideoReverseTimerId);
            bgVideoReverseTimerId = null;
          }
          if (bgVideoReverseRafId !== null) {
            window.cancelAnimationFrame(bgVideoReverseRafId);
            bgVideoReverseRafId = null;
          }
        };

        const endBgVideoReverse = () => {
          clearBgVideoReverseTimers();
          shouldReverseBgVideoOnFirstEnd = false;
          isBgVideoReversing = false;
          bgVideoLastReverseTime = null;
          if (!bgVideo) {
            return;
          }
          bgVideo.pause();
          try {
            bgVideo.currentTime = 0;
          } catch (error) {
            console.warn('Unable to reset background video time after reverse', error);
          }
          bgVideo.playbackRate = 1;
          bgVideo.loop = true;
          ensureBgVideoPlaying();
        };

        const startBgVideoReverseFallback = () => {
          if (!bgVideo) {
            return;
          }
          clearBgVideoReverseTimers();
          isBgVideoReversing = true;
          bgVideo.pause();
          bgVideo.playbackRate = 1;
          bgVideoLastReverseTime = null;
          bgVideoReverseTimerId = window.setInterval(() => {
            if (!bgVideo) {
              clearBgVideoReverseTimers();
              return;
            }
            if (bgVideo.currentTime <= BG_VIDEO_REVERSE_THRESHOLD) {
              endBgVideoReverse();
              return;
            }
            const nextTime = Math.max(0, bgVideo.currentTime - BG_VIDEO_REVERSE_STEP);
            try {
              bgVideo.currentTime = nextTime;
            } catch (error) {
              console.warn('Unable to step background video during manual reverse', error);
              endBgVideoReverse();
            }
          }, BG_VIDEO_REVERSE_INTERVAL);
        };

        const monitorBgVideoReverseProgress = () => {
          if (!bgVideo || !isBgVideoReversing) {
            return;
          }
          if (bgVideo.currentTime <= BG_VIDEO_REVERSE_THRESHOLD) {
            endBgVideoReverse();
            return;
          }
          if (bgVideoLastReverseTime !== null && bgVideo.currentTime >= bgVideoLastReverseTime) {
            console.warn('Background video reverse playback not progressing, falling back to manual rewind.');
            bgVideo.pause();
            bgVideo.playbackRate = 1;
            startBgVideoReverseFallback();
            return;
          }
          bgVideoLastReverseTime = bgVideo.currentTime;
          bgVideoReverseRafId = window.requestAnimationFrame(monitorBgVideoReverseProgress);
        };

        const startBgVideoReverse = () => {
          if (!bgVideo || isBgVideoReversing) {
            return;
          }
          shouldReverseBgVideoOnFirstEnd = false;
          isBgVideoReversing = true;
          clearBgVideoReverseTimers();
          try {
            const magnitude = Math.max(1, Math.abs(bgVideo.playbackRate) || 1);
            bgVideo.playbackRate = -magnitude;
            const reversePromise = bgVideo.play();
            if (reversePromise && typeof reversePromise.then === 'function') {
              reversePromise
                .then(() => {
                  bgVideoLastReverseTime = bgVideo.currentTime;
                  monitorBgVideoReverseProgress();
                })
                .catch((error) => {
                  console.warn('Unable to reverse background video playback via playbackRate', error);
                  bgVideo.pause();
                  bgVideo.playbackRate = 1;
                  startBgVideoReverseFallback();
                });
            } else {
              bgVideoLastReverseTime = bgVideo.currentTime;
              monitorBgVideoReverseProgress();
            }
          } catch (error) {
            console.warn('Unable to reverse background video playback', error);
            bgVideo.pause();
            bgVideo.playbackRate = 1;
            startBgVideoReverseFallback();
          }
        };

        if (bgVideo) {
          bgVideo.loop = false;
          bgVideo.addEventListener('loadeddata', ensureBgVideoPlaying);
          bgVideo.addEventListener('canplay', () => {
            ensureBgVideoPlaying();
            if (backdropEl) {
              backdropEl.classList.add('video-ready');
              backdropEl.classList.remove('video-error');
            }
          });
          bgVideo.addEventListener('stalled', ensureBgVideoPlaying);
          bgVideo.addEventListener('suspend', ensureBgVideoPlaying);
          bgVideo.addEventListener('ended', () => {
            if (isBgVideoReversing) {
              return;
            }
            if (shouldReverseBgVideoOnFirstEnd) {
              startBgVideoReverse();
              return;
            }
            try {
              bgVideo.currentTime = 0;
            } catch (error) {
              console.warn('Unable to reset background video time after loop', error);
            }
            ensureBgVideoPlaying();
          });
          bgVideo.addEventListener('error', () => {
            console.warn('Background video failed to load', bgVideo.error);
            if (backdropEl) {
              backdropEl.classList.add('video-error');
              backdropEl.classList.remove('video-ready');
            }
          });
          ensureBgVideoPlaying();
        }

        document.addEventListener('fullscreenchange', () => {
          if (!document.fullscreenElement) {
            unlockOrientation();
          }
        });

        const openSettings = (open) => {
          settingsOpen = open;
          if (settingsOpen) {
            settingsMenu.classList.add('active');
            settingsMenu.setAttribute('aria-hidden', 'false');
          } else {
            settingsMenu.classList.remove('active');
            settingsMenu.setAttribute('aria-hidden', 'true');
          }
        };

        settingsButtons.forEach((button) => {
          button.addEventListener('click', (event) => {
            event.stopPropagation();
            openSettings(!settingsOpen);
          });
        });

        if (settingsLoginLink) {
          settingsLoginLink.addEventListener('click', (event) => {
            event.preventDefault();
            openSettings(false);
            openStartModal({ view: 'login' });
          });
        }

        document.addEventListener('click', (event) => {
          if (!settingsMenu.contains(event.target)) {
            openSettings(false);
          }
        });

        if (rewatchIntroButton) {
          rewatchIntroButton.addEventListener('click', () => {
            openSettings(false);
            showIntroOverlay();
          });
        }

        if (orientationActionButton) {
          orientationActionButton.addEventListener('click', async (event) => {
            event.preventDefault();
            cancelIntroCountdown();
            setOrientationActionState('working');
            orientationActionButton.disabled = true;
            await requestIntroFullscreen({ fromGesture: true });
            await lockOrientationLandscape({ fromGesture: true });

            if (!introHasStartedPlaying) {
              awaitingLandscapeBeforePlayback = false;
              const playbackPromise = startIntroPlayback();
              if (playbackPromise && typeof playbackPromise.then === 'function') {
                playbackPromise.catch(() => {});
              }
              return;
            }

            introVideo.muted = false;
            const resumePromise = introVideo.play();
            if (resumePromise && typeof resumePromise.then === 'function') {
              resumePromise
                .then(() => {
                  clearIntroAudioPrompt();
                  setOrientationActionState('done');
                  orientationActionButton.disabled = true;
                })
                .catch((error) => {
                  console.warn('Unable to resume intro audio from rotate control', error);
                  orientationActionButton.disabled = false;
                  setOrientationActionState('ready');
                  requestIntroAudioGesture();
                });
            } else {
              clearIntroAudioPrompt();
              setOrientationActionState('done');
            }
          });
        }

        const updateAudioUI = () => {
          const isMuted = audioEl.muted || audioEl.paused;
          if (isMuted) {
            audioToggle.setAttribute('aria-pressed', 'false');
            audioLabel.textContent = 'Sound Off';
            audioIcon.textContent = 'üîá';
          } else {
            audioToggle.setAttribute('aria-pressed', 'true');
            audioLabel.textContent = 'Sound On';
            audioIcon.textContent = 'üîä';
          }
        };

        const tryPlayAudio = () => {
          audioEl.volume = 0.65;
          audioEl.muted = false;
          const playPromise = audioEl.play();
          if (playPromise && typeof playPromise.then === 'function') {
            playPromise
              .then(() => {
                audioPrompt.classList.remove('active');
                updateAudioUI();
              })
              .catch(() => {
                audioEl.muted = true;
                audioPrompt.classList.add('active');
                updateAudioUI();
              });
          }
        };

        const startMainExperience = () => {
          if (hasMainExperienceStarted) {
            return;
          }
          hasMainExperienceStarted = true;
          bodyEl.classList.remove('intro-active');
          tryPlayAudio();
          ensureBgVideoPlaying();
          if (bgVideo) {
            const currentSrc = bgVideo.currentSrc || (bgVideo.querySelector('source')?.src) || 'no-src';
            console.log('[start.html] Using video source:', currentSrc);
          }
          updateAudioUI();
        };

        const cancelIntroCountdown = () => {
          if (introCountdownId !== null) {
            clearTimeout(introCountdownId);
            introCountdownId = null;
          }
        };

        const clearIntroAudioPrompt = () => {
          introAwaitingUserAudio = false;
          if (introOverlay) {
            introOverlay.classList.remove('needs-user-audio');
          }
          if (introInteractionNotice) {
            introInteractionNotice.setAttribute('aria-hidden', 'true');
          }
        };

        const requestIntroAudioGesture = () => {
          introAwaitingUserAudio = true;
          if (introOverlay) {
            introOverlay.classList.add('needs-user-audio');
          }
          if (introInteractionNotice) {
            introInteractionNotice.setAttribute('aria-hidden', 'false');
          }
        };

        const markIntroAsSeen = () => {
          try {
            sessionStorage.setItem(INTRO_STORAGE_KEY, 'true');
          } catch (error) {
            console.warn('Unable to persist intro trailer state', error);
          }
        };

        const finishIntro = () => {
          if (!introActive && hasMainExperienceStarted) {
            return;
          }
          cancelIntroCountdown();
          introActive = false;
          clearIntroAudioPrompt();
          if (skipIntroButton) {
            skipIntroButton.disabled = true;
          }
          if (skipIntroLabel) {
            skipIntroLabel.textContent = 'Enjoy the game!';
          }
          if (introVideo) {
            introVideo.pause();
            introVideo.currentTime = 0;
          }
          if (introOverlay) {
            introOverlay.classList.add('is-finished');
            introOverlay.classList.remove('is-playing', 'is-active', 'needs-user-audio');
            introOverlay.setAttribute('aria-hidden', 'true');
            orientationWarning?.setAttribute('aria-hidden', 'true');
          }
          exitIntroPresentation();
          awaitingLandscapeBeforePlayback = false;
          introHasStartedPlaying = false;
          if (orientationActionButton) {
            orientationActionButton.disabled = false;
            setOrientationActionState('ready');
          }
          bodyEl.classList.remove('intro-active');
          markIntroAsSeen();
          if (!hasMainExperienceStarted) {
            startMainExperience();
          } else {
            if (shouldResumeThemeAfterIntro) {
              audioEl.muted = false;
              const resumePromise = audioEl.play();
              if (resumePromise && typeof resumePromise.then === 'function') {
                resumePromise
                  .then(() => {
                    audioPrompt.classList.remove('active');
                    updateAudioUI();
                  })
                  .catch(() => {
                    audioPrompt.classList.add('active');
                    audioEl.muted = true;
                    updateAudioUI();
                  });
              } else {
                audioPrompt.classList.remove('active');
                updateAudioUI();
              }
            } else {
              updateAudioUI();
            }
          }
          shouldResumeThemeAfterIntro = false;
        };

        const startIntroPlayback = () => {
          if (!introOverlay || !introVideo) {
            startMainExperience();
            return null;
          }
          if (introHasStartedPlaying) {
            return introVideo.paused ? introVideo.play() : null;
          }
          introHasStartedPlaying = true;
          introCountdownId = null;
          awaitingLandscapeBeforePlayback = false;
          introOverlay.classList.add('is-playing');
          orientationWarning?.setAttribute('aria-hidden', 'true');
          if (orientationActionButton) {
            orientationActionButton.disabled = true;
          }
          introVideo.currentTime = 0;
          introVideo.muted = false;
          clearIntroAudioPrompt();
          requestIntroFullscreen({ fromGesture: false }).catch(() => {});
          lockOrientationLandscape({ fromGesture: false }).catch(() => {});
          const playPromise = introVideo.play();
          if (playPromise && typeof playPromise.then === 'function') {
            playPromise
              .then(() => {
                clearIntroAudioPrompt();
                setOrientationActionState('done');
                if (orientationActionButton) {
                  orientationActionButton.disabled = true;
                }
              })
              .catch((error) => {
                console.warn('Intro video autoplay with sound failed', error);
                introVideo.muted = true;
                if (orientationActionButton) {
                  orientationActionButton.disabled = false;
                  setOrientationActionState('ready');
                }
                requestIntroAudioGesture();
                const mutedAttempt = introVideo.play();
                if (mutedAttempt && typeof mutedAttempt.then === 'function') {
                  mutedAttempt.catch((mutedError) => {
                    console.warn('Intro video muted autoplay failed', mutedError);
                    finishIntro();
                  });
                }
              });
            return playPromise;
          }
          setOrientationActionState('done');
          return null;
        };

        const showIntroOverlay = async () => {
          if (!introOverlay || !introVideo) {
            startMainExperience();
            return;
          }
          introActive = true;
          introHasStartedPlaying = false;
          awaitingLandscapeBeforePlayback = false;
          cancelIntroCountdown();
          shouldResumeThemeAfterIntro = !audioEl.paused && !audioEl.muted;
          if (!audioEl.paused) {
            audioEl.pause();
          }
          clearIntroAudioPrompt();
          introOverlay.classList.remove('is-finished');
          introOverlay.classList.remove('is-playing');
          introOverlay.classList.add('is-active');
          introOverlay.setAttribute('aria-hidden', 'false');
          bodyEl.classList.add('intro-active');
          orientationWarning?.setAttribute('aria-hidden', 'false');
          if (skipIntroLabel) {
            skipIntroLabel.textContent = 'Skip Intro';
          }
          if (skipIntroButton) {
            skipIntroButton.classList.remove('skip-toggle--active');
            skipIntroButton.disabled = false;
          }
          if (orientationActionButton) {
            orientationActionButton.disabled = false;
            setOrientationActionState('ready');
          }
          introVideo.pause();
          introVideo.currentTime = 0;
          introVideo.muted = false;

          const schedulePlayback = (delay = 800) => {
            cancelIntroCountdown();
            introCountdownId = window.setTimeout(() => {
              setOrientationActionState('working');
              const playbackPromise = startIntroPlayback();
              if (playbackPromise && typeof playbackPromise.then === 'function') {
                playbackPromise.catch(() => {});
              }
            }, delay);
          };

          const landscapeNow = isLandscapeOrientation();
          if (!isMobileDevice || landscapeNow) {
            schedulePlayback(1200);
          } else {
            awaitingLandscapeBeforePlayback = true;
          }

          await requestIntroFullscreen({ fromGesture: false });
          const locked = await lockOrientationLandscape({ fromGesture: false });
          if ((locked || isLandscapeOrientation()) && awaitingLandscapeBeforePlayback) {
            awaitingLandscapeBeforePlayback = false;
            schedulePlayback(600);
          } else if (awaitingLandscapeBeforePlayback) {
            setOrientationActionState('ready');
          }
        };

        const handleOrientationUpdate = () => {
          if (!introActive) {
            return;
          }

          if (isLandscapeOrientation()) {
            if (awaitingLandscapeBeforePlayback && !introHasStartedPlaying) {
              awaitingLandscapeBeforePlayback = false;
              setOrientationActionState('working');
              const playbackPromise = startIntroPlayback();
              if (playbackPromise && typeof playbackPromise.then === 'function') {
                playbackPromise.catch(() => {});
              }
            }
          } else if (!introHasStartedPlaying && orientationActionButton) {
            orientationActionButton.disabled = false;
            setOrientationActionState('ready');
          }
        };

        window.addEventListener('orientationchange', handleOrientationUpdate);
        window.addEventListener('resize', handleOrientationUpdate);

        audioToggle.addEventListener('click', (event) => {
          event.preventDefault();
          event.stopPropagation();

          if (audioEl.paused) {
            tryPlayAudio();
            return;
          }

          if (!audioEl.muted) {
            audioEl.muted = true;
            audioPrompt.classList.remove('active');
            updateAudioUI();
            return;
          }

          audioEl.muted = false;
          const resumePromise = audioEl.play();
          if (resumePromise && typeof resumePromise.then === 'function') {
            resumePromise
              .then(() => {
                audioPrompt.classList.remove('active');
                updateAudioUI();
              })
              .catch(() => {
                audioEl.muted = true;
                audioPrompt.classList.add('active');
                updateAudioUI();
              });
          } else {
            updateAudioUI();
          }
        });

        document.addEventListener('pointerdown', (event) => {
          const pointerTarget = event?.target || null;
          if (
            pointerTarget &&
            typeof pointerTarget.closest === 'function' &&
            pointerTarget.closest('[data-skip-intro]')
          ) {
            return;
          }

          if (introActive) {
            requestIntroFullscreen({ fromGesture: true });
            lockOrientationLandscape({ fromGesture: true });
          }

          if (introActive && introAwaitingUserAudio && introVideo) {
            introVideo.muted = false;
            const resumeIntro = introVideo.play();
            if (resumeIntro && typeof resumeIntro.then === 'function') {
              resumeIntro
                .then(() => {
                  clearIntroAudioPrompt();
                  setOrientationActionState('done');
                  if (orientationActionButton) {
                    orientationActionButton.disabled = true;
                  }
                })
                .catch((error) => {
                  console.warn('Unable to resume intro audio from gesture', error);
                  if (orientationActionButton) {
                    orientationActionButton.disabled = false;
                    setOrientationActionState('ready');
                  }
                });
            } else {
              clearIntroAudioPrompt();
              setOrientationActionState('done');
              if (orientationActionButton) {
                orientationActionButton.disabled = true;
              }
            }
          }

          if (!hasMainExperienceStarted || introActive) {
            return;
          }
          ensureBgVideoPlaying();
          if (audioEl.paused) {
            tryPlayAudio();
          } else if (audioEl.muted) {
            audioEl.muted = false;
            audioEl
              .play()
              .then(() => {
                audioPrompt.classList.remove('active');
                updateAudioUI();
              })
              .catch(() => {
                audioEl.muted = true;
                audioPrompt.classList.add('active');
                updateAudioUI();
              });
          }
        });

        document.addEventListener('visibilitychange', () => {
          if (!hasMainExperienceStarted) {
            return;
          }
          if (document.visibilityState === 'visible') {
            ensureBgVideoPlaying();
            if (!audioEl.paused && audioEl.muted) {
              audioEl.muted = false;
              audioEl.play().catch(() => {
                audioEl.muted = true;
              });
              updateAudioUI();
            }
          }
        });

        if (skipIntroButton) {
          skipIntroButton.addEventListener('click', () => {
            if (skipIntroLabel) {
              skipIntroLabel.textContent = 'Skipping...';
            }
            skipIntroButton.classList.add('skip-toggle--active');
            finishIntro();
          });
        }

        if (introVideo) {
          introVideo.addEventListener('ended', () => {
            finishIntro();
          });
          introVideo.addEventListener('error', () => {
            console.warn('Intro video failed to play', introVideo.error);
            finishIntro();
          });
          introVideo.addEventListener('webkitendfullscreen', () => {
            if (introActive) {
              finishIntro();
            } else {
              exitIntroPresentation();
            }
          });
        }

        const hasSeenIntro = (() => {
          try {
            return sessionStorage.getItem(INTRO_STORAGE_KEY) === 'true';
          } catch (error) {
            console.warn('Unable to read intro trailer state', error);
            return false;
          }
        })();

        if (introOverlay && introVideo && !hasSeenIntro) {
          showIntroOverlay();
        } else {
          if (introOverlay) {
            clearIntroAudioPrompt();
            introOverlay.classList.add('is-finished');
            introOverlay.classList.remove('is-active', 'is-playing', 'needs-user-audio');
            introOverlay.setAttribute('aria-hidden', 'true');
            orientationWarning?.setAttribute('aria-hidden', 'true');
          }
          startMainExperience();
        }
      })();
    </script>
  </body>
</html>
