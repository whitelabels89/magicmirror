<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex,nofollow,noarchive" />
  <title>Nai Nai Admin Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --espresso: #2b1b14;
      --caramel: #c98b2b;
      --cream: #fff2e3;
      --cinnamon: #9c5a3c;
      --red: #b3202e;
      --line: 1px solid rgba(43, 27, 20, 0.14);
      --radius-lg: 16px;
      --radius-md: 12px;
      --shadow: 0 12px 28px rgba(43, 27, 20, 0.12);
      --maxw: min(1200px, calc(100% - 2rem));
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      color: var(--espresso);
      background:
        radial-gradient(circle at 8% 8%, rgba(201, 139, 43, 0.18), transparent 35%),
        radial-gradient(circle at 90% 12%, rgba(179, 32, 46, 0.12), transparent 40%),
        linear-gradient(180deg, #fff9f1, #fff2e3);
      min-height: 100vh;
    }

    .container {
      width: var(--maxw);
      margin: 0 auto;
      padding: 1rem 0 2rem;
    }

    .topbar {
      border: var(--line);
      border-radius: var(--radius-lg);
      background: linear-gradient(145deg, rgba(43, 27, 20, 0.96), rgba(84, 45, 31, 0.95));
      box-shadow: 0 18px 38px rgba(43, 27, 20, 0.22);
      color: var(--cream);
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.8rem;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 0.7rem;
    }

    .brand img {
      width: 58px;
      height: 58px;
      object-fit: contain;
      border-radius: 12px;
      border: 1px solid rgba(255, 242, 227, 0.35);
      background: rgba(255, 242, 227, 0.08);
      padding: 0.3rem;
    }

    .brand h1 {
      margin: 0;
      font-family: "Noto Serif Display", serif;
      font-size: clamp(1.45rem, 2.4vw, 2rem);
      line-height: 1.2;
    }

    .brand p {
      margin: 0.22rem 0 0;
      font-size: 0.86rem;
      color: rgba(255, 242, 227, 0.86);
    }

    .top-actions {
      display: flex;
      gap: 0.55rem;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid transparent;
      text-decoration: none;
      cursor: pointer;
      font-size: 0.84rem;
      font-weight: 600;
      padding: 0.55rem 0.95rem;
      transition: transform 220ms ease, box-shadow 220ms ease, background 220ms ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-family: "Inter", sans-serif;
    }

    .btn:hover { transform: translateY(-2px); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .btn-main {
      background: var(--caramel);
      color: #2f1b10;
      box-shadow: 0 8px 18px rgba(201, 139, 43, 0.34);
    }

    .btn-soft {
      background: #fff7eb;
      border-color: rgba(43, 27, 20, 0.2);
      color: #4b2e21;
    }

    .btn-dark {
      background: rgba(255, 242, 227, 0.1);
      color: var(--cream);
      border-color: rgba(255, 242, 227, 0.35);
    }

    .panel {
      border: var(--line);
      border-radius: var(--radius-lg);
      background: rgba(255, 242, 227, 0.82);
      box-shadow: var(--shadow);
      padding: 0.95rem;
    }

    .panel h2 {
      margin: 0;
      font-family: "Noto Serif Display", serif;
      font-size: 1.38rem;
      line-height: 1.2;
      color: #3a2217;
    }

    .panel h3 {
      margin: 0;
      font-size: 1.03rem;
      color: #4a2b1f;
    }

    .panel p.muted {
      margin: 0.45rem 0 0;
      color: rgba(43, 27, 20, 0.76);
      font-size: 0.89rem;
      line-height: 1.56;
    }

    #auth-panel {
      margin-top: 1rem;
      max-width: 680px;
    }

    .auth-layout {
      margin-top: 0.75rem;
      display: grid;
      gap: 0.85rem;
    }

    .auth-box {
      border: var(--line);
      border-radius: var(--radius-md);
      background: #fff9f2;
      padding: 0.8rem;
      display: none;
    }

    .auth-box.show { display: block; }

    .field label {
      display: block;
      margin-bottom: 0.18rem;
      font-size: 0.76rem;
      color: rgba(43, 27, 20, 0.76);
    }

    .field input,
    .field select,
    .field textarea {
      width: 100%;
      border: 1px solid rgba(43, 27, 20, 0.18);
      border-radius: 9px;
      background: #fffdf9;
      color: #2b1b14;
      padding: 0.5rem 0.56rem;
      font-size: 0.84rem;
      font-family: "Inter", sans-serif;
      outline: none;
    }

    .field textarea {
      min-height: 84px;
      resize: vertical;
    }

    .auth-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.55rem;
      margin-top: 0.6rem;
    }

    .status-line {
      margin-top: 0.52rem;
      font-size: 0.8rem;
      min-height: 1em;
      color: rgba(43, 27, 20, 0.8);
    }

    .status-line.error { color: #9f2430; }
    .status-line.success { color: #1e6f36; }

    #dashboard-root {
      display: none;
      margin-top: 1rem;
    }

    .stats {
      margin-top: 0.8rem;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 0.56rem;
    }

    .stat {
      border: 1px solid rgba(43, 27, 20, 0.16);
      border-radius: 12px;
      background: #fff9f1;
      padding: 0.58rem;
    }

    .stat-label {
      font-size: 0.76rem;
      color: rgba(43, 27, 20, 0.72);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin: 0;
    }

    .stat-value {
      margin: 0.22rem 0 0;
      font-size: 1.22rem;
      font-weight: 700;
      color: #3c2418;
    }

    .filters {
      margin-top: 0.8rem;
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 0.5rem;
      align-items: end;
    }

    .table-wrap {
      margin-top: 0.8rem;
      border: var(--line);
      border-radius: 12px;
      overflow: auto;
      background: #fffdf9;
      max-height: 480px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 920px;
    }

    th,
    td {
      padding: 0.5rem 0.56rem;
      border-bottom: 1px solid rgba(43, 27, 20, 0.08);
      text-align: left;
      vertical-align: top;
      font-size: 0.8rem;
    }

    th {
      position: sticky;
      top: 0;
      z-index: 1;
      background: #f9efe1;
      color: #3e2519;
      font-size: 0.74rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      border: 1px solid rgba(43, 27, 20, 0.16);
      border-radius: 999px;
      padding: 0.14rem 0.44rem;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      background: #fff;
      color: #4a2b1f;
    }

    .chip.order { background: rgba(201, 139, 43, 0.2); }
    .chip.event { background: rgba(179, 32, 46, 0.14); }

    .status-new { color: #8b4d2d; }
    .status-in_progress { color: #805f00; }
    .status-done { color: #1d6a2f; }
    .status-cancelled { color: #8f2b34; }

    .inline-actions {
      display: grid;
      gap: 0.3rem;
      min-width: 190px;
    }

    .inline-actions .btn {
      font-size: 0.74rem;
      padding: 0.34rem 0.54rem;
      border-radius: 8px;
    }

    .grid {
      margin-top: 1rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .config-form,
    .pin-form {
      margin-top: 0.82rem;
      display: grid;
      gap: 0.55rem;
    }

    .asset-upload {
      margin-top: 0.8rem;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.56rem;
      align-items: end;
    }

    .asset-grid {
      margin-top: 0.86rem;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 0.56rem;
    }

    .asset-card {
      border: 1px solid rgba(43, 27, 20, 0.15);
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
    }

    .asset-card img {
      width: 100%;
      height: 94px;
      object-fit: cover;
      display: block;
      background: #f4ead8;
    }

    .asset-meta {
      padding: 0.36rem 0.46rem 0.48rem;
      font-size: 0.71rem;
      color: rgba(43, 27, 20, 0.72);
      line-height: 1.45;
      word-break: break-word;
    }

    .asset-actions {
      margin-top: 0.42rem;
      display: flex;
      gap: 0.36rem;
      flex-wrap: wrap;
    }

    .btn-danger {
      background: rgba(179, 32, 46, 0.12);
      border-color: rgba(179, 32, 46, 0.3);
      color: #8f2330;
    }

    .link-tools {
      margin-top: 1rem;
      border: var(--line);
      border-radius: var(--radius-md);
      background: #fff9f2;
      padding: 0.75rem;
      display: grid;
      gap: 0.56rem;
    }

    .link-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .qr-preview-wrap {
      border: 1px solid rgba(43, 27, 20, 0.14);
      border-radius: 10px;
      background: #fff;
      padding: 0.5rem;
      width: min(220px, 100%);
      aspect-ratio: 1 / 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .qr-preview-wrap img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: none;
    }

    .qr-preview-note {
      margin: 0;
      font-size: 0.72rem;
      color: rgba(43, 27, 20, 0.68);
      text-align: center;
    }

    .invoice-layout {
      margin-top: 0.85rem;
      display: grid;
      gap: 0.75rem;
    }

    .invoice-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.55rem;
    }

    .invoice-items-wrap {
      border: 1px solid rgba(43, 27, 20, 0.16);
      border-radius: 10px;
      background: #fffdf9;
      padding: 0.6rem;
    }

    .invoice-items {
      display: grid;
      gap: 0.5rem;
    }

    .invoice-item-row {
      border: 1px solid rgba(43, 27, 20, 0.14);
      border-radius: 10px;
      background: #fff7ea;
      padding: 0.5rem;
      display: grid;
      gap: 0.45rem;
    }

    .invoice-item-grid {
      display: grid;
      grid-template-columns: 1.1fr 0.85fr 0.4fr 0.7fr 0.8fr auto;
      gap: 0.4rem;
      align-items: end;
    }

    .inv-item-subtotal[readonly] {
      background: #f7eee3;
      font-weight: 700;
      color: #2f1f17;
    }

    .invoice-item-note {
      display: grid;
      grid-template-columns: 1fr;
    }

    .invoice-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .invoice-result-card {
      border: 1px solid rgba(43, 27, 20, 0.16);
      border-radius: 12px;
      background: linear-gradient(145deg, #fff9f0, #fff2e3);
      padding: 0.7rem;
      display: grid;
      gap: 0.45rem;
    }

    .invoice-result-card p {
      margin: 0;
      font-size: 0.82rem;
      color: rgba(43, 27, 20, 0.84);
      line-height: 1.5;
    }

    .invoice-history-wrap {
      margin-top: 0.65rem;
      border: 1px solid rgba(43, 27, 20, 0.16);
      border-radius: 10px;
      overflow: auto;
      background: #fffdf9;
    }

    .invoice-history-wrap table {
      min-width: 760px;
    }

    .invoice-history-actions {
      display: flex;
      gap: 0.35rem;
      flex-wrap: wrap;
    }

    @media (max-width: 1020px) {
      .grid { grid-template-columns: 1fr; }
      .stats { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .filters { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .asset-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
      .auth-grid { grid-template-columns: 1fr; }
      .invoice-grid { grid-template-columns: 1fr; }
      .invoice-item-grid { grid-template-columns: 1fr 1fr; }
    }

    @media (max-width: 640px) {
      .container { width: min(1200px, calc(100% - 1rem)); }
      .topbar { padding: 0.8rem; }
      .asset-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .asset-upload { grid-template-columns: 1fr; }
      .invoice-item-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="container">
    <header class="topbar">
      <div class="brand">
        <img src="./logonainai.png" alt="Logo Nai Nai Lapis" />
        <div>
          <h1>Nai Nai Admin Dashboard</h1>
          <p>Edit konten landing page, upload asset, monitor order + klik customer.</p>
        </div>
      </div>
      <div class="top-actions">
        <a class="btn btn-dark" href="/products/class/cake-bakery-class/nai-nai-lapis.html" target="_blank" rel="noopener noreferrer">Buka Landing Page</a>
        <button class="btn btn-main" id="refresh-all" type="button" disabled>Refresh Data</button>
        <button class="btn btn-dark" id="logout-btn" type="button" style="display:none;">Logout</button>
      </div>
    </header>

    <section class="panel" id="auth-panel">
      <h2 id="auth-title">Autentikasi Admin PIN</h2>
      <p class="muted" id="auth-desc">Sistem mengecek apakah PIN admin sudah pernah diaktifkan.</p>

      <div class="auth-layout">
        <div class="auth-box" id="setup-box">
          <h3>Aktivasi PIN Pertama Kali</h3>
          <p class="muted" style="margin-top:0.35rem;">Buat PIN 4-8 digit angka. Simpan baik-baik karena PIN ini dipakai untuk login dashboard.</p>
          <form id="setup-form" class="auth-grid">
            <div class="field">
              <label for="setup-pin">PIN Baru</label>
              <input id="setup-pin" type="password" inputmode="numeric" placeholder="Contoh: 1234" required />
            </div>
            <div class="field">
              <label for="setup-pin-confirm">Konfirmasi PIN</label>
              <input id="setup-pin-confirm" type="password" inputmode="numeric" placeholder="Ulangi PIN" required />
            </div>
            <div style="grid-column:1 / -1; display:flex; gap:0.55rem; flex-wrap:wrap;">
              <button class="btn btn-main" type="submit">Aktifkan PIN</button>
            </div>
          </form>
        </div>

        <div class="auth-box" id="login-box">
          <h3>Login Admin</h3>
          <p class="muted" style="margin-top:0.35rem;">Masukkan PIN admin untuk membuka dashboard.</p>
          <form id="login-form" class="auth-grid">
            <div class="field" style="grid-column:1 / -1; max-width:320px;">
              <label for="login-pin">PIN</label>
              <input id="login-pin" type="password" inputmode="numeric" placeholder="Masukkan PIN" required />
            </div>
            <div style="grid-column:1 / -1; display:flex; gap:0.55rem; flex-wrap:wrap;">
              <button class="btn btn-main" type="submit">Login</button>
            </div>
          </form>
        </div>

        <p class="status-line" id="auth-status"></p>
      </div>
    </section>

    <section id="dashboard-root">
      <section class="panel">
        <h2>Monitoring Lead & Order</h2>
        <p class="muted">Data memuat event klik CTA dan submit form order dari customer.</p>

        <div class="stats">
          <article class="stat">
            <p class="stat-label">Total Data</p>
            <p class="stat-value" id="stat-total">0</p>
          </article>
          <article class="stat">
            <p class="stat-label">Order</p>
            <p class="stat-value" id="stat-order">0</p>
          </article>
          <article class="stat">
            <p class="stat-label">Event Click</p>
            <p class="stat-value" id="stat-event">0</p>
          </article>
          <article class="stat">
            <p class="stat-label">Status New</p>
            <p class="stat-value" id="stat-new">0</p>
          </article>
        </div>

        <div class="filters">
          <div class="field">
            <label for="filter-kind">Jenis</label>
            <select id="filter-kind">
              <option value="">Semua</option>
              <option value="order">Order</option>
              <option value="event">Event Click</option>
            </select>
          </div>
          <div class="field">
            <label for="filter-status">Status</label>
            <select id="filter-status">
              <option value="">Semua</option>
              <option value="new">new</option>
              <option value="in_progress">in_progress</option>
              <option value="done">done</option>
              <option value="cancelled">cancelled</option>
            </select>
          </div>
          <div class="field">
            <label for="filter-limit">Limit</label>
            <select id="filter-limit">
              <option value="100">100</option>
              <option value="200" selected>200</option>
              <option value="500">500</option>
              <option value="1000">1000</option>
            </select>
          </div>
          <div class="field">
            <label for="filter-q">Cari</label>
            <input id="filter-q" type="text" placeholder="Nama / produk / label" />
          </div>
          <div class="field">
            <button class="btn btn-main" id="apply-filter" type="button" style="width:100%;">Terapkan Filter</button>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Waktu</th>
                <th>Jenis</th>
                <th>Nama / Label</th>
                <th>Produk</th>
                <th>WA</th>
                <th>Catatan</th>
                <th>Status</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="orders-body">
              <tr><td colspan="8">Loading data...</td></tr>
            </tbody>
          </table>
        </div>
        <p class="status-line" id="orders-status"></p>
      </section>

      <div class="grid">
        <section class="panel">
          <h2>Kontrol Konten Landing Page</h2>
          <p class="muted">Perubahan di sini otomatis dipakai di `nai-nai-lapis.html`.</p>

          <form class="config-form" id="config-form">
            <div class="field">
              <label for="cfg-title">Hero Title</label>
              <input id="cfg-title" name="heroTitle" type="text" required />
            </div>
            <div class="field">
              <label for="cfg-subtitle">Hero Subtitle</label>
              <textarea id="cfg-subtitle" name="heroSubtitle" required></textarea>
            </div>
            <div class="field">
              <label for="cfg-announcement">Announcement</label>
              <input id="cfg-announcement" name="announcement" type="text" />
            </div>
            <div class="field">
              <label for="cfg-wa">WhatsApp Admin (08.. / 62..)</label>
              <input id="cfg-wa" name="adminWhatsapp" type="text" />
            </div>
            <div class="field">
              <label for="cfg-sizes">Ukuran Lapis (pisahkan koma)</label>
              <input id="cfg-sizes" name="lapisSizes" type="text" placeholder="10 x 10, 10 x 20, 20 x 20" />
            </div>
            <div class="field">
              <label for="cfg-seasonal">Label Seasonal</label>
              <input id="cfg-seasonal" name="seasonalLabel" type="text" />
            </div>
            <button class="btn btn-main" type="submit">Simpan Konten</button>
          </form>
          <p class="status-line" id="config-status"></p>

          <div class="link-tools">
            <h3>QR Code & Shortlink</h3>
            <p class="muted" style="margin-top:0;">Generate shortlink + QR untuk landing page, lalu kirim hasilnya ke WhatsApp admin.</p>

            <div class="field">
              <label for="qr-target-link">Link Target</label>
              <input
                id="qr-target-link"
                type="url"
                value="https://queensacademy.id/products/class/cake-bakery-class/nai-nai-lapis.html#cake-bakery-class"
                placeholder="https://..."
                required
              />
            </div>

            <div class="field">
              <label for="shortlink-code">Custom Buntut Shortlink (opsional)</label>
              <input id="shortlink-code" type="text" placeholder="contoh: nainai-lapis" maxlength="32" />
              <p class="muted" style="margin-top:0.25rem;">Format: 4-32 karakter, pakai huruf kecil/angka/tanda minus.</p>
            </div>

            <div class="field">
              <label for="shortlink-output">Shortlink Hasil</label>
              <input id="shortlink-output" type="text" placeholder="Belum digenerate" readonly />
            </div>

            <div class="link-actions">
              <button class="btn btn-main" id="generate-shortlink-btn" type="button">Generate Shortlink</button>
              <button class="btn btn-soft" id="generate-qr-btn" type="button">Generate QR</button>
              <button class="btn btn-soft" id="send-qr-wa-btn" type="button">Kirim ke WhatsApp Admin</button>
              <a class="btn btn-soft" id="download-qr-btn" href="#" target="_blank" rel="noopener noreferrer">Buka / Download QR</a>
            </div>

            <div class="qr-preview-wrap">
              <img id="qr-preview-img" alt="Preview QR Code Nai Nai Lapis" />
              <p class="qr-preview-note" id="qr-preview-note">Preview QR akan muncul di sini.</p>
            </div>

            <p class="status-line" id="qr-status"></p>
          </div>
        </section>

        <section class="panel">
          <h2>Upload Asset Gambar</h2>
          <p class="muted">Upload file PNG/JPG/JPEG/WEBP max 8MB ke folder `cake-bakery-class`. Jika nama file sama, otomatis replace.</p>

          <form id="upload-form" class="asset-upload">
            <div class="field">
              <label for="asset-file">Pilih file</label>
              <input id="asset-file" name="asset" type="file" accept=".png,.jpg,.jpeg,.webp" required />
            </div>
            <button class="btn btn-main" type="submit">Upload</button>
          </form>
          <p class="status-line" id="upload-status"></p>

          <h3 style="margin-top:0.95rem;">Daftar Asset</h3>
          <div class="asset-grid" id="asset-grid"></div>
        </section>
      </div>

      <section class="panel" style="margin-top:1rem;">
        <h2>Generate Invoice Digital</h2>
        <p class="muted">Buat invoice PDF yang siap dikirim ke customer lewat WhatsApp, lengkap dengan ucapan terima kasih.</p>
        <p class="muted" id="invoice-form-mode">Mode: Buat invoice baru.</p>

        <form id="invoice-form" class="invoice-layout">
          <div class="invoice-grid">
            <div class="field">
              <label for="inv-customer-name">Nama Customer</label>
              <input id="inv-customer-name" type="text" placeholder="Nama customer" required />
            </div>
            <div class="field">
              <label for="inv-customer-wa">WhatsApp Customer</label>
              <input id="inv-customer-wa" type="text" placeholder="08xxxxxxxxxx / 62xxxxxxxxxx" required />
            </div>
          </div>

          <div class="field">
            <label for="inv-customer-address">Alamat / Keterangan Customer</label>
            <textarea id="inv-customer-address" placeholder="Alamat kirim, nama kantor, atau detail customer lainnya"></textarea>
          </div>

          <div class="invoice-grid">
            <div class="field">
              <label for="inv-order-date">Tanggal Invoice</label>
              <input id="inv-order-date" type="date" required />
            </div>
            <div class="field">
              <label for="inv-due-date">Jatuh Tempo (opsional)</label>
              <input id="inv-due-date" type="date" />
            </div>
          </div>

          <div class="invoice-items-wrap">
            <h3>Item Produk</h3>
            <p class="muted" style="margin-top:0.3rem;">Isi item order customer. Kamu bisa tambahkan lebih dari satu item.</p>
            <div id="invoice-items" class="invoice-items"></div>
            <div class="invoice-actions" style="margin-top:0.55rem;">
              <button class="btn btn-soft" id="add-invoice-item" type="button">Tambah Item</button>
            </div>
          </div>

          <div class="invoice-grid">
            <div class="field">
              <label for="inv-discount">Diskon (Rp)</label>
              <input id="inv-discount" type="number" min="0" step="1000" value="0" />
            </div>
            <div class="field">
              <label for="inv-shipping">Ongkir / Biaya Tambahan (Rp)</label>
              <input id="inv-shipping" type="number" min="0" step="1000" value="0" />
            </div>
          </div>

          <div class="field">
            <label for="inv-notes">Catatan Invoice (opsional)</label>
            <textarea id="inv-notes" placeholder="Contoh: Delivery tanggal 18.00, mohon konfirmasi sebelum kirim"></textarea>
          </div>

          <p class="muted" id="invoice-total-preview">Estimasi Total: Rp 0</p>

          <div class="invoice-actions">
            <button class="btn btn-main" id="invoice-submit-btn" type="submit">Generate Invoice PDF + Kirim WhatsApp</button>
            <button class="btn btn-soft" id="invoice-cancel-edit-btn" type="button" style="display:none;">Batal Edit</button>
          </div>
        </form>
        <p class="status-line" id="invoice-status"></p>
        <div id="invoice-result"></div>

        <h3 style="margin-top:1rem;">Riwayat Invoice</h3>
        <div class="invoice-history-wrap">
          <table>
            <thead>
              <tr>
                <th>Tanggal</th>
                <th>No Invoice</th>
                <th>Customer</th>
                <th>WA</th>
                <th>Total</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="invoice-history-body">
              <tr><td colspan="6">Belum ada invoice.</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="panel" style="margin-top:1rem;">
        <h2>Keamanan PIN Admin</h2>
        <p class="muted">Gunakan form ini untuk mengganti PIN. Setelah ganti PIN, sesi lama otomatis diganti dengan sesi baru.</p>

        <form class="pin-form" id="change-pin-form">
          <div class="field">
            <label for="old-pin">PIN Lama</label>
            <input id="old-pin" type="password" inputmode="numeric" placeholder="PIN saat ini" required />
          </div>
          <div class="field">
            <label for="new-pin">PIN Baru</label>
            <input id="new-pin" type="password" inputmode="numeric" placeholder="PIN baru (4-8 digit)" required />
          </div>
          <div class="field">
            <label for="new-pin-confirm">Konfirmasi PIN Baru</label>
            <input id="new-pin-confirm" type="password" inputmode="numeric" placeholder="Ulangi PIN baru" required />
          </div>
          <button class="btn btn-main" type="submit">Ganti PIN</button>
        </form>
        <p class="status-line" id="pin-status"></p>
      </section>
    </section>
  </main>

  <script>
    var API_BASE = "/api/nainai";
    var AUTH_BASE = "/api/nainai/admin/auth";
    var TOKEN_STORAGE_KEY = "nainai_admin_token_v1";
    var DEFAULT_QR_TARGET = "https://queensacademy.id/products/class/cake-bakery-class/nai-nai-lapis.html#cake-bakery-class";
    var adminToken = localStorage.getItem(TOKEN_STORAGE_KEY) || "";

    function setToken(token) {
      adminToken = String(token || "").trim();
      if (adminToken) {
        localStorage.setItem(TOKEN_STORAGE_KEY, adminToken);
      } else {
        localStorage.removeItem(TOKEN_STORAGE_KEY);
      }
    }

    function escapeHtml(text) {
      return String(text || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function formatDate(iso) {
      if (!iso) return "-";
      var d = new Date(iso);
      if (Number.isNaN(d.getTime())) return "-";
      return d.toLocaleString("id-ID");
    }

    function setLine(id, message, type) {
      var el = document.getElementById(id);
      if (!el) return;
      el.classList.remove("error", "success");
      if (type) el.classList.add(type);
      el.textContent = message || "";
    }

    function normalizeTo62(rawPhone) {
      var value = String(rawPhone || "").replace(/[^0-9+]/g, "").trim();
      if (!value) return "";
      if (value.indexOf("+") === 0) value = value.slice(1);
      if (value.indexOf("08") === 0) value = "62" + value.slice(1);
      else if (value.indexOf("8") === 0) value = "62" + value;
      else if (value.indexOf("62") !== 0) value = "62" + value;
      return value;
    }

    function sanitizeHttpUrl(rawValue) {
      var value = String(rawValue || "").trim();
      if (!value) return "";
      try {
        var parsed = new URL(value);
        if (parsed.protocol !== "http:" && parsed.protocol !== "https:") return "";
        return parsed.toString();
      } catch (_) {
        return "";
      }
    }

    function buildQrImageUrl(targetLink) {
      return "https://api.qrserver.com/v1/create-qr-code/?size=900x900&margin=12&format=png&data=" + encodeURIComponent(targetLink);
    }

    function formatRupiah(value) {
      var numeric = Number(value);
      if (!Number.isFinite(numeric) || numeric < 0) numeric = 0;
      return "Rp " + Math.round(numeric).toLocaleString("id-ID");
    }

    function parseMoney(value) {
      var numeric = Number(value);
      if (!Number.isFinite(numeric) || numeric < 0) return 0;
      return Math.round(numeric);
    }

    function toAbsoluteHttpUrl(rawValue) {
      var value = String(rawValue || "").trim();
      if (!value) return "";
      try {
        return new URL(value, window.location.origin).toString();
      } catch (_) {
        return "";
      }
    }

    function authFetch(url, options) {
      var opts = options || {};
      var headers = Object.assign({}, opts.headers || {});
      if (adminToken) headers["x-nainai-admin-token"] = adminToken;
      opts.headers = headers;
      return fetch(url, opts);
    }

    function apiJson(url, options) {
      return authFetch(url, options).then(function (res) {
        return res.json().catch(function () { return {}; }).then(function (payload) {
          if (!res.ok) {
            var err = new Error(payload && payload.error ? payload.error : ("HTTP " + res.status));
            err.status = res.status;
            err.payload = payload;
            throw err;
          }
          return payload;
        });
      });
    }

    function handleUnauthorized(error, message) {
      if (error && error.status === 401) {
        setToken("");
        showAuthMode("login", message || "Sesi habis. Silakan login ulang.");
        return true;
      }
      return false;
    }

    function showAuthMode(mode, message) {
      var setupBox = document.getElementById("setup-box");
      var loginBox = document.getElementById("login-box");
      var authPanel = document.getElementById("auth-panel");
      var dashboard = document.getElementById("dashboard-root");
      var refreshBtn = document.getElementById("refresh-all");
      var logoutBtn = document.getElementById("logout-btn");
      var authTitle = document.getElementById("auth-title");
      var authDesc = document.getElementById("auth-desc");

      authPanel.style.display = "block";
      dashboard.style.display = "none";
      refreshBtn.disabled = true;
      logoutBtn.style.display = "none";

      setupBox.classList.remove("show");
      loginBox.classList.remove("show");

      if (mode === "setup") {
        authTitle.textContent = "Aktivasi PIN Admin";
        authDesc.textContent = "Belum ada PIN admin. Lakukan aktivasi PIN pertama kali.";
        setupBox.classList.add("show");
      } else {
        authTitle.textContent = "Login Admin PIN";
        authDesc.textContent = "PIN sudah aktif. Silakan login untuk mengakses dashboard.";
        loginBox.classList.add("show");
      }

      setLine("auth-status", message || "", message ? "success" : "");
    }

    function openDashboard(message) {
      document.getElementById("auth-panel").style.display = "none";
      document.getElementById("dashboard-root").style.display = "block";
      document.getElementById("refresh-all").disabled = false;
      document.getElementById("logout-btn").style.display = "inline-flex";
      if (message) setLine("orders-status", message, "success");
      loadAll();
    }

    function getAuthState() {
      return fetch(AUTH_BASE + "/state")
        .then(function (res) { return res.json(); })
        .then(function (payload) {
          if (!payload || !payload.ok) throw new Error("Gagal cek status auth");
          return payload;
        });
    }

    function verifyExistingSession() {
      if (!adminToken) return Promise.resolve(false);
      return apiJson(AUTH_BASE + "/me")
        .then(function () { return true; })
        .catch(function () {
          setToken("");
          return false;
        });
    }

    function initAuthFlow() {
      getAuthState()
        .then(function (state) {
          return verifyExistingSession().then(function (validSession) {
            if (validSession && state.initialized) {
              openDashboard();
              return;
            }
            if (!state.initialized) {
              showAuthMode("setup");
            } else {
              showAuthMode("login");
            }
          });
        })
        .catch(function (err) {
          showAuthMode("login", "Gagal memuat status autentikasi: " + (err.message || "unknown"));
        });
    }

    function doBootstrap(pin, confirmPin) {
      return apiJson(AUTH_BASE + "/bootstrap", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pin: pin, confirmPin: confirmPin })
      });
    }

    function doLogin(pin) {
      return apiJson(AUTH_BASE + "/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pin: pin })
      });
    }

    function doLogout() {
      return apiJson(AUTH_BASE + "/logout", { method: "POST" });
    }

    function doChangePin(oldPin, newPin, confirmPin) {
      return apiJson(AUTH_BASE + "/change-pin", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ oldPin: oldPin, newPin: newPin, confirmPin: confirmPin })
      });
    }

    function statusClass(status) {
      var normalized = String(status || "").toLowerCase();
      if (normalized === "in_progress") return "status-in_progress";
      if (normalized === "done") return "status-done";
      if (normalized === "cancelled") return "status-cancelled";
      return "status-new";
    }

    function renderStats(rows) {
      var total = rows.length;
      var order = rows.filter(function (row) { return row.kind === "order"; }).length;
      var eventCount = rows.filter(function (row) { return row.kind === "event"; }).length;
      var statusNew = rows.filter(function (row) { return String(row.status || "new") === "new"; }).length;

      document.getElementById("stat-total").textContent = String(total);
      document.getElementById("stat-order").textContent = String(order);
      document.getElementById("stat-event").textContent = String(eventCount);
      document.getElementById("stat-new").textContent = String(statusNew);
    }

    function buildStatusOptions(selected) {
      var options = ["new", "in_progress", "done", "cancelled"];
      return options.map(function (opt) {
        var sel = opt === selected ? " selected" : "";
        return '<option value="' + opt + '"' + sel + '>' + opt + '</option>';
      }).join("");
    }

    function renderRows(rows) {
      var tbody = document.getElementById("orders-body");
      if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="8">Belum ada data.</td></tr>';
        return;
      }

      tbody.innerHTML = rows.map(function (row) {
        var id = escapeHtml(row.id || "");
        var kind = escapeHtml(row.kind || "event");
        var nameOrLabel = row.kind === "order" ? (row.name || "-") : (row.label || row.eventType || "-");
        var notes = row.kind === "order" ? (row.notes || "-") : (row.sourcePage || "-");

        return '' +
          '<tr>' +
            '<td>' + escapeHtml(formatDate(row.createdAt)) + '</td>' +
            '<td><span class="chip ' + kind + '">' + kind + '</span></td>' +
            '<td>' + escapeHtml(nameOrLabel) + '</td>' +
            '<td>' + escapeHtml(row.product || "-") + (row.size ? ('<br><small>' + escapeHtml(row.size) + '</small>') : '') + '</td>' +
            '<td>' + escapeHtml(row.whatsapp || "-") + '</td>' +
            '<td>' + escapeHtml(notes) + '</td>' +
            '<td class="' + statusClass(row.status) + '">' + escapeHtml(row.status || "new") + '</td>' +
            '<td>' +
              '<div class="inline-actions">' +
                '<select id="status-' + id + '">' + buildStatusOptions(row.status || "new") + '</select>' +
                '<input id="note-' + id + '" type="text" placeholder="catatan admin" value="' + escapeHtml(row.adminNote || "") + '" />' +
                '<button class="btn btn-main save-row" data-id="' + id + '">Simpan</button>' +
              '</div>' +
            '</td>' +
          '</tr>';
      }).join("");

      Array.prototype.slice.call(document.querySelectorAll(".save-row")).forEach(function (btn) {
        btn.addEventListener("click", function () {
          var id = btn.getAttribute("data-id");
          var status = document.getElementById("status-" + id).value;
          var note = document.getElementById("note-" + id).value;
          updateRow(id, status, note);
        });
      });
    }

    function getFilters() {
      return {
        kind: document.getElementById("filter-kind").value,
        status: document.getElementById("filter-status").value,
        limit: document.getElementById("filter-limit").value,
        q: document.getElementById("filter-q").value.trim()
      };
    }

    function buildQuery(params) {
      var pairs = [];
      Object.keys(params).forEach(function (key) {
        if (params[key]) pairs.push(encodeURIComponent(key) + "=" + encodeURIComponent(params[key]));
      });
      return pairs.length ? ("?" + pairs.join("&")) : "";
    }

    function loadOrders() {
      setLine("orders-status", "Memuat data...");
      return apiJson(API_BASE + "/orders" + buildQuery(getFilters()))
        .then(function (payload) {
          var rows = payload.data || [];
          renderStats(rows);
          renderRows(rows);
          setLine("orders-status", "Data ter-update: " + formatDate(new Date().toISOString()), "success");
        })
        .catch(function (err) {
          if (handleUnauthorized(err, "Sesi habis. Login ulang untuk melihat data order.")) return;
          setLine("orders-status", "Error: " + (err.message || "gagal load"), "error");
        });
    }

    function updateRow(id, status, adminNote) {
      setLine("orders-status", "Menyimpan status...");
      apiJson(API_BASE + "/orders/" + encodeURIComponent(id), {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: status, adminNote: adminNote })
      })
        .then(function () {
          setLine("orders-status", "Status berhasil disimpan.", "success");
          loadOrders();
        })
        .catch(function (err) {
          if (handleUnauthorized(err, "Sesi habis. Login ulang untuk update data.")) return;
          setLine("orders-status", "Error simpan status: " + (err.message || "unknown"), "error");
        });
    }

    function fillConfig(config) {
      document.getElementById("cfg-title").value = config.heroTitle || "";
      document.getElementById("cfg-subtitle").value = config.heroSubtitle || "";
      document.getElementById("cfg-announcement").value = config.announcement || "";
      document.getElementById("cfg-wa").value = config.adminWhatsapp || "";
      document.getElementById("cfg-sizes").value = Array.isArray(config.lapisSizes) ? config.lapisSizes.join(", ") : "";
      document.getElementById("cfg-seasonal").value = config.seasonalLabel || "";
    }

    function loadConfig() {
      return apiJson(API_BASE + "/config")
        .then(function (payload) {
          if (payload && payload.config) fillConfig(payload.config);
        })
        .catch(function (err) {
          if (!handleUnauthorized(err, "Sesi habis. Login ulang.")) {
            setLine("config-status", "Gagal memuat config: " + (err.message || "unknown"), "error");
          }
        });
    }

    function saveConfig(event) {
      event.preventDefault();
      setLine("config-status", "Menyimpan config...");

      var payload = {
        heroTitle: document.getElementById("cfg-title").value,
        heroSubtitle: document.getElementById("cfg-subtitle").value,
        announcement: document.getElementById("cfg-announcement").value,
        adminWhatsapp: document.getElementById("cfg-wa").value,
        lapisSizes: document.getElementById("cfg-sizes").value,
        seasonalLabel: document.getElementById("cfg-seasonal").value
      };

      apiJson(API_BASE + "/config", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
        .then(function (result) {
          fillConfig(result.config || {});
          setLine("config-status", "Config landing page berhasil disimpan.", "success");
        })
        .catch(function (err) {
          if (handleUnauthorized(err, "Sesi habis. Login ulang untuk simpan config.")) return;
          setLine("config-status", "Error simpan config: " + (err.message || "unknown"), "error");
        });
    }

    function getQrTargetLink() {
      var input = document.getElementById("qr-target-link");
      var parsed = sanitizeHttpUrl(input && input.value ? input.value : "");
      return parsed;
    }

    function getRequestedShortCode() {
      var input = document.getElementById("shortlink-code");
      var raw = String(input && input.value ? input.value : "").trim().toLowerCase();
      if (!raw) return "";

      var cleaned = raw
        .replace(/[^a-z0-9-]/g, "")
        .replace(/-+/g, "-")
        .replace(/^-|-$/g, "")
        .slice(0, 32);

      if (input && input.value !== cleaned) input.value = cleaned;
      return cleaned;
    }

    function getGeneratedShortlink() {
      var input = document.getElementById("shortlink-output");
      return sanitizeHttpUrl(input && input.value ? input.value : "");
    }

    function setQrPreview(targetLink) {
      var img = document.getElementById("qr-preview-img");
      var note = document.getElementById("qr-preview-note");
      var downloadBtn = document.getElementById("download-qr-btn");
      if (!img || !note || !downloadBtn) return;

      if (!targetLink) {
        img.removeAttribute("src");
        img.style.display = "none";
        note.style.display = "block";
        note.textContent = "Preview QR akan muncul di sini.";
        downloadBtn.href = "#";
        downloadBtn.setAttribute("aria-disabled", "true");
        return;
      }

      var qrUrl = buildQrImageUrl(targetLink);
      img.src = qrUrl;
      img.style.display = "block";
      note.style.display = "none";
      downloadBtn.href = qrUrl;
      downloadBtn.removeAttribute("aria-disabled");
    }

    function generateShortlink() {
      var targetLink = getQrTargetLink();
      if (!targetLink) {
        setLine("qr-status", "Link target tidak valid. Pastikan formatnya http/https.", "error");
        return;
      }

      var requestedCode = getRequestedShortCode();
      if (requestedCode && requestedCode.length < 4) {
        setLine("qr-status", "Custom buntut minimal 4 karakter.", "error");
        return;
      }

      setLine("qr-status", "Membuat shortlink...");
      var payload = { targetUrl: targetLink };
      if (requestedCode) payload.code = requestedCode;

      apiJson(API_BASE + "/shortlinks", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
        .then(function (result) {
          var shortUrl = sanitizeHttpUrl(result && result.shortlink ? result.shortlink.shortUrl : "");
          var generatedCode = result && result.shortlink ? String(result.shortlink.code || "") : "";
          if (!shortUrl) {
            setLine("qr-status", "Shortlink berhasil dibuat, tapi URL hasil tidak valid.", "error");
            return;
          }
          document.getElementById("shortlink-output").value = shortUrl;
          if (generatedCode) {
            var codeInput = document.getElementById("shortlink-code");
            if (codeInput) codeInput.value = generatedCode;
          }
          setQrPreview(shortUrl);
          setLine("qr-status", "Shortlink + QR berhasil digenerate.", "success");
        })
        .catch(function (err) {
          if (handleUnauthorized(err, "Sesi habis. Login ulang untuk generate shortlink.")) return;
          setLine("qr-status", "Gagal generate shortlink: " + (err.message || "unknown"), "error");
        });
    }

    function generateQrOnly() {
      var shareLink = getGeneratedShortlink() || getQrTargetLink();
      if (!shareLink) {
        setLine("qr-status", "Isi link target dulu sebelum generate QR.", "error");
        setQrPreview("");
        return;
      }
      setQrPreview(shareLink);
      setLine("qr-status", "QR berhasil diperbarui.", "success");
    }

    function sendQrToWhatsAppAdmin() {
      var targetLink = getQrTargetLink();
      var shortlink = getGeneratedShortlink();
      var shareLink = shortlink || targetLink;
      if (!shareLink) {
        setLine("qr-status", "Belum ada link valid untuk dikirim ke WhatsApp.", "error");
        return;
      }

      var waInput = document.getElementById("cfg-wa");
      var waNumber = normalizeTo62(waInput && waInput.value ? waInput.value : "") || "6288972681212";
      var qrLink = buildQrImageUrl(shareLink);
      var message = [
        "Halo Admin Nai Nai, ini hasil QR landing page.",
        "",
        "Link target:",
        targetLink || "-",
        "",
        "Shortlink:",
        shortlink || "(belum ada, pakai link target)",
        "",
        "Link QR code:",
        qrLink
      ].join("\n");

      var waUrl = "https://wa.me/" + encodeURIComponent(waNumber) + "?text=" + encodeURIComponent(message);
      window.open(waUrl, "_blank", "noopener,noreferrer");
      setLine("qr-status", "Membuka WhatsApp admin dengan link QR.", "success");
    }

    function todayYmd() {
      var now = new Date();
      var tzOffset = now.getTimezoneOffset() * 60000;
      return new Date(now.getTime() - tzOffset).toISOString().slice(0, 10);
    }

    var INVOICE_VARIANT_OPTIONS = {
      Lapis: [
        { value: "Original - 10 x 10", price: 125000 },
        { value: "Original - 10 x 20", price: 250000 },
        { value: "Original - 20 x 20", price: 450000 },
        { value: "Seasonal - 10 x 20", price: 300000 },
        { value: "Seasonal - 20 x 20", price: 550000 }
      ],
      Nastar: [
        { value: "1 toples", price: 110000 },
        { value: "2 toples", price: 200000 },
        { value: "4 toples", price: 425000 }
      ]
    };

    var INVOICE_PAYMENT_INFO = {
      transferBank: "BCA",
      transferAccount: "6600419186",
      transferName: "William Susanto",
      shopeeLink: "https://id.shp.ee/JzFf5AA"
    };
    var invoiceHistoryRows = [];
    var activeEditInvoiceId = "";

    function getInvoiceVariantOptions(product) {
      return product === "Nastar" ? INVOICE_VARIANT_OPTIONS.Nastar : INVOICE_VARIANT_OPTIONS.Lapis;
    }

    function buildInvoiceVariantOptionHtml(product, selected) {
      var options = getInvoiceVariantOptions(product);
      return options.map(function (opt) {
        var isSelected = String(opt.value) === String(selected || "");
        return '<option value="' + escapeHtml(opt.value) + '"' + (isSelected ? " selected" : "") + '>' + escapeHtml(opt.value) + "</option>";
      }).join("");
    }

    function getInvoiceVariantPrice(product, variant) {
      var options = getInvoiceVariantOptions(product);
      for (var i = 0; i < options.length; i += 1) {
        if (String(options[i].value) === String(variant)) return Number(options[i].price) || 0;
      }
      return 0;
    }

    function loadImageForCanvas(src) {
      return new Promise(function (resolve) {
        var img = new Image();
        img.onload = function () { resolve(img); };
        img.onerror = function () { resolve(null); };
        img.src = src;
      });
    }

    function wrapCanvasLines(ctx, text, maxWidth) {
      var value = String(text || "").replace(/\s+/g, " ").trim();
      if (!value) return [""];
      var words = value.split(" ");
      var lines = [];
      var current = words.shift() || "";
      words.forEach(function (word) {
        var test = current ? (current + " " + word) : word;
        if (ctx.measureText(test).width <= maxWidth) {
          current = test;
        } else {
          lines.push(current);
          current = word;
        }
      });
      lines.push(current);
      return lines;
    }

    function drawRoundedRectCanvas(ctx, x, y, w, h, r, fillColor, strokeColor) {
      var radius = Math.min(r, w / 2, h / 2);
      ctx.beginPath();
      ctx.moveTo(x + radius, y);
      ctx.arcTo(x + w, y, x + w, y + h, radius);
      ctx.arcTo(x + w, y + h, x, y + h, radius);
      ctx.arcTo(x, y + h, x, y, radius);
      ctx.arcTo(x, y, x + w, y, radius);
      ctx.closePath();
      if (fillColor) {
        ctx.fillStyle = fillColor;
        ctx.fill();
      }
      if (strokeColor) {
        ctx.strokeStyle = strokeColor;
        ctx.lineWidth = 2;
        ctx.stroke();
      }
    }

    async function createInvoicePreviewBlob(invoice) {
      var canvas = document.createElement("canvas");
      canvas.width = 1080;
      canvas.height = 1480;
      var ctx = canvas.getContext("2d");
      if (!ctx) throw new Error("Canvas context tidak tersedia");

      ctx.fillStyle = "#fff9f2";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#2b1b14";
      ctx.fillRect(0, 0, canvas.width, 240);
      ctx.fillStyle = "#c98b2b";
      ctx.fillRect(0, 232, canvas.width, 8);

      var logo = await loadImageForCanvas("/products/class/cake-bakery-class/logonainai.png");
      if (logo) {
        var logoBox = { x: 44, y: 36, w: 132, h: 132 };
        var logoRatio = logo.width / logo.height;
        var drawW = logoBox.w;
        var drawH = drawW / logoRatio;
        if (drawH > logoBox.h) {
          drawH = logoBox.h;
          drawW = drawH * logoRatio;
        }
        var drawX = logoBox.x + ((logoBox.w - drawW) / 2);
        var drawY = logoBox.y + ((logoBox.h - drawH) / 2);
        ctx.drawImage(logo, drawX, drawY, drawW, drawH);
      }

      ctx.fillStyle = "#fff3e6";
      ctx.font = "700 56px Georgia, serif";
      ctx.fillText("INVOICE", 208, 108);
      ctx.font = "600 28px Georgia, serif";
      ctx.fillText("Nai Nai Lapis", 208, 154);
      ctx.font = "500 20px Arial, sans-serif";
      ctx.fillText("Lapis & Nastar Premium", 208, 188);

      ctx.font = "600 22px Arial, sans-serif";
      ctx.textAlign = "right";
      ctx.fillText("No Invoice: " + String(invoice.invoiceNumber || "-"), 1032, 86);
      ctx.font = "500 20px Arial, sans-serif";
      ctx.fillText("Tanggal: " + String(invoice.orderDate || "-"), 1032, 122);
      if (invoice.dueDate) {
        ctx.fillText("Jatuh Tempo: " + String(invoice.dueDate || "-"), 1032, 156);
      }
      ctx.fillText("WhatsApp: " + String(invoice.customerWhatsapp || "-"), 1032, invoice.dueDate ? 190 : 156);
      ctx.textAlign = "left";

      drawRoundedRectCanvas(ctx, 44, 280, 482, 196, 22, "#fff3df", "#d8b98a");
      drawRoundedRectCanvas(ctx, 554, 280, 482, 196, 22, "#fffef9", "#d8b98a");

      ctx.fillStyle = "#5a3425";
      ctx.font = "700 24px Georgia, serif";
      ctx.fillText("Invoice Untuk", 72, 324);
      ctx.fillStyle = "#2b1b14";
      ctx.font = "700 34px Georgia, serif";
      var customerNameLines = wrapCanvasLines(ctx, invoice.customerName || "-", 430).slice(0, 2);
      customerNameLines.forEach(function (line, idx) {
        ctx.fillText(line, 72, 366 + (idx * 38));
      });
      ctx.fillStyle = "#3d2a1f";
      ctx.font = "500 20px Arial, sans-serif";
      ctx.fillText(String(invoice.customerWhatsapp || "-"), 72, 436);

      ctx.fillStyle = "#5a3425";
      ctx.font = "700 24px Georgia, serif";
      ctx.fillText("Dari", 582, 324);
      ctx.fillStyle = "#2b1b14";
      ctx.font = "700 33px Georgia, serif";
      ctx.fillText("Nai Nai Lapis", 582, 366);
      ctx.fillStyle = "#3d2a1f";
      ctx.font = "500 20px Arial, sans-serif";
      ctx.fillText("Kue Lapis & Nastar", 582, 402);

      var tableX = 44;
      var tableY = 516;
      var tableW = 992;
      drawRoundedRectCanvas(ctx, tableX, tableY, tableW, 56, 14, "#f2ddbb", null);
      ctx.fillStyle = "#4b2e21";
      ctx.font = "700 20px Arial, sans-serif";
      ctx.fillText("Item", tableX + 20, tableY + 36);
      ctx.textAlign = "center";
      ctx.fillText("Qty", tableX + 486, tableY + 36);
      ctx.textAlign = "right";
      ctx.fillText("Harga", tableX + 688, tableY + 36);
      ctx.fillText("Subtotal", tableX + 958, tableY + 36);
      ctx.textAlign = "left";

      var rowY = tableY + 64;
      var items = Array.isArray(invoice.items) ? invoice.items.slice(0, 6) : [];
      items.forEach(function (item, index) {
        var rowH = 56;
        var bg = index % 2 === 0 ? "#fffef9" : "#fff8ec";
        ctx.fillStyle = bg;
        ctx.fillRect(tableX, rowY, tableW, rowH);
        ctx.strokeStyle = "#efddc0";
        ctx.lineWidth = 1;
        ctx.strokeRect(tableX, rowY, tableW, rowH);

        ctx.fillStyle = "#2f1f17";
        ctx.font = "600 18px Arial, sans-serif";
        var label = item && item.size ? (item.product + " (" + item.size + ")") : String((item && item.product) || "-");
        var clipped = label.length > 44 ? (label.slice(0, 44) + "...") : label;
        ctx.fillText(clipped, tableX + 20, rowY + 34);

        ctx.textAlign = "center";
        ctx.font = "500 18px Arial, sans-serif";
        ctx.fillText(String((item && item.qty) || "-"), tableX + 486, rowY + 34);

        ctx.textAlign = "right";
        ctx.fillText(formatRupiah((item && item.unitPrice) || 0), tableX + 688, rowY + 34);
        ctx.font = "700 18px Arial, sans-serif";
        ctx.fillText(formatRupiah((item && item.lineTotal) || 0), tableX + 958, rowY + 34);
        ctx.textAlign = "left";

        rowY += rowH;
      });

      if (!items.length) {
        ctx.fillStyle = "#fffef9";
        ctx.fillRect(tableX, rowY, tableW, 56);
        ctx.strokeStyle = "#efddc0";
        ctx.strokeRect(tableX, rowY, tableW, 56);
        ctx.fillStyle = "#6a4b3a";
        ctx.font = "500 18px Arial, sans-serif";
        ctx.fillText("Belum ada item invoice.", tableX + 20, rowY + 34);
        rowY += 56;
      }

      var summaryX = 700;
      var summaryY = rowY + 24;
      drawRoundedRectCanvas(ctx, summaryX, summaryY, 336, 188, 18, "#fff3df", "#d8b98a");
      ctx.fillStyle = "#5a3425";
      ctx.font = "600 20px Arial, sans-serif";
      ctx.fillText("Subtotal", summaryX + 20, summaryY + 46);
      ctx.textAlign = "right";
      ctx.fillText(formatRupiah(invoice.subtotal || 0), summaryX + 316, summaryY + 46);
      ctx.textAlign = "left";
      ctx.fillText("Diskon", summaryX + 20, summaryY + 80);
      ctx.textAlign = "right";
      ctx.fillText("- " + formatRupiah(invoice.discount || 0), summaryX + 316, summaryY + 80);
      ctx.textAlign = "left";
      ctx.fillText("Ongkir", summaryX + 20, summaryY + 114);
      ctx.textAlign = "right";
      ctx.fillText(formatRupiah(invoice.shipping || 0), summaryX + 316, summaryY + 114);
      ctx.strokeStyle = "#c89b54";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(summaryX + 20, summaryY + 132);
      ctx.lineTo(summaryX + 316, summaryY + 132);
      ctx.stroke();
      ctx.textAlign = "left";
      ctx.fillStyle = "#2b1b14";
      ctx.font = "700 25px Arial, sans-serif";
      ctx.fillText("Total", summaryX + 20, summaryY + 168);
      ctx.textAlign = "right";
      ctx.fillText(formatRupiah(invoice.total || 0), summaryX + 316, summaryY + 168);
      ctx.textAlign = "left";

      var paymentY = summaryY + 206;
      drawRoundedRectCanvas(ctx, 44, paymentY, 992, 120, 14, "#fffef9", "#e6d2ae");
      ctx.fillStyle = "#5a3425";
      ctx.font = "700 20px Arial, sans-serif";
      ctx.fillText("Pembayaran", 64, paymentY + 32);
      ctx.fillStyle = "#2b1b14";
      ctx.font = "700 18px Arial, sans-serif";
      ctx.fillText("Transfer Bank", 64, paymentY + 56);
      ctx.fillStyle = "#4a3125";
      ctx.font = "500 18px Arial, sans-serif";
      ctx.fillText("Bank: " + INVOICE_PAYMENT_INFO.transferBank, 64, paymentY + 78);
      ctx.fillText("No. Rekening: " + INVOICE_PAYMENT_INFO.transferAccount, 64, paymentY + 98);
      ctx.fillText("Atas Nama: " + INVOICE_PAYMENT_INFO.transferName, 64, paymentY + 116);

      ctx.fillStyle = "#2b1b14";
      ctx.font = "700 18px Arial, sans-serif";
      ctx.fillText("Shopee", 560, paymentY + 56);
      ctx.fillStyle = "#8b4f31";
      ctx.font = "500 18px Arial, sans-serif";
      var shopeeLines = wrapCanvasLines(ctx, INVOICE_PAYMENT_INFO.shopeeLink, 430).slice(0, 2);
      shopeeLines.forEach(function (line, idx) {
        ctx.fillText(line, 560, paymentY + 80 + (idx * 22));
      });

      if (invoice.notes) {
        var notesY = paymentY + 136;
        drawRoundedRectCanvas(ctx, 44, notesY, 992, 124, 14, "#fffef9", "#e6d2ae");
        ctx.fillStyle = "#5a3425";
        ctx.font = "700 20px Arial, sans-serif";
        ctx.fillText("Catatan Order", 64, notesY + 36);
        ctx.fillStyle = "#4a3125";
        ctx.font = "500 18px Arial, sans-serif";
        var noteLines = wrapCanvasLines(ctx, invoice.notes, 948).slice(0, 3);
        noteLines.forEach(function (line, idx) {
          ctx.fillText(line, 64, notesY + 66 + (idx * 26));
        });
      }

      ctx.fillStyle = "#5a3425";
      ctx.font = "italic 500 20px Georgia, serif";
      ctx.textAlign = "center";
      ctx.fillText("Terima kasih sudah order di Nai Nai Lapis.", canvas.width / 2, canvas.height - 54);
      ctx.textAlign = "left";

      var blob = await new Promise(function (resolve, reject) {
        canvas.toBlob(function (fileBlob) {
          if (!fileBlob) {
            reject(new Error("Gagal generate image preview invoice"));
            return;
          }
          resolve(fileBlob);
        }, "image/png", 0.96);
      });
      return blob;
    }

    function sanitizeFileName(rawName) {
      return String(rawName || "invoice")
        .toLowerCase()
        .replace(/[^a-z0-9-]+/g, "-")
        .replace(/-+/g, "-")
        .replace(/^-|-$/g, "") || "invoice";
    }

    async function uploadInvoicePreviewImage(invoice) {
      if (!invoice || !invoice.invoiceNumber) return "";
      var blob = await createInvoicePreviewBlob(invoice);
      var formData = new FormData();
      var fileName = sanitizeFileName(invoice.invoiceNumber) + "-preview.png";
      formData.append("asset", blob, fileName);

      var uploadResult = await apiJson(API_BASE + "/upload-asset", {
        method: "POST",
        body: formData
      });
      var uploadedUrl = uploadResult && uploadResult.file ? uploadResult.file.url : "";
      return sanitizeHttpUrl(toAbsoluteHttpUrl(uploadedUrl));
    }

    function buildAdminInvoiceWhatsappUrl(invoice, previewImageUrl, fallbackUrl) {
      var adminWaInput = document.getElementById("cfg-wa");
      var adminWa = normalizeTo62(adminWaInput && adminWaInput.value ? adminWaInput.value : "") || "6288972681212";
      if (!invoice) return sanitizeHttpUrl(fallbackUrl || ("https://wa.me/" + encodeURIComponent(adminWa)));
      var customerWa = normalizeTo62(invoice.customerWhatsapp || "");

      var lines = [
        "Halo Admin Nai Nai Lapis,",
        "mohon bantu forward invoice ini ke customer:",
        "",
        "Nama Customer: " + String(invoice.customerName || "-"),
        "WA Customer: " + (customerWa || String(invoice.customerWhatsapp || "-")),
        "No Invoice: " + String(invoice.invoiceNumber || "-"),
        "Total: " + formatRupiah(invoice.total || 0),
        "",
        "Pembayaran Transfer:",
        INVOICE_PAYMENT_INFO.transferBank,
        INVOICE_PAYMENT_INFO.transferAccount + " (" + INVOICE_PAYMENT_INFO.transferName + ")",
        "Shopee: " + INVOICE_PAYMENT_INFO.shopeeLink
      ];

      if (previewImageUrl) {
        lines.push("Preview Invoice: " + previewImageUrl);
      } else {
        lines.push("Preview Invoice: -");
      }

      lines.push("");
      lines.push("Terima kasih.");

      return "https://wa.me/" + encodeURIComponent(adminWa) + "?text=" + encodeURIComponent(lines.join("\n"));
    }

    function updateInvoiceItemLineSubtotal(row) {
      if (!row) return 0;
      var qty = Math.round(Number((row.querySelector(".inv-item-qty") || {}).value || 0));
      if (!Number.isFinite(qty) || qty <= 0) qty = 0;
      var unitPrice = parseMoney((row.querySelector(".inv-item-price") || {}).value || 0);
      var lineTotal = qty * unitPrice;
      var subtotalField = row.querySelector(".inv-item-subtotal");
      if (subtotalField) {
        subtotalField.value = formatRupiah(lineTotal);
      }
      return lineTotal;
    }

    function createInvoiceItemRow(data) {
      var preset = data || {};
      var selectedProduct = String(preset.product || "Lapis");
      if (selectedProduct !== "Nastar") selectedProduct = "Lapis";
      var selectedSize = String(preset.size || preset.variant || "");
      var qty = Number.isFinite(Number(preset.qty)) ? Math.max(1, Math.round(Number(preset.qty))) : 1;
      var unitPrice = Number.isFinite(Number(preset.unitPrice)) ? Math.max(0, Math.round(Number(preset.unitPrice))) : 0;
      var notes = String(preset.notes || "");
      if (!selectedSize) {
        var fallbackOptions = getInvoiceVariantOptions(selectedProduct);
        selectedSize = fallbackOptions.length ? fallbackOptions[0].value : "";
      }
      if (!unitPrice) {
        unitPrice = getInvoiceVariantPrice(selectedProduct, selectedSize);
      }

      var row = document.createElement("div");
      row.className = "invoice-item-row";
      row.innerHTML = '' +
        '<div class="invoice-item-grid">' +
          '<div class="field">' +
            '<label>Produk</label>' +
            '<select class="inv-item-product">' +
              '<option value="Lapis"' + (selectedProduct === "Lapis" ? " selected" : "") + '>Lapis</option>' +
              '<option value="Nastar"' + (selectedProduct === "Nastar" ? " selected" : "") + '>Nastar</option>' +
            '</select>' +
          '</div>' +
          '<div class="field">' +
            '<label>Varian & Ukuran</label>' +
            '<select class="inv-item-size">' + buildInvoiceVariantOptionHtml(selectedProduct, selectedSize) + '</select>' +
          '</div>' +
          '<div class="field">' +
            '<label>Qty</label>' +
            '<input class="inv-item-qty" type="number" min="1" step="1" value="' + String(qty) + '" required />' +
          '</div>' +
          '<div class="field">' +
            '<label>Harga Satuan (Rp)</label>' +
            '<input class="inv-item-price" type="number" min="0" step="1000" value="' + String(unitPrice) + '" required />' +
          '</div>' +
          '<div class="field">' +
            '<label>Subtotal</label>' +
            '<input class="inv-item-subtotal" type="text" value="' + formatRupiah(qty * unitPrice) + '" readonly />' +
          '</div>' +
          '<div class="field">' +
            '<label>&nbsp;</label>' +
            '<button type="button" class="btn btn-danger inv-item-remove">Hapus</button>' +
          '</div>' +
        '</div>' +
        '<div class="invoice-item-note field">' +
          '<label>Catatan item (opsional)</label>' +
          '<input class="inv-item-note" type="text" placeholder="Contoh: varian Imlek, toples gold, dll" value="' + escapeHtml(notes) + '" />' +
        '</div>';

      var productField = row.querySelector(".inv-item-product");
      var sizeField = row.querySelector(".inv-item-size");
      var qtyField = row.querySelector(".inv-item-qty");
      var priceField = row.querySelector(".inv-item-price");
      var noteField = row.querySelector(".inv-item-note");

      function syncVariantOptions(setDefaultPrice) {
        var product = String(productField && productField.value ? productField.value : "Lapis");
        var current = String(sizeField && sizeField.value ? sizeField.value : "");
        if (sizeField) {
          sizeField.innerHTML = buildInvoiceVariantOptionHtml(product, current);
          if (!sizeField.value) {
            var opts = getInvoiceVariantOptions(product);
            sizeField.value = opts.length ? opts[0].value : "";
          }
        }
        if (setDefaultPrice && priceField) {
          var suggested = getInvoiceVariantPrice(product, sizeField ? sizeField.value : "");
          if (suggested > 0) {
            priceField.value = String(suggested);
          }
        }
      }

      row.querySelector(".inv-item-remove").addEventListener("click", function () {
        var wrap = document.getElementById("invoice-items");
        if (!wrap) return;
        if (wrap.children.length <= 1) {
          if (productField) productField.value = "Lapis";
          syncVariantOptions(true);
          if (qtyField) qtyField.value = "1";
          if (priceField && !Number(priceField.value)) {
            priceField.value = String(getInvoiceVariantPrice("Lapis", sizeField ? sizeField.value : ""));
          }
          if (noteField) noteField.value = "";
        } else {
          row.remove();
        }
        updateInvoiceTotalPreview();
      });

      if (productField) {
        productField.addEventListener("change", function () {
          syncVariantOptions(true);
          updateInvoiceTotalPreview();
        });
      }
      if (sizeField) {
        sizeField.addEventListener("change", function () {
          var suggested = getInvoiceVariantPrice(
            productField ? productField.value : "Lapis",
            sizeField.value
          );
          if (suggested > 0 && priceField) {
            priceField.value = String(suggested);
          }
          updateInvoiceTotalPreview();
        });
      }

      Array.prototype.slice.call(row.querySelectorAll("input, select")).forEach(function (field) {
        field.addEventListener("input", updateInvoiceTotalPreview);
        field.addEventListener("change", updateInvoiceTotalPreview);
      });

      syncVariantOptions(false);
      updateInvoiceItemLineSubtotal(row);

      return row;
    }

    function addInvoiceItem(data) {
      var wrap = document.getElementById("invoice-items");
      if (!wrap) return;
      wrap.appendChild(createInvoiceItemRow(data));
      updateInvoiceTotalPreview();
    }

    function readInvoiceItemsForSubmit() {
      var rows = Array.prototype.slice.call(document.querySelectorAll(".invoice-item-row"));
      var items = [];
      var invalidRows = [];

      rows.forEach(function (row, index) {
        var product = String((row.querySelector(".inv-item-product") || {}).value || "").trim();
        var size = String((row.querySelector(".inv-item-size") || {}).value || "").trim();
        var qty = Math.round(Number((row.querySelector(".inv-item-qty") || {}).value || 0));
        var unitPrice = parseMoney((row.querySelector(".inv-item-price") || {}).value || 0);
        var notes = String((row.querySelector(".inv-item-note") || {}).value || "").trim();

        if (!product || !size || !Number.isFinite(qty) || qty <= 0 || !Number.isFinite(unitPrice) || unitPrice <= 0) {
          invalidRows.push(index + 1);
          return;
        }

        items.push({
          product: product,
          size: size,
          qty: qty,
          unitPrice: unitPrice,
          notes: notes
        });
      });

      return {
        items: items,
        invalidRows: invalidRows
      };
    }

    function updateInvoiceTotalPreview() {
      var rows = Array.prototype.slice.call(document.querySelectorAll(".invoice-item-row"));
      var subtotal = rows.reduce(function (sum, row) {
        return sum + updateInvoiceItemLineSubtotal(row);
      }, 0);
      var discountRaw = parseMoney((document.getElementById("inv-discount") || {}).value || 0);
      var shipping = parseMoney((document.getElementById("inv-shipping") || {}).value || 0);
      var discount = Math.min(discountRaw, subtotal);
      var total = Math.max(0, subtotal - discount + shipping);

      var preview = document.getElementById("invoice-total-preview");
      if (!preview) return;
      preview.textContent = "Estimasi Total: " + formatRupiah(total) +
        " (Subtotal " + formatRupiah(subtotal) +
        ", Diskon " + formatRupiah(discount) +
        ", Ongkir " + formatRupiah(shipping) + ")";
    }

    function findInvoiceHistoryById(invoiceId) {
      var id = String(invoiceId || "");
      if (!id) return null;
      for (var i = 0; i < invoiceHistoryRows.length; i += 1) {
        var row = invoiceHistoryRows[i];
        if (row && String(row.id || "") === id) return row;
      }
      return null;
    }

    function setInvoiceFormMode(invoiceRow) {
      var modeText = document.getElementById("invoice-form-mode");
      var submitBtn = document.getElementById("invoice-submit-btn");
      var cancelBtn = document.getElementById("invoice-cancel-edit-btn");

      if (invoiceRow && invoiceRow.id) {
        activeEditInvoiceId = String(invoiceRow.id);
        if (modeText) modeText.textContent = "Mode: Edit invoice " + String(invoiceRow.invoiceNumber || "-") + ".";
        if (submitBtn) submitBtn.textContent = "Simpan Perubahan Invoice + Kirim WhatsApp";
        if (cancelBtn) cancelBtn.style.display = "inline-flex";
      } else {
        activeEditInvoiceId = "";
        if (modeText) modeText.textContent = "Mode: Buat invoice baru.";
        if (submitBtn) submitBtn.textContent = "Generate Invoice PDF + Kirim WhatsApp";
        if (cancelBtn) cancelBtn.style.display = "none";
      }
    }

    function resetInvoiceFormToCreate(clearResult) {
      var form = document.getElementById("invoice-form");
      if (form) form.reset();

      var orderDateInput = document.getElementById("inv-order-date");
      if (orderDateInput) orderDateInput.value = todayYmd();

      var itemsWrap = document.getElementById("invoice-items");
      if (itemsWrap) {
        itemsWrap.innerHTML = "";
        addInvoiceItem({ product: "Lapis", qty: 1, unitPrice: 0 });
      }

      setInvoiceFormMode(null);
      if (clearResult) renderInvoiceResult(null);
      updateInvoiceTotalPreview();
    }

    function loadInvoiceIntoForm(invoiceRow) {
      if (!invoiceRow || !invoiceRow.id) return;

      document.getElementById("inv-customer-name").value = String(invoiceRow.customerName || "");
      document.getElementById("inv-customer-wa").value = String(invoiceRow.customerWhatsapp || "");
      document.getElementById("inv-customer-address").value = String(invoiceRow.customerAddress || "");
      document.getElementById("inv-order-date").value = String(invoiceRow.orderDate || todayYmd());
      document.getElementById("inv-due-date").value = String(invoiceRow.dueDate || "");
      document.getElementById("inv-discount").value = String(parseMoney(invoiceRow.discount || 0));
      document.getElementById("inv-shipping").value = String(parseMoney(invoiceRow.shipping || 0));
      document.getElementById("inv-notes").value = String(invoiceRow.notes || "");

      var itemsWrap = document.getElementById("invoice-items");
      if (itemsWrap) {
        itemsWrap.innerHTML = "";
        var items = Array.isArray(invoiceRow.items) && invoiceRow.items.length
          ? invoiceRow.items
          : [{ product: "Lapis", qty: 1, unitPrice: 0 }];
        items.forEach(function (item) {
          addInvoiceItem({
            product: item.product,
            size: item.size,
            qty: item.qty,
            unitPrice: item.unitPrice,
            notes: item.notes
          });
        });
      }

      setInvoiceFormMode(invoiceRow);
      updateInvoiceTotalPreview();
      setLine("invoice-status", "Mode edit aktif. Ubah data lalu klik simpan.", "success");

      var invoicePanel = document.getElementById("invoice-form");
      if (invoicePanel && invoicePanel.scrollIntoView) {
        invoicePanel.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    }

    function enrichInvoiceResultWithPreview(result) {
      var payload = result || {};
      var invoice = payload.invoice || {};
      return uploadInvoicePreviewImage(invoice)
        .then(function (previewImageUrl) {
          payload.previewImageUrl = previewImageUrl;
          payload.whatsappUrl = buildAdminInvoiceWhatsappUrl(invoice, previewImageUrl, payload.whatsappUrl);
          return payload;
        })
        .catch(function () {
          payload.previewImageUrl = "";
          payload.whatsappUrl = buildAdminInvoiceWhatsappUrl(invoice, "", payload.whatsappUrl);
          return payload;
        });
    }

    function renderInvoiceResult(payload) {
      var wrap = document.getElementById("invoice-result");
      if (!wrap) return;
      if (!payload || !payload.invoice) {
        wrap.innerHTML = "";
        return;
      }

      var invoice = payload.invoice || {};
      var whatsappUrl = sanitizeHttpUrl(payload.whatsappUrl || "");
      var previewImageUrl = sanitizeHttpUrl(payload.previewImageUrl || "");
      var title = String(payload.title || "Invoice Berhasil Dibuat");

      wrap.innerHTML = '' +
        '<article class="invoice-result-card">' +
          '<h3>' + escapeHtml(title) + '</h3>' +
          '<p><strong>No Invoice:</strong> ' + escapeHtml(invoice.invoiceNumber || "-") + '</p>' +
          '<p><strong>Customer:</strong> ' + escapeHtml(invoice.customerName || "-") + ' (' + escapeHtml(invoice.customerWhatsapp || "-") + ')</p>' +
          '<p><strong>Total:</strong> ' + escapeHtml(formatRupiah(invoice.total || 0)) + '</p>' +
          (previewImageUrl ? ('<p><strong>Preview Invoice:</strong> <a href="' + escapeHtml(previewImageUrl) + '" target="_blank" rel="noopener noreferrer">Buka Preview Invoice</a></p>') : "") +
          '<div class="invoice-actions">' +
            '<button class="btn btn-main" id="send-invoice-wa-btn" type="button">Kirim ke WhatsApp Admin</button>' +
          '</div>' +
        '</article>';

      var sendBtn = document.getElementById("send-invoice-wa-btn");
      if (sendBtn) {
        sendBtn.disabled = !whatsappUrl;
        sendBtn.addEventListener("click", function () {
          if (!whatsappUrl) return;
          window.open(whatsappUrl, "_blank", "noopener,noreferrer");
        });
      }
    }

    function resendInvoiceFromHistory(invoiceId) {
      var row = findInvoiceHistoryById(invoiceId);
      if (!row) {
        setLine("invoice-status", "Invoice tidak ditemukan di history.", "error");
        return;
      }

      setLine("invoice-status", "Menyiapkan kirim ulang invoice ke WhatsApp admin...");
      enrichInvoiceResultWithPreview({ invoice: row, whatsappUrl: "" })
        .then(function (result) {
          result.title = "Invoice Siap Dikirim Ulang";
          renderInvoiceResult(result);
          if (result.whatsappUrl) {
            window.open(result.whatsappUrl, "_blank", "noopener,noreferrer");
          }
          setLine("invoice-status", "Kirim ulang invoice berhasil disiapkan. Chat WhatsApp admin sudah dibuka.", "success");
        })
        .catch(function (err) {
          setLine("invoice-status", "Gagal kirim ulang invoice: " + (err && err.message ? err.message : "unknown"), "error");
        });
    }

    function deleteInvoiceFromHistory(invoiceId) {
      var row = findInvoiceHistoryById(invoiceId);
      if (!row) {
        setLine("invoice-status", "Invoice tidak ditemukan di history.", "error");
        return;
      }

      var confirmed = window.confirm("Hapus invoice ini?\n" + String(row.invoiceNumber || "-") + " - " + String(row.customerName || "-"));
      if (!confirmed) return;

      setLine("invoice-status", "Menghapus invoice...");
      apiJson(API_BASE + "/invoices/" + encodeURIComponent(String(row.id || "")), {
        method: "DELETE"
      })
        .then(function () {
          if (activeEditInvoiceId && activeEditInvoiceId === String(row.id || "")) {
            resetInvoiceFormToCreate(false);
          }
          renderInvoiceResult(null);
          setLine("invoice-status", "Invoice berhasil dihapus.", "success");
          loadInvoices();
        })
        .catch(function (err) {
          if (handleUnauthorized(err, "Sesi habis. Login ulang untuk hapus invoice.")) return;
          setLine("invoice-status", "Gagal hapus invoice: " + (err.message || "unknown"), "error");
        });
    }

    function renderInvoiceHistory(rows) {
      var tbody = document.getElementById("invoice-history-body");
      if (!tbody) return;
      if (!rows || !rows.length) {
        tbody.innerHTML = '<tr><td colspan="6">Belum ada invoice.</td></tr>';
        return;
      }

      tbody.innerHTML = rows.map(function (row) {
        var pdfUrl = sanitizeHttpUrl(toAbsoluteHttpUrl(row.pdfUrl || row.pdfPath || ""));
        var encodedId = encodeURIComponent(String(row.id || ""));
        return '' +
          '<tr>' +
            '<td>' + escapeHtml(formatDate(row.createdAt)) + '</td>' +
            '<td>' + escapeHtml(row.invoiceNumber || "-") + '</td>' +
            '<td>' + escapeHtml(row.customerName || "-") + '</td>' +
            '<td>' + escapeHtml(row.customerWhatsapp || "-") + '</td>' +
            '<td>' + escapeHtml(formatRupiah(row.total || 0)) + '</td>' +
            '<td>' +
              '<div class="invoice-history-actions">' +
                '<button class="btn btn-soft history-edit-invoice" data-id="' + encodedId + '" type="button">Edit</button>' +
                '<button class="btn btn-soft history-resend-invoice" data-id="' + encodedId + '" type="button">Kirim Ulang</button>' +
                '<button class="btn btn-danger history-delete-invoice" data-id="' + encodedId + '" type="button">Hapus</button>' +
                (pdfUrl ? ('<a class="btn btn-soft" href="' + escapeHtml(pdfUrl) + '" target="_blank" rel="noopener noreferrer">PDF</a>') : "") +
              '</div>' +
            '</td>' +
          '</tr>';
      }).join("");

      Array.prototype.slice.call(document.querySelectorAll(".history-edit-invoice")).forEach(function (btn) {
        btn.addEventListener("click", function () {
          var encoded = String(btn.getAttribute("data-id") || "");
          var decoded = "";
          try { decoded = decodeURIComponent(encoded); } catch (_) { decoded = encoded; }
          var row = findInvoiceHistoryById(decoded);
          if (!row) return;
          loadInvoiceIntoForm(row);
        });
      });

      Array.prototype.slice.call(document.querySelectorAll(".history-resend-invoice")).forEach(function (btn) {
        btn.addEventListener("click", function () {
          var encoded = String(btn.getAttribute("data-id") || "");
          var decoded = "";
          try { decoded = decodeURIComponent(encoded); } catch (_) { decoded = encoded; }
          resendInvoiceFromHistory(decoded);
        });
      });

      Array.prototype.slice.call(document.querySelectorAll(".history-delete-invoice")).forEach(function (btn) {
        btn.addEventListener("click", function () {
          var encoded = String(btn.getAttribute("data-id") || "");
          var decoded = "";
          try { decoded = decodeURIComponent(encoded); } catch (_) { decoded = encoded; }
          deleteInvoiceFromHistory(decoded);
        });
      });
    }

    function loadInvoices() {
      return apiJson(API_BASE + "/invoices?limit=120")
        .then(function (payload) {
          invoiceHistoryRows = Array.isArray(payload.data) ? payload.data : [];
          renderInvoiceHistory(invoiceHistoryRows);
        })
        .catch(function (err) {
          if (handleUnauthorized(err, "Sesi habis. Login ulang untuk akses invoice.")) return;
          setLine("invoice-status", "Gagal memuat invoice: " + (err.message || "unknown"), "error");
        });
    }

    function submitInvoice(event) {
      event.preventDefault();
      var name = String((document.getElementById("inv-customer-name") || {}).value || "").trim();
      var customerWa = String((document.getElementById("inv-customer-wa") || {}).value || "").trim();
      var customerAddress = String((document.getElementById("inv-customer-address") || {}).value || "").trim();
      var orderDate = String((document.getElementById("inv-order-date") || {}).value || "").trim();
      var dueDate = String((document.getElementById("inv-due-date") || {}).value || "").trim();
      var discount = parseMoney((document.getElementById("inv-discount") || {}).value || 0);
      var shipping = parseMoney((document.getElementById("inv-shipping") || {}).value || 0);
      var notes = String((document.getElementById("inv-notes") || {}).value || "").trim();
      var read = readInvoiceItemsForSubmit();
      var targetInvoiceId = activeEditInvoiceId;
      var isEditMode = Boolean(targetInvoiceId);

      if (!name || !customerWa) {
        setLine("invoice-status", "Nama dan WhatsApp customer wajib diisi.", "error");
        return;
      }
      if (!read.items.length) {
        setLine("invoice-status", "Isi minimal 1 item produk dengan qty dan harga.", "error");
        return;
      }
      if (read.invalidRows && read.invalidRows.length) {
        setLine("invoice-status", "Cek item baris: " + read.invalidRows.join(", ") + ". Pastikan varian, qty, dan harga sudah valid.", "error");
        return;
      }

      var payload = {
        customerName: name,
        customerWhatsapp: customerWa,
        customerAddress: customerAddress,
        orderDate: orderDate || todayYmd(),
        dueDate: dueDate,
        discount: discount,
        shipping: shipping,
        notes: notes,
        items: read.items
      };

      var endpoint = isEditMode
        ? (API_BASE + "/invoices/" + encodeURIComponent(targetInvoiceId))
        : (API_BASE + "/invoices");
      var method = isEditMode ? "PATCH" : "POST";
      var actionText = isEditMode ? "Menyimpan perubahan invoice PDF..." : "Membuat invoice PDF...";

      setLine("invoice-status", actionText);
      apiJson(endpoint, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
        .then(function (result) {
          setLine("invoice-status", "Invoice PDF berhasil. Menyiapkan preview image...");
          return enrichInvoiceResultWithPreview(result);
        })
        .then(function (result) {
          result.title = isEditMode ? "Invoice Berhasil Diperbarui" : "Invoice Berhasil Dibuat";
          renderInvoiceResult(result);
          if (result && result.whatsappUrl) {
            window.open(result.whatsappUrl, "_blank", "noopener,noreferrer");
          }
          setLine(
            "invoice-status",
            isEditMode
              ? "Invoice berhasil diperbarui. Chat WhatsApp admin sudah dibuka dengan link Preview Invoice."
              : "Invoice berhasil dibuat. Chat WhatsApp admin sudah dibuka dengan link Preview Invoice.",
            "success"
          );
          if (isEditMode && activeEditInvoiceId === targetInvoiceId) {
            setInvoiceFormMode(null);
          }
          loadInvoices();
        })
        .catch(function (err) {
          if (handleUnauthorized(err, isEditMode ? "Sesi habis. Login ulang untuk edit invoice." : "Sesi habis. Login ulang untuk generate invoice.")) return;
          setLine("invoice-status", "Gagal proses invoice: " + (err.message || "unknown"), "error");
        });
    }

    function initInvoiceForm() {
      var itemsWrap = document.getElementById("invoice-items");
      if (!itemsWrap) return;
      if (!itemsWrap.children.length) addInvoiceItem({ product: "Lapis", qty: 1, unitPrice: 0 });

      var orderDateInput = document.getElementById("inv-order-date");
      if (orderDateInput && !orderDateInput.value) orderDateInput.value = todayYmd();

      var addBtn = document.getElementById("add-invoice-item");
      if (addBtn && !addBtn.dataset.bound) {
        addBtn.dataset.bound = "true";
        addBtn.addEventListener("click", function () {
          addInvoiceItem({ product: "Lapis", qty: 1, unitPrice: 0 });
        });
      }

      var discountInput = document.getElementById("inv-discount");
      if (discountInput && !discountInput.dataset.bound) {
        discountInput.dataset.bound = "true";
        discountInput.addEventListener("input", updateInvoiceTotalPreview);
      }
      var shippingInput = document.getElementById("inv-shipping");
      if (shippingInput && !shippingInput.dataset.bound) {
        shippingInput.dataset.bound = "true";
        shippingInput.addEventListener("input", updateInvoiceTotalPreview);
      }

      setInvoiceFormMode(null);
      updateInvoiceTotalPreview();
    }

    function renderAssets(assets) {
      var wrap = document.getElementById("asset-grid");
      if (!assets || !assets.length) {
        wrap.innerHTML = "<p>Belum ada asset.</p>";
        return;
      }
      wrap.innerHTML = assets.map(function (asset) {
        var safeName = escapeHtml(asset.name);
        var encodedName = encodeURIComponent(asset.name || "");
        return '' +
          '<article class="asset-card">' +
            '<img src="' + asset.url + '" alt="' + escapeHtml(asset.name) + '" loading="lazy" />' +
            '<div class="asset-meta">' +
              '<strong>' + safeName + '</strong><br>' +
              'Size: ' + escapeHtml(String(asset.size || 0)) + ' bytes<br>' +
              'Update: ' + escapeHtml(formatDate(asset.updatedAt)) +
              '<div class="asset-actions">' +
                '<button class="btn btn-danger delete-asset" data-name="' + encodedName + '" type="button">Hapus</button>' +
              '</div>' +
            '</div>' +
          '</article>';
      }).join("");

      Array.prototype.slice.call(document.querySelectorAll(".delete-asset")).forEach(function (btn) {
        btn.addEventListener("click", function () {
          var encodedName = btn.getAttribute("data-name") || "";
          var originalName = "";
          try { originalName = decodeURIComponent(encodedName); } catch (_) { originalName = encodedName; }
          deleteAsset(originalName);
        });
      });
    }

    function refreshAssets() {
      return apiJson(API_BASE + "/assets")
        .then(function (payload) {
          renderAssets(payload.assets || []);
        })
        .catch(function (err) {
          if (handleUnauthorized(err, "Sesi habis. Login ulang untuk lihat asset.")) return;
          setLine("upload-status", "Gagal memuat asset: " + (err.message || "unknown"), "error");
        });
    }

    function uploadAsset(event) {
      event.preventDefault();
      var fileInput = document.getElementById("asset-file");
      if (!fileInput.files || !fileInput.files.length) {
        setLine("upload-status", "Pilih file dulu.", "error");
        return;
      }
      setLine("upload-status", "Uploading...");

      var formData = new FormData();
      formData.append("asset", fileInput.files[0]);

      apiJson(API_BASE + "/upload-asset", {
        method: "POST",
        body: formData
      })
        .then(function (result) {
          fileInput.value = "";
          setLine("upload-status", "Upload berhasil: " + (result.file && result.file.name ? result.file.name : "ok"), "success");
          refreshAssets();
        })
        .catch(function (err) {
          if (handleUnauthorized(err, "Sesi habis. Login ulang untuk upload asset.")) return;
          setLine("upload-status", "Error upload: " + (err.message || "unknown"), "error");
        });
    }

    function deleteAsset(fileName) {
      if (!fileName) return;
      var confirmed = window.confirm("Hapus file ini?\\n" + fileName);
      if (!confirmed) return;

      setLine("upload-status", "Menghapus file " + fileName + "...");
      apiJson(API_BASE + "/assets/" + encodeURIComponent(fileName), {
        method: "DELETE"
      })
        .then(function () {
          setLine("upload-status", "File berhasil dihapus: " + fileName, "success");
          refreshAssets();
        })
        .catch(function (err) {
          if (handleUnauthorized(err, "Sesi habis. Login ulang untuk hapus asset.")) return;
          setLine("upload-status", "Error hapus file: " + (err.message || "unknown"), "error");
        });
    }

    function loadAll() {
      loadConfig();
      refreshAssets();
      loadOrders();
      loadInvoices();
      initInvoiceForm();
    }

    document.getElementById("setup-form").addEventListener("submit", function (event) {
      event.preventDefault();
      var pin = document.getElementById("setup-pin").value.trim();
      var confirmPin = document.getElementById("setup-pin-confirm").value.trim();
      setLine("auth-status", "Mengaktifkan PIN...");

      doBootstrap(pin, confirmPin)
        .then(function (result) {
          setToken(result.token || "");
          document.getElementById("setup-form").reset();
          openDashboard("PIN berhasil diaktifkan. Dashboard siap dipakai.");
        })
        .catch(function (err) {
          setLine("auth-status", "Gagal aktivasi PIN: " + (err.message || "unknown"), "error");
        });
    });

    document.getElementById("login-form").addEventListener("submit", function (event) {
      event.preventDefault();
      var pin = document.getElementById("login-pin").value.trim();
      setLine("auth-status", "Login...");

      doLogin(pin)
        .then(function (result) {
          setToken(result.token || "");
          document.getElementById("login-form").reset();
          openDashboard("Login berhasil.");
        })
        .catch(function (err) {
          setLine("auth-status", "Gagal login: " + (err.message || "unknown"), "error");
        });
    });

    document.getElementById("logout-btn").addEventListener("click", function () {
      doLogout()
        .catch(function () { return null; })
        .then(function () {
          setToken("");
          showAuthMode("login", "Logout berhasil.");
        });
    });

    document.getElementById("change-pin-form").addEventListener("submit", function (event) {
      event.preventDefault();
      var oldPin = document.getElementById("old-pin").value.trim();
      var newPin = document.getElementById("new-pin").value.trim();
      var confirmPin = document.getElementById("new-pin-confirm").value.trim();
      setLine("pin-status", "Mengganti PIN...");

      doChangePin(oldPin, newPin, confirmPin)
        .then(function (result) {
          setToken(result.token || "");
          document.getElementById("change-pin-form").reset();
          setLine("pin-status", "PIN berhasil diganti.", "success");
        })
        .catch(function (err) {
          if (handleUnauthorized(err, "Sesi habis. Login ulang untuk ganti PIN.")) return;
          setLine("pin-status", "Gagal ganti PIN: " + (err.message || "unknown"), "error");
        });
    });

    document.getElementById("apply-filter").addEventListener("click", function () {
      loadOrders();
    });

    document.getElementById("refresh-all").addEventListener("click", function () {
      loadAll();
    });

    document.getElementById("config-form").addEventListener("submit", saveConfig);
    document.getElementById("upload-form").addEventListener("submit", uploadAsset);
    document.getElementById("invoice-form").addEventListener("submit", submitInvoice);
    document.getElementById("invoice-cancel-edit-btn").addEventListener("click", function () {
      resetInvoiceFormToCreate(true);
      setLine("invoice-status", "Mode edit dibatalkan. Kembali ke mode invoice baru.", "success");
    });
    document.getElementById("generate-shortlink-btn").addEventListener("click", generateShortlink);
    document.getElementById("generate-qr-btn").addEventListener("click", generateQrOnly);
    document.getElementById("send-qr-wa-btn").addEventListener("click", sendQrToWhatsAppAdmin);

    var qrTargetInput = document.getElementById("qr-target-link");
    if (qrTargetInput) {
      if (!qrTargetInput.value.trim()) {
        qrTargetInput.value = DEFAULT_QR_TARGET;
      }
      qrTargetInput.addEventListener("input", function () {
        document.getElementById("shortlink-output").value = "";
      });
    }

    document.getElementById("download-qr-btn").addEventListener("click", function (event) {
      var href = event.currentTarget.getAttribute("href") || "";
      if (!href || href === "#") {
        event.preventDefault();
        setLine("qr-status", "Generate QR dulu sebelum download.", "error");
      }
    });

    setQrPreview("");
    initInvoiceForm();

    initAuthFlow();
    setInterval(function () {
      if (document.getElementById("dashboard-root").style.display === "block") {
        loadOrders();
      }
    }, 30000);
  </script>
</body>
</html>
