<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Anak - Queen‚Äôs Academy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Forum&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #0d2d2b;
      color: #ffe58e;
      font-family: 'Forum', sans-serif;
      margin: 0;
      padding: 2rem;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background-color: rgba(255,255,255,0.05);
      padding: 2rem;
      border-radius: 12px;
    }
    .dashboard-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,229,142,0.15);
      border-radius: 16px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      overflow: hidden;
    }
    h1, h2, h3 { color: #ffe58e; }
    #badgeList, #galeri { display: flex; flex-wrap: wrap; gap: 12px; }
    .badge-item img, #galeri img {
      width: 100px;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(255,255,255,0.2);
    }
    .badge-item span {
      display: block;
      font-size: 0.75rem;
      text-align: center;
      margin-top: 4px;
    }
    iframe { border: none; border-radius: 12px; }
    #uploadForm {
      max-width: 100%;
    }
    #uploadForm input[type="file"],
    #uploadForm input[type="text"],
    #uploadForm button {
      box-sizing: border-box;
      width: 100%;
      max-width: 100%;
    }
    #uploadForm input, #uploadForm button {
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    #uploadForm input {
      background-color: rgba(255,255,255,0.06);
      border: 1px solid rgba(255, 229, 142, 0.3);
      color: #ffe58e;
    }
    #uploadForm button {
      background-color: #ffe58e;
      color: #0d2d2b;
      font-weight: bold;
      cursor: pointer;
      border: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dashboard Anak ‚Äì Queen‚Äôs Academy</h1>
    <div id="loading">üîÑ Memuat data anak...</div>
    <div id="dashboard" style="display:none;">
      <div class="dashboard-card">
        <h2 id="namaAnak"></h2>
        <p id="usiaAnak"></p>
        <div id="sertifikatContainer"></div>
      </div>

      <div class="dashboard-card">
        <h3>üìã Kesimpulan</h3>
        <p id="kesimpulanAI" style="white-space: pre-wrap;"></p>
      </div>

      <div class="dashboard-card">
        <h3>üß† Evaluasi Psikotest dari AI</h3>
        <div id="evaluasiAI"></div>
      </div>

      <div class="dashboard-card">
        <h3>üéØ Tipe Bakat & Kepribadian</h3>
        <p id="tipeBakat">üß† -</p>
        <p id="tipeKepribadian">üôÇ -</p>
      </div>

      <div class="dashboard-card">
        <h3>üèÖ Badge</h3>
        <div id="badgeList"></div>
      </div>

      <div class="dashboard-card">
        <h3>üìö Rekomendasi Kelas</h3>
        <ul id="rekomKelas" style="padding-left: 1.5rem;"></ul>
      </div>

      <div class="dashboard-card">
        <h3>üé® Galeri Karya Anak</h3>
        <div id="galeri"></div>
      </div>

      <div class="dashboard-card">
        <h3>üìù Upload Karya Anak</h3>
        <form id="uploadForm">
          <input type="file" id="fileInput" accept="image/*" required>
          <input type="text" id="titleInput" placeholder="Judul karya" required>
          <button type="submit">Upload Karya</button>
          <div id="uploadStatus"></div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const cid = urlParams.get("cid");
    const API_URL = "https://script.google.com/macros/s/AKfycbx5cPx2YQzYLbjMzFJPwIEr_bMsm4VGB8OA-04p33hnuXK61Mm36U04W3IrihbsIDukhw/exec";

    function getDriveImageUrlFromRaw(rawUrl) {
      try {
        const idMatch = rawUrl.match(/\/d\/([a-zA-Z0-9_-]+)|id=([a-zA-Z0-9_-]+)/);
        const fileId = idMatch ? (idMatch[1] || idMatch[2]) : null;
        return fileId ? `https://drive.google.com/uc?export=view&id=${fileId}` : rawUrl;
      } catch (err) {
        console.warn("‚ö†Ô∏è Gagal parsing link gambar:", rawUrl, err);
        return rawUrl;
      }
    }

    if (!cid) {
      document.getElementById("loading").innerText = "‚ùå CID tidak ditemukan di URL.";
    } else {
      fetch(`${API_URL}?cid=${cid}`, { cache: "no-store" })
        .then(res => res.json())
        .then(data => {
          document.getElementById("loading").style.display = "none";
          document.getElementById("dashboard").style.display = "block";

          document.getElementById("namaAnak").innerText = data.nama || "-";
          document.getElementById("usiaAnak").innerText = `Usia: ${data.usia || "-"}`;
          document.getElementById("kesimpulanAI").innerText = data.kesimpulan || "-";
          document.getElementById("tipeBakat").innerText = `üß† ${data.tipe_bakat || "-"}`;
          document.getElementById("tipeKepribadian").innerText = `üôÇ ${data.tipe_kepribadian || "-"}`;

          const sertifikatEl = document.getElementById("sertifikatContainer");
          if (
            data.sertifikat &&
            typeof data.sertifikat === "string" &&
            data.sertifikat.match(/drive\.google\.com\/.*\/view/)
          ) {
            sertifikatEl.innerHTML = `<iframe src="${data.sertifikat.replace("/view", "/preview")}" width="100%" height="480" loading="lazy" allowfullscreen></iframe>`;
          } else {
            sertifikatEl.innerHTML = "<p>Sertifikat belum tersedia atau tautan salah.</p>";
          }


          const evaluasiEl = document.getElementById("evaluasiAI");
          if (data.evaluasi && data.evaluasi.length > 0) {
            data.evaluasi.forEach(e => {
              const p = document.createElement("p");
              p.innerText = `${e.komponen}: ${e.analisis}`;
              evaluasiEl.appendChild(p);
            });
          } else {
            evaluasiEl.innerHTML = "<p>Tidak ada evaluasi ditemukan.</p>";
          }

          const badgeEl = document.getElementById("badgeList");
          if (data.tipe_bakat && typeof data.tipe_bakat === "string") {
            const badgeMap = {
              "Imajinatif": "badge_imajinatif.png",
              "Logika": "badge_logika.png",
              "Verbal": "badge_verbal.png",
              "Sosial": "badge_sosial.png",
              "Multi": "badge_multitalenta.png"
            };

            const badgeEl = document.getElementById("badgeList");
            Object.keys(badgeMap).forEach(kata => {
              if (data.tipe_bakat.includes(kata)) {
                const wrapper = document.createElement("div");
                wrapper.classList.add("badge-item");
                wrapper.innerHTML = `
                  <img src="/badges/${badgeMap[kata]}" alt="${kata}">
                  <span>${kata}</span>
                `;
                badgeEl.appendChild(wrapper);
              }
            }); 
          } else {
            badgeEl.innerHTML = "<p>Belum ada badge yang cocok.</p>";
          }


          const kelasEl = document.getElementById("rekomKelas");
          if (data.rekomendasi && data.rekomendasi.length > 0) {
            data.rekomendasi.forEach(r => {
              const li = document.createElement("li");
              li.innerText = r;
              kelasEl.appendChild(li);
            });
          } else {
            kelasEl.innerHTML = "<li>Tidak ada rekomendasi kelas.</li>";
          }

          // PATCHED GALLERY WITH PREVIEW + DELETE
          const galeri = document.getElementById("galeri");
          if (data.karya && data.karya.length > 0) {
            galeri.innerHTML = ""; // Bersihkan isi awal

            data.karya.forEach(k => {
              if (k && k.url && typeof k.url === "string") {
                const wrapper = document.createElement("div");
                wrapper.className = "karya-card";
                wrapper.style.border = "1px solid #ffe58e";
                wrapper.style.padding = "10px";
                wrapper.style.borderRadius = "10px";
                wrapper.style.margin = "10px";
                wrapper.style.maxWidth = "250px";
                wrapper.style.backgroundColor = "rgba(255,255,255,0.04)";
                wrapper.style.textAlign = "center";

                let previewElement;
                if (k.url.match(/\.(jpg|jpeg|png|gif)$/i)) {
                  previewElement = document.createElement("img");
                  previewElement.src = k.url;
                  previewElement.style.width = "100%";
                  previewElement.style.borderRadius = "6px";
                } else if (k.url.match(/\.(mp4|webm)$/i)) {
                  previewElement = document.createElement("video");
                  previewElement.controls = true;
                  previewElement.style.width = "100%";
                  const source = document.createElement("source");
                  source.src = k.url;
                  previewElement.appendChild(source);
                } else if (k.url.match(/\.pdf$/i)) {
                  previewElement = document.createElement("iframe");
                  previewElement.src = k.url;
                  previewElement.style.width = "100%";
                  previewElement.style.height = "150px";
                } else {
                  previewElement = document.createElement("a");
                  previewElement.href = k.url;
                  previewElement.innerText = "Lihat Karya";
                  previewElement.target = "_blank";
                }

                const caption = document.createElement("p");
                caption.innerText = k.judul || "Tanpa Judul";
                caption.style.fontSize = "0.9rem";
                caption.style.marginTop = "0.5rem";

                const btnDelete = document.createElement("button");
                btnDelete.innerText = "üóëÔ∏è Hapus";
                btnDelete.style.marginTop = "8px";
                btnDelete.style.padding = "6px 10px";
                btnDelete.style.border = "none";
                btnDelete.style.borderRadius = "6px";
                btnDelete.style.cursor = "pointer";
                btnDelete.style.backgroundColor = "#ffe58e";
                btnDelete.style.color = "#0d2d2b";
                btnDelete.onclick = () => {
                  if (confirm("Yakin ingin menghapus karya ini?")) {
                    hapusKarya(k.id); // bukan lagi k.timestamp
                  }
                };

                wrapper.appendChild(previewElement);
                wrapper.appendChild(caption);
                wrapper.appendChild(btnDelete);
                galeri.appendChild(wrapper);
              } else {
                console.warn("‚ö†Ô∏è Invalid karya item:", k);
              }
            });
          } else {
            galeri.innerHTML = "<p>Belum ada karya diunggah.</p>";
          }
        })
        .catch(err => {
          document.getElementById("loading").innerText = "‚ùå Gagal memuat data.";
          console.error(err);
        });
    }

    // PATCHED UPLOAD SCRIPT MULAI DI SINI
    const fileInput = document.getElementById("fileInput");
    const titleInput = document.getElementById("titleInput");
    const uploadStatus = document.getElementById("uploadStatus");

    document.getElementById("uploadForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const file = fileInput.files[0];
      const title = titleInput.value;

      if (!file || !title || !cid) {
        uploadStatus.innerText = "‚ùå Lengkapi semua data!";
        return;
      }

      uploadStatus.innerText = "‚è≥ Mengunggah ke server...";

      const formData = new FormData();
      formData.append("file", file);
      formData.append("cid", cid);
      formData.append("title", title);

      try {
        const res = await fetch("https://firebase-upload-backend.onrender.com/upload", {
          method: "POST",
          body: formData
        });

        const result = await res.json();
        console.log("‚úÖ Response:", result);
        uploadStatus.innerText = result.message || "‚úÖ Berhasil!";
        if (result.url) location.reload();
      } catch (err) {
        console.error("‚ùå Upload error:", err);
        uploadStatus.innerText = "‚ùå Gagal upload: " + err.message;
      }
    });
    // Fungsi hapusKarya dipanggil dari tombol hapus karya
    async function hapusKarya(timestamp) {
      console.log("üß® Kirim hapus:", { cid, timestamp });

      if (!cid || !timestamp) {
        alert("‚ùå CID atau Timestamp kosong. Gagal menghapus.");
        return;
      }

      try {
        const res = await fetch("https://firebase-upload-backend.onrender.com/hapus-karya", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cid, timestamp }),
        });

        const result = await res.json();
        if (result.success) {
          alert("‚úîÔ∏è Karya berhasil dihapus.");
          location.reload();
        } else {
          alert("‚ùå Gagal menghapus karya.");
          console.log("üõë Backend message:", result.message || result.error);
        }
      } catch (err) {
        console.error("‚ùå Error hapus:", err);
        alert("‚ö†Ô∏è Terjadi error saat menghapus.");
      }
    }
  </script>
</body>
</html>
