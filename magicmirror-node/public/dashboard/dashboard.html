<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#e5f3ff">
  <link href="https://fonts.googleapis.com/css2?family=Forum&display=swap" rel="stylesheet">
  <style>
    /* ====== THEME DEFAULT (Login-style) ====== */
    body.theme-default {
      background: linear-gradient(to bottom right, #dff1ff, #e6f3fb);
      color: #003c5a;
    }
    .theme-default .dashboard-card {
      background: #ffffff;
      border: 1px solid #c0e7f5;
    }
    .theme-default .dashboard-card h3 {
      padding: 0 12px;
    }
    .theme-default #profileButtons button,
    .theme-default #profileNote button {
      background-color: #ffffff;
      color: #003c5a;
      border: 1px solid #c0e7f5;
    }
    .theme-default .modal-content {
      background-color: #ffffff;
      color: #003c5a;
    }
    .theme-default .badge-item span,
    .theme-default .dashboard-card p,
    .theme-default .dashboard-card li,
    .theme-default .dashboard-card ul,
    .theme-default .dashboard-card h3,
    .theme-default .dashboard-card h4,
    .theme-default #professionalContent {
      color: #003c5a;
    }
    .theme-default #galeri {
      background-color: #fff;
      border: 1px solid #c0e7f5;
    }
    .theme-default #galeri img {
      border: 1px solid #c0e7f5;
    }

    /* ====== THEME LEGACY (Fun Modern: Pink, Coral, Yellow) ====== */
    body.theme-legacy {
      background: #ffd6e0;
      color: #4b2e2e;
    }
    .theme-legacy .dashboard-card {
      background: #ffffff;
      border: 2px solid #ffb3c6;
      border-radius: 20px;
      padding: 1rem 0;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 8px rgba(255, 182, 193, 0.3);
    }

    .theme-legacy .dashboard-card h3,
    .theme-legacy .dashboard-card p,
    .theme-legacy .dashboard-card ul {
      padding-left: 12px;
      padding-right: 12px;
    }
    .theme-legacy .dashboard-card h3 {
      margin-top: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .theme-legacy #profileButtons button,
    .theme-legacy #profileNote button {
      background-color: #ffb3c6;
      color: white;
      border: none;
      font-weight: bold;
    }
    .theme-legacy .modal-content {
      background-color: #fff0f5;
      color: #4b2e2e;
    }
    .theme-legacy .badge-item span,
    .theme-legacy .dashboard-card p,
    .theme-legacy .dashboard-card li,
    .theme-legacy .dashboard-card ul,
    .theme-legacy .dashboard-card h3,
    .theme-legacy .dashboard-card h4,
    .theme-legacy #professionalContent {
      color: #4b2e2e;
    }
    .theme-legacy #galeri {
      background-color: #fffafc;
      border: 1px solid #ffb3c6;
    }
    .theme-legacy #galeri img {
      border: 1px solid #ffb3c6;
      border-radius: 8px;
    }

    /* ====== END THEME PATCH ====== */
    #menuToggle {
      position: fixed;
      top: 10px;
      right: 12px;
      z-index: 2000;
      background: none;
      border: none;
      font-size: 1.8rem;
      color: #ffe58e;
      cursor: pointer;
    }
    #dropdownMenu {
      position: fixed;
      top: 44px;
      right: 12px;
      background-color: #ffffff;
      color: #003c5a;
      border: 1px solid #ffe58e;
      border-radius: 8px;
      padding: 8px;
      display: none;
      flex-direction: column;
      z-index: 2000;
    }
    #dropdownMenu button {
      background: none;
      border: none;
      color: inherit;
      text-align: left;
      padding: 8px 12px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    #dropdownMenu button:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }
    /* Fallback: pastikan semua button dalam menu dropdown mewarisi warna dari parent */
    [id*="dropdownMenu"] button:not([style*="color"]) {
      color: inherit;
    }
    /* Hilangkan efek biru saat klik/touch pada tombol dan input */
    button:focus,
    input:focus {
      outline: none;
      box-shadow: none;
    }
    button,
    input {
      -webkit-tap-highlight-color: transparent;
    }
    body {
      font-family: 'Forum', sans-serif;
      margin: 0;
      padding: 4px;
    }
    /* body.theme-default and .theme-default ... moved to theme-legacy above */
    body.theme-queens {
      background: linear-gradient(135deg, #f6f3e8, #e8e2d0);
      color: #4b3d2a;
    }
    .theme-queens .dashboard-card {
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid #d5c9a4;
    }

    .judul-badge-fix {
      margin: 1rem 3px 0.5rem 3px;
    }
    .judul-galeri-fix {
      margin: 0.5rem 3px 0.5rem 3px;
    }
    .theme-legacy .judul-galeri-fix {
      margin-top: 1rem;
    }
    .theme-queens #profileButtons button,
    .theme-queens #profileNote button {
      background-color: #f6f3e8;
      color: #4b3d2a;
      border: 1px solid #d5c9a4;
    }
    .theme-queens .modal-content {
      background-color: #fffdf6;
      color: #4b3d2a;
    }
    .theme-queens .badge-item span {
      color: #4b3d2a;
    }
    .theme-queens .dashboard-card p,
    .theme-queens .dashboard-card li,
    .theme-queens .dashboard-card ul,
    .theme-queens .dashboard-card h3,
    .theme-queens .dashboard-card h4 {
      color: #4b3d2a;
    }
    .theme-queens #professionalContent {
      color: #4b3d2a;
    }
    .theme-queens #galeri {
      background-color: #fff;
      border: 1px solid #ffe58e;
    }
    .theme-queens #galeri img {
      border: 1px solid #ffe58e;
    }
    /* theme-icoding: iCoding visual style */
    body.theme-icoding {
      background: #f6f3e8;
      color: #4b3d2a;
    }
    .theme-icoding .dashboard-card {
      background: #fffdf6;
      border: 1px solid #d5c9a4;
    }
    .theme-icoding #profileButtons button,
    .theme-icoding #profileNote button {
      background-color: #fffdf6;
      color: #4b3d2a;
      border: 1px solid #d5c9a4;
    }
    .theme-icoding .modal-content {
      background-color: #fffdf6;
      color: #4b3d2a;
    }
    .theme-icoding .badge-item span,
    .theme-icoding .dashboard-card p,
    .theme-icoding .dashboard-card li,
    .theme-icoding .dashboard-card ul,
    .theme-icoding .dashboard-card h3,
    .theme-icoding .dashboard-card h4,
    .theme-icoding #professionalContent {
      color: #4b3d2a;
    }
    .theme-icoding #galeri {
      background-color: #fff;
      border: 1px solid #d5c9a4;
    }
    .theme-icoding #galeri img {
      border: 1px solid #d5c9a4;
    }
    .container {
      max-width: 100%;
      margin: auto;
      background-color: rgba(255,255,255,0.05);
      padding: 0px;
      padding-top: 12px;
      border-radius: 12px;
      overflow-x: visible;
    }
    /* Tambahkan padding-bottom agar dashboard tidak tertutup bottom navbar */
    #dashboard {
      padding-bottom: 60px;
    }
    .dashboard-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,229,142,0.15);
      border-radius: 16px;
      padding: 0.5rem 0;
      margin-bottom: 1.5rem;
      overflow: visible;
    }
    #profileHeader {
      text-align: center;
      margin-bottom: 1.5rem;
      margin-top: 8px;
      padding-top: 6px;
    }
    #profileHeader img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ffe58e;
    }
    /* Reduce spacing between lines in #profileBio */
    #profileBio p {
      margin: 2px 0;
      line-height: 1.2;
    }
    /* Reduce vertical padding for the badge card and set smaller margin-bottom */
    #badgeCard {
      padding: 1rem 0;
      margin-bottom: 0.5rem;
      overflow: visible;
    }
    
    #profileName {
      font-size: 1.2rem;
      font-weight: bold;
      margin-top: 0.5rem;
    }
    #profileStats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5rem;
      padding: 0 5px;
      text-align: center;
      width: 100%;
    }
    #profileStats div {
      flex: 1;
      font-size: 0.9rem;
      text-align: center;
    }
    #profileStats div:nth-child(1) {
      text-align: center;
      margin-left: -5px;
    }
    #profileStats div:nth-child(2) {
      text-align: center;
    }
    #profileStats div:nth-child(3) {
      text-align: center;
      margin-right: 0;
      margin-left: -2px;
    }
    #profileButtons {
      display: flex;
      justify-content: space-around;
      margin-top: 1rem;
    }
    #profileButtons button {
      flex: 1;
      margin: 0 5px;
      padding: 8px 0;
      border-radius: 10px;
      border: 1px solid #ffe58e;
      background: transparent;
      color: #ffe58e;
      font-weight: bold;
      cursor: pointer;
    }
    #profileNote {
      background-color: rgba(255,255,255,0.05);
      padding: 0.5rem;
      font-size: 0.85rem;
      margin-top: 1rem;
      border-radius: 8px;
      text-align: center;
      color: #ccc;
    }
    #professionalContent {
      display: none;
      transition: all 0.3s ease;
    }
    #galeri {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1px;
      border: none;
      padding: 0;
      box-sizing: border-box;
    }
    #galeriCard {
      margin-top: 0.5rem;
      padding-bottom: 1rem;
    }

    /* MODAL FULLSCREEN KARYA */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal-content {
      position: relative;
      background-color: #0d2d2b;
      padding: 1rem;
      border-radius: 12px;
      max-width: 90%;
      max-height: 90%;
      text-align: center;
    }
    .modal-content img, .modal-content video, .modal-content iframe {
      max-width: 100%;
      max-height: 60vh;
      margin-bottom: 1rem;
    }
    .modal-actions {
      display: flex;
      justify-content: space-around;
      gap: 10px;
      margin-top: 1rem;
    }
    .modal-actions button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 0.95rem;
      font-weight: bold;
      border: none;
      background-color: #ffe58e;
      color: #0d2d2b;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .modal-actions button:hover {
      background-color: #ffda75;
    }
    .kelas-option {
      background-color: rgba(255, 255, 255, 0.06);
      color: #ffe58e;
      border: 1px solid rgba(255, 229, 142, 0.3);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
      width: 100%;
      display: block;
    }
    .kelas-option:hover {
      background-color: rgba(255, 229, 142, 0.15);
    }
    .modal-close {
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 1.5rem;
      color: #fff;
      cursor: pointer;
    }
    .karya-card {
      background-color: transparent;
      border: none;
      padding: 0;
      margin: 0;
      border-radius: 0;
    }
    .karya-card img {
      width: 100%;
      height: auto;
      aspect-ratio: 4 / 5;
      object-fit: cover;
      border-radius: 12px;
    }
    h1, h2, h3 { color: #ffe58e; }
    #badgeList {
      display: flex;
      flex-wrap: nowrap;
      gap: 12px;
      overflow-x: auto;
      padding-left: 12px;
      padding-right: 12px;
      scroll-padding-left: 12px;
      scroll-padding-right: 12px;
      -webkit-overflow-scrolling: touch;
    }
    .badge-item {
      flex: 0 0 auto;
      text-align: center;
      overflow: visible;
      padding-top: 8px;
      padding-bottom: 8px;
    }
    .badge-item img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 50%;
      box-shadow: 0 0 6px rgba(255,255,255,0.2);
      display: block;
      margin-bottom: 4px;
    }
    #galeri img {
      width: 100%;
      height: auto;
      aspect-ratio: 4 / 5;
      object-fit: cover;
      display: block;
      border: none;
      border-radius: 0;
    }
    .badge-item span {
      display: block;
      font-size: 0.75rem;
      text-align: center;
      margin-top: 4px;
      text-align: center;
    }
    .badge-item:first-child {
      margin-left: 0;
    }
    .badge-item:last-child {
      margin-right: 0;
    }
    iframe { border: none; border-radius: 12px; }
    #uploadForm {
      max-width: 100%;
    }
    #uploadForm input[type="file"],
    #uploadForm input[type="text"],
    #uploadForm button {
      box-sizing: border-box;
      width: 100%;
      max-width: 100%;
    }
    #uploadForm input, #uploadForm button {
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    #uploadForm input {
      background-color: rgba(255,255,255,0.06);
      border: 1px solid rgba(255, 229, 142, 0.3);
      color: #ffe58e;
    }
    #uploadForm button {
      background-color: #ffe58e;
      color: #0d2d2b;
      font-weight: bold;
      cursor: pointer;
      border: none;
    }
    /* Bottom Nav Bar */
    /* Edit Profile Modal */
#editProfileModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.75);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1002;
    }
#editProfileModal .modal-content {
      background-color: #0d2d2b;
      padding: 1rem;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
    }
#editProfileModal h3 {
      margin-top: 0;
      color: #ffe58e;
    }
#editProfileModal input {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      margin-bottom: 12px;
      border: 1px solid #ffe58e;
      border-radius: 8px;
      background-color: rgba(255,255,255,0.06);
      color: #ffe58e;
    }
#editProfileModal button {
      padding: 10px 16px;
      background-color: #ffe58e;
      color: #0d2d2b;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #bottomNavBar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: inherit;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 8px 0;
      border-top: 1px solid rgba(255,255,255,0.1);
      z-index: 1001;
    }
    #bottomNavBar button {
      background: none;
      border: none;
      color: inherit;
      font-size: 1.6rem;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #bottomNavBar button img {
      width: 24px;
      height: 24px;
      object-fit: contain;
      border-radius: 0;
    }
    #bottomNavBar button:last-child img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }
    #loading {
      text-align: center;
      font-size: 1rem;
      color: #ffe58e;
      background: url('/login_illustration_blue.png') center top no-repeat;
      background-size: contain;
      padding-top: 260px;
      background-repeat: no-repeat;
    }
    .spinner {
      margin: 0 auto 1rem;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,229,142,0.3);
      border-top: 4px solid #ffe58e;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes heartBeat {
      0% { transform: scale(0.8) translate(-50%, -50%); opacity: 0; }
      25% { transform: scale(1.2) translate(-50%, -50%); opacity: 1; }
      50% { transform: scale(1) translate(-50%, -50%); opacity: 0.8; }
      75% { transform: scale(1.2) translate(-50%, -50%); opacity: 1; }
      100% { transform: scale(0.8) translate(-50%, -50%); opacity: 0; }
    }

    #heartOverlay.show {
      display: block;
      animation: heartBeat 1s ease-in-out;
    }
  </style>
</head>
<body class="theme-default">
  <!-- Hamburger Menu Toggle -->
  <button id="menuToggle" aria-label="Menu" title="Menu" style="border: 1px solid white; border-radius: 10px; background: transparent; padding: 6px; margin-top: 4px;">
    <span style="display:inline-block;vertical-align:middle;">
      <svg width="28" height="28" viewBox="0 0 28 28" style="vertical-align:middle; color: white;" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect y="6" width="28" height="3" rx="1.5" fill="currentColor"/>
        <rect y="13" width="28" height="3" rx="1.5" fill="currentColor"/>
        <rect y="20" width="28" height="3" rx="1.5" fill="currentColor"/>
      </svg>
    </span>
  </button>
  <!-- Dropdown Menu -->
  <div id="dropdownMenu">
    <button onclick="logout()">Logout</button>
    <button onclick="openChangePassword()">Ganti Password</button>
  </div>
  <div class="container">
  <script>
    // Session check: redirect to login.html if firebase_token not found
    document.addEventListener('DOMContentLoaded', function() {
      const token = localStorage.getItem("firebase_token");
      if (!token) {
        window.location.href = "/login.html";
      }
    });
    // Hamburger menu toggle for dropdown
    document.getElementById("menuToggle").addEventListener("click", function(e) {
      e.stopPropagation();
      const menu = document.getElementById("dropdownMenu");
      menu.style.display = (menu.style.display === "flex") ? "none" : "flex";
    });

    window.addEventListener("click", function(e) {
      if (!document.getElementById("menuToggle").contains(e.target) && !document.getElementById("dropdownMenu").contains(e.target)) {
        document.getElementById("dropdownMenu").style.display = "none";
      }
    });
  </script>
    <div id="loading">
      <div class="spinner"></div>
      <p>Mengunduh kecerdasan luar biasa anak Anda</p>
    </div>
    <div id="dashboard" style="display:none;">
      <div id="profileHeader" id="profileHeaderWrapper">
        <img id="profilePhoto" src="https://placehold.co/80x80" alt="Foto Anak" onclick="previewProfilePhoto()" />
        <div id="profileName">Nama Anak</div>
        <div id="profileStats">
          <div><strong id="totalPosts">0</strong><br>Posts</div>
          <div onclick="openFollowerModal()" style="cursor:pointer;"><strong id="totalFollowers">0</strong><br>Followers</div>
          <div onclick="openFollowingModal()" style="cursor:pointer;"><strong id="totalFollowing">0</strong><br>Following</div>
        </div>
        <div id="profileBio" style="margin-top: 0.5rem; font-size: 0.85rem; line-height: 1.4;">
          <p id="tipeBakat">talent: -</p>
          <p id="tipeKepribadian">personality: -</p>
        </div>
        <div id="profileButtons">
          <button>Edit Profile</button>
          <button onclick="openShareModal()">Share Profile</button>
          <!-- <button id="unfollowBtn" style="display:none;" onclick="updateFollowing(cid, false)">Unfollow</button> -->
          <button onclick="toggleTheme()">Switch Theme</button>
          <button id="followUnfollowBtn" style="display:none;">Follow</button>
        </div>
        <div id="profileNote" style="margin-bottom: 0.25rem;">
          <button onclick="toggleProfessional()" style="padding: 8px 16px;">Show / Hide Dashboard</button>
          <div id="professionalContent">
            <h2 id="namaAnak"></h2>
            <p id="usiaAnak"></p>
            <div id="sertifikatContainer"></div>
            <h4>üìã Kesimpulan</h4>
            <p id="kesimpulanAI" style="white-space: pre-wrap;"></p>
            <h4>üß† Evaluasi AI</h4>
            <div id="evaluasiAI"></div>
          </div>
        </div>
      </div>

      <div class="dashboard-card" id="badgeGaleriCard">
        <h3 class="judul-badge-fix">üèÖ Badge</h3>
        <div id="badgeList"></div>
        <h3 class="judul-galeri-fix">üé® Galeri Karya Anak</h3>
        <div id="galeri"></div>
      </div>

      <!-- Following and Explore sections removed as per instruction -->
</body>
  <div id="followingModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-close" onclick="document.getElementById('followingModal').style.display='none'">√ó</div>
      <h3>üë• Daftar Following</h3>
      <div id="modalFollowingList" style="max-height: 60vh; overflow-y: auto;"></div>
    </div>
  </div>

  <div id="followerModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-close" onclick="document.getElementById('followerModal').style.display='none'">√ó</div>
      <h3>üë• Daftar Follower</h3>
      <div id="modalFollowerList" style="max-height: 60vh; overflow-y: auto;"></div>
    </div>
  </div>


      <div class="dashboard-card">
        <h3>üìö Rekomendasi Kelas</h3>
        <ul id="rekomKelas" style="padding-left: 1.5rem;"></ul>
      </div>

      <div class="dashboard-card">
        <h3>üìù Upload Karya Anak</h3>
        <!-- Flag anti-spam upload -->
        <script>
          let sedangUpload = false;
        </script>
        <form id="uploadForm">
          <input type="file" id="fileInput" accept="image/*" required>
          <input type="text" id="titleInput" placeholder="Judul karya" required>
          <button type="submit" style="flex: 1; margin: 0 5px 1.5rem; padding: 8px 0; border-radius: 10px; border: 1px solid; background: transparent; font-weight: bold; cursor: pointer;">Upload Karya</button>
          <div id="uploadStatus"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Firebase App & Auth SDK for logout functionality -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <!-- Deklarasi global cid agar bisa digunakan di semua script setelah ini -->
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const cid = urlParams.get("cid") || localStorage.getItem("cid");
  </script>
  <script>
    function openFollowingModal() {
      const modal = document.getElementById("followingModal");
      const list = document.getElementById("modalFollowingList");
      list.innerHTML = "‚è≥ Memuat...";

      fetch(`https://firebase-upload-backend.onrender.com/proxy-following?cid=${cid}&action=getfollowing`)
        .then(r => r.json())
        .then(followingData => {
          list.innerHTML = "";
          if (!Array.isArray(followingData)) {
            if (followingData && followingData.hasOwnProperty("cid")) {
              followingData = [followingData];
            } else {
              list.innerHTML = "<p>‚ùå Gagal memuat data.</p>";
              return;
            }
          }

          if (followingData.length === 0) {
            list.innerHTML = "<p>Belum mengikuti akun lain.</p>";
            return;
          }

          followingData.forEach(user => {
            const div = document.createElement("div");
            div.style.marginBottom = "8px";
            div.innerHTML = `
              <a href="/dashboard/dashboard.html?cid=${user.cid}" style="display:flex;align-items:center;text-decoration:none;color:inherit;">
                <img src="${user.foto}" style="width:40px;height:40px;border-radius:50%;margin-right:8px;object-fit:cover;">
                <span>${user.nama}</span>
              </a>
            `;
            list.appendChild(div);
          });
        })
        .catch(err => {
          console.error("‚ùå Gagal load following:", err);
          list.innerHTML = "<p>‚ùå Gagal memuat data.</p>";
        });

      modal.style.display = "flex";
      history.pushState({ modal: "following" }, '', '#following');
    }

    function openFollowerModal() {
      const modal = document.getElementById("followerModal");
      const list = document.getElementById("modalFollowerList");
      fetch(`https://firebase-upload-backend.onrender.com/proxy-follower?cid=${cid}&action=getfollower`)
        .then(r => r.json())
        .then(data => {
          list.innerHTML = "";
          if (!Array.isArray(data)) return list.innerHTML = "<p>‚ùå Gagal muat data.</p>";
          data.forEach(user => {
            const div = document.createElement("div");
            div.style.marginBottom = "8px";
            div.innerHTML = `
              <a href="/dashboard/dashboard.html?cid=${user.cid}" style="display:flex;align-items:center;text-decoration:none;color:inherit;">
                <img src="${user.foto}" style="width:40px;height:40px;border-radius:50%;margin-right:8px;object-fit:cover;">
                <span>${user.nama}</span>
              </a>
            `;
            list.appendChild(div);
          });
        });
      modal.style.display = "flex";
      // Tambahkan pushState untuk modal follower
      history.pushState({ modal: "follower" }, '', '#follower');
    }

    // Fungsi untuk close modal saat tekan tombol Back (popstate)
    window.addEventListener("popstate", function (event) {
      const followingModal = document.getElementById("followingModal");
      const followerModal = document.getElementById("followerModal");
      if (followingModal && followingModal.style.display === "flex") {
        followingModal.style.display = "none";
        history.replaceState(null, '', location.pathname + location.search);
      }
      if (followerModal && followerModal.style.display === "flex") {
        followerModal.style.display = "none";
        history.replaceState(null, '', location.pathname + location.search);
      }
    });
    const firebaseConfig = {
      apiKey: "AIzaSyAy70WBTa9zWkFi49WhXLGnJYRbLVb6n8A",
      authDomain: "socmed-karya-anak.firebaseapp.com",
      projectId: "socmed-karya-anak",
      storageBucket: "socmed-karya-anak.firebasestorage.app",
      messagingSenderId: "903463596001",
      appId: "1:903463596001:web:9f994ac58fc6b7d6e6eca0",
      measurementId: "G-9FKWHFXNGM"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
  </script>
  <!-- Validasi login: redirect ke login jika tidak ada ?cid di URL, simpan/baca dari localStorage -->
  <script>
    // Pastikan validasi session & cid dilakukan setelah DOM siap
    document.addEventListener("DOMContentLoaded", function () {
      const urlParams = new URLSearchParams(window.location.search);
      let cid = urlParams.get("cid");

      if (cid) {
        localStorage.setItem("cid", cid);
      } else {
        cid = localStorage.getItem("cid");
      }

      const cid_login = localStorage.getItem("cid_login");
      const isOwner = (cid && cid_login && cid === cid_login);
      // Hide profileButtons at initial load, will be shown after isOwner validation
      const profileButtons = document.getElementById("profileButtons");
      if (profileButtons) profileButtons.style.display = "none";

      // Validasi session login: redirect jika tidak ada cid atau firebase_token
      if (!cid || !localStorage.getItem("firebase_token")) {
        alert("‚ö†Ô∏è Anda belum login atau session habis.");
        window.location.href = "/login.html";
      }

      // Simpan ke global agar bisa diakses script lain
      window.cid = cid;
      window.cid_login = cid_login;
      window.isOwner = isOwner;
      window.profileButtons = profileButtons;
      window.data = {};
    });
  </script>
  
  <script>
    // Edit Profile Modal logic
    document.addEventListener("DOMContentLoaded", function() {
      const editBtn = document.querySelector('#profileButtons button');
      if (editBtn) {
        editBtn.onclick = () => {
          document.getElementById("editProfileModal").style.display = "flex";
          document.getElementById("editNama").value = document.getElementById("profileName").innerText;
          document.getElementById("editUsia").value = document.getElementById("usiaAnak").innerText.replace("Usia: ", "");
          
        };
      }
    });

    function simpanProfil() {
      const nama = document.getElementById("editNama").value.trim();
      const usia = document.getElementById("editUsia").value.trim();
      const fotoFile = document.getElementById("editFotoFile").files[0];

      if (nama) {
        document.getElementById("profileName").innerText = nama;
        document.getElementById("namaAnak").innerText = nama;
      }
      if (usia) {
        document.getElementById("usiaAnak").innerText = "Usia: " + usia;
      }

      if (fotoFile) {
        const reader = new FileReader();
        reader.onload = async function (e) {
          const base64Image = e.target.result;
          document.querySelector("#profileHeader img").src = base64Image;

          try {
            const response = await fetch("https://firebase-upload-backend.onrender.com/update-profil", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                action: "updateProfile",
                cid,
                nama,
                usia,
                foto: base64Image
              })
            });
            const result = await response.json();
            console.log("üì∏ Profil updated:", result);
          } catch (err) {
            console.error("‚ùå Error updating profile:", err);
          }
        };
        reader.readAsDataURL(fotoFile);
      } else {
        fetch("https://script.google.com/macros/s/AKfycbx5cPx2YQzYLbjMzFJPwIEr_bMsm4VGB8OA-04p33hnuXK61Mm36U04W3IrihbsIDukhw/exec", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "updateProfile",
            cid,
            nama,
            usia
          })
        });
      }

      document.getElementById("editProfileModal").style.display = "none";
    }

    function previewProfilePhoto() {
      const img = document.getElementById("profilePhoto").src;
      document.getElementById("profilePreviewImg").src = img;
      document.getElementById("profilePhotoModal").style.display = "flex";
    }

    function closeProfilePhotoModal() {
      document.getElementById("profilePhotoModal").style.display = "none";
    }

    // urlParams dan cid sudah dideklarasikan di atas
    if (cid && history.state === null) {
      history.replaceState({ modal: null }, '', location.href);
    }
    const API_URL = "https://firebase-upload-backend.onrender.com/proxy-getprofile";
    // Objek katalogKelas
    const katalogKelas = {
      "Craft & Coding": {
        usia: "4‚Äì6 tahun",
        deskripsi: "Latih motorik & imajinasi anak dengan coding lewat kerajinan digital & fisik.",
        link: "https://wa.me/6282125896546?text=Halo%20Admin%20Queen's%20Academy,%20saya%20ingin%20tanya%20detail%20tentang%20kelas%20Craft%20&%20Coding."
      },
      "Digital Literacy Foundations": {
        usia: "4‚Äì6 tahun",
        deskripsi: "Pengenalan komputer dan teknologi untuk anak usia dini.",
        link: "https://wa.me/6282125896546?text=Halo%20Admin%20Queen's%20Academy,%20saya%20ingin%20tanya%20detail%20tentang%20kelas%20Digital%20Literacy%20Foundations."
      },
      "Digital Creativity": {
        usia: "4‚Äì6 tahun",
        deskripsi: "Eksplorasi karya digital untuk menyalurkan ide kreatif anak.",
        link: "https://wa.me/6282125896546?text=Halo%20Admin%20Queen's%20Academy,%20saya%20ingin%20tanya%20detail%20tentang%20kelas%20Digital%20Creativity."
      },
      "Robotics Junior": {
        usia: "7‚Äì9 tahun",
        deskripsi: "Dasar-dasar robotika dan pemrograman untuk anak SD.",
        link: "https://wa.me/6282125896546?text=Halo%20Admin%20Queen's%20Academy,%20saya%20ingin%20tanya%20detail%20tentang%20kelas%20Robotics%20Junior."
      },
      "Game Coding Kids": {
        usia: "7‚Äì12 tahun",
        deskripsi: "Belajar membuat game sederhana dengan pemrograman visual.",
        link: "https://wa.me/6282125896546?text=Halo%20Admin%20Queen's%20Academy,%20saya%20ingin%20tanya%20detail%20tentang%20kelas%20Game%20Coding%20Kids."
      }
    };

    function getDriveImageUrlFromRaw(rawUrl) {
      try {
        const idMatch = rawUrl.match(/\/d\/([a-zA-Z0-9_-]+)|id=([a-zA-Z0-9_-]+)/);
        const fileId = idMatch ? (idMatch[1] || idMatch[2]) : null;
        return fileId ? `https://drive.google.com/uc?export=view&id=${fileId}` : rawUrl;
      } catch (err) {
        console.warn("‚ö†Ô∏è Gagal parsing link gambar:", rawUrl, err);
        return rawUrl;
      }
    }

    if (!cid) {
      document.getElementById("loading").innerText = "‚ùå CID tidak ditemukan di URL.";
    } else {
      fetch(`${API_URL}?cid=${cid}`, { cache: "no-store" })
        .then(res => res.json())
        .then(res => {
          data = res;
          const userRole = res.role || "";
          const isModerator = userRole === "moderator";
// Fungsi global untuk update following (follow/unfollow)
async function updateFollowing(targetCid, isFollow = true) {
  try {
    const currentCid = localStorage.getItem("cid_login");
    if (!currentCid) return alert("Session habis.");

    // Ambil data following dari GAS untuk akun saat ini
    const res = await fetch(`https://firebase-upload-backend.onrender.com/proxy-following?cid=${currentCid}&action=getfollowing`);
    let currentFollowing = await res.json();
    if (!Array.isArray(currentFollowing)) currentFollowing = [];

    // Tambah atau hapus targetCid
    if (isFollow && !currentFollowing.map(u => typeof u === "object" ? u.cid : u).includes(targetCid)) {
      currentFollowing.push(targetCid);
    } else if (!isFollow) {
      currentFollowing = currentFollowing.filter(u => (typeof u === "object" ? u.cid : u) !== targetCid);
    }

    const followingList = currentFollowing.map(u => typeof u === "object" ? u.cid : u);

    await fetch(`https://firebase-upload-backend.onrender.com/update-following`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ cid: currentCid, followingList })
    });

    alert(isFollow ? "‚úÖ Diikuti" : "‚ùå Dihapus dari daftar");
    location.reload();
  } catch (err) {
    console.error("‚ùå Gagal update following:", err);
    alert("‚ö†Ô∏è Gagal memperbarui daftar.");
  }
}
          // Eksplorasi akun lain
          // Ambil daftar following global agar bisa digunakan di Explore
          let followList = [];
          fetch(`https://firebase-upload-backend.onrender.com/proxy-following?cid=${cid}&action=getfollowing`)
            .then(r => r.json())
            .then(followingData => {
              if (Array.isArray(followingData)) {
                followList = followingData.map(u => u.cid);
              }
            })
            .finally(() => {
              fetch("https://firebase-upload-backend.onrender.com/proxy-following?cid=all&action=getfollowing")
                .then(r => r.json())
                .then(allUsers => {
                  const explore = document.getElementById("exploreList");
                  if (!explore) return;
                  explore.innerHTML = "";
                  // PATCH: handle both array and single object (getprofile)
                  if (!Array.isArray(allUsers)) {
                    if (allUsers && allUsers.hasOwnProperty("cid")) {
                      allUsers = [allUsers]; // Konversi jadi array jika hanya 1 user
                    } else {
                      console.error("‚ùå Data explore bukan array:", allUsers);
                      const el = document.getElementById("exploreList");
                      if (el) el.innerText = "‚ùå Gagal memuat data.";
                      return;
                    }
                  }
                  allUsers.forEach(user => {
                    if (user.cid !== cid) {
                      const div = document.createElement("div");
                      div.style.marginBottom = "8px";
                      div.style.display = "flex";
                      div.style.alignItems = "center";
                      div.innerHTML = `
                        <a href="/dashboard/dashboard.html?cid=${user.cid}" style="display:flex;align-items:center;text-decoration:none;color:inherit;">
                          <img src="${user.foto}" style="width:40px;height:40px;border-radius:50%;margin-right:8px;object-fit:cover;">
                          <span>${user.nama}</span>
                        </a>
                      `;
                      // Tambahkan tombol Follow jika isOwner dan belum di-follow
                      if (isOwner && !followList.includes(user.cid)) {
                        const button = document.createElement("button");
                        button.innerText = "Follow";
                        button.style.marginLeft = "auto";
                        button.style.padding = "4px 10px";
                        button.style.fontSize = "0.8rem";
                        button.style.borderRadius = "6px";
                        button.style.cursor = "pointer";
                        button.style.border = "1px solid #ffe58e";
                        button.style.background = "transparent";
                        button.style.color = "#ffe58e";
                        button.onclick = () => updateFollowing(user.cid, true);
                        div.appendChild(button);
                      }
                      explore.appendChild(div);
                    }
                  });
                })
                .catch(err => {
                  console.error("‚ùå Gagal memuat daftar akun:", err);
                  const el = document.getElementById("exploreList");
                  if (el) el.innerText = "‚ùå Gagal memuat data.";
                });
            });

          // Segera sembunyikan loading dan tampilkan dashboard setelah data profil dasar berhasil di-render
          document.getElementById("loading").style.display = "none";
          document.getElementById("dashboard").style.display = "block";
          // PATCH: Ambil daftar following akun login (async function)
          let loginFollowingCIDs = [];

          async function fetchLoginFollowing() {
            try {
              const res = await fetch(`https://firebase-upload-backend.onrender.com/proxy-following?cid=${cid_login}&action=getfollowing`);
              const dataLogin = await res.json();
              if (Array.isArray(dataLogin)) {
                loginFollowingCIDs = dataLogin.map(u => typeof u === "object" ? u.cid : u);
              } else if (typeof dataLogin === "object" && dataLogin.cid) {
                loginFollowingCIDs = [dataLogin.cid];
              } else {
                loginFollowingCIDs = [];
              }
            } catch (err) {
              console.error("‚ùå Gagal mengambil following user login:", err);
            }
          }

          // Pastikan fetchLoginFollowing dipanggil dan selesai sebelum render tombol follow/unfollow user target
          (async function() {
            await fetchLoginFollowing();
            // After fetchLoginFollowing, show profileButtons (for both owner and not owner, will hide children below if needed)
            if (profileButtons) profileButtons.style.display = "flex";
            if (!isOwner) {
              // Sembunyikan semua tombol kecuali Follow/Unfollow
              Array.from(profileButtons.children).forEach(btn => {
                if (btn.id !== "followUnfollowBtn") btn.style.display = "none";
              });

              // Sembunyikan upload dan dashboard section hanya jika bukan owner
              const uploadForm = document.getElementById("uploadForm");
              if (uploadForm) uploadForm.style.display = "none";

              const profileNote = document.getElementById("profileNote");
              if (profileNote) profileNote.style.display = "none";

              const profileNoteBtn = document.querySelector('#profileNote button');
              if (profileNoteBtn) profileNoteBtn.style.display = "none";

              // Tampilkan tombol Follow/Unfollow sesuai status follow
              const followUnfollowBtn = document.getElementById("followUnfollowBtn");
              // Validasi agar loginFollowingCIDs sudah terisi sebelum digunakan
              const isFollowed = loginFollowingCIDs && loginFollowingCIDs.length > 0 ? loginFollowingCIDs.includes(cid) : false;

              followUnfollowBtn.innerText = isFollowed ? "Unfollow" : "Follow";
              followUnfollowBtn.dataset.isFollowed = isFollowed;
              followUnfollowBtn.onclick = async () => {
                const currentlyFollowed = followUnfollowBtn.dataset.isFollowed === "true";
                await updateFollowing(cid, !currentlyFollowed);
              };
              followUnfollowBtn.style.display = "inline-block";
              followUnfollowBtn.style.position = "relative";
              followUnfollowBtn.style.zIndex = "10";
            }
          })();

          document.getElementById("namaAnak").innerText = data.nama || "-";
          document.getElementById("profileName").innerText = data.nama || "-";
          if (data.foto && typeof data.foto === "string") {
            document.querySelector("#profileHeader img").src = data.foto;
          }
          if (isOwner && data.foto && typeof data.foto === "string") {
            document.querySelector("#bottomNavBar button:last-child img").src = data.foto;
          }
          document.getElementById("totalPosts").innerText = data.karya ? data.karya.length : 0;
          // Ganti cara update followers/following dengan fetch API baru
          fetch(`https://firebase-upload-backend.onrender.com/proxy-following?cid=${cid}&action=getfollowing`)
            .then(res => res.json())
            .then(following => {
              document.getElementById("totalFollowing").innerText = Array.isArray(following) ? following.length : 0;
            });

          fetch(`https://firebase-upload-backend.onrender.com/proxy-follower?cid=${cid}&action=getfollower`)
            .then(res => res.json())
            .then(follower => {
              document.getElementById("totalFollowers").innerText = Array.isArray(follower) ? follower.length : 0;
            });
          document.getElementById("usiaAnak").innerText = `Usia: ${data.usia || "-"}`;
          document.getElementById("kesimpulanAI").innerText = data.kesimpulan || "-";
          document.getElementById("tipeBakat").innerText = `Talent: ${data.tipe_bakat || "-"}`;
          document.getElementById("tipeKepribadian").innerText = `Personality: ${data.tipe_kepribadian || "-"}`;

          const sertifikatEl = document.getElementById("sertifikatContainer");
          if (
            data.sertifikat &&
            typeof data.sertifikat === "string" &&
            data.sertifikat.match(/drive\.google\.com\/.*\/view/)
          ) {
            sertifikatEl.innerHTML = `<iframe src="${data.sertifikat.replace("/view", "/preview")}" width="100%" height="480" loading="lazy" allowfullscreen></iframe>`;
          } else {
            sertifikatEl.innerHTML = "<p>Sertifikat belum tersedia atau tautan salah.</p>";
          }


          const evaluasiEl = document.getElementById("evaluasiAI");
          if (data.evaluasi && data.evaluasi.length > 0) {
            data.evaluasi.forEach(e => {
              const p = document.createElement("p");
              p.innerText = `${e.komponen}: ${e.analisis}`;
              evaluasiEl.appendChild(p);
            });
          } else {
            evaluasiEl.innerHTML = "<p>Tidak ada evaluasi ditemukan.</p>";
          }

          const badgeEl = document.getElementById("badgeList");
          if (data.tipe_bakat && typeof data.tipe_bakat === "string") {
            const badgeMap = {
              "Imajinatif": "badge_imajinatif.png",
              "Logika": "badge_logika.png",
              "Verbal": "badge_verbal.png",
              "Sosial": "badge_sosial.png",
              "Multi": "badge_multitalenta.png"
            };

            // Tambahkan badge manual "New" sebelum loop badgeMap
            const tambahBadge = document.createElement("div");
            tambahBadge.classList.add("badge-item");
            tambahBadge.innerHTML = `
              <img src="https://img.icons8.com/ios-filled/50/ffe58e/plus-math.png" tabindex="-1" style="background: rgba(255,255,255,0.06); padding:10px; width: 60px; height: 60px; border-radius: 50%; object-fit: contain; cursor: pointer;" onclick="openKelasOptions()" />
              <span>New</span>
            `;
            badgeEl.appendChild(tambahBadge);

            Object.keys(badgeMap).forEach(kata => {
              if (data.tipe_bakat.includes(kata)) {
                const wrapper = document.createElement("div");
                wrapper.classList.add("badge-item");
                wrapper.innerHTML = `
                  <img src="/badges/${badgeMap[kata]}" alt="${kata}">
                  <span>${kata}</span>
                `;
                badgeEl.appendChild(wrapper);
              }
            }); 
          } else {
            badgeEl.innerHTML = "<p>Belum ada badge yang cocok.</p>";
          }


          const kelasEl = document.getElementById("rekomKelas");
          if (data.rekomendasi && data.rekomendasi.length > 0) {
            data.rekomendasi.forEach(r => {
              const li = document.createElement("li");
              li.innerText = r;
              kelasEl.appendChild(li);
            });
          } else {
            kelasEl.innerHTML = "<li>Tidak ada rekomendasi kelas.</li>";
          }

          // PATCHED GALLERY WITH PREVIEW + DELETE + MODAL
          const galeri = document.getElementById("galeri");
          if (data.karya && data.karya.length > 0) {
            galeri.innerHTML = ""; // Bersihkan isi awal

            data.karya.forEach(k => {
              if (k && k.url && typeof k.url === "string") {
                const wrapper = document.createElement("div");
                wrapper.className = "karya-card";
                wrapper.style.border = "none";
                wrapper.style.padding = "0";
                wrapper.style.margin = "0";
                wrapper.style.maxWidth = "100%";
                wrapper.style.backgroundColor = "transparent";
                wrapper.style.textAlign = "left";

                let previewElement;
                if (k.url.match(/\.(jpg|jpeg|png|gif)$/i)) {
                  previewElement = document.createElement("img");
                  previewElement.src = k.url;
                  previewElement.style.width = "100%";
                  previewElement.style.height = "100%";
                  previewElement.style.objectFit = "cover";
                  previewElement.style.aspectRatio = "4 / 5";
                } else if (k.url.match(/\.(mp4|webm)$/i)) {
                  previewElement = document.createElement("video");
                  previewElement.controls = true;
                  previewElement.style.width = "100%";
                  previewElement.style.height = "100%";
                  previewElement.style.objectFit = "cover";
                  previewElement.style.aspectRatio = "4 / 5";
                  const source = document.createElement("source");
                  source.src = k.url;
                  previewElement.appendChild(source);
                } else if (k.url.match(/\.pdf$/i)) {
                  previewElement = document.createElement("iframe");
                  previewElement.src = k.url;
                  previewElement.style.width = "100%";
                  previewElement.style.height = "150px";
                } else {
                  previewElement = document.createElement("a");
                  previewElement.href = k.url;
                  previewElement.innerText = "Lihat Karya";
                  previewElement.target = "_blank";
                }

                // Modal open on click
                wrapper.onclick = () => openModal(k);

                // Tambahkan tombol hapus jika moderator
                if (isModerator) {
                  const btnDelete = document.createElement("button");
                  btnDelete.innerText = "üóëÔ∏è";
                  btnDelete.style.position = "absolute";
                  btnDelete.style.top = "6px";
                  btnDelete.style.right = "6px";
                  btnDelete.style.backgroundColor = "#ffe58e";
                  btnDelete.style.color = "#0d2d2b";
                  btnDelete.style.border = "none";
                  btnDelete.style.borderRadius = "50%";
                  btnDelete.style.padding = "4px 8px";
                  btnDelete.style.cursor = "pointer";
                  btnDelete.title = "Hapus Karya";
                  btnDelete.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm("Yakin ingin menghapus karya ini?")) {
                      hapusKarya(k.id_karya);
                    }
                  };
                  wrapper.style.position = "relative";
                  wrapper.appendChild(btnDelete);
                }

                wrapper.appendChild(previewElement);
                galeri.appendChild(wrapper);
              } else {
                console.warn("‚ö†Ô∏è Invalid karya item:", k);
              }
            });
          } else {
            galeri.innerHTML = "<p>Belum ada karya diunggah.</p>";
          }
        })
        .catch(err => {
          document.getElementById("loading").innerText = "‚ùå Gagal memuat data.";
          console.error(err);
        });

    // MODAL FULLSCREEN KARYA (dipindahkan ke global)
    let currentModalKarya = null;

    function openModal(karya) {
      currentModalKarya = karya;
      const modal = document.getElementById("karyaModal");
      const container = document.getElementById("modalMedia");
      container.innerHTML = "";

      let media;
      if (karya.url.match(/\.(jpg|jpeg|png|gif)$/i)) {
        media = document.createElement("img");
        media.src = karya.url;
      } else if (karya.url.match(/\.(mp4|webm)$/i)) {
        media = document.createElement("video");
        media.src = karya.url;
        media.controls = true;
      } else if (karya.url.match(/\.pdf$/i)) {
        media = document.createElement("iframe");
        media.src = karya.url;
      } else {
        media = document.createElement("a");
        media.href = karya.url;
        media.innerText = "Lihat Karya";
        media.target = "_blank";
      }

      container.appendChild(media);
      modal.style.display = "flex";
    }

    // Fungsi untuk tombol ‚ûï pada rekomendasi kelas - DIPINDAHKAN KE GLOBAL
    function openKelasOptions(kelas = null) {
      const modal = document.getElementById("kelasModal");
      const titleEl = document.getElementById("kelasModalTitle");
      const contentEl = document.getElementById("kelasModalContent");

      if (!kelas) {
        // Tambahkan pushState untuk daftar kelas
        history.pushState({ modal: 'kelasList' }, '', '#kelas');
        titleEl.innerText = "üìö Pilih Kelas";
        contentEl.innerHTML = "";
        Object.keys(katalogKelas).forEach(k => {
          const btn = document.createElement("button");
          btn.innerText = k;
          btn.className = "kelas-option";
          btn.onclick = () => openKelasOptions(k);
          contentEl.appendChild(btn);
        });
        // Tambahkan tombol Upload Karya di bawah daftar kelas
        const uploadBtn = document.createElement("button");
        uploadBtn.innerText = "üì§ Upload Karya";
        uploadBtn.className = "kelas-option";
        uploadBtn.onclick = () => {
          contentEl.innerHTML = `
            <button onclick="openKelasOptions()" style="position:absolute; top:8px; left:12px; background:none; border:none; color:#ffe58e; font-weight:bold; font-size:1.2rem; cursor:pointer; z-index:1000;">‚¨ÖÔ∏è</button>
            <form id="modalUploadForm" style="margin-top: 1rem;">
              <input type="file" id="modalFileInput" accept="image/*" required>
              <input type="text" id="modalTitleInput" placeholder="Judul Karya" required>
              <button type="submit">üì§ Upload</button>
              <div id="modalUploadStatus"></div>
            </form>
          `;

          document.getElementById("modalUploadForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            const file = document.getElementById("modalFileInput").files[0];
            const title = document.getElementById("modalTitleInput").value;
            const status = document.getElementById("modalUploadStatus");

            if (!file || !title || !cid) {
              status.innerText = "‚ùå Lengkapi semua data!";
              return;
            }

            status.innerText = "‚è≥ Mengunggah ke server...";
            const formData = new FormData();
            formData.append("file", file);
            formData.append("cid", cid);
            formData.append("title", title);

            try {
              const res = await fetch("https://firebase-upload-backend.onrender.com/upload", {
                method: "POST",
                body: formData
              });
              const result = await res.json();
              status.innerText = result.message || "‚úÖ Berhasil!";
              if (result.url) location.reload();
            } catch (err) {
              console.error("‚ùå Upload error:", err);
              status.innerText = "‚ùå Gagal upload: " + err.message;
            }
          });
        };
        contentEl.appendChild(uploadBtn);
        modal.style.display = "flex";
        return;
      }

      // Tambahkan pushState untuk detail kelas
      history.pushState({ modal: 'kelasDetail', kelas }, '', '#kelas');

      const info = katalogKelas[kelas];
      if (!info) return;

      titleEl.innerText = `üìö ${kelas}`;
      contentEl.innerHTML = `
        <button onclick="openKelasOptions()" style="position:absolute; top:8px; left:12px; background:none; border:none; color:#ffe58e; font-weight:bold; font-size:1.2rem; cursor:pointer; z-index:1000;">‚¨ÖÔ∏è</button>
        <p><strong>Usia:</strong> ${info.usia}</p>
        <p><strong>Deskripsi:</strong><br>${info.deskripsi}</p>
      `;

      // Optional: set the main upload form's title to kelas for convenience
      if (document.getElementById("titleInput")) {
        document.getElementById("titleInput").value = kelas;
      }
      modal.style.display = "flex";
    }

    function closeKelasModal() {
      document.getElementById("kelasModal").style.display = "none";
    }

    // Handler popstate untuk navigasi modal kelas
    window.onpopstate = function(event) {
      if (event.state && event.state.modal === 'kelasDetail') {
        openKelasOptions(); // kembali ke daftar kelas
      } else {
        closeKelasModal(); // tutup modal sepenuhnya
      }
    };

    function openWhatsAppDetail() {
      const adminWA = "6282125896546";
      const message = encodeURIComponent("Halo Admin Queen's Academy, saya ingin tanya detail tentang kelas ini.");
      window.open(`https://wa.me/${adminWA}?text=${message}`, "_blank");
    }

      // Share Profile Modal Functions
    function openShareModal() {
      const name = document.getElementById("profileName").innerText || "anak";
      const handle = `@${name.toLowerCase().replace(/\s+/g, "")}`;
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${window.location.href}`;

      document.getElementById("qrCodeImg").src = qrUrl;
      document.getElementById("shareHandle").innerText = handle;
      document.getElementById("shareModal").style.display = "flex";
    }

    function closeShareModal() {
      document.getElementById("shareModal").style.display = "none";
    }

    function copyProfileLink() {
      navigator.clipboard.writeText(window.location.href).then(() => {
        alert("üìã Link profil disalin!");
      });
    }

    function shareWhatsApp() {
      const text = `Lihat profil anakku di sini\n${window.location.href}`;
      const waUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
      window.open(waUrl, "_blank");
    }

    function closeModal() {
      document.getElementById("karyaModal").style.display = "none";
    }

    function modalLike() {
      const heart = document.getElementById("heartOverlay");
      if (!heart) return;
      heart.style.display = "block"; // Pastikan overlay tampil
      heart.classList.remove("show"); // Reset dulu
      void heart.offsetWidth; // Trigger reflow agar animasi bisa diputar ulang
      heart.classList.add("show");
      // Sembunyikan overlay setelah animasi selesai
      setTimeout(() => {
        heart.classList.remove("show");
        heart.style.display = "none";
      }, 1000);
    }
    function modalComment() {
      const comment = prompt("Tulis komentar:");
      if (comment) alert("üí¨ Komentar disimpan: " + comment);
    }
    function modalShare() {
      if (currentModalKarya && currentModalKarya.url) {
        navigator.clipboard.writeText(currentModalKarya.url).then(() => {
          alert("üì§ Link karya disalin ke clipboard!");
        });
      }
    }
    function modalDelete() {
      if (currentModalKarya && confirm("Yakin ingin menghapus karya ini?")) {
        hapusKarya(currentModalKarya.id);
        closeModal();
      }
    }
    }

    // PATCHED UPLOAD SCRIPT MULAI DI SINI
    const fileInput = document.getElementById("fileInput");
    const titleInput = document.getElementById("titleInput");
    const uploadStatus = document.getElementById("uploadStatus");

const uploadFormElement = document.getElementById("uploadForm");
if (uploadFormElement) {
  uploadFormElement.addEventListener("submit", async function (e) {
    e.preventDefault();
    if (sedangUpload) return;
    sedangUpload = true;

    const file = fileInput.files[0];
    const title = titleInput.value;
    const button = this.querySelector("button[type='submit']");

    if (!file || !title || !cid) {
      uploadStatus.innerText = "‚ùå Lengkapi semua data!";
      sedangUpload = false;
      return;
    }

    button.disabled = true;
    button.innerText = "‚è≥ Mengunggah...";

    uploadStatus.innerText = "‚è≥ Uploading...";

    const formData = new FormData();
    formData.append("file", file);
    formData.append("cid", cid);
    formData.append("title", title);

    try {
      const res = await fetch("https://firebase-upload-backend.onrender.com/upload", {
        method: "POST",
        body: formData
      });

      const result = await res.json();
      console.log("‚úÖ Response:", result);
      uploadStatus.innerText = result.message || "‚úÖ Berhasil!";
      if (result.url) location.reload();
    } catch (err) {
      console.error("‚ùå Upload error:", err);
      uploadStatus.innerText = "‚ùå Gagal upload: " + err.message;
      button.disabled = false;
      button.innerText = "Upload Karya";
      sedangUpload = false;
    }
  });
}
    // Fungsi hapusKarya dipanggil dari tombol hapus karya
    async function hapusKarya(id_karya) {
      console.log("üß® Kirim hapus:", { cid, id_karya });

      if (!cid || !id_karya) {
        alert("‚ùå CID atau ID_KARYA kosong. Gagal menghapus.");
        return;
      }

      try {
        const res = await fetch("https://firebase-upload-backend.onrender.com/hapus-karya", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cid, id_karya }),
        });

        const result = await res.json();
        if (result.success) {
          alert("‚úîÔ∏è Karya berhasil dihapus.");
          location.reload();
        } else {
          alert("‚ùå Gagal menghapus karya.");
          console.log("üõë Backend message:", result.message || result.error);
        }
      } catch (err) {
        console.error("‚ùå Error hapus:", err);
        alert("‚ö†Ô∏è Terjadi error saat menghapus.");
      }
    }

    // Bottom Nav Bar Functions
    function goHome() {
      const cid = localStorage.getItem("cid");
      if (cid) {
        window.location.href = `/dashboard/home.html?cid=${cid}`;
      } else {
        alert("‚ö†Ô∏è CID tidak ditemukan.");
      }
    }
    function goSearch() {
      alert("üîç Fitur pencarian coming soon!");
    }
    function goReels() {
      alert("üé¨ Fitur reels coming soon!");
    }
    function goProfile() {
      const cid = localStorage.getItem("cid_login");
      if (cid) {
        window.location.href = `/dashboard/dashboard.html?cid=${cid}`;
      } else {
        alert("‚ö†Ô∏è Session tidak ditemukan. Silakan login ulang.");
        window.location.href = "/login.html";
      }
    }

    // PATCHED FEED HOME RENDER POST: show nama depan atau fallback ke cid
    // Fungsi render feed post (untuk home.html, contoh implementasi)
    function renderFeedPost(post) {
      // Ambil nama depan dari post.nama jika ada, fallback ke cid jika tidak ada nama
      const namaDepan = (post.nama || post.cid || "").split(" ")[0];
      return `<div>üé® <strong>${namaDepan}</strong> baru saja mengunggah: ${post.judul}</div>`;
    }

    function toggleProfessional() {
      const content = document.getElementById("professionalContent");
      if (content.style.display === "none" || content.style.display === "") {
        content.style.display = "block";
      } else {
        content.style.display = "none";
      }
    }
    // Theme Switcher
    function toggleTheme() {
      const body = document.body;
      if (body.classList.contains("theme-icoding")) {
        body.classList.remove("theme-icoding");
        body.classList.add("theme-legacy");
        updateThemeColorMeta("#ffe3ec");
      } else if (body.classList.contains("theme-queens")) {
        body.classList.remove("theme-queens");
        body.classList.add("theme-icoding");
        updateThemeColorMeta("#f6f3e8");
      } else if (body.classList.contains("theme-default")) {
        body.classList.remove("theme-default");
        body.classList.add("theme-legacy");
        updateThemeColorMeta("#ffe3ec");
      } else {
        body.classList.remove("theme-legacy");
        body.classList.add("theme-default");
        updateThemeColorMeta("#e5f3ff");
      }
    }

    function updateThemeColorMeta(color) {
      let meta = document.querySelector("meta[name='theme-color']");
      if (!meta) {
        meta = document.createElement("meta");
        meta.name = "theme-color";
        document.head.appendChild(meta);
      }
      meta.setAttribute("content", color);
    }

    // Logout Function: hybrid (Firebase Auth + localStorage)
    function logout() {
      if (firebase?.auth) {
        firebase.auth().signOut().catch(() => {}); // attempt logout firebase
      }
      localStorage.clear(); // bersihkan semuanya
      window.location.href = "/login.html";
    }

    function openChangePassword() {
      if (confirm("Ingin login dengan akun Gmail Anda? Klik OK untuk login via Gmail.\nAtau klik Batal untuk ubah password manual.")) {
        const provider = new firebase.auth.GoogleAuthProvider();
        firebase.auth().signInWithPopup(provider)
          .then((result) => {
            const user = result.user;
            if (!user) return alert("‚ùå Login gagal.");
            alert(`‚úÖ Login berhasil: ${user.displayName}`);
            // Simpan email dan nama ke Sheets atau Firestore jika perlu
            // Dapat ditambahkan logika tambahan jika ingin update status migrated di Sheets
          })
          .catch((error) => {
            console.error("‚ùå Login Gmail error:", error);
            alert("‚ùå Gagal login Gmail.");
          });
      } else {
        // Minta email pribadi user sebelum ganti password
        // Email ini akan digunakan sebagai akun resmi di Firebase Auth
        const email = prompt("Masukkan email pribadi Anda (wajib untuk ganti password):");
        if (!email || !email.includes("@")) {
          alert("‚ö†Ô∏è Email tidak valid.");
          return;
        }
        const newPassword = prompt("Masukkan password baru:");
        if (!newPassword || newPassword.trim().length < 6) {
          alert("‚ö†Ô∏è Password harus minimal 6 karakter.");
          return;
        }
        // Cek keberadaan cid
        if (!cid) return alert("‚ùå CID tidak ditemukan, silakan login ulang.");
        // Debug log sebelum fetch
        console.log("üì§ Ganti password:", { cid, email, newPassword });
        // Kirim data ke backend: cid, email, password
        fetch("https://firebase-upload-backend.onrender.com/ganti-password", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cid, email, password: newPassword })
        })
        .then(res => res.json())
        .then(result => {
          if (result.success) {
            alert("‚úÖ Password berhasil diganti.");
          } else {
            alert("‚ùå Gagal mengganti password.");
          }
        })
        .catch(err => {
          console.error("‚ùå Error:", err);
          alert("‚ö†Ô∏è Terjadi kesalahan.");
        });
      }
    }
  </script>
  <div id="navPlaceholder"></div>
  <script>
    // Pastikan body punya class theme-default jika belum ada
    (function() {
      var body = document.body;
      if (!body.classList.contains("theme-default")) {
        body.classList.add("theme-default");
      }
    })();
    fetch('/dashboard/botnav.html')
      .then(res => res.text())
      .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // Ambil isi <style> dan append manual ke <head>
        const styles = doc.querySelectorAll('style');
        styles.forEach(style => {
          const newStyle = document.createElement('style');
          newStyle.innerHTML = style.innerHTML;
          document.head.appendChild(newStyle);
        });

        // Sisanya tempel ke navPlaceholder
        const bodyContent = doc.body || doc;
        const wrapper = document.createElement("div");
        wrapper.innerHTML = bodyContent.innerHTML;

        // Tambahkan class dashboard-botnav dan theme yang aktif pada wrapper utama (bukan ke semua elemen anak)
        const currentTheme = document.body.className || "theme-default";
        wrapper.classList.add('dashboard-botnav');
        wrapper.classList.add(currentTheme);

        document.getElementById('navPlaceholder').innerHTML = "";
        document.getElementById('navPlaceholder').appendChild(wrapper);
      });
  </script>
  <!-- Edit Profile Modal -->
  <div id="editProfileModal">
    <div class="modal-content">
      <h3>Edit Profil Anak</h3>
      <input type="text" id="editNama" placeholder="Nama Anak" />
      <input type="text" id="editUsia" placeholder="Usia Anak" />
      <input type="file" id="editFotoFile" accept="image/*" />
      <button onclick="simpanProfil()">Simpan</button>
    </div>
  </div>
  <!-- Share Profile Modal -->
  <div id="shareModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-close" onclick="closeShareModal()">√ó</div>
      <h3 id="shareHandle">@nama</h3>
      <img id="qrCodeImg" src="" alt="QR Code" style="margin:1rem auto; max-width:200px; border-radius:8px;" />
      <div class="modal-actions">
        <button onclick="copyProfileLink()">üîó Copy Link</button>
        <button onclick="shareWhatsApp()">üì≤ WhatsApp</button>
        <button onclick="alert('üîß Fitur Instagram belum tersedia')">üì∏ Instagram</button>
      </div>
    </div>
  </div>
  <!-- (Removed old script that patched badgeCard h3 inline style for badge title) -->
  <div id="heartOverlay" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1000; pointer-events:none;">
    <img src="https://img.icons8.com/emoji/96/red-heart.png" alt="Love" style="width: 96px; height: 96px; opacity: 0.8;" />
  </div>
</body>
  <div id="karyaModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-close" onclick="closeModal()">√ó</div>
      <div id="modalMedia"></div>
      <div class="modal-actions">
        <button onclick="modalLike()">‚ù§Ô∏è</button>
        <button onclick="modalComment()">üí¨</button>
        <button onclick="modalShare()">üì§</button>
        <button onclick="modalDelete()">üóëÔ∏è</button>
      </div>
    </div>
  </div>
  <div id="profilePhotoModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-close" onclick="closeProfilePhotoModal()">√ó</div>
      <img id="profilePreviewImg" src="" alt="Preview Foto Profil" style="max-width: 100%; border-radius: 12px;" />
    </div>
  </div>
  <div id="kelasModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-close" onclick="closeKelasModal()">√ó</div>
      <h3 id="kelasModalTitle">üìö Kelas</h3>
      <div id="kelasModalContent" style="text-align:left; font-size: 0.85rem; padding-top: 2rem;"></div>
      <div class="modal-actions">
        <button onclick="closeKelasModal()">‚ùå Tutup Menu</button>
        <button onclick="openWhatsAppDetail()">üì± Free Trial</button>
      </div>
    </div>
  </div>
  <script>
    // Scroll to Upload Karya Anak
    function scrollToUpload() {
      const form = document.getElementById("uploadForm");
      if (form) form.scrollIntoView({ behavior: "smooth" });
    }
  </script>
</body>
</html>

  
    
    
  
    