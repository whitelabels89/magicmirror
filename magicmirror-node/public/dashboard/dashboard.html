<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Forum&display=swap" rel="stylesheet">
  <style>
    /* Hilangkan efek biru saat klik/touch pada tombol dan input */
    button:focus,
    input:focus {
      outline: none;
      box-shadow: none;
    }
    button,
    input {
      -webkit-tap-highlight-color: transparent;
    }
    body {
      font-family: 'Forum', sans-serif;
      margin: 0;
      padding: 4px;
    }
    body.theme-default {
      background-color: #0d2d2b;
      color: #ffe58e;
    }
    body.theme-queens {
      background: linear-gradient(135deg, #f6f3e8, #e8e2d0);
      color: #4b3d2a;
    }
    .theme-queens .dashboard-card {
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid #d5c9a4;
    }
    .theme-queens #profileButtons button,
    .theme-queens #profileNote button {
      background-color: #f6f3e8;
      color: #4b3d2a;
      border: 1px solid #d5c9a4;
    }
    .theme-queens .modal-content {
      background-color: #fffdf6;
      color: #4b3d2a;
    }
    .theme-queens .badge-item span {
      color: #4b3d2a;
    }
    .theme-queens .dashboard-card p,
    .theme-queens .dashboard-card li,
    .theme-queens .dashboard-card ul,
    .theme-queens .dashboard-card h3,
    .theme-queens .dashboard-card h4 {
      color: #4b3d2a;
    }
    .theme-queens #professionalContent {
      color: #4b3d2a;
    }
    .theme-queens #galeri {
      background-color: #fff;
      border: 1px solid #ffe58e;
    }
    .theme-queens #galeri img {
      border: 1px solid #ffe58e;
    }
    .container {
      max-width: 100%;
      margin: auto;
      background-color: rgba(255,255,255,0.05);
      padding: 0px;
      padding-top: 12px;
      border-radius: 12px;
      overflow-x: visible;
    }
    .dashboard-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,229,142,0.15);
      border-radius: 16px;
      padding: 0.5rem 0;
      margin-bottom: 1.5rem;
      overflow: visible;
    }
    #profileHeader {
      text-align: center;
      margin-bottom: 1.5rem;
      margin-top: 8px;
      padding-top: 6px;
    }
    #profileHeader img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ffe58e;
    }
    /* Reduce spacing between lines in #profileBio */
    #profileBio p {
      margin: 2px 0;
      line-height: 1.2;
    }
    /* Reduce vertical padding for the badge card and set smaller margin-bottom */
    #badgeCard {
      padding: 1rem 0;
      margin-bottom: 0.5rem;
      overflow: visible;
    }
    
    #profileName {
      font-size: 1.2rem;
      font-weight: bold;
      margin-top: 0.5rem;
    }
    #profileStats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5rem;
      padding: 0 5px;
      text-align: center;
      width: 100%;
    }
    #profileStats div {
      flex: 1;
      font-size: 0.9rem;
      text-align: center;
    }
    #profileStats div:nth-child(1) {
      text-align: center;
      margin-left: -5px;
    }
    #profileStats div:nth-child(2) {
      text-align: center;
    }
    #profileStats div:nth-child(3) {
      text-align: center;
      margin-right: 0;
      margin-left: -2px;
    }
    #profileButtons {
      display: flex;
      justify-content: space-around;
      margin-top: 1rem;
    }
    #profileButtons button {
      flex: 1;
      margin: 0 5px;
      padding: 8px 0;
      border-radius: 10px;
      border: 1px solid #ffe58e;
      background: transparent;
      color: #ffe58e;
      font-weight: bold;
      cursor: pointer;
    }
    #profileNote {
      background-color: rgba(255,255,255,0.05);
      padding: 0.5rem;
      font-size: 0.85rem;
      margin-top: 1rem;
      border-radius: 8px;
      text-align: center;
      color: #ccc;
    }
    #professionalContent {
      display: none;
      transition: all 0.3s ease;
    }
    #galeri {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1px;
      border: none;
      padding: 0;
      box-sizing: border-box;
    }
    #galeriCard {
      margin-top: 0.5rem;
      padding-bottom: 1rem;
    }

    /* MODAL FULLSCREEN KARYA */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal-content {
      position: relative;
      background-color: #0d2d2b;
      padding: 1rem;
      border-radius: 12px;
      max-width: 90%;
      max-height: 90%;
      text-align: center;
    }
    .modal-content img, .modal-content video, .modal-content iframe {
      max-width: 100%;
      max-height: 60vh;
      margin-bottom: 1rem;
    }
    .modal-actions {
      display: flex;
      justify-content: space-around;
      gap: 10px;
      margin-top: 1rem;
    }
    .modal-actions button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 0.95rem;
      font-weight: bold;
      border: none;
      background-color: #ffe58e;
      color: #0d2d2b;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .modal-actions button:hover {
      background-color: #ffda75;
    }
    .kelas-option {
      background-color: rgba(255, 255, 255, 0.06);
      color: #ffe58e;
      border: 1px solid rgba(255, 229, 142, 0.3);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
      width: 100%;
      display: block;
    }
    .kelas-option:hover {
      background-color: rgba(255, 229, 142, 0.15);
    }
    .modal-close {
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 1.5rem;
      color: #fff;
      cursor: pointer;
    }
    .karya-card {
      background-color: transparent;
      border: none;
      padding: 0;
      margin: 0;
      border-radius: 0;
    }
    .karya-card img {
      width: 100%;
      height: auto;
      aspect-ratio: 4 / 5;
      object-fit: cover;
      border-radius: 12px;
    }
    h1, h2, h3 { color: #ffe58e; }
    #badgeList {
      display: flex;
      flex-wrap: nowrap;
      gap: 12px;
      overflow-x: auto;
      padding-left: 12px;
      padding-right: 12px;
      scroll-padding-left: 12px;
      scroll-padding-right: 12px;
      -webkit-overflow-scrolling: touch;
    }
    .badge-item {
      flex: 0 0 auto;
      text-align: center;
      overflow: visible;
      padding-top: 8px;
      padding-bottom: 8px;
    }
    .badge-item img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 50%;
      box-shadow: 0 0 6px rgba(255,255,255,0.2);
      display: block;
      margin-bottom: 4px;
    }
    #galeri img {
      width: 100%;
      height: auto;
      aspect-ratio: 4 / 5;
      object-fit: cover;
      display: block;
      border: none;
      border-radius: 0;
    }
    .badge-item span {
      display: block;
      font-size: 0.75rem;
      text-align: center;
      margin-top: 4px;
      text-align: center;
    }
    .badge-item:first-child {
      margin-left: 0;
    }
    .badge-item:last-child {
      margin-right: 0;
    }
    iframe { border: none; border-radius: 12px; }
    #uploadForm {
      max-width: 100%;
    }
    #uploadForm input[type="file"],
    #uploadForm input[type="text"],
    #uploadForm button {
      box-sizing: border-box;
      width: 100%;
      max-width: 100%;
    }
    #uploadForm input, #uploadForm button {
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    #uploadForm input {
      background-color: rgba(255,255,255,0.06);
      border: 1px solid rgba(255, 229, 142, 0.3);
      color: #ffe58e;
    }
    #uploadForm button {
      background-color: #ffe58e;
      color: #0d2d2b;
      font-weight: bold;
      cursor: pointer;
      border: none;
    }
    /* Bottom Nav Bar */
    /* Edit Profile Modal */
#editProfileModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.75);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1002;
    }
#editProfileModal .modal-content {
      background-color: #0d2d2b;
      padding: 1rem;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
    }
#editProfileModal h3 {
      margin-top: 0;
      color: #ffe58e;
    }
#editProfileModal input {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      margin-bottom: 12px;
      border: 1px solid #ffe58e;
      border-radius: 8px;
      background-color: rgba(255,255,255,0.06);
      color: #ffe58e;
    }
#editProfileModal button {
      padding: 10px 16px;
      background-color: #ffe58e;
      color: #0d2d2b;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #bottomNavBar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #0d2d2b;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 8px 0;
      border-top: 1px solid rgba(255,255,255,0.1);
      z-index: 1001;
    }
    #bottomNavBar button {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.6rem;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #bottomNavBar button img {
      width: 24px;
      height: 24px;
      object-fit: contain;
      border-radius: 0;
    }
    #bottomNavBar button:last-child img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }
    #loading {
      text-align: center;
      padding: 2rem;
      font-size: 1rem;
      color: #ffe58e;
    }
    .spinner {
      margin: 0 auto 1rem;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,229,142,0.3);
      border-top: 4px solid #ffe58e;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes heartBeat {
      0% { transform: scale(0.8) translate(-50%, -50%); opacity: 0; }
      25% { transform: scale(1.2) translate(-50%, -50%); opacity: 1; }
      50% { transform: scale(1) translate(-50%, -50%); opacity: 0.8; }
      75% { transform: scale(1.2) translate(-50%, -50%); opacity: 1; }
      100% { transform: scale(0.8) translate(-50%, -50%); opacity: 0; }
    }

    #heartOverlay.show {
      display: block;
      animation: heartBeat 1s ease-in-out;
    }
  </style>
</head>
<body class="theme-default">
  <div class="container">
    <div id="loading">
      <div class="spinner"></div>
      <p>Mengunduh kecerdasan luar biasa anak Anda ⏳</p>
    </div>
    <div id="dashboard" style="display:none;">
      <div id="profileHeader">
        <img id="profilePhoto" src="https://placehold.co/80x80" alt="Foto Anak" onclick="previewProfilePhoto()" />
        <div id="profileName">Nama Anak</div>
        <div id="profileStats">
          <div><strong id="totalPosts">0</strong><br>Posts</div>
          <div><strong>1M</strong><br>Followers</div>
          <div><strong>2</strong><br>Following</div>
        </div>
        <div id="profileBio" style="margin-top: 0.5rem; font-size: 0.85rem; line-height: 1.4;">
          <p id="tipeBakat">talent: -</p>
          <p id="tipeKepribadian">personality: -</p>
        </div>
        <div id="profileButtons">
          <button>Edit Profile</button>
          <button onclick="openShareModal()">Share Profile</button>
          <button onclick="toggleTheme()">Switch Theme</button>
          <button onclick="logout()">Logout</button>
          <button onclick="openChangePassword()">Ganti Password</button>
        </div>
        <div id="profileNote">
          <button onclick="toggleProfessional()" style="flex: 1; margin: 0 5px; padding: 8px 12px; border-radius: 10px; border: 1px solid #ffe58e; background: transparent; color: #ffe58e; font-weight: bold; cursor: pointer;">Show / Hide Dashboard</button>
          <div id="professionalContent">
            <h2 id="namaAnak"></h2>
            <p id="usiaAnak"></p>
            <div id="sertifikatContainer"></div>
            <h4>📋 Kesimpulan</h4>
            <p id="kesimpulanAI" style="white-space: pre-wrap;"></p>
            <h4>🧠 Evaluasi AI</h4>
            <div id="evaluasiAI"></div>
          </div>
        </div>
      </div>

      <div class="dashboard-card" id="badgeCard">
        <h3 style="margin: 0.5rem 0;">🏅 Badge</h3>
        <div id="badgeList"></div>
      </div>

      <div class="dashboard-card" id="galeriCard">
        <h3>🎨 Galeri Karya Anak</h3>
        <div id="galeri"></div>
      </div>

      <div class="dashboard-card">
        <h3>📚 Rekomendasi Kelas</h3>
        <ul id="rekomKelas" style="padding-left: 1.5rem;"></ul>
      </div>

      <div class="dashboard-card">
        <h3>📝 Upload Karya Anak</h3>
        <form id="uploadForm">
          <input type="file" id="fileInput" accept="image/*" required>
          <input type="text" id="titleInput" placeholder="Judul karya" required>
          <button type="submit">Upload Karya</button>
          <div id="uploadStatus"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Validasi login: redirect ke login jika tidak ada ?cid di URL, simpan/baca dari localStorage -->
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    let cid = urlParams.get("cid");

    if (cid) {
      localStorage.setItem("cid", cid);
    } else {
      cid = localStorage.getItem("cid");
    }

    if (!cid) {
      alert("⚠️ Anda belum login atau session habis.");
      window.location.href = "/login.html";
    }

    let data = {};
  </script>
  
  <script>
    // Edit Profile Modal logic
    document.addEventListener("DOMContentLoaded", function() {
      const editBtn = document.querySelector('#profileButtons button');
      if (editBtn) {
        editBtn.onclick = () => {
          document.getElementById("editProfileModal").style.display = "flex";
          document.getElementById("editNama").value = document.getElementById("profileName").innerText;
          document.getElementById("editUsia").value = document.getElementById("usiaAnak").innerText.replace("Usia: ", "");
          
        };
      }
    });

    function simpanProfil() {
      const nama = document.getElementById("editNama").value.trim();
      const usia = document.getElementById("editUsia").value.trim();
      const fotoFile = document.getElementById("editFotoFile").files[0];

      if (nama) {
        document.getElementById("profileName").innerText = nama;
        document.getElementById("namaAnak").innerText = nama;
      }
      if (usia) {
        document.getElementById("usiaAnak").innerText = "Usia: " + usia;
      }

      if (fotoFile) {
        const reader = new FileReader();
        reader.onload = async function (e) {
          const base64Image = e.target.result;
          document.querySelector("#profileHeader img").src = base64Image;

          try {
            const response = await fetch("https://firebase-upload-backend.onrender.com/update-profil", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                action: "updateProfile",
                cid,
                nama,
                usia,
                foto: base64Image
              })
            });
            const result = await response.json();
            console.log("📸 Profil updated:", result);
          } catch (err) {
            console.error("❌ Error updating profile:", err);
          }
        };
        reader.readAsDataURL(fotoFile);
      } else {
        fetch("https://script.google.com/macros/s/AKfycbx5cPx2YQzYLbjMzFJPwIEr_bMsm4VGB8OA-04p33hnuXK61Mm36U04W3IrihbsIDukhw/exec", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "updateProfile",
            cid,
            nama,
            usia
          })
        });
      }

      document.getElementById("editProfileModal").style.display = "none";
    }

    function previewProfilePhoto() {
      const img = document.getElementById("profilePhoto").src;
      document.getElementById("profilePreviewImg").src = img;
      document.getElementById("profilePhotoModal").style.display = "flex";
    }

    function closeProfilePhotoModal() {
      document.getElementById("profilePhotoModal").style.display = "none";
    }

    // urlParams dan cid sudah dideklarasikan di atas
    if (cid && history.state === null) {
      history.replaceState({ modal: null }, '', location.href);
    }
    const API_URL = "https://script.google.com/macros/s/AKfycbx5cPx2YQzYLbjMzFJPwIEr_bMsm4VGB8OA-04p33hnuXK61Mm36U04W3IrihbsIDukhw/exec";
    // Objek katalogKelas
    const katalogKelas = {
      "Craft & Coding": {
        usia: "4–6 tahun",
        deskripsi: "Latih motorik & imajinasi anak dengan coding lewat kerajinan digital & fisik.",
        link: "https://wa.me/6282125896546?text=Halo%20Admin%20Queen's%20Academy,%20saya%20ingin%20tanya%20detail%20tentang%20kelas%20Craft%20&%20Coding."
      },
      "Digital Literacy Foundations": {
        usia: "4–6 tahun",
        deskripsi: "Pengenalan komputer dan teknologi untuk anak usia dini.",
        link: "https://wa.me/6282125896546?text=Halo%20Admin%20Queen's%20Academy,%20saya%20ingin%20tanya%20detail%20tentang%20kelas%20Digital%20Literacy%20Foundations."
      },
      "Digital Creativity": {
        usia: "4–6 tahun",
        deskripsi: "Eksplorasi karya digital untuk menyalurkan ide kreatif anak.",
        link: "https://wa.me/6282125896546?text=Halo%20Admin%20Queen's%20Academy,%20saya%20ingin%20tanya%20detail%20tentang%20kelas%20Digital%20Creativity."
      },
      "Robotics Junior": {
        usia: "7–9 tahun",
        deskripsi: "Dasar-dasar robotika dan pemrograman untuk anak SD.",
        link: "https://wa.me/6282125896546?text=Halo%20Admin%20Queen's%20Academy,%20saya%20ingin%20tanya%20detail%20tentang%20kelas%20Robotics%20Junior."
      },
      "Game Coding Kids": {
        usia: "7–12 tahun",
        deskripsi: "Belajar membuat game sederhana dengan pemrograman visual.",
        link: "https://wa.me/6282125896546?text=Halo%20Admin%20Queen's%20Academy,%20saya%20ingin%20tanya%20detail%20tentang%20kelas%20Game%20Coding%20Kids."
      }
    };

    function getDriveImageUrlFromRaw(rawUrl) {
      try {
        const idMatch = rawUrl.match(/\/d\/([a-zA-Z0-9_-]+)|id=([a-zA-Z0-9_-]+)/);
        const fileId = idMatch ? (idMatch[1] || idMatch[2]) : null;
        return fileId ? `https://drive.google.com/uc?export=view&id=${fileId}` : rawUrl;
      } catch (err) {
        console.warn("⚠️ Gagal parsing link gambar:", rawUrl, err);
        return rawUrl;
      }
    }

    if (!cid) {
      document.getElementById("loading").innerText = "❌ CID tidak ditemukan di URL.";
    } else {
      fetch(`${API_URL}?cid=${cid}`, { cache: "no-store" })
        .then(res => res.json())
        .then(res => {
          data = res;
          document.getElementById("loading").style.display = "none";
          document.getElementById("dashboard").style.display = "block";

          document.getElementById("namaAnak").innerText = data.nama || "-";
          document.getElementById("profileName").innerText = data.nama || "-";
          if (data.foto && typeof data.foto === "string") {
            document.querySelector("#profileHeader img").src = data.foto;
            document.querySelector("#bottomNavBar button:last-child img").src = data.foto;
          }
          document.getElementById("totalPosts").innerText = data.karya ? data.karya.length : 0;
          document.getElementById("usiaAnak").innerText = `Usia: ${data.usia || "-"}`;
          document.getElementById("kesimpulanAI").innerText = data.kesimpulan || "-";
          document.getElementById("tipeBakat").innerText = `Talent: ${data.tipe_bakat || "-"}`;
          document.getElementById("tipeKepribadian").innerText = `Personality: ${data.tipe_kepribadian || "-"}`;

          const sertifikatEl = document.getElementById("sertifikatContainer");
          if (
            data.sertifikat &&
            typeof data.sertifikat === "string" &&
            data.sertifikat.match(/drive\.google\.com\/.*\/view/)
          ) {
            sertifikatEl.innerHTML = `<iframe src="${data.sertifikat.replace("/view", "/preview")}" width="100%" height="480" loading="lazy" allowfullscreen></iframe>`;
          } else {
            sertifikatEl.innerHTML = "<p>Sertifikat belum tersedia atau tautan salah.</p>";
          }


          const evaluasiEl = document.getElementById("evaluasiAI");
          if (data.evaluasi && data.evaluasi.length > 0) {
            data.evaluasi.forEach(e => {
              const p = document.createElement("p");
              p.innerText = `${e.komponen}: ${e.analisis}`;
              evaluasiEl.appendChild(p);
            });
          } else {
            evaluasiEl.innerHTML = "<p>Tidak ada evaluasi ditemukan.</p>";
          }

          const badgeEl = document.getElementById("badgeList");
          if (data.tipe_bakat && typeof data.tipe_bakat === "string") {
            const badgeMap = {
              "Imajinatif": "badge_imajinatif.png",
              "Logika": "badge_logika.png",
              "Verbal": "badge_verbal.png",
              "Sosial": "badge_sosial.png",
              "Multi": "badge_multitalenta.png"
            };

            // Tambahkan badge manual "New" sebelum loop badgeMap
            const tambahBadge = document.createElement("div");
            tambahBadge.classList.add("badge-item");
            tambahBadge.innerHTML = `
              <img src="https://img.icons8.com/ios-filled/50/ffe58e/plus-math.png" tabindex="-1" style="background: rgba(255,255,255,0.06); padding:10px; width: 60px; height: 60px; border-radius: 50%; object-fit: contain; cursor: pointer;" onclick="openKelasOptions()" />
              <span>New</span>
            `;
            badgeEl.appendChild(tambahBadge);

            Object.keys(badgeMap).forEach(kata => {
              if (data.tipe_bakat.includes(kata)) {
                const wrapper = document.createElement("div");
                wrapper.classList.add("badge-item");
                wrapper.innerHTML = `
                  <img src="/badges/${badgeMap[kata]}" alt="${kata}">
                  <span>${kata}</span>
                `;
                badgeEl.appendChild(wrapper);
              }
            }); 
          } else {
            badgeEl.innerHTML = "<p>Belum ada badge yang cocok.</p>";
          }


          const kelasEl = document.getElementById("rekomKelas");
          if (data.rekomendasi && data.rekomendasi.length > 0) {
            data.rekomendasi.forEach(r => {
              const li = document.createElement("li");
              li.innerText = r;
              kelasEl.appendChild(li);
            });
          } else {
            kelasEl.innerHTML = "<li>Tidak ada rekomendasi kelas.</li>";
          }

          // PATCHED GALLERY WITH PREVIEW + DELETE + MODAL
          const galeri = document.getElementById("galeri");
          if (data.karya && data.karya.length > 0) {
            galeri.innerHTML = ""; // Bersihkan isi awal

            data.karya.forEach(k => {
              if (k && k.url && typeof k.url === "string") {
                const wrapper = document.createElement("div");
                wrapper.className = "karya-card";
                wrapper.style.border = "none";
                wrapper.style.padding = "0";
                wrapper.style.margin = "0";
                wrapper.style.maxWidth = "100%";
                wrapper.style.backgroundColor = "transparent";
                wrapper.style.textAlign = "left";

                let previewElement;
                if (k.url.match(/\.(jpg|jpeg|png|gif)$/i)) {
                  previewElement = document.createElement("img");
                  previewElement.src = k.url;
                  previewElement.style.width = "100%";
                  previewElement.style.height = "100%";
                  previewElement.style.objectFit = "cover";
                  previewElement.style.aspectRatio = "4 / 5";
                } else if (k.url.match(/\.(mp4|webm)$/i)) {
                  previewElement = document.createElement("video");
                  previewElement.controls = true;
                  previewElement.style.width = "100%";
                  previewElement.style.height = "100%";
                  previewElement.style.objectFit = "cover";
                  previewElement.style.aspectRatio = "4 / 5";
                  const source = document.createElement("source");
                  source.src = k.url;
                  previewElement.appendChild(source);
                } else if (k.url.match(/\.pdf$/i)) {
                  previewElement = document.createElement("iframe");
                  previewElement.src = k.url;
                  previewElement.style.width = "100%";
                  previewElement.style.height = "150px";
                } else {
                  previewElement = document.createElement("a");
                  previewElement.href = k.url;
                  previewElement.innerText = "Lihat Karya";
                  previewElement.target = "_blank";
                }

                // Modal open on click
                wrapper.onclick = () => openModal(k);

                // wrapper.appendChild(caption);
                // wrapper.appendChild(btnDelete);
                wrapper.appendChild(previewElement);
                galeri.appendChild(wrapper);
              } else {
                console.warn("⚠️ Invalid karya item:", k);
              }
            });
          } else {
            galeri.innerHTML = "<p>Belum ada karya diunggah.</p>";
          }
        })
        .catch(err => {
          document.getElementById("loading").innerText = "❌ Gagal memuat data.";
          console.error(err);
        });

    // MODAL FULLSCREEN KARYA (dipindahkan ke global)
    let currentModalKarya = null;

    function openModal(karya) {
      currentModalKarya = karya;
      const modal = document.getElementById("karyaModal");
      const container = document.getElementById("modalMedia");
      container.innerHTML = "";

      let media;
      if (karya.url.match(/\.(jpg|jpeg|png|gif)$/i)) {
        media = document.createElement("img");
        media.src = karya.url;
      } else if (karya.url.match(/\.(mp4|webm)$/i)) {
        media = document.createElement("video");
        media.src = karya.url;
        media.controls = true;
      } else if (karya.url.match(/\.pdf$/i)) {
        media = document.createElement("iframe");
        media.src = karya.url;
      } else {
        media = document.createElement("a");
        media.href = karya.url;
        media.innerText = "Lihat Karya";
        media.target = "_blank";
      }

      container.appendChild(media);
      modal.style.display = "flex";
    }

    // Fungsi untuk tombol ➕ pada rekomendasi kelas - DIPINDAHKAN KE GLOBAL
    function openKelasOptions(kelas = null) {
      const modal = document.getElementById("kelasModal");
      const titleEl = document.getElementById("kelasModalTitle");
      const contentEl = document.getElementById("kelasModalContent");

      if (!kelas) {
        // Tambahkan pushState untuk daftar kelas
        history.pushState({ modal: 'kelasList' }, '', '#kelas');
        titleEl.innerText = "📚 Pilih Kelas";
        contentEl.innerHTML = "";
        Object.keys(katalogKelas).forEach(k => {
          const btn = document.createElement("button");
          btn.innerText = k;
          btn.className = "kelas-option";
          btn.onclick = () => openKelasOptions(k);
          contentEl.appendChild(btn);
        });
        // Tambahkan tombol Upload Karya di bawah daftar kelas
        const uploadBtn = document.createElement("button");
        uploadBtn.innerText = "📤 Upload Karya";
        uploadBtn.className = "kelas-option";
        uploadBtn.onclick = () => {
          contentEl.innerHTML = `
            <button onclick="openKelasOptions()" style="position:absolute; top:8px; left:12px; background:none; border:none; color:#ffe58e; font-weight:bold; font-size:1.2rem; cursor:pointer; z-index:1000;">⬅️</button>
            <form id="modalUploadForm" style="margin-top: 1rem;">
              <input type="file" id="modalFileInput" accept="image/*" required>
              <input type="text" id="modalTitleInput" placeholder="Judul Karya" required>
              <button type="submit">📤 Upload</button>
              <div id="modalUploadStatus"></div>
            </form>
          `;

          document.getElementById("modalUploadForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            const file = document.getElementById("modalFileInput").files[0];
            const title = document.getElementById("modalTitleInput").value;
            const status = document.getElementById("modalUploadStatus");

            if (!file || !title || !cid) {
              status.innerText = "❌ Lengkapi semua data!";
              return;
            }

            status.innerText = "⏳ Mengunggah ke server...";
            const formData = new FormData();
            formData.append("file", file);
            formData.append("cid", cid);
            formData.append("title", title);

            try {
              const res = await fetch("https://firebase-upload-backend.onrender.com/upload", {
                method: "POST",
                body: formData
              });
              const result = await res.json();
              status.innerText = result.message || "✅ Berhasil!";
              if (result.url) location.reload();
            } catch (err) {
              console.error("❌ Upload error:", err);
              status.innerText = "❌ Gagal upload: " + err.message;
            }
          });
        };
        contentEl.appendChild(uploadBtn);
        modal.style.display = "flex";
        return;
      }

      // Tambahkan pushState untuk detail kelas
      history.pushState({ modal: 'kelasDetail', kelas }, '', '#kelas');

      const info = katalogKelas[kelas];
      if (!info) return;

      titleEl.innerText = `📚 ${kelas}`;
      contentEl.innerHTML = `
        <button onclick="openKelasOptions()" style="position:absolute; top:8px; left:12px; background:none; border:none; color:#ffe58e; font-weight:bold; font-size:1.2rem; cursor:pointer; z-index:1000;">⬅️</button>
        <p><strong>Usia:</strong> ${info.usia}</p>
        <p><strong>Deskripsi:</strong><br>${info.deskripsi}</p>
      `;

      // Optional: set the main upload form's title to kelas for convenience
      if (document.getElementById("titleInput")) {
        document.getElementById("titleInput").value = kelas;
      }
      modal.style.display = "flex";
    }

    function closeKelasModal() {
      document.getElementById("kelasModal").style.display = "none";
    }

    // Handler popstate untuk navigasi modal kelas
    window.onpopstate = function(event) {
      if (event.state && event.state.modal === 'kelasDetail') {
        openKelasOptions(); // kembali ke daftar kelas
      } else {
        closeKelasModal(); // tutup modal sepenuhnya
      }
    };

    function openWhatsAppDetail() {
      const adminWA = "6282125896546";
      const message = encodeURIComponent("Halo Admin Queen's Academy, saya ingin tanya detail tentang kelas ini.");
      window.open(`https://wa.me/${adminWA}?text=${message}`, "_blank");
    }

      // Share Profile Modal Functions
    function openShareModal() {
      const name = document.getElementById("profileName").innerText || "anak";
      const handle = `@${name.toLowerCase().replace(/\s+/g, "")}`;
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${window.location.href}`;

      document.getElementById("qrCodeImg").src = qrUrl;
      document.getElementById("shareHandle").innerText = handle;
      document.getElementById("shareModal").style.display = "flex";
    }

    function closeShareModal() {
      document.getElementById("shareModal").style.display = "none";
    }

    function copyProfileLink() {
      navigator.clipboard.writeText(window.location.href).then(() => {
        alert("📋 Link profil disalin!");
      });
    }

    function shareWhatsApp() {
      const text = `Lihat profil anakku di sini\n${window.location.href}`;
      const waUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
      window.open(waUrl, "_blank");
    }

    function closeModal() {
      document.getElementById("karyaModal").style.display = "none";
    }

    function modalLike() {
      const heart = document.getElementById("heartOverlay");
      heart.classList.add("show");
      setTimeout(() => {
        heart.classList.remove("show");
      }, 1000);
    }
    function modalComment() {
      const comment = prompt("Tulis komentar:");
      if (comment) alert("💬 Komentar disimpan: " + comment);
    }
    function modalShare() {
      if (currentModalKarya && currentModalKarya.url) {
        navigator.clipboard.writeText(currentModalKarya.url).then(() => {
          alert("📤 Link karya disalin ke clipboard!");
        });
      }
    }
    function modalDelete() {
      if (currentModalKarya && confirm("Yakin ingin menghapus karya ini?")) {
        hapusKarya(currentModalKarya.id);
        closeModal();
      }
    }
    }

    // PATCHED UPLOAD SCRIPT MULAI DI SINI
    const fileInput = document.getElementById("fileInput");
    const titleInput = document.getElementById("titleInput");
    const uploadStatus = document.getElementById("uploadStatus");

    document.getElementById("uploadForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const file = fileInput.files[0];
      const title = titleInput.value;

      if (!file || !title || !cid) {
        uploadStatus.innerText = "❌ Lengkapi semua data!";
        return;
      }

      uploadStatus.innerText = "⏳ Mengunggah ke server...";

      const formData = new FormData();
      formData.append("file", file);
      formData.append("cid", cid);
      formData.append("title", title);

      try {
        const res = await fetch("https://firebase-upload-backend.onrender.com/upload", {
          method: "POST",
          body: formData
        });

        const result = await res.json();
        console.log("✅ Response:", result);
        uploadStatus.innerText = result.message || "✅ Berhasil!";
        if (result.url) location.reload();
      } catch (err) {
        console.error("❌ Upload error:", err);
        uploadStatus.innerText = "❌ Gagal upload: " + err.message;
      }
    });
    // Fungsi hapusKarya dipanggil dari tombol hapus karya
    async function hapusKarya(id_karya) {
      console.log("🧨 Kirim hapus:", { cid, id_karya });

      if (!cid || !id_karya) {
        alert("❌ CID atau ID_KARYA kosong. Gagal menghapus.");
        return;
      }

      try {
        const res = await fetch("https://firebase-upload-backend.onrender.com/hapus-karya", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cid, id_karya }),
        });

        const result = await res.json();
        if (result.success) {
          alert("✔️ Karya berhasil dihapus.");
          location.reload();
        } else {
          alert("❌ Gagal menghapus karya.");
          console.log("🛑 Backend message:", result.message || result.error);
        }
      } catch (err) {
        console.error("❌ Error hapus:", err);
        alert("⚠️ Terjadi error saat menghapus.");
      }
    }

    // Bottom Nav Bar Functions
    function goHome() {
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
    function goSearch() {
      alert("🔍 Fitur pencarian coming soon!");
    }
    function goReels() {
      alert("🎬 Fitur reels coming soon!");
    }
    function goProfile() {
      const section = document.getElementById("profileHeader");
      if (section) section.scrollIntoView({ behavior: "smooth" });
    }

    function toggleProfessional() {
      const content = document.getElementById("professionalContent");
      if (content.style.display === "none" || content.style.display === "") {
        content.style.display = "block";
      } else {
        content.style.display = "none";
      }
    }
    // Theme Switcher
    function toggleTheme() {
      const body = document.body;
      if (body.classList.contains("theme-queens")) {
        body.classList.remove("theme-queens");
        body.classList.add("theme-default");
      } else {
        body.classList.remove("theme-default");
        body.classList.add("theme-queens");
      }
    }

    // Logout and Change Password Functions
    function logout() {
      firebase.auth().signOut().then(() => {
        alert("👋 Logout berhasil!");
        window.location.replace("/login.html");
      }).catch(err => {
        console.error("❌ Firebase logout error:", err);
        alert("⚠️ Terjadi kesalahan saat logout.");
      });
    }

    function openChangePassword() {
      const newPassword = prompt("Masukkan password baru:");
      if (!newPassword || newPassword.trim().length < 6) {
        alert("⚠️ Password harus minimal 6 karakter.");
        return;
      }

      const username = data.whatsapp?.replace(/\s+/g, "") || cid; // Pakai nomor WA sebagai username
      fetch("https://firebase-upload-backend.onrender.com/ganti-password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password: newPassword })
      })
      .then(res => res.json())
      .then(result => {
        if (result.success) {
          alert("✅ Password berhasil diganti.");
        } else {
          alert("❌ Gagal mengganti password.");
        }
      })
      .catch(err => {
        console.error("❌ Error:", err);
        alert("⚠️ Terjadi kesalahan.");
      });
    }
  </script>
  <!-- Bottom Navigation Bar -->
  <div id="bottomNavBar">
    <button onclick="goHome()">
      <img src="https://img.icons8.com/ios-filled/24/ffffff/home.png" alt="Home" />
    </button>
    <button onclick="goSearch()">
      <img src="https://img.icons8.com/ios-filled/24/ffffff/search--v1.png" alt="Search" />
    </button>
    <!--
      Default: open modal kelas "Craft & Coding". 
      Untuk versi dinamis, ganti parameternya sesuai kebutuhan.
    -->
    <button onclick="openKelasOptions()">
      <img src="https://img.icons8.com/ios-filled/24/ffffff/plus-math.png" alt="Upload" />
    </button>
    <button onclick="goReels()">
      <img src="https://img.icons8.com/ios-filled/24/ffffff/cinema-.png" alt="Reels" />
    </button>
    <button onclick="goProfile()">
      <img src="https://placehold.co/32x32" alt="Profile" />
    </button>
  </div>
  <!-- Edit Profile Modal -->
  <div id="editProfileModal">
    <div class="modal-content">
      <h3>Edit Profil Anak</h3>
      <input type="text" id="editNama" placeholder="Nama Anak" />
      <input type="text" id="editUsia" placeholder="Usia Anak" />
      <input type="file" id="editFotoFile" accept="image/*" />
      <button onclick="simpanProfil()">Simpan</button>
    </div>
  </div>
  <!-- Share Profile Modal -->
  <div id="shareModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-close" onclick="closeShareModal()">×</div>
      <h3 id="shareHandle">@nama</h3>
      <img id="qrCodeImg" src="" alt="QR Code" style="margin:1rem auto; max-width:200px; border-radius:8px;" />
      <div class="modal-actions">
        <button onclick="copyProfileLink()">🔗 Copy Link</button>
        <button onclick="shareWhatsApp()">📲 WhatsApp</button>
        <button onclick="alert('🔧 Fitur Instagram belum tersedia')">📸 Instagram</button>
      </div>
    </div>
  </div>
  <script>
    // Temukan elemen .dashboard-card dengan id badgeCard dan ubah <h3> menjadi versi dengan style margin
    document.addEventListener("DOMContentLoaded", function() {
      var badgeCard = document.getElementById('badgeCard');
      if (badgeCard) {
        var h3 = badgeCard.querySelector('h3');
        if (h3 && (h3.textContent.trim() === "🏅 Badge" || h3.textContent.trim().includes("🏅 Badge"))) {
          // Ganti dengan versi style langsung
          h3.outerHTML = '<h3 style="margin: 0.5rem 0;">🏅 Badge</h3>';
        }
      }
    });
  </script>
  <div id="heartOverlay" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1000; pointer-events:none;">
    <img src="https://img.icons8.com/emoji/96/red-heart.png" alt="Love" style="width: 96px; height: 96px; opacity: 0.8;" />
  </div>
</body>
  <div id="karyaModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-close" onclick="closeModal()">×</div>
      <div id="modalMedia"></div>
      <div class="modal-actions">
        <button onclick="modalLike()">❤️</button>
        <button onclick="modalComment()">💬</button>
        <button onclick="modalShare()">📤</button>
        <button onclick="modalDelete()">🗑️</button>
      </div>
    </div>
  </div>
  <div id="profilePhotoModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-close" onclick="closeProfilePhotoModal()">×</div>
      <img id="profilePreviewImg" src="" alt="Preview Foto Profil" style="max-width: 100%; border-radius: 12px;" />
    </div>
  </div>
  <div id="kelasModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-close" onclick="closeKelasModal()">×</div>
      <h3 id="kelasModalTitle">📚 Kelas</h3>
      <div id="kelasModalContent" style="text-align:left; font-size: 0.85rem; padding-top: 2rem;"></div>
      <div class="modal-actions">
        <button onclick="closeKelasModal()">❌ Tutup Menu</button>
        <button onclick="openWhatsAppDetail()">📱 Free Trial</button>
      </div>
    </div>
  </div>
</html>
</html>

  <script>
// Scroll to Upload Karya Anak
function scrollToUpload() {
  const form = document.getElementById("uploadForm");
  if (form) form.scrollIntoView({ behavior: "smooth" });
}
</script>
</html>

  
    
    
  
    