<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Anak - Queen‚Äôs Academy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Forum&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #0d2d2b;
      color: #ffe58e;
      font-family: 'Forum', sans-serif;
      margin: 0;
      padding: 4px;
    }
    .container {
      max-width: 100%;
      margin: auto;
      background-color: rgba(255,255,255,0.05);
      padding: 0;
      border-radius: 12px;
    }
    #floatingUploadBtn {
      position: fixed;
      bottom: 16px;
      right: 16px;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background-color: #ffe58e;
      color: #0d2d2b;
      font-size: 32px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      cursor: pointer;
    }
    .dashboard-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,229,142,0.15);
      border-radius: 16px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      overflow: hidden;
    }
    #profileHeader {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    #profileHeader img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ffe58e;
    }
    #profileName {
      font-size: 1.2rem;
      font-weight: bold;
      margin-top: 0.5rem;
    }
    #profileStats {
      display: flex;
      justify-content: space-around;
      margin-top: 0.5rem;
    }
    #profileStats div {
      font-size: 0.9rem;
    }
    #profileButtons {
      display: flex;
      justify-content: space-around;
      margin-top: 1rem;
    }
    #profileButtons button {
      flex: 1;
      margin: 0 5px;
      padding: 8px 0;
      border-radius: 10px;
      border: 1px solid #ffe58e;
      background: transparent;
      color: #ffe58e;
      font-weight: bold;
      cursor: pointer;
    }
    #profileNote {
      background-color: rgba(255,255,255,0.05);
      padding: 0.5rem;
      font-size: 0.85rem;
      margin-top: 1rem;
      border-radius: 8px;
      text-align: center;
      color: #ccc;
    }
    #galeri {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    /* MODAL FULLSCREEN KARYA */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal-content {
      position: relative;
      background-color: #0d2d2b;
      padding: 1rem;
      border-radius: 12px;
      max-width: 90%;
      max-height: 90%;
      text-align: center;
    }
    .modal-content img, .modal-content video, .modal-content iframe {
      max-width: 100%;
      max-height: 60vh;
      margin-bottom: 1rem;
    }
    .modal-actions {
      display: flex;
      justify-content: space-around;
      gap: 10px;
      margin-top: 1rem;
    }
    .modal-actions button {
      flex: 1;
      padding: 0.5rem;
      border-radius: 8px;
      border: none;
      background-color: #ffe58e;
      color: #0d2d2b;
      font-weight: bold;
      cursor: pointer;
    }
    .modal-close {
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 1.5rem;
      color: #fff;
      cursor: pointer;
    }
    .karya-card {
      background-color: transparent;
      border: none;
      padding: 0;
      margin: 0;
      border-radius: 0;
    }
    .karya-card img {
      width: 100%;
      height: auto;
      aspect-ratio: 1/1;
      object-fit: cover;
      border-radius: 0;
    }
    h1, h2, h3 { color: #ffe58e; }
    #badgeList { display: flex; flex-wrap: wrap; gap: 12px; }
    .badge-item img, #galeri img {
      width: 100px;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(255,255,255,0.2);
    }
    .badge-item span {
      display: block;
      font-size: 0.75rem;
      text-align: center;
      margin-top: 4px;
    }
    iframe { border: none; border-radius: 12px; }
    #uploadForm {
      max-width: 100%;
    }
    #uploadForm input[type="file"],
    #uploadForm input[type="text"],
    #uploadForm button {
      box-sizing: border-box;
      width: 100%;
      max-width: 100%;
    }
    #uploadForm input, #uploadForm button {
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    #uploadForm input {
      background-color: rgba(255,255,255,0.06);
      border: 1px solid rgba(255, 229, 142, 0.3);
      color: #ffe58e;
    }
    #uploadForm button {
      background-color: #ffe58e;
      color: #0d2d2b;
      font-weight: bold;
      cursor: pointer;
      border: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dashboard Anak ‚Äì Queen‚Äôs Academy</h1>
    <div id="loading">üîÑ Memuat data anak...</div>
    <div id="dashboard" style="display:none;">
      <div id="profileHeader">
        <img src="https://placehold.co/80x80" alt="Foto Anak" />
        <div id="profileName">Nama Anak</div>
        <div id="profileStats">
          <div><strong id="totalPosts">0</strong><br>Posts</div>
          <div><strong>‚Äì</strong><br>Followers</div>
          <div><strong>‚Äì</strong><br>Following</div>
        </div>
        <div id="profileButtons">
          <button>Edit Profile</button>
          <button>Share Profile</button>
        </div>
        <div id="profileNote">Professional dashboard</div>
      </div>
      <div class="dashboard-card">
        <h2 id="namaAnak"></h2>
        <p id="usiaAnak"></p>
        <div id="sertifikatContainer"></div>
      </div>

      <div class="dashboard-card">
        <h3>üìã Kesimpulan</h3>
        <p id="kesimpulanAI" style="white-space: pre-wrap;"></p>
      </div>

      <div class="dashboard-card">
        <h3>üß† Evaluasi Psikotest dari AI</h3>
        <div id="evaluasiAI"></div>
      </div>

      <div class="dashboard-card">
        <h3>üéØ Tipe Bakat & Kepribadian</h3>
        <p id="tipeBakat">üß† -</p>
        <p id="tipeKepribadian">üôÇ -</p>
      </div>

      <div class="dashboard-card">
        <h3>üèÖ Badge</h3>
        <div id="badgeList"></div>
      </div>

      <div class="dashboard-card">
        <h3>üìö Rekomendasi Kelas</h3>
        <ul id="rekomKelas" style="padding-left: 1.5rem;"></ul>
      </div>

      <div class="dashboard-card">
        <h3>üé® Galeri Karya Anak</h3>
        <div id="galeri"></div>
      </div>

      <div class="dashboard-card">
        <h3>üìù Upload Karya Anak</h3>
        <form id="uploadForm">
          <input type="file" id="fileInput" accept="image/*" required>
          <input type="text" id="titleInput" placeholder="Judul karya" required>
          <button type="submit">Upload Karya</button>
          <div id="uploadStatus"></div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const cid = urlParams.get("cid");
    const API_URL = "https://script.google.com/macros/s/AKfycbx5cPx2YQzYLbjMzFJPwIEr_bMsm4VGB8OA-04p33hnuXK61Mm36U04W3IrihbsIDukhw/exec";

    function getDriveImageUrlFromRaw(rawUrl) {
      try {
        const idMatch = rawUrl.match(/\/d\/([a-zA-Z0-9_-]+)|id=([a-zA-Z0-9_-]+)/);
        const fileId = idMatch ? (idMatch[1] || idMatch[2]) : null;
        return fileId ? `https://drive.google.com/uc?export=view&id=${fileId}` : rawUrl;
      } catch (err) {
        console.warn("‚ö†Ô∏è Gagal parsing link gambar:", rawUrl, err);
        return rawUrl;
      }
    }

    if (!cid) {
      document.getElementById("loading").innerText = "‚ùå CID tidak ditemukan di URL.";
    } else {
      fetch(`${API_URL}?cid=${cid}`, { cache: "no-store" })
        .then(res => res.json())
        .then(data => {
          document.getElementById("loading").style.display = "none";
          document.getElementById("dashboard").style.display = "block";

          document.getElementById("namaAnak").innerText = data.nama || "-";
          document.getElementById("profileName").innerText = data.nama || "-";
          document.getElementById("totalPosts").innerText = data.karya ? data.karya.length : 0;
          document.getElementById("usiaAnak").innerText = `Usia: ${data.usia || "-"}`;
          document.getElementById("kesimpulanAI").innerText = data.kesimpulan || "-";
          document.getElementById("tipeBakat").innerText = `üß† ${data.tipe_bakat || "-"}`;
          document.getElementById("tipeKepribadian").innerText = `üôÇ ${data.tipe_kepribadian || "-"}`;

          const sertifikatEl = document.getElementById("sertifikatContainer");
          if (
            data.sertifikat &&
            typeof data.sertifikat === "string" &&
            data.sertifikat.match(/drive\.google\.com\/.*\/view/)
          ) {
            sertifikatEl.innerHTML = `<iframe src="${data.sertifikat.replace("/view", "/preview")}" width="100%" height="480" loading="lazy" allowfullscreen></iframe>`;
          } else {
            sertifikatEl.innerHTML = "<p>Sertifikat belum tersedia atau tautan salah.</p>";
          }


          const evaluasiEl = document.getElementById("evaluasiAI");
          if (data.evaluasi && data.evaluasi.length > 0) {
            data.evaluasi.forEach(e => {
              const p = document.createElement("p");
              p.innerText = `${e.komponen}: ${e.analisis}`;
              evaluasiEl.appendChild(p);
            });
          } else {
            evaluasiEl.innerHTML = "<p>Tidak ada evaluasi ditemukan.</p>";
          }

          const badgeEl = document.getElementById("badgeList");
          if (data.tipe_bakat && typeof data.tipe_bakat === "string") {
            const badgeMap = {
              "Imajinatif": "badge_imajinatif.png",
              "Logika": "badge_logika.png",
              "Verbal": "badge_verbal.png",
              "Sosial": "badge_sosial.png",
              "Multi": "badge_multitalenta.png"
            };

            const badgeEl = document.getElementById("badgeList");
            Object.keys(badgeMap).forEach(kata => {
              if (data.tipe_bakat.includes(kata)) {
                const wrapper = document.createElement("div");
                wrapper.classList.add("badge-item");
                wrapper.innerHTML = `
                  <img src="/badges/${badgeMap[kata]}" alt="${kata}">
                  <span>${kata}</span>
                `;
                badgeEl.appendChild(wrapper);
              }
            }); 
          } else {
            badgeEl.innerHTML = "<p>Belum ada badge yang cocok.</p>";
          }


          const kelasEl = document.getElementById("rekomKelas");
          if (data.rekomendasi && data.rekomendasi.length > 0) {
            data.rekomendasi.forEach(r => {
              const li = document.createElement("li");
              li.innerText = r;
              kelasEl.appendChild(li);
            });
          } else {
            kelasEl.innerHTML = "<li>Tidak ada rekomendasi kelas.</li>";
          }

          // PATCHED GALLERY WITH PREVIEW + DELETE + MODAL
          const galeri = document.getElementById("galeri");
          if (data.karya && data.karya.length > 0) {
            galeri.innerHTML = ""; // Bersihkan isi awal

            data.karya.forEach(k => {
              // Pastikan properti id tersedia
              k.id = k.id || k.id_karya || null;
              if (k && k.url && typeof k.url === "string") {
                const wrapper = document.createElement("div");
                wrapper.className = "karya-card";
                wrapper.style.border = "none";
                wrapper.style.padding = "0";
                wrapper.style.margin = "0";
                wrapper.style.maxWidth = "100%";
                wrapper.style.backgroundColor = "transparent";
                wrapper.style.textAlign = "left";

                let previewElement;
                if (k.url.match(/\.(jpg|jpeg|png|gif)$/i)) {
                  previewElement = document.createElement("img");
                  previewElement.src = k.url;
                  previewElement.style.width = "100%";
                  previewElement.style.height = "100%";
                  previewElement.style.objectFit = "cover";
                  previewElement.style.aspectRatio = "1 / 1";
                } else if (k.url.match(/\.(mp4|webm)$/i)) {
                  previewElement = document.createElement("video");
                  previewElement.controls = true;
                  previewElement.style.width = "100%";
                  previewElement.style.height = "100%";
                  previewElement.style.objectFit = "cover";
                  previewElement.style.aspectRatio = "1 / 1";
                  const source = document.createElement("source");
                  source.src = k.url;
                  previewElement.appendChild(source);
                } else if (k.url.match(/\.pdf$/i)) {
                  previewElement = document.createElement("iframe");
                  previewElement.src = k.url;
                  previewElement.style.width = "100%";
                  previewElement.style.height = "150px";
                } else {
                  previewElement = document.createElement("a");
                  previewElement.href = k.url;
                  previewElement.innerText = "Lihat Karya";
                  previewElement.target = "_blank";
                }

                // Modal open on click (setelah id dipastikan ada)
                wrapper.onclick = () => openModal(k);

                wrapper.appendChild(previewElement);
                galeri.appendChild(wrapper);
              } else {
                console.warn("‚ö†Ô∏è Invalid karya item:", k);
              }
            });
          } else {
            galeri.innerHTML = "<p>Belum ada karya diunggah.</p>";
          }
        })
        .catch(err => {
          document.getElementById("loading").innerText = "‚ùå Gagal memuat data.";
          console.error(err);
        });

    // MODAL FULLSCREEN KARYA (dipindahkan ke global)
    let currentModalKarya = null;

    function openModal(karya) {
      currentModalKarya = karya;
      const modal = document.getElementById("karyaModal");
      const container = document.getElementById("modalMedia");
      container.innerHTML = "";

      let media;
      if (karya.url.match(/\.(jpg|jpeg|png|gif)$/i)) {
        media = document.createElement("img");
        media.src = karya.url;
      } else if (karya.url.match(/\.(mp4|webm)$/i)) {
        media = document.createElement("video");
        media.src = karya.url;
        media.controls = true;
      } else if (karya.url.match(/\.pdf$/i)) {
        media = document.createElement("iframe");
        media.src = karya.url;
      } else {
        media = document.createElement("a");
        media.href = karya.url;
        media.innerText = "Lihat Karya";
        media.target = "_blank";
      }

      container.appendChild(media);
      modal.style.display = "flex";
    }

    function closeModal() {
      document.getElementById("karyaModal").style.display = "none";
    }

    function modalLike() {
      alert("‚ù§Ô∏è Karya disukai!");
    }
    function modalComment() {
      const comment = prompt("Tulis komentar:");
      if (comment) alert("üí¨ Komentar disimpan: " + comment);
    }
    function modalShare() {
      if (currentModalKarya && currentModalKarya.url) {
        navigator.clipboard.writeText(currentModalKarya.url).then(() => {
          alert("üì§ Link karya disalin ke clipboard!");
        });
      }
    }
    function modalDelete() {
      if (!currentModalKarya || !currentModalKarya.id) {
        alert("‚ùå Data karya tidak lengkap.");
        return;
      }
      if (confirm("Yakin ingin menghapus karya ini?")) {
        hapusKarya(currentModalKarya.id);
        closeModal();
      }
    }
    }

    // PATCHED UPLOAD SCRIPT MULAI DI SINI
    const fileInput = document.getElementById("fileInput");
    const titleInput = document.getElementById("titleInput");
    const uploadStatus = document.getElementById("uploadStatus");

    document.getElementById("uploadForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const file = fileInput.files[0];
      const title = titleInput.value;

      if (!file || !title || !cid) {
        uploadStatus.innerText = "‚ùå Lengkapi semua data!";
        return;
      }

      uploadStatus.innerText = "‚è≥ Mengunggah ke server...";

      const formData = new FormData();
      formData.append("file", file);
      formData.append("cid", cid);
      formData.append("title", title);

      try {
        const res = await fetch("https://firebase-upload-backend.onrender.com/upload", {
          method: "POST",
          body: formData
        });

        const result = await res.json();
        console.log("‚úÖ Response:", result);
        uploadStatus.innerText = result.message || "‚úÖ Berhasil!";
        if (result.url) location.reload();
      } catch (err) {
        console.error("‚ùå Upload error:", err);
        uploadStatus.innerText = "‚ùå Gagal upload: " + err.message;
      }
    });
</script>
  <script>
    function scrollToUpload() {
      const uploadForm = document.getElementById("uploadForm");
      if (uploadForm) uploadForm.scrollIntoView({ behavior: "smooth" });
    }
  </script>
  <div id="floatingUploadBtn" onclick="scrollToUpload()">Ôºã</div>
</body>
  <div id="karyaModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-close" onclick="closeModal()">√ó</div>
      <div id="modalMedia"></div>
      <div class="modal-actions">
        <button onclick="modalLike()">‚ù§Ô∏è</button>
        <button onclick="modalComment()">üí¨</button>
        <button onclick="modalShare()">üì§</button>
        <button onclick="modalDelete()">üóëÔ∏è</button>
      </div>
    </div>
  </div>
</html>
