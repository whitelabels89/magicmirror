<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Anak - Queen’s Academy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Forum&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #0d2d2b;
      color: #ffe58e;
      font-family: 'Forum', sans-serif;
      margin: 0;
      padding: 2rem;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background-color: rgba(255,255,255,0.05);
      padding: 2rem;
      border-radius: 12px;
    }
    .dashboard-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,229,142,0.15);
      border-radius: 16px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      overflow: hidden;
    }
    h1, h2, h3 { color: #ffe58e; }
    #badgeList, #galeri { display: flex; flex-wrap: wrap; gap: 12px; }
    .badge-item img, #galeri img {
      width: 100px;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(255,255,255,0.2);
    }
    .badge-item span {
      display: block;
      font-size: 0.75rem;
      text-align: center;
      margin-top: 4px;
    }
    iframe { border: none; border-radius: 12px; }
    #uploadForm {
      max-width: 100%;
    }
    #uploadForm input[type="file"],
    #uploadForm input[type="text"],
    #uploadForm button {
      box-sizing: border-box;
      width: 100%;
      max-width: 100%;
    }
    #uploadForm input, #uploadForm button {
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    #uploadForm input {
      background-color: rgba(255,255,255,0.06);
      border: 1px solid rgba(255, 229, 142, 0.3);
      color: #ffe58e;
    }
    #uploadForm button {
      background-color: #ffe58e;
      color: #0d2d2b;
      font-weight: bold;
      cursor: pointer;
      border: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dashboard Anak – Queen’s Academy</h1>
    <div id="loading">🔄 Memuat data anak...</div>
    <div id="dashboard" style="display:none;">
      <div class="dashboard-card">
        <h2 id="namaAnak"></h2>
        <p id="usiaAnak"></p>
        <div id="sertifikatContainer"></div>
      </div>

      <div class="dashboard-card">
        <h3>📋 Kesimpulan</h3>
        <p id="kesimpulanAI" style="white-space: pre-wrap;"></p>
      </div>

      <div class="dashboard-card">
        <h3>🧠 Evaluasi Psikotest dari AI</h3>
        <div id="evaluasiAI"></div>
      </div>

      <div class="dashboard-card">
        <h3>🎯 Tipe Bakat & Kepribadian</h3>
        <p id="tipeBakat">🧠 -</p>
        <p id="tipeKepribadian">🙂 -</p>
      </div>

      <div class="dashboard-card">
        <h3>🏅 Badge</h3>
        <div id="badgeList"></div>
      </div>

      <div class="dashboard-card">
        <h3>📚 Rekomendasi Kelas</h3>
        <ul id="rekomKelas" style="padding-left: 1.5rem;"></ul>
      </div>

      <div class="dashboard-card">
        <h3>🎨 Galeri Karya Anak</h3>
        <div id="galeri"></div>
      </div>

      <div class="dashboard-card">
        <h3>📝 Upload Karya Anak</h3>
        <form id="uploadForm">
          <input type="file" id="fileInput" accept="image/*" required>
          <input type="text" id="titleInput" placeholder="Judul karya" required>
          <button type="submit">Upload Karya</button>
          <div id="uploadStatus"></div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const cid = urlParams.get("cid");
    const API_URL = "https://script.google.com/macros/s/AKfycbx5cPx2YQzYLbjMzFJPwIEr_bMsm4VGB8OA-04p33hnuXK61Mm36U04W3IrihbsIDukhw/exec";

    function getDriveImageUrlFromRaw(rawUrl) {
      try {
        const idMatch = rawUrl.match(/\/d\/([a-zA-Z0-9_-]+)|id=([a-zA-Z0-9_-]+)/);
        const fileId = idMatch ? (idMatch[1] || idMatch[2]) : null;
        return fileId ? `https://drive.google.com/uc?export=view&id=${fileId}` : rawUrl;
      } catch (err) {
        console.warn("⚠️ Gagal parsing link gambar:", rawUrl, err);
        return rawUrl;
      }
    }

    if (!cid) {
      document.getElementById("loading").innerText = "❌ CID tidak ditemukan di URL.";
    } else {
      fetch(`${API_URL}?cid=${cid}`, { cache: "no-store" })
        .then(res => res.json())
        .then(data => {
          document.getElementById("loading").style.display = "none";
          document.getElementById("dashboard").style.display = "block";

          document.getElementById("namaAnak").innerText = data.nama || "-";
          document.getElementById("usiaAnak").innerText = `Usia: ${data.usia || "-"}`;
          document.getElementById("kesimpulanAI").innerText = data.kesimpulan || "-";
          document.getElementById("tipeBakat").innerText = `🧠 ${data.tipe_bakat || "-"}`;
          document.getElementById("tipeKepribadian").innerText = `🙂 ${data.tipe_kepribadian || "-"}`;

          const sertifikatEl = document.getElementById("sertifikatContainer");
          if (data.sertifikat && data.sertifikat.includes("drive.google.com")) {
            sertifikatEl.innerHTML = `
              <iframe src="${data.sertifikat.replace("/view", "/preview")}" width="100%" height="480"></iframe>`;
          } else {
            sertifikatEl.innerHTML = "<p>Tautan sertifikat tidak valid.</p>";
          }

          const evaluasiEl = document.getElementById("evaluasiAI");
          if (data.evaluasi && data.evaluasi.length > 0) {
            data.evaluasi.forEach(e => {
              const p = document.createElement("p");
              p.innerText = `${e.komponen}: ${e.analisis}`;
              evaluasiEl.appendChild(p);
            });
          } else {
            evaluasiEl.innerHTML = "<p>Tidak ada evaluasi ditemukan.</p>";
          }

          const badgeEl = document.getElementById("badgeList");
          if (data.badges && data.badges.length > 0) {
            data.badges.forEach(b => {
              const item = document.createElement("div");
              item.classList.add("badge-item");
              item.innerHTML = `<img src="${b.url}"><span>${b.nama}</span>`;
              badgeEl.appendChild(item);
            });
          } else {
            badgeEl.innerHTML = "<p>Tidak ada badge ditemukan.</p>";
          }

          const kelasEl = document.getElementById("rekomKelas");
          if (data.rekomendasi && data.rekomendasi.length > 0) {
            data.rekomendasi.forEach(r => {
              const li = document.createElement("li");
              li.innerText = r;
              kelasEl.appendChild(li);
            });
          } else {
            kelasEl.innerHTML = "<li>Tidak ada rekomendasi kelas.</li>";
          }

          const galeri = document.getElementById("galeri");
          if (data.karya && data.karya.length > 0) {
            data.karya.forEach(k => {
              if (k && k.url && typeof k.url === "string" && k.url.includes("drive.google.com")) {
                const imgLink = getDriveImageUrlFromRaw(k.url);
                console.log("✅ Final img link:", imgLink);

                const wrapper = document.createElement("div");
                wrapper.style.display = "inline-block";
                wrapper.style.margin = "10px";
                wrapper.style.textAlign = "center";
                wrapper.style.maxWidth = "200px";

                const img = document.createElement("img");
                img.src = imgLink;
                img.alt = k.judul || "Karya Anak";
                img.style.display = "block";
                img.style.width = "100%";
                img.style.maxHeight = "200px";
                img.style.objectFit = "contain";
                img.style.border = "1px solid #ffe58e";
                img.style.borderRadius = "8px";
                img.onerror = () => {
                  console.warn("❌ Gagal load gambar:", img.src);
                  img.src = "https://dummyimage.com/200x150/cccccc/333333&text=Image+Not+Found";
                  img.alt = "Image not found";
                };
                img.onload = () => {
                  console.log("✅ Gambar berhasil dimuat:", img.src);
                };

                const caption = document.createElement("p");
                caption.innerText = k.judul || "";
                caption.style.fontSize = "0.9rem";
                caption.style.marginTop = "0.5rem";

                wrapper.appendChild(img);
                wrapper.appendChild(caption);
                galeri.appendChild(wrapper);
              } else {
                console.warn("⚠️ Invalid karya item:", k);
              }
            });
          } else {
            galeri.innerHTML = "<p>Belum ada karya diunggah.</p>";
          }
        })
        .catch(err => {
          document.getElementById("loading").innerText = "❌ Gagal memuat data.";
          console.error(err);
        });
    }

    document.getElementById("uploadForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const file = document.getElementById("fileInput").files[0];
      const title = document.getElementById("titleInput").value;
      const status = document.getElementById("uploadStatus");

      if (!file || !title || !cid) {
        status.innerText = "❌ Lengkapi semua kolom!";
        return;
      }

      const reader = new FileReader();
      reader.onloadend = async function () {
        const base64 = reader.result.split(",")[1];
        const payload = { cid, title, filename: file.name, mimeType: file.type, base64 };

        try {
          const res = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify(payload)
          });

          const result = await res.json();
          status.innerText = result.message || "✅ Berhasil upload!";
          if (result.message.includes("✅")) location.reload();
        } catch (err) {
          status.innerText = "❌ Gagal upload: " + err;
        }
      };
      reader.readAsDataURL(file);
    });
  </script>
  <script type="module">
    import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-storage.js";
  
    const storage = window.firebaseStorage;
  
    const uploadForm = document.getElementById("uploadForm");
    const fileInput = document.getElementById("fileInput");
    const titleInput = document.getElementById("titleInput");
    const uploadStatus = document.getElementById("uploadStatus");
  
    uploadForm.addEventListener("submit", async function (e) {
      e.preventDefault();
  
      const file = fileInput.files[0];
      const title = titleInput.value;
      const cid = new URLSearchParams(window.location.search).get("cid");
  
      if (!file || !title || !cid) {
        uploadStatus.innerText = "❌ Lengkapi semua data!";
        return;
      }
  
      uploadStatus.innerText = "⏳ Mengunggah ke Firebase...";
  
      try {
        // Path folder di Firebase: /karya/CID/nama_file
        const storageRef = ref(storage, `karya/${cid}/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
  
        const downloadURL = await getDownloadURL(storageRef);
        console.log("✅ Link gambar:", downloadURL);
  
        uploadStatus.innerText = "📤 Menyimpan ke Google Sheets...";
  
        // Kirim data ke Apps Script
        const res = await fetch("https://script.google.com/macros/s/AKfycbx5cPx2YQzYLbjMzFJPwIEr_bMsm4VGB8OA-04p33hnuXK61Mm36U04W3IrihbsIDukhw/exec", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cid, title, url: downloadURL })
        });
  
        const result = await res.json();
        uploadStatus.innerText = result.message || "✅ Berhasil!";
        location.reload();
      } catch (err) {
        console.error("❌ Upload error:", err);
        uploadStatus.innerText = "❌ Gagal upload: " + err.message;
      }
    });
  </script>
</body>
</html>
