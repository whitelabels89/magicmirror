<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MG-L2 Â· Mewarnai Penjumlahan (6â€“9)</title>
  <link rel="stylesheet" href="/elearn/worlds/calistung/math-game/mathgame-shell.css" />
  <style>
    :root{
      --c6:#e74c3c;
      --c7:#f1c40f;
      --c8:#2ecc71;
      --c9:#3498db;
      --bg:#f6f7fb;
      --ink:#1f2d3d;
    }
    *{box-sizing:border-box}
    .candy-stage{display:flex;flex-direction:column;gap:20px;position:relative}
    .candy-stage .legend{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:center}
    .swatch{display:flex;align-items:center;gap:8px;background:white;border:2px solid #eef2ff;padding:8px 12px;border-radius:14px;cursor:pointer;user-select:none;box-shadow:0 6px 14px rgba(15,59,113,.12);transition:transform .08s ease, box-shadow .12s ease}
    .swatch.active{outline:3px solid rgba(59,130,246,.3);box-shadow:0 10px 18px rgba(15,59,113,.18)}
    .swatch:focus{outline:4px solid rgba(59,130,246,.35)}
    .dot{width:28px;height:28px;border-radius:50%}
    .swatch b{font-size:18px}

    .status{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:center;margin-top:4px}
    .pill{background:white;border:1px solid #e5e9f5;border-radius:999px;padding:6px 12px;font-size:14px;box-shadow:0 6px 12px rgba(15,59,113,.1)}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:18px}

    .candy{position:relative;background:transparent;border:0;border-radius:18px;padding:10px;min-height:130px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:22px;cursor:pointer;transition:transform .08s ease, box-shadow .18s ease}
    .candy:active{transform:scale(.97)}
    .candy.disabled{pointer-events:none;opacity:.98}
    .candy svg{width:100%;height:120px;display:block}
    .candy.correct .label{color:#fff;text-shadow:0 1px 1px rgba(0,0,0,.25)}
    .candy .label{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:28px;font-weight:800;color:#222;pointer-events:none;z-index:2}

    .confetti{position:absolute;inset:0;pointer-events:none}
    @keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
    .oops{animation:shake .28s ease}
    .stage-note{color:#6b7280;font-size:13px;text-align:center}
    footer.stage-note strong{color:#111827}
  </style>
  <link rel="stylesheet" href="/elearn/worlds/calistung/buttons.css" />
</head>
<body class="mathgame-shell theme-mint" data-nav-badge="Calistung Math" data-nav-home-url="/elearn/worlds/calistung/index.html">
  <div class="shell-wrapper">
    <header class="shell-header">
      <div class="shell-header__title">
        <span class="shell-badge">Level 2</span>
        <h1 class="shell-title">Permen Penjumlahan 6â€“9</h1>
        <p class="shell-subtitle">Pilih warna dari palet, klik permen dengan hasil penjumlahan yang cocok, dan kunci semua warna.</p>
      </div>
      <div class="shell-hud">
        <div class="shell-pill">
          <span class="shell-pill-label">Permen Benar</span>
          <span class="shell-pill-value" data-hud-value="score">0 / 10</span>
        </div>
        <div class="shell-pill">
          <span class="shell-pill-label">Warna Terpilih</span>
          <span class="shell-pill-value" data-hud-value="palette">â€”</span>
        </div>
      </div>
    </header>

    <section class="mission-card">
      <h2>ðŸŽ¯ Misimu</h2>
      <p data-mission-text>Pilih warna 6â€“9 dari palet, lalu klik permen yang jumlahnya sama. Permen yang benar akan tetap berwarna.</p>
    </section>

    <main class="mathgame-stage">
      <section class="stage-card stage-card--contrast candy-stage">
        <div class="legend" id="palette" aria-label="Palet warna">
          <div class="swatch" data-value="6" data-color="var(--c6)" role="button" tabindex="0" aria-label="Warna untuk angka 6">
            <span class="dot" style="background:var(--c6)"></span><b>6</b>
          </div>
          <div class="swatch" data-value="7" data-color="var(--c7)" role="button" tabindex="0" aria-label="Warna untuk angka 7">
            <span class="dot" style="background:var(--c7)"></span><b>7</b>
          </div>
          <div class="swatch" data-value="8" data-color="var(--c8)" role="button" tabindex="0" aria-label="Warna untuk angka 8">
            <span class="dot" style="background:var(--c8)"></span><b>8</b>
          </div>
          <div class="swatch" data-value="9" data-color="var(--c9)" role="button" tabindex="0" aria-label="Warna untuk angka 9">
            <span class="dot" style="background:var(--c9)"></span><b>9</b>
          </div>
          <span class="pill" id="selectedInfo">Tidak ada warna terpilih</span>
        </div>

        <div class="status">
          <span class="pill">Benar: <b id="score">0</b>/10</span>
          <span class="pill" id="hint">Pilih warna dulu.</span>
        </div>

        <section class="grid" id="board" aria-label="Papan soal"></section>
        <canvas class="confetti" id="confetti" width="0" height="0"></canvas>
        <footer class="stage-note">MGâ€‘L2 â€¢ QueensAcademy. Warnai permen sesuai hasil penjumlahan 6â€“9.</footer>
      </section>
    </main>

    <section class="shell-action-bar" aria-label="Kontrol aksi">
      <button id="reset" class="shell-button ghost" type="button">â†º Reset</button>
      <button id="check" class="shell-button secondary" type="button">Periksa Jawaban</button>
      <button id="shuffle" class="shell-button" type="button">Acak Soal</button>
      <button id="btnSelesai" class="shell-button ghost" type="button">Selesai</button>
    </section>

    <aside class="buddy-widget" aria-label="Teman penyemangat">
      <div class="buddy-avatar" data-buddy-emoji aria-hidden="true">ðŸŽ¨</div>
      <div class="buddy-dialog" data-buddy-dialog>Pilih warna favoritmu dulu, lalu klik permennya. Warna yang benar akan terkunci.</div>
    </aside>
  </div>

  <script src="/elearn/worlds/calistung/math-game/mathgame-shell.js"></script>
  <script>
  const PROBLEMS = [
    {a:5,b:2},
    {a:3,b:3},
    {a:7,b:2},
    {a:5,b:3},
    {a:4,b:2},
    {a:7,b:2},
    {a:4,b:5},
    {a:5,b:1},
    {a:5,b:4},
    {a:4,b:4},
  ];

  let currentProblems = PROBLEMS.slice();

  const palette = document.getElementById('palette');
  const selectedInfo = document.getElementById('selectedInfo');
  const board = document.getElementById('board');
  const scoreEl = document.getElementById('score');
  const hintEl = document.getElementById('hint');
  const resetBtn = document.getElementById('reset');
  const checkBtn = document.getElementById('check');
  const shuffleBtn = document.getElementById('shuffle');
  const buddyEmojiEl = document.querySelector('[data-buddy-emoji]');
  const buddyDialogEl = document.querySelector('[data-buddy-dialog]');
  const hudScoreEl = document.querySelector('[data-hud-value="score"]');
  const hudPaletteEl = document.querySelector('[data-hud-value="palette"]');

  let selected = null;
  let score = 0;

  const defaultBuddyText = 'Pilih warna lalu klik permennya. Warna benar akan terkunci!';

  function setBuddy(emoji, text){
    if(buddyEmojiEl && emoji){ buddyEmojiEl.textContent = emoji; }
    if(buddyDialogEl && text){ buddyDialogEl.textContent = text; }
    if(window.mathgameShell && typeof window.mathgameShell.setBuddyMood === 'function'){
      window.mathgameShell.setBuddyMood(emoji, text);
    }
  }

  function syncHud(){
    const label = `${score} / ${currentProblems.length}`;
    if(hudScoreEl) hudScoreEl.textContent = label;
    if(hudPaletteEl) hudPaletteEl.textContent = selected ? selected.value : 'â€”';
    if(window.mathgameShell && typeof window.mathgameShell.updateHud === 'function'){
      window.mathgameShell.updateHud({ score: label, palette: selected ? selected.value : 'â€”' });
    }
  }

  function candySVG(){
    return `
    <svg viewBox="0 0 180 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <path class="fillable wrap" d="M24 18 C18 10, 8 10, 6 24 C5 35, 10 44, 18 50 C8 56, 4 70, 8 82 C12 92, 22 94, 28 86 L44 60 Z" fill="#ffffff" stroke="#111" stroke-width="3" />
      <rect class="fillable body" x="44" y="24" width="92" height="72" rx="22" ry="22" fill="#ffffff" stroke="#111" stroke-width="3" />
      <path class="fillable wrap" d="M136 60 L152 86 C158 94, 168 92, 172 82 C176 70, 172 56, 162 50 C170 44, 175 35, 174 24 C172 10, 162 10, 156 18 Z" fill="#ffffff" stroke="#111" stroke-width="3" />
    </svg>`;
  }

  function createCandy(idx, a, b){
    const el = document.createElement('div');
    el.className = 'candy';
    el.dataset.index = idx;
    el.dataset.a = a;
    el.dataset.b = b;
    el.dataset.answer = a + b;
    el.setAttribute('role','button');
    el.setAttribute('tabindex','0');
    el.setAttribute('aria-label',`Permen ${a}+${b}`);
    el.innerHTML = candySVG() + `<span class="label">${a}+${b}</span>`;
    el.addEventListener('click', () => paint(el));
    el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); paint(el); }});
    return el;
  }

  function build(){
    board.innerHTML = '';
    currentProblems.forEach((p,i)=> board.appendChild(createCandy(i,p.a,p.b)));
    score = 0;
    selected = null;
    selectedInfo.textContent = 'Tidak ada warna terpilih';
    hintEl.textContent = 'Pilih warna lalu klik permen.';
    setBuddy('ðŸŽ¨', defaultBuddyText);
    updateScore();
  }

  function updateScore(){
    scoreEl.textContent = score;
    syncHud();
    if(score === currentProblems.length){
      hintEl.textContent = 'Hebat! Semua benar ðŸŽ‰';
      setBuddy('ðŸŽ‰', 'Permenmu penuh warna! Semua jawaban tepat.');
      celebrate();
    }
  }

  function setSelected(value, color){
    selected = {value:Number(value), color};
    [...document.querySelectorAll('.swatch')].forEach(s=>s.classList.toggle('active', s.dataset.value==value));
    selectedInfo.textContent = `Warna terpilih: ${value}`;
    hintEl.textContent = 'Klik permen yang sesuai.';
    syncHud();
  }

  palette.addEventListener('click', (e)=>{
    const sw = e.target.closest('.swatch');
    if(!sw) return;
    setSelected(sw.dataset.value, getComputedStyle(document.documentElement).getPropertyValue(colorVar(sw.dataset.value)).trim());
  });

  palette.addEventListener('keydown',(e)=>{
    const sw = e.target.closest('.swatch');
    if(!sw) return;
    if(e.key==='Enter' || e.key===' '){
      e.preventDefault();
      setSelected(sw.dataset.value, getComputedStyle(document.documentElement).getPropertyValue(colorVar(sw.dataset.value)).trim());
    }
  });

  function colorVar(val){
    return val==6? '--c6' : val==7? '--c7' : val==8? '--c8' : '--c9';
  }

  function paint(el){
    if(!selected){ hintEl.textContent = 'Pilih warna dulu ya.'; return; }
    if(el.classList.contains('disabled')) return;
    el.querySelectorAll('.fillable').forEach(n=>{ n.setAttribute('fill', selected.color); });
    el.querySelector('.label').style.color = '#fff';
    el.dataset.chosen = String(selected.value);
    hintEl.textContent = 'Klik "Periksa Jawaban" untuk menilai.';
  }

  checkBtn.addEventListener('click', ()=>{
    let newlyCorrect = 0;
    [...board.children].forEach(el=>{
      if(el.classList.contains('disabled')) return;
      const chosen = Number(el.dataset.chosen || NaN);
      const ans = Number(el.dataset.answer);
      if(!Number.isNaN(chosen)){
        if(chosen === ans){
          el.classList.add('correct','disabled');
          const ansColor = getComputedStyle(document.documentElement).getPropertyValue(colorVar(ans)).trim();
          el.querySelectorAll('.fillable').forEach(n=> n.setAttribute('fill', ansColor));
          el.querySelector('.label').style.color = '#fff';
          newlyCorrect++;
        } else {
          el.classList.add('oops');
          setTimeout(()=>{ el.classList.remove('oops'); }, 320);
          el.querySelectorAll('.fillable').forEach(n=> n.setAttribute('fill', '#ffffff'));
          el.querySelector('.label').style.color = '';
          delete el.dataset.chosen;
        }
      }
    });
    if(newlyCorrect>0){ score += newlyCorrect; updateScore(); }
    else { hintEl.textContent = 'Coba lanjutkan yang belum benar.'; }
  });

  resetBtn.addEventListener('click', ()=>{
    currentProblems = PROBLEMS.slice();
    build();
  });

  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

  shuffleBtn.addEventListener('click', ()=>{
    currentProblems = shuffle(PROBLEMS.slice());
    build();
    hintEl.textContent = 'Soal diacak. Pilih warna lalu klik permen.';
  });

  function celebrate(){
    const cvs = document.getElementById('confetti');
    const ctx = cvs.getContext('2d');
    const {innerWidth:w, innerHeight:h} = window; cvs.width=w; cvs.height=h;
    const bits = Array.from({length:160},()=>({
      x: Math.random()*w,
      y: -20 - Math.random()*h*.5,
      r: 4+Math.random()*4,
      s: 1+Math.random()*2,
      c: ['var(--c6)','var(--c7)','var(--c8)','var(--c9)'][Math.floor(Math.random()*4)]
    }));
    let t=0; const maxT=1500;
    (function draw(){
      t+=16; ctx.clearRect(0,0,w,h);
      bits.forEach(b=>{ b.y += b.s*3; b.x += Math.sin((t+b.y)/40); ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue(b.c); ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); });
      if(t<maxT) requestAnimationFrame(draw); else ctx.clearRect(0,0,w,h);
    })();
  }

  build();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="/elearn/manifest-lessons.js"></script>
  <script src="/elearn/userInfo.js"></script>
  <script src="/elearn/common/worksheet-submit.js"></script>
  <script>
    window.WORKSHEET_DEBUG = true;
    window.WORKSHEET_META = { course_id: "mathgame-basic" };
    const info = (typeof getUserInfo === "function") ? getUserInfo() : {};
    initWorksheetSubmit({
      muridUid: info.uid || "",
      cid: info.cid || "",
      namaAnak: info.nama || "",
      role: (info.role || "").toLowerCase()
    });
  </script>
  <script src="/elearn/common/calistung-navbar.js"></script>
</body>
</html>
