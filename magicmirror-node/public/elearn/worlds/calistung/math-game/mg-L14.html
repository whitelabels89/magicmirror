<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MG-L14 — Target Sum Challenge</title>
  <link rel="stylesheet" href="/elearn/worlds/calistung/math-game/mathgame-shell.css" />
  <style>
    .target-stage {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .target-layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 20px;
    }

    @media (max-width: 820px){
      .target-layout { grid-template-columns: 1fr; }
    }

    .target-card {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(122, 124, 251, 0.25);
      border-radius: 22px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      color: rgba(15, 23, 42, 0.88);
      box-shadow: 0 16px 40px rgba(15, 59, 113, 0.14);
    }

    .target-number {
      font-size: 56px;
      font-weight: 900;
      letter-spacing: 1px;
    }

    .progress {
      height: 10px;
      background: rgba(226, 232, 240, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.45);
      border-radius: 999px;
      overflow: hidden;
    }

    .progress > i {
      display: block;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #7bdcff, #ffd36e);
      transition: width .35s ease;
    }

    .target-card__stats {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .target-card__stats .shell-pill {
      background: rgba(12, 18, 35, 0.92);
      color: #eaf2ff;
      border: 1px solid rgba(122, 124, 251, 0.3);
      box-shadow: 0 10px 24px rgba(12, 18, 45, 0.18);
    }

    .target-card__stats .shell-pill strong {
      color: inherit;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(110px,1fr));
      gap: 14px;
    }

    @media (max-width: 620px){
      .grid { grid-template-columns: repeat(2, minmax(120px,1fr)); }
    }

    .token {
      position: relative;
      user-select: none;
      cursor: pointer;
      border: none;
      width: 100%;
      aspect-ratio: 5/3;
      border-radius: 18px;
      background:
        radial-gradient(120% 180% at -10% -20%, rgba(255,255,255,.15), rgba(255,255,255,0) 40%),
        linear-gradient(135deg, #2a3a71, #1c2852 55%, #162046);
      border: 1px solid #263568;
      box-shadow: inset 0 6px 12px rgba(0,0,0,.35), 0 10px 20px rgba(0,0,0,.35);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 38px;
      color: #f0f6ff;
      text-shadow: 0 2px 0 rgba(0,0,0,.35);
      transition: transform .08s ease, filter .15s ease, outline-color .2s ease;
      outline: 2px solid transparent;
    }

    .token:hover { filter: brightness(1.05); }
    .token:active { transform: translateY(2px); }
    .token.selected { outline: 3px solid #ffd36e; background: linear-gradient(135deg, #32469a, #24356d 55%, #1a2754); }
    .token.correct { outline: 3px solid #5bf595; animation: bounce .45s ease; }
    .token.wrong { outline: 3px solid #ff6b6b; animation: shake .35s ease; }

    @keyframes shake{10%{transform:translateX(-2px)} 30%{transform:translateX(3px)} 50%{transform:translateX(-3px)} 70%{transform:translateX(2px)} 100%{transform:translateX(0)} }
    @keyframes bounce{0%{transform:scale(1)} 40%{transform:scale(1.06)} 100%{transform:scale(1)} }

    .notice {
      margin-top: 10px;
      font-size: 14px;
      color: rgba(71, 85, 105, 0.88);
    }
  </style>
  <link rel="stylesheet" href="/elearn/worlds/calistung/buttons.css" />
</head>
<body class="mathgame-shell theme-neon" data-nav-badge="Calistung Math" data-nav-home-url="/elearn/worlds/calistung/index.html">
  <div class="shell-wrapper">
    <header class="shell-header">
      <div class="shell-header__title">
        <span class="shell-badge">Level 14</span>
        <h1 class="shell-title">Target Sum Challenge</h1>
        <p class="shell-subtitle">Pilih 2–3 kartu angka hingga jumlahnya sama dengan target. Kumpulkan skor tinggi per ronde!</p>
      </div>
      <div class="shell-hud">
        <div class="shell-pill">
          <span class="shell-pill-label">Skor</span>
          <span class="shell-pill-value" data-hud-value="score">0</span>
        </div>
        <div class="shell-pill">
          <span class="shell-pill-label">Ronde</span>
          <span class="shell-pill-value" data-hud-value="round">1</span>
        </div>
        <div class="shell-pill">
          <span class="shell-pill-label">Waktu</span>
          <span class="shell-pill-value" data-hud-value="time" data-hud-format="time">00:00</span>
        </div>
      </div>
    </header>

    <section class="mission-card">
      <h2>🎯 Misimu</h2>
      <p data-mission-text>Pilih kombinasi angka yang nilainya sama dengan target. Gunakan tombol Cek Jawaban untuk mengetahui hasilmu.</p>
    </section>

    <main class="mathgame-stage">
      <section class="stage-card stage-card--contrast target-stage">
        <div class="target-layout">
          <section class="target-card">
            <div>
              <div class="target-label">Jumlahkan angka menjadi</div>
              <div class="target-number" id="target">—</div>
            </div>
            <div class="progress"><i id="progressBar"></i></div>
            <div class="target-card__stats" aria-live="polite">
              <div class="shell-pill">Skor: <strong id="score">0</strong></div>
              <div class="shell-pill">Ronde: <strong id="round">1</strong>/10</div>
              <div class="shell-pill">Waktu: <strong id="time">00:00</strong></div>
            </div>
            <p class="notice">Pilih 2–3 kartu angka hingga totalnya sama dengan target. Tekan Acak Soal untuk menyusun ulang angka tanpa menghapus skor.</p>
          </section>
          <section>
            <div class="grid" id="grid"></div>
          </section>
        </div>
      </section>
    </main>

    <section class="shell-action-bar" aria-label="Kontrol aksi">
      <button id="btnCheck" class="shell-button" type="button">✅ Periksa Jawaban</button>
      <button id="btnShuffle" class="shell-button secondary" type="button">🔄 Acak Soal</button>
      <button id="btnReset" class="shell-button ghost" type="button">↺ Reset</button>
      <button id="btnSelesai" class="shell-button ghost" type="button">Selesai</button>
    </section>

    <aside class="buddy-widget" aria-label="Teman penyemangat">
      <div class="buddy-avatar" data-buddy-emoji aria-hidden="true">🎯</div>
      <div class="buddy-dialog" data-buddy-dialog>Pilih 2 atau 3 angka yang kalau dijumlahkan sama dengan target. Cek jawabanmu untuk dapat skor!</div>
    </aside>
  </div>
  <script src="/elearn/worlds/calistung/math-game/mathgame-shell.js"></script>
  <script>
  (function(){
    const grid = document.getElementById('grid');
    const targetEl = document.getElementById('target');
    const scoreEl = document.getElementById('score');
    const roundEl = document.getElementById('round');
    const timeEl = document.getElementById('time');
    const bar = document.getElementById('progressBar');
    const btnCheck = document.getElementById('btnCheck');
    const btnShuffle = document.getElementById('btnShuffle');
    const btnReset = document.getElementById('btnReset');
    const ok = document.getElementById('sfx-ok');
    const bad = document.getElementById('sfx-bad');

    const hudScoreEl = document.querySelector('[data-hud-value="score"]');
    const hudRoundEl = document.querySelector('[data-hud-value="round"]');
    const hudTimeEl = document.querySelector('[data-hud-value="time"]');
    const buddyEmojiEl = document.querySelector('[data-buddy-emoji]');
    const buddyDialogEl = document.querySelector('[data-buddy-dialog]');

    const maxRound = 10;

    let state = {
      round: 1,
      score: 0,
      target: 0,
      tokens: [],
      selectedIdx: new Set(),
      startTime: Date.now(),
      timer: null
    };
    let isTransitioning = false;

    function setBuddy(emoji, text){
      if(buddyEmojiEl && emoji){ buddyEmojiEl.textContent = emoji; }
      if(buddyDialogEl && text){ buddyDialogEl.textContent = text; }
      if(window.mathgameShell && typeof window.mathgameShell.setBuddyMood === 'function'){
        window.mathgameShell.setBuddyMood(emoji, text);
      }
    }

    function fmt(n){return n<10?`0${n}`:`${n}`}

    function syncHud(){
      const seconds = Math.floor((Date.now() - state.startTime)/1000);
      const minutes = Math.floor(seconds / 60);
      const ss = seconds % 60;
      const timeLabel = `${fmt(minutes)}:${fmt(ss)}`;
      timeEl.textContent = timeLabel;
      if(hudScoreEl) hudScoreEl.textContent = state.score;
      if(hudRoundEl) hudRoundEl.textContent = state.round;
      if(hudTimeEl) hudTimeEl.textContent = timeLabel;
      if(window.mathgameShell && typeof window.mathgameShell.updateHud === 'function'){
        window.mathgameShell.updateHud({ score: state.score, round: state.round, time: seconds });
      }
    }

    function tick(){
      syncHud();
    }

    function randomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min}

    function resetTimer(){
      if(state.timer) clearInterval(state.timer);
      state.startTime = Date.now();
      state.timer = setInterval(tick, 500);
      syncHud();
    }

    function generateRound(resetProgress){
      if(!resetProgress){
        state.round = 1;
        state.score = 0;
      }
      resetTimer();
      buildBoard(true);
      updateUI();
      setBuddy('🎯', 'Pilih angka sesuai target, lalu cek jawabannya.');
    }

    function buildBoard(newTarget=false){
      const poolSize = 8;
      const nums=[];
      while(nums.length<poolSize){
        const n=randomInt(1,15);
        if(!nums.includes(n)) nums.push(n);
      }
      const shuffled=[...nums].sort(()=>Math.random()-0.5);
      const comboLen = Math.random()<0.65?2:3;
      let target = 0;
      for(let i=0;i<comboLen;i++){ target += shuffled[i]; }
      state.target = newTarget ? target : state.target || target;
      state.tokens = nums;
      state.selectedIdx = new Set();
      isTransitioning = false;
      renderGrid();
    }

    function renderGrid(){
      grid.innerHTML = '';
      state.tokens.forEach((n,idx)=>{
        const btn = document.createElement('button');
        btn.className = 'token'; btn.type='button'; btn.textContent = n;
        btn.setAttribute('aria-pressed', 'false');
        btn.addEventListener('click',()=>toggleSelect(idx, btn));
        grid.appendChild(btn);
      });
      targetEl.textContent = state.target;
      bar.style.width = `${Math.min(100, (state.score % 100))}%`;
      syncHud();
    }

    function toggleSelect(idx, el){
      if(isTransitioning) return;
      if(state.selectedIdx.has(idx)){
        state.selectedIdx.delete(idx);
        el.classList.remove('selected');
        el.setAttribute('aria-pressed','false');
      } else {
        if(state.selectedIdx.size >= 3){
          setBuddy('😉', 'Cukup pilih 2 atau 3 angka saja ya.');
          return;
        }
        state.selectedIdx.add(idx);
        el.classList.add('selected');
        el.setAttribute('aria-pressed','true');
      }
      evaluateSelectionAuto();
    }

    function currentSum(){
      let sum = 0;
      state.selectedIdx.forEach(i=> sum += state.tokens[i]);
      return sum;
    }

    function flashResult(correct, onDone){
      const nodes=[...grid.children];
      const selected = [...state.selectedIdx];
      selected.forEach(i=>{
        const el=nodes[i];
        if(!el) return;
        el.classList.add(correct? 'correct':'wrong');
        setTimeout(()=>{
          el.classList.remove('correct','wrong','selected');
          el.setAttribute('aria-pressed','false');
        }, 360);
      });
      state.selectedIdx.clear();
      if(typeof onDone === 'function'){
        setTimeout(onDone, correct ? 180 : 380);
      }
    }

    function nextRound(){
      state.round = Math.min(maxRound, state.round + 1);
      buildBoard(true);
      updateUI();
      setBuddy('🚀', `Ronde ${state.round}. Cari kombinasi baru yang nilainya ${state.target}!`);
    }

    function handleCorrect(auto=false){
      if(isTransitioning) return;
      isTransitioning = true;
      state.score += 10;
      scoreEl.textContent = state.score;
      ok.currentTime = 0;
      ok.play().catch(()=>{});
      bar.style.width = `${Math.min(100, (state.score % 100))}%`;
      const successMsg = auto
        ? 'Mantap! Kombinasinya pas, soal baru siap.'
        : 'Hebat! Kombinasinya tepat, lanjut ke tantangan berikutnya.';
      setBuddy('🏆', successMsg);
      flashResult(true, () => {
        nextRound();
        isTransitioning = false;
        syncHud();
      });
    }

    function handleIncorrect(){
      if(isTransitioning) return;
      isTransitioning = true;
      state.score = Math.max(0, state.score - 2);
      scoreEl.textContent = state.score;
      bad.currentTime=0; bad.play().catch(()=>{});
      bar.style.width = `${Math.min(100, (state.score % 100))}%`;
      flashResult(false, () => {
        isTransitioning = false;
        syncHud();
      });
      setBuddy('🧐', 'Belum pas. Coba kombinasi angka lain yang nilainya sama dengan target.');
    }

    function evaluateSelectionAuto(){
      if(state.selectedIdx.size < 2 || state.selectedIdx.size > 3) return;
      if(isTransitioning) return;
      if(currentSum() === state.target){
        handleCorrect(true);
      }
    }

    btnCheck.addEventListener('click', ()=>{
      if(isTransitioning) return;
      if(state.selectedIdx.size === 0){
        setBuddy('🤔', 'Pilih dulu 2 atau 3 angka sebelum mengecek ya.');
        return;
      }
      if(currentSum() === state.target){
        handleCorrect();
      } else {
        handleIncorrect();
      }
    });

    btnShuffle.addEventListener('click', ()=>{
      buildBoard(true);
      const pick=[...state.tokens].sort(()=>Math.random()-0.5);
      const len=Math.random()<0.65?2:3;
      let t=0; for(let i=0;i<len;i++){t+=pick[i];}
      state.target=t;
      targetEl.textContent=t;
      setBuddy('🎲', 'Angkanya diacak. Temukan kombinasi baru!');
      isTransitioning = false;
      syncHud();
    });

    btnReset.addEventListener('click', ()=>{
      generateRound(false);
    });

    function updateUI(){
      scoreEl.textContent = state.score;
      roundEl.textContent = `${state.round}`;
      syncHud();
    }

    generateRound(true);
  })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="/elearn/manifest-lessons.js"></script>
  <script src="/elearn/userInfo.js"></script>
  <script src="/elearn/common/worksheet-submit.js"></script>
  <script>
    window.WORKSHEET_DEBUG = true;
    window.WORKSHEET_META = { course_id: "mathgame-basic" };
    const info = (typeof getUserInfo === "function") ? getUserInfo() : {};
    initWorksheetSubmit({
      muridUid: info.uid || "",
      cid: info.cid || "",
      namaAnak: info.nama || "",
      role: (info.role || "").toLowerCase()
    });
  </script>
  <script src="/elearn/common/calistung-navbar.js"></script>
</body>
</html>
