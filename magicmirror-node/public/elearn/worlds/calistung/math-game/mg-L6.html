<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Game Logika Gambar</title>
  <link rel="stylesheet" href="/elearn/worlds/calistung/math-game/mathgame-shell.css" />
  <style>
    .logic-stage{display:flex;flex-direction:column;gap:18px;align-items:center}
    .logic-rows{display:grid;gap:16px;width:100%}
    .logic-row{display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap;font-size:24px}
    .logic-row .emoji{font-size:44px}
    .logic-row input[type="number"]{width:90px;font-size:22px;padding:6px 8px;text-align:center;border-radius:14px;border:2px solid rgba(248,113,113,.35);transition:border-color .18s ease, box-shadow .18s ease}
    .logic-row input[type="number"]:focus{outline:none;border-color:#f97316;box-shadow:0 0 0 4px rgba(249,115,22,.2)}
    .result-box{font-weight:700;font-size:18px;color:#ea580c;text-align:center;min-height:28px}
  </style>
  <link rel="stylesheet" href="/elearn/worlds/calistung/buttons.css" />
</head>
<body class="mathgame-shell theme-sunset" data-nav-badge="Calistung Math" data-nav-home-url="/elearn/worlds/calistung/index.html">
  <div class="shell-wrapper">
    <header class="shell-header">
      <div class="shell-header__title">
        <span class="shell-badge">Level 6</span>
        <h1 class="shell-title">Jumlahkan Angka Sesuai Gambar</h1>
        <p class="shell-subtitle">Amati kode gambar, hitung nilainya, dan isi hasil penjumlahan terakhir.</p>
      </div>
      <div class="shell-hud">
        <div class="shell-pill">
          <span class="shell-pill-label">Percobaan</span>
          <span class="shell-pill-value" data-hud-value="attempts">0</span>
        </div>
        <div class="shell-pill">
          <span class="shell-pill-label">Status</span>
          <span class="shell-pill-value" data-hud-value="status">Menunggu</span>
        </div>
      </div>
    </header>

    <section class="mission-card">
      <h2>üéØ Misimu</h2>
      <p data-mission-text>Temukan nilai setiap gambar, lalu hitung jumlah dari tiga gambar berbeda dan tulis jawabannya.</p>
    </section>

    <main class="mathgame-stage">
      <section class="stage-card stage-card--contrast logic-stage">
        <h2 class="stage-section-title">Tebak Nilai Gambarnya</h2>
        <div class="logic-rows" id="questionRows"></div>
        <p class="result-box" id="resultBox"></p>
      </section>
    </main>

    <section class="shell-action-bar" aria-label="Kontrol aksi">
      <button id="btnShuffle" class="shell-button secondary" type="button">üîÑ Acak Soal</button>
      <button id="btnCheck" class="shell-button" type="button">‚úÖ Cek Jawaban</button>
      <button id="btnSelesai" class="shell-button ghost" type="button">Selesai</button>
    </section>

    <aside class="buddy-widget" aria-label="Teman penyemangat">
      <div class="buddy-avatar" data-buddy-emoji aria-hidden="true">üçä</div>
      <div class="buddy-dialog" data-buddy-dialog>Tulis nilai yang cocok dengan gambar di setiap baris. Untuk baris terakhir, jumlahkan semuanya ya!</div>
    </aside>
  </div>

  <script src="/elearn/worlds/calistung/math-game/mathgame-shell.js"></script>
  <script>
    const characters = [
      { options: ["üçé", "üçä", "üçå"], value: 0, chosen: "" },
      { options: ["üßÄ", "üçï", "üçû"], value: 0, chosen: "" },
      { options: ["ü•ö", "üç©", "ü•ú"], value: 0, chosen: "" }
    ];

    const rowsContainer = document.getElementById('questionRows');
    const resultBox = document.getElementById('resultBox');
    const btnShuffle = document.getElementById('btnShuffle');
    const btnCheck = document.getElementById('btnCheck');
    const buddyEmojiEl = document.querySelector('[data-buddy-emoji]');
    const buddyDialogEl = document.querySelector('[data-buddy-dialog]');
    const hudAttemptsEl = document.querySelector('[data-hud-value="attempts"]');
    const hudStatusEl = document.querySelector('[data-hud-value="status"]');

    let attempts = 0;

    function setBuddy(emoji, text){
      if(buddyEmojiEl && emoji){ buddyEmojiEl.textContent = emoji; }
      if(buddyDialogEl && text){ buddyDialogEl.textContent = text; }
      if(window.mathgameShell && typeof window.mathgameShell.setBuddyMood === 'function'){
        window.mathgameShell.setBuddyMood(emoji, text);
      }
    }

    function syncHud(status){
      if(hudAttemptsEl) hudAttemptsEl.textContent = attempts;
      if(hudStatusEl) hudStatusEl.textContent = status;
      if(window.mathgameShell && typeof window.mathgameShell.updateHud === 'function'){
        window.mathgameShell.updateHud({ attempts, status });
      }
    }

    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function clearRows(){
      rowsContainer.innerHTML = '';
    }

    function createRow(row, index){
      const div = document.createElement('div');
      div.className = 'logic-row';
      row.forEach((id, i) => {
        const span = document.createElement('span');
        span.className = 'emoji';
        span.textContent = characters[id].chosen;
        div.appendChild(span);
        if (i < row.length - 1) {
          const plus = document.createElement('span');
          plus.textContent = '+';
          div.appendChild(plus);
        }
      });
      const eq = document.createElement('span');
      eq.className = 'equal';
      eq.textContent = '=';
      eq.style.fontWeight = '700';
      div.appendChild(eq);
      if(index === 3){
        const input = document.createElement('input');
        input.type = 'number';
        input.id = 'answerInput';
        input.setAttribute('aria-label','Jawaban penjumlahan tiga gambar berbeda');
        div.appendChild(input);
      } else {
        const total = row.reduce((a, id) => a + characters[id].value, 0);
        const result = document.createElement('span');
        result.textContent = total;
        result.style.fontWeight = '700';
        div.appendChild(result);
      }
      rowsContainer.appendChild(div);
    }

    function setupQuestions() {
      characters.forEach(char => {
        char.value = getRandomInt(2, 9);
        char.chosen = char.options[Math.floor(Math.random() * char.options.length)];
      });
      const rows = [
        [0, 0, 0],
        [1, 1, 1],
        [2, 2, 2],
        [0, 1, 2]
      ];
      clearRows();
      rows.forEach((row, index) => createRow(row, index));
      const input = document.getElementById('answerInput');
      if(input){ input.value = ''; input.style.backgroundColor = '#fff'; }
      resultBox.textContent = '';
      attempts = 0;
      setBuddy('üçä', 'Tebak nilainya dari baris pertama, kedua, dan ketiga. Lalu jumlahkan ketiganya di baris terakhir.');
      syncHud('Menunggu');
    }

    function checkAnswer() {
      const input = document.getElementById('answerInput');
      if(!input){ return; }
      const correct = characters[0].value + characters[1].value + characters[2].value;
      attempts += 1;
      if (parseInt(input.value, 10) === correct) {
        input.style.backgroundColor = '#c8f7c5';
        resultBox.textContent = `Hebat! Jawabannya ${correct}.`; 
        setBuddy('üéâ', 'Jawabanmu tepat! Gambar-gambar itu jumlahnya segitu.');
        syncHud('Benar');
      } else {
        input.style.backgroundColor = '#f7c5c5';
        resultBox.textContent = 'Belum tepat, coba hitung lagi ya!';
        setBuddy('ü§î', 'Coba jumlahkan ulang nilai masing-masing gambar.');
        syncHud('Belum benar');
      }
    }

    btnShuffle.addEventListener('click', setupQuestions);
    btnCheck.addEventListener('click', checkAnswer);

    setupQuestions();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="/elearn/manifest-lessons.js"></script>
  <script src="/elearn/userInfo.js"></script>
  <script src="/elearn/common/worksheet-submit.js"></script>
  <script>
    window.WORKSHEET_DEBUG = true;
    window.WORKSHEET_META = { course_id: "mathgame-basic" };
    const info = (typeof getUserInfo === "function") ? getUserInfo() : {};
    initWorksheetSubmit({
      muridUid: info.uid || "",
      cid: info.cid || "",
      namaAnak: info.nama || "",
      role: (info.role || "").toLowerCase()
    });
  </script>
  <script src="/elearn/common/calistung-navbar.js"></script>
</body>
</html>
