<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MG-L8a — Koding Pengurangan (Honeycomb)</title>
  <style>
    :root{
      --bg:#0f1226; /* dark indigo */
      --panel:#171a33;
      --accent:#57b0ff;
      --accent-2:#78d0ff;
      --good:#19d27e;
      --bad:#ff5a78;
      --ink:#e9efff;
      --muted:#9fb1d6;
      --drop:#20254a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Poppins, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      background: radial-gradient(1200px 700px at 20% 0%, #1b2148, #0f1226 60%);
      color:var(--ink);
    }
    header{padding:20px 16px 0; text-align:center}
    h1{margin:0; letter-spacing:0.5px; font-size:clamp(20px, 2.6vw, 30px)}
    .subtitle{color:var(--muted); margin-top:6px; font-size:clamp(12px, 1.6vw, 14px)}

    .game-wrap{
      max-width:1100px; margin:18px auto; padding:16px; 
    }

    .hud{display:flex; gap:10px; justify-content:center; margin-bottom:12px}
    .btn{
      border:none; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:700;
      background:linear-gradient(180deg, #2a3a77, #1a2356);
      color:#fff; box-shadow:0 6px 0 #0a133d, inset 0 1px 0 rgba(255,255,255,0.15);
      transition:transform .05s ease, box-shadow .05s ease; letter-spacing:.2px
    }
    .btn:active{transform:translateY(2px); box-shadow:0 4px 0 #0a133d}
    .btn.secondary{background:linear-gradient(180deg, #31406e, #222c54)}

    .board{
      display:grid; 
      grid-template-columns: 1fr clamp(12px,2vw,18px) 1fr; 
      gap:18px; align-items:start;
    }

    /* Left column: problems */
    .problems{display:flex; flex-direction:column; gap:14px}
    .problem{
      background:var(--panel); border-radius:16px; padding:12px 12px; 
      display:grid; grid-template-columns:auto 24px auto 42px; align-items:center; gap:8px;
      outline:1px solid #252a52; position:relative; min-height:96px
    }
    .sym{font-weight:900; color:var(--muted); text-align:center}
    .dropzone{
      width:42px; height:42px; border-radius:10px; background:var(--drop);
      outline:2px dashed #4250a3; outline-offset:-6px; display:flex; align-items:center; justify-content:center; color:#7e8fd6; font-size:12px;
    }
    .problem.ok{outline:2px solid var(--good)}
    .problem.nope{outline:2px solid var(--bad)}

    /* Right column: answers */
    .answers{display:flex; flex-direction:column; gap:14px}
    .card{
      background:var(--panel); border-radius:16px; padding:10px; display:flex; align-items:center; justify-content:center;
      min-height:96px; outline:1px solid #252a52; cursor:grab; user-select:none
    }
    .card:active{cursor:grabbing}
    .card.attached{opacity:.85; cursor:not-allowed}

    /* Utility */
    .note{color:var(--muted); font-size:12px; text-align:center; margin-top:8px}

    /* SVG sizing containers */
    .cluster{width:160px; height:90px; display:flex; align-items:center; justify-content:center}

    /* Toast */
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#11162f; color:#dfe6ff; padding:10px 14px; border-radius:12px; box-shadow: 0 8px 30px rgba(0,0,0,.35); display:none }
    .toast.show{ display:inline-block }

    @media (max-width: 860px){
      .board{ grid-template-columns: 1fr; }
      .answers{ order:2 }
      .problems{ order:1 }
    }
  </style>
</head>
<body>
  <header>
    <h1>KODING PENGURANGAN</h1>
    <div class="subtitle">Hitung pengurangan bangun datar (honeycomb) lalu pasangkan dengan jawabannya yang tepat.</div>
  </header>

  <div class="game-wrap">
    <div class="hud">
      <button id="btnCheck" class="btn">Periksa Jawaban</button>
      <button id="btnShuffle" class="btn secondary">Acak Soal</button>
    </div>

    <div class="board">
      <div class="problems" id="problems"></div>
      <div></div>
      <div class="answers" id="answers"></div>
    </div>
    <div class="note">Tarik kartu jawaban ke kotak di tiap baris. Di HP: tap kartu lalu tap kotak tujuan.</div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ========= Utility =========
    const $ = (sel, el=document)=>el.querySelector(sel);
    const $$ = (sel, el=document)=>Array.from(el.querySelectorAll(sel));
    const rand = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;

    function showToast(msg, ms=1600){
      const t = $('#toast');
      t.textContent = msg; t.classList.add('show');
      clearTimeout(showToast._id);
      showToast._id = setTimeout(()=>t.classList.remove('show'), ms);
    }

    // ========= SVG Honeycomb =========
    function hexPoints(cx, cy, size){
      // pointy-top hex
      const pts = [];
      for(let i=0;i<6;i++){
        const ang = Math.PI/180 * (60*i - 30);
        const x = cx + size * Math.cos(ang);
        const y = cy + size * Math.sin(ang);
        pts.push(`${x.toFixed(2)},${y.toFixed(2)}`);
      }
      return pts.join(' ');
    }

    function axialToPixel(q, r, size){
      // pointy orientation
      const x = size * Math.sqrt(3) * (q + r/2);
      const y = size * 1.5 * r;
      return {x, y};
    }

    function makeClusterSVG(coloredCount=0, {size=14, stroke='#2a3778'}={}){
      const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
      svg.setAttribute('viewBox','-55 -50 110 100');
      svg.setAttribute('width','150');
      svg.setAttribute('height','84');

      const order = [ {q:0,r:0}, {q:1,r:0}, {q:1,r:-1}, {q:0,r:-1}, {q:-1,r:0}, {q:-1,r:1}, {q:0,r:1} ];
      // background subtle
      const bg = document.createElementNS(svg.namespaceURI,'rect');
      bg.setAttribute('x','-60'); bg.setAttribute('y','-52'); bg.setAttribute('width','120'); bg.setAttribute('height','104');
      bg.setAttribute('rx','14'); bg.setAttribute('fill','transparent');
      svg.appendChild(bg);

      order.forEach((ax, idx)=>{
        const {x, y} = axialToPixel(ax.q, ax.r, size);
        const poly = document.createElementNS(svg.namespaceURI,'polygon');
        poly.setAttribute('points', hexPoints(x, y, size));
        const on = idx < coloredCount; // first N are blue
        poly.setAttribute('fill', on ? '#64b2ff' : '#f0f4ff');
        poly.setAttribute('stroke', stroke);
        poly.setAttribute('stroke-width', '2');
        svg.appendChild(poly);
      });
      return svg;
    }

    // ========= Game State =========
    const STATE = {
      problems: [], // {id, a, b, result}
      mapping: new Map(), // problemId -> answerId
      answers: [] // {id, value}
    };

    const PROBLEM_COUNT = 5;

    function genProblems(){
      STATE.problems = [];
      for(let i=0;i<PROBLEM_COUNT;i++){
        const a = rand(2,7); // 2..7
        const b = rand(0,a-1); // ensure non-negative
        STATE.problems.push({ id: `p${i+1}`, a, b, result: a-b });
      }
      // generate answers from results then shuffle
      STATE.answers = STATE.problems.map((p,i)=>({ id:`a${i+1}`, value:p.result }));
      // small chance of duplicates is OK — still match by value
      shuffle(STATE.answers);
      STATE.mapping.clear();
    }

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function render(){
      const P = $('#problems');
      const A = $('#answers');
      P.innerHTML = ''; A.innerHTML = '';

      // Render problems
      STATE.problems.forEach(p=>{
        const row = document.createElement('div');
        row.className = 'problem'; row.dataset.pid = p.id;

        const left = document.createElement('div'); left.className = 'cluster';
        left.appendChild( makeClusterSVG(p.a) );
        const symMinus = document.createElement('div'); symMinus.className='sym'; symMinus.textContent='−';
        const right = document.createElement('div'); right.className = 'cluster';
        right.appendChild( makeClusterSVG(p.b) );

        const dz = document.createElement('div'); dz.className='dropzone'; dz.textContent='Drop';
        dz.dataset.pid = p.id; setupDropzone(dz);

        row.append(left, symMinus, right, dz);
        P.appendChild(row);
      });

      // Render answers
      STATE.answers.forEach(ans=>{
        const card = document.createElement('div');
        card.className = 'card'; card.draggable = true; card.dataset.aid = ans.id; card.dataset.value = ans.value;
        const wrap = document.createElement('div'); wrap.className = 'cluster';
        wrap.appendChild( makeClusterSVG(ans.value) );
        card.appendChild(wrap);
        setupDraggable(card);
        A.appendChild(card);
      });
    }

    // ========= Drag & Drop =========
    let selectedAid = null; // for tap-selection fallback

    function setupDraggable(el){
      el.addEventListener('dragstart', e=>{
        e.dataTransfer.setData('text/plain', el.dataset.aid);
        setTimeout(()=>el.classList.add('dragging'), 0);
      });
      el.addEventListener('dragend', ()=>{
        el.classList.remove('dragging');
      });

      // Tap-to-select fallback for mobile
      el.addEventListener('click', ()=>{
        // toggle selection
        if(selectedAid === el.dataset.aid){ selectedAid=null; el.style.outline='1px solid #252a52'; return; }
        $$('.card').forEach(c=>c.style.outline='1px solid #252a52');
        selectedAid = el.dataset.aid;
        el.style.outline='2px solid var(--accent)';
        showToast('Pilih kotak tujuan di kolom kiri');
      });
    }

    function setupDropzone(dz){
      dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.style.outlineColor = '#6aa5ff'; });
      dz.addEventListener('dragleave', ()=>{ dz.style.outlineColor = '#4250a3'; });
      dz.addEventListener('drop', e=>{
        e.preventDefault(); dz.style.outlineColor = '#4250a3';
        const aid = e.dataTransfer.getData('text/plain');
        attachAnswer(aid, dz.dataset.pid);
      });
      dz.addEventListener('click', ()=>{
        if(selectedAid){ attachAnswer(selectedAid, dz.dataset.pid); selectedAid=null; $$('.card').forEach(c=>c.style.outline='1px solid #252a52'); }
      });
    }

    function attachAnswer(aid, pid){
      const card = $(`.card[data-aid="${aid}"]`);
      if(!card || card.classList.contains('attached')){ showToast('Jawaban sudah dipakai.'); return; }
      const dz = $(`.dropzone[data-pid="${pid}"]`);
      if(!dz) return;

      // if this dropzone already has a child, release it first
      const previous = dz.querySelector('.card');
      if(previous){ previous.classList.remove('attached'); $('#answers').appendChild(previous); }

      // attach
      card.classList.add('attached');
      dz.textContent='';
      dz.appendChild(card);
      STATE.mapping.set(pid, aid);
    }

    // ========= Check =========
    function check(){
      let correct=0;
      STATE.problems.forEach(p=>{
        const row = $(`.problem[data-pid="${p.id}"]`);
        row.classList.remove('ok','nope');
        const aid = STATE.mapping.get(p.id);
        if(!aid){ row.classList.add('nope'); return; }
        const value = parseInt($(`.card[data-aid="${aid}"]`).dataset.value,10);
        if(value === p.result){ row.classList.add('ok'); correct++; } else { row.classList.add('nope'); }
      });
      if(correct===STATE.problems.length){ showToast('Perfect! Semua benar! 🎉'); confettiLite(); }
      else showToast(`${correct}/${STATE.problems.length} benar. Coba lagi!`);
    }

    function confettiLite(){
      // ultra light confetti: just flash borders
      document.body.animate([{filter:'brightness(1)'},{filter:'brightness(1.3)'},{filter:'brightness(1)'}],{duration:480});
    }

    // ========= Shuffle =========
    function shuffleAll(){ genProblems(); render(); showToast('Soal diacak ✅'); }

    // ========= Boot =========
    $('#btnCheck').addEventListener('click', check);
    $('#btnShuffle').addEventListener('click', shuffleAll);
    genProblems(); render();
  </script>
    <button id="finishBtn-L8a" style="margin-top: 20px; padding: 10px; background-color: green; color: white;">Selesai</button>
<script>
document.getElementById("finishBtn-L8a").addEventListener("click", function() {
  alert("Level selesai!");
  fetch("/elearn/worlds/calistung/math-game/config.json")
    .then(() => console.log("progress saved"));
  window.location.href = "/elearn/worlds/calistung/math-game/index.html";
});
</script>
</body>
</html>
