<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MG-L8a ‚Äî Koding Pengurangan (Honeycomb)</title>
  <link rel="stylesheet" href="/elearn/worlds/calistung/math-game/mathgame-shell.css" />
  <style>
    :root {
      --bg:#0f1226;
      --panel:#171a33;
      --accent:#57b0ff;
      --accent-2:#78d0ff;
      --good:#19d27e;
      --bad:#ff5a78;
      --ink:#e9efff;
      --muted:#9fb1d6;
      --drop:#20254a;
    }

    .honey-stage {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .honey-stage__board {
      background: radial-gradient(1200px 700px at 20% 0%, #1b2148, #0f1226 60%);
      color: var(--ink);
      border-radius: 20px;
      padding: 18px;
      display: grid;
      gap: 18px;
    }

    .honey-hud {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      border: none;
      padding: 12px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      background: linear-gradient(180deg, #2a3a77, #1a2356);
      color: #fff;
      box-shadow: 0 6px 0 #0a133d, inset 0 1px 0 rgba(255, 255, 255, 0.15);
      transition: transform .05s ease, box-shadow .05s ease, filter .05s ease;
    }

    .btn:active { transform: translateY(2px); box-shadow: 0 4px 0 #0a133d; }
    .btn.secondary { background: linear-gradient(180deg, #31406e, #222c54); }

    .board {
      display: grid;
      grid-template-columns: 1fr clamp(12px,2vw,18px) 1fr;
      gap: 18px;
      align-items: start;
    }

    .problems {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .problem {
      background: var(--panel);
      border-radius: 16px;
      padding: 12px 12px;
      display: grid;
      grid-template-columns: auto 24px auto 42px;
      align-items: center;
      gap: 8px;
      outline: 1px solid #252a52;
      position: relative;
      min-height: 96px;
    }

    .sym {
      font-weight: 900;
      color: var(--muted);
      text-align: center;
    }

    .dropzone {
      width: 42px;
      height: 42px;
      border-radius: 10px;
      background: var(--drop);
      outline: 2px dashed #4250a3;
      outline-offset: -6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #7e8fd6;
      font-size: 12px;
    }

    .problem.ok { outline: 2px solid var(--good); }
    .problem.nope { outline: 2px solid var(--bad); }

    .answers {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .card {
      background: var(--panel);
      border-radius: 16px;
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 96px;
      outline: 1px solid #252a52;
      cursor: grab;
      user-select: none;
    }

    .card:active { cursor: grabbing; }
    .card.attached { opacity: .85; cursor: not-allowed; }

    .cluster {
      width: 160px;
      height: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .honey-note {
      color: var(--muted);
      font-size: 12px;
      text-align: center;
      margin-top: 8px;
    }

    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      background: #11162f;
      color: #dfe6ff;
      padding: 10px 14px;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, .35);
      display: none;
      z-index: 10;
    }

    .toast.show { display: inline-block; }

    @media (max-width: 860px) {
      .board { grid-template-columns: 1fr; }
      .answers { order: 2; }
      .problems { order: 1; }
    }
  </style>
  <link rel="stylesheet" href="/elearn/worlds/calistung/buttons.css" />
</head>
<body class="mathgame-shell theme-neon" data-nav-badge="Calistung Math" data-nav-home-url="/elearn/worlds/calistung/index.html">
  <div class="shell-wrapper">
    <header class="shell-header">
      <div class="shell-header__title">
        <span class="shell-badge">Level 8</span>
        <h1 class="shell-title">Koding Pengurangan Honeycomb</h1>
        <p class="shell-subtitle">Hitung sel honeycomb yang tersisa, lalu pasangkan kartu jawaban yang tepat ke setiap kotak drop.</p>
      </div>
      <div class="shell-hud">
        <div class="shell-pill">
          <span class="shell-pill-label">Jawaban Benar</span>
          <span class="shell-pill-value" data-hud-value="score">0 / 5</span>
        </div>
        <div class="shell-pill">
          <span class="shell-pill-label">Percobaan</span>
          <span class="shell-pill-value" data-hud-value="attempts">0</span>
        </div>
      </div>
    </header>

    <section class="mission-card">
      <h2>üéØ Misimu</h2>
      <p data-mission-text>Tarik kartu jawaban atau tap untuk memilihnya, lalu isi setiap kotak pengurangan dengan hasil yang benar.</p>
    </section>

    <main class="mathgame-stage">
      <section class="stage-card stage-card--contrast honey-stage">
        <div class="honey-stage__board">
          <div class="board">
            <div class="problems" id="problems"></div>
            <div></div>
            <div class="answers" id="answers"></div>
          </div>
          <p class="honey-note">Tarik kartu jawaban ke kotak di tiap baris. Di HP: tap kartu lalu tap kotak tujuan.</p>
        </div>
      </section>
    </main>

    <section class="shell-action-bar" aria-label="Kontrol aksi">
      <button id="btnShuffle" class="shell-button secondary" type="button">üîÑ Acak Soal</button>
      <button id="btnCheck" class="shell-button" type="button">‚úÖ Periksa Jawaban</button>
      <button id="btnSelesai" class="shell-button ghost" type="button">Selesai</button>
    </section>

    <aside class="buddy-widget" aria-label="Teman penyemangat">
      <div class="buddy-avatar" data-buddy-emoji aria-hidden="true">üêù</div>
      <div class="buddy-dialog" data-buddy-dialog>Geser kartu jawaban ke sarang lebah yang pas. Hitung dulu ya sel yang tersisa.</div>
    </aside>
  </div>

  <div class="toast" id="toast"></div>

  <script src="/elearn/worlds/calistung/math-game/mathgame-shell.js"></script>
  <script>
    const $ = (sel, el=document)=>el.querySelector(sel);
    const $$ = (sel, el=document)=>Array.from(el.querySelectorAll(sel));
    const rand = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;

    const STATE = {
      problems: [],
      mapping: new Map(),
      answers: []
    };

    const PROBLEM_COUNT = 5;

    const hudScoreEl = document.querySelector('[data-hud-value="score"]');
    const hudAttemptsEl = document.querySelector('[data-hud-value="attempts"]');
    const buddyEmojiEl = document.querySelector('[data-buddy-emoji]');
    const buddyDialogEl = document.querySelector('[data-buddy-dialog]');
    const toastEl = document.getElementById('toast');

    let attempts = 0;
    let score = 0;
    const defaultBuddyText = 'Pasangkan setiap hasil pengurangan dengan kartu sarang lebah yang benar.';

    function showToast(msg, ms=1600){
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      clearTimeout(showToast._id);
      showToast._id = setTimeout(()=>toastEl.classList.remove('show'), ms);
    }

    function setBuddy(emoji, text){
      if(buddyEmojiEl && emoji){ buddyEmojiEl.textContent = emoji; }
      if(buddyDialogEl && text){ buddyDialogEl.textContent = text; }
      if(window.mathgameShell && typeof window.mathgameShell.setBuddyMood === 'function'){
        window.mathgameShell.setBuddyMood(emoji, text);
      }
    }

    function syncHud(){
      const label = `${score} / ${PROBLEM_COUNT}`;
      if(hudScoreEl) hudScoreEl.textContent = label;
      if(hudAttemptsEl) hudAttemptsEl.textContent = attempts;
      if(window.mathgameShell && typeof window.mathgameShell.updateHud === 'function'){
        window.mathgameShell.updateHud({ score: label, attempts });
      }
    }

    function hexPoints(cx, cy, size){
      const pts = [];
      for(let i=0;i<6;i++){
        const ang = Math.PI/180 * (60*i - 30);
        const x = cx + size * Math.cos(ang);
        const y = cy + size * Math.sin(ang);
        pts.push(`${x.toFixed(2)},${y.toFixed(2)}`);
      }
      return pts.join(' ');
    }

    function axialToPixel(q, r, size){
      const x = size * Math.sqrt(3) * (q + r/2);
      const y = size * 1.5 * r;
      return {x, y};
    }

    function makeClusterSVG(coloredCount=0, {size=14, stroke='#2a3778'}={}){
      const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
      svg.setAttribute('viewBox','-55 -50 110 100');
      svg.setAttribute('width','150');
      svg.setAttribute('height','84');

      const order = [ {q:0,r:0}, {q:1,r:0}, {q:1,r:-1}, {q:0,r:-1}, {q:-1,r:0}, {q:-1,r:1}, {q:0,r:1} ];
      const bg = document.createElementNS(svg.namespaceURI,'rect');
      bg.setAttribute('x','-60'); bg.setAttribute('y','-52'); bg.setAttribute('width','120'); bg.setAttribute('height','104');
      bg.setAttribute('rx','14'); bg.setAttribute('fill','transparent');
      svg.appendChild(bg);

      order.forEach((ax, idx)=>{
        const {x, y} = axialToPixel(ax.q, ax.r, size);
        const poly = document.createElementNS(svg.namespaceURI,'polygon');
        poly.setAttribute('points', hexPoints(x, y, size));
        const on = idx < coloredCount;
        poly.setAttribute('fill', on ? '#64b2ff' : '#f0f4ff');
        poly.setAttribute('stroke', stroke);
        poly.setAttribute('stroke-width', '2');
        svg.appendChild(poly);
      });
      return svg;
    }

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr;
    }

    function genProblems(){
      STATE.problems = [];
      for(let i=0;i<PROBLEM_COUNT;i++){
        const a = rand(2,7);
        const b = rand(0,a-1);
        STATE.problems.push({ id: `p${i+1}`, a, b, result: a-b });
      }
      STATE.answers = STATE.problems.map((p,i)=>({ id:`a${i+1}`, value:p.result }));
      shuffle(STATE.answers);
      STATE.mapping.clear();
      attempts = 0;
      score = 0;
      syncHud();
      setBuddy('üêù', defaultBuddyText);
    }

    function render(){
      const P = $('#problems');
      const A = $('#answers');
      P.innerHTML = ''; A.innerHTML = '';

      STATE.problems.forEach(p=>{
        const row = document.createElement('div');
        row.className = 'problem'; row.dataset.pid = p.id;

        const left = document.createElement('div'); left.className = 'cluster';
        left.appendChild( makeClusterSVG(p.a) );
        const symMinus = document.createElement('div'); symMinus.className='sym'; symMinus.textContent='‚àí';
        const right = document.createElement('div'); right.className = 'cluster';
        right.appendChild( makeClusterSVG(p.b) );

        const dz = document.createElement('div'); dz.className='dropzone'; dz.textContent='Drop';
        dz.dataset.pid = p.id; setupDropzone(dz);

        row.append(left, symMinus, right, dz);
        P.appendChild(row);
      });

      STATE.answers.forEach(ans=>{
        const card = document.createElement('div');
        card.className = 'card'; card.draggable = true; card.dataset.aid = ans.id; card.dataset.value = ans.value;
        const wrap = document.createElement('div'); wrap.className = 'cluster';
        wrap.appendChild( makeClusterSVG(ans.value) );
        card.appendChild(wrap);
        setupDraggable(card);
        A.appendChild(card);
      });
    }

    let selectedAid = null;

    function setupDraggable(el){
      el.addEventListener('dragstart', e=>{
        e.dataTransfer.setData('text/plain', el.dataset.aid);
        setTimeout(()=>el.classList.add('dragging'), 0);
      });
      el.addEventListener('dragend', ()=>{
        el.classList.remove('dragging');
      });

      el.addEventListener('click', ()=>{
        if(selectedAid === el.dataset.aid){
          selectedAid=null;
          el.style.outline='1px solid #252a52';
          return;
        }
        $$('.card').forEach(c=>c.style.outline='1px solid #252a52');
        selectedAid = el.dataset.aid;
        el.style.outline='2px solid var(--accent)';
        showToast('Pilih kotak tujuan di kolom kiri');
      });
    }

    function setupDropzone(dz){
      dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.style.outlineColor = '#6aa5ff'; });
      dz.addEventListener('dragleave', ()=>{ dz.style.outlineColor = '#4250a3'; });
      dz.addEventListener('drop', e=>{
        e.preventDefault(); dz.style.outlineColor = '#4250a3';
        const aid = e.dataTransfer.getData('text/plain');
        attachAnswer(aid, dz.dataset.pid);
      });
      dz.addEventListener('click', ()=>{
        if(selectedAid){ attachAnswer(selectedAid, dz.dataset.pid); selectedAid=null; $$('.card').forEach(c=>c.style.outline='1px solid #252a52'); }
      });
    }

    function attachAnswer(aid, pid){
      const card = $(`.card[data-aid="${aid}"]`);
      if(!card || card.classList.contains('attached')){ showToast('Jawaban sudah dipakai.'); return; }
      const dz = $(`.dropzone[data-pid="${pid}"]`);
      if(!dz) return;

      const previous = dz.querySelector('.card');
      if(previous){ previous.classList.remove('attached'); $('#answers').appendChild(previous); }

      card.classList.add('attached');
      dz.textContent='';
      dz.appendChild(card);
      STATE.mapping.set(pid, aid);
    }

    function check(){
      let correct=0;
      STATE.problems.forEach(p=>{
        const row = $(`.problem[data-pid="${p.id}"]`);
        row.classList.remove('ok','nope');
        const aid = STATE.mapping.get(p.id);
        if(!aid){ row.classList.add('nope'); return; }
        const value = parseInt($(`.card[data-aid="${aid}"]`).dataset.value,10);
        if(value === p.result){ row.classList.add('ok'); correct++; } else { row.classList.add('nope'); }
      });
      score = correct;
      attempts += 1;
      if(correct===STATE.problems.length){
        showToast('Perfect! Semua benar! üéâ');
        setBuddy('üèÜ', 'Semua hasil pengurangannya pas! Kamu jago banget.');
      } else {
        showToast(`${correct}/${STATE.problems.length} benar. Coba lagi!`);
        setBuddy('ü§î', 'Masih ada yang belum cocok. Coba tukar kartunya lagi, ya!');
      }
      syncHud();
    }

    function shuffleAll(){
      genProblems();
      render();
      showToast('Soal diacak ‚úÖ');
      setBuddy('üé≤', 'Sarang lebahnya berubah! Cocokkan lagi hasilnya.');
      syncHud();
    }

    $('#btnCheck').addEventListener('click', check);
    $('#btnShuffle').addEventListener('click', shuffleAll);

    genProblems();
    render();
    syncHud();
    setBuddy('üêù', defaultBuddyText);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="/elearn/manifest-lessons.js"></script>
  <script src="/elearn/userInfo.js"></script>
  <script src="/elearn/common/worksheet-submit.js"></script>
  <script>
    window.WORKSHEET_DEBUG = true;
    window.WORKSHEET_META = { course_id: "mathgame-basic" };
    const info = (typeof getUserInfo === "function") ? getUserInfo() : {};
    initWorksheetSubmit({
      muridUid: info.uid || "",
      cid: info.cid || "",
      namaAnak: info.nama || "",
      role: (info.role || "").toLowerCase()
    });
  </script>
  <script src="/elearn/common/calistung-navbar.js"></script>
</body>
</html>
