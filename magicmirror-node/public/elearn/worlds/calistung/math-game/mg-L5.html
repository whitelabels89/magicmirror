<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MG-L5 • Sign Coding</title>
  <link rel="stylesheet" href="/elearn/worlds/calistung/math-game/mathgame-shell.css" />
  <style>
    :root { --gap: 10px; --tile: 64px; }
    *{box-sizing:border-box}
    .sign-stage{display:flex;flex-direction:column;gap:18px}
    .key{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:var(--gap)}
    .key-card{background:#fff;border-radius:16px;padding:12px;display:flex;align-items:center;justify-content:center;gap:10px;border:1px solid rgba(148,163,184,.35);box-shadow:0 8px 16px rgba(14,165,233,.16)}
    .pair{display:flex;align-items:center;gap:8px}
    .token{width:var(--tile);height:var(--tile);border-radius:16px;background:#f8fafc;display:grid;place-items:center;font-size:32px;border:1px solid rgba(148,163,184,.35)}
    .op{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;background:#e0f2fe;border:1px dashed rgba(59,130,246,.45);}

    .board{display:grid;gap:20px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center}
    .blank{width:48px;height:48px;border-radius:12px;border:2px dashed rgba(148,163,184,.45);background:#f1f5f9;display:grid;place-items:center;cursor:pointer;font-size:22px;user-select:none;transition:transform .08s ease, box-shadow .1s ease}
    .blank:hover{transform:translateY(-2px);box-shadow:0 12px 24px rgba(94,234,212,.18)}
    .blank.correct{background:#dcfce7;border-color:#16a34a;color:#14532d}
    .blank.wrong{background:#fee2e2;border-color:#dc2626;color:#7f1d1d}

    .score-pill{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.9);color:#0f172a;font-weight:700;box-shadow:0 8px 18px rgba(14,165,233,.2)}
    @media (max-width:740px){ :root{ --tile:56px } .op{ width:32px; height:32px; } }
  </style>
  <link rel="stylesheet" href="/elearn/worlds/calistung/buttons.css" />
</head>
<body class="mathgame-shell theme-mint" data-nav-badge="Calistung Math" data-nav-home-url="/elearn/worlds/calistung/index.html">
  <div class="shell-wrapper">
    <header class="shell-header">
      <div class="shell-header__title">
        <span class="shell-badge">Level 5</span>
        <h1 class="shell-title">Sign Coding</h1>
        <p class="shell-subtitle">Klik kotak kosong untuk memilih tanda operasi sesuai hewan di sebelah kirinya.</p>
      </div>
      <div class="shell-hud">
        <div class="shell-pill">
          <span class="shell-pill-label">Tanda Tepat</span>
          <span class="shell-pill-value" data-hud-value="score">0 / 24</span>
        </div>
      </div>
    </header>

    <section class="mission-card">
      <h2>🎯 Misimu</h2>
      <p data-mission-text>Gunakan kunci hewan → tanda operasi. Isi semua kotak kosong dengan tanda yang sesuai urutan.</p>
    </section>

    <main class="mathgame-stage">
      <section class="stage-card stage-card--contrast sign-stage">
        <h2 class="stage-section-title">Kunci Hewan</h2>
        <div id="key" class="key"></div>
        <h2 class="stage-section-title">Papan Soal</h2>
        <div id="board" class="board"></div>
        <p class="stage-note" id="statusMessage">Klik tanda kosong untuk mengganti operator.</p>
      </section>
    </main>

    <section class="shell-action-bar" aria-label="Kontrol aksi">
      <button id="check" class="shell-button secondary" type="button">Periksa Jawaban</button>
      <button id="shuffle" class="shell-button" type="button">Acak Soal</button>
      <span id="score" class="score-pill">Benar: 0</span>
      <button id="btnSelesai" class="shell-button ghost" type="button">Selesai</button>
    </section>

    <aside class="buddy-widget" aria-label="Teman penyemangat">
      <div class="buddy-avatar" data-buddy-emoji aria-hidden="true">🦊</div>
      <div class="buddy-dialog" data-buddy-dialog>Pilih tanda operasi sesuai hewan di sebelah kiri kotaknya. Coba klik bergantian sampai cocok!</div>
    </aside>
  </div>

  <script src="/elearn/worlds/calistung/math-game/mathgame-shell.js"></script>
  <script>
    const EMO = ["🐷","🐮","🐑","🐼","🤖"];
    const OPS = ["−","×","+","÷","⭕"];

    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }

    function buildAnimalMapping(){
      const ops = shuffle([...OPS]);
      const order = [...EMO];
      const map = new Map();
      order.forEach((emo,idx)=> map.set(emo, ops[idx]));
      return { map, order };
    }

    function renderKey(mapping){
      const key = document.getElementById('key');
      key.innerHTML = '';
      mapping.order.forEach(emo=>{
        const card = document.createElement('div');
        card.className = 'key-card';
        const pair = document.createElement('div');
        pair.className = 'pair';
        pair.innerHTML = `<div class="token">${emo}</div>`;
        const op = document.createElement('div');
        op.className = 'op';
        op.textContent = mapping.map.get(emo);
        card.appendChild(pair);
        card.appendChild(op);
        key.appendChild(card);
      });
    }

    function buildRow(len){
      const seq = [];
      for(let i=0;i<len;i++){
        seq.push( EMO[Math.floor(Math.random()*EMO.length)] );
      }
      return seq;
    }

    function expectedOps(seq, mapping){
      const ex = [];
      for(let i=0;i<seq.length-1;i++){
        ex.push( mapping.map.get(seq[i]) );
      }
      return ex;
    }

    function renderBoard(mapping){
      const board = document.getElementById('board');
      board.innerHTML = '';
      const rows = 4;
      const tokensPerRow = 7;
      for(let r=0;r<rows;r++){
        const rowEl = document.createElement('div');
        rowEl.className = 'row';
        const seq = buildRow(tokensPerRow);
        const exOps = expectedOps(seq, mapping);
        rowEl.dataset.answers = JSON.stringify(exOps);

        for(let i=0;i<seq.length;i++){
          const t = document.createElement('div');
          t.className = 'token';
          t.textContent = seq[i];
          rowEl.appendChild(t);
          if(i < seq.length - 1){
            const b = document.createElement('div');
            b.className = 'blank';
            b.dataset.choiceIndex = -1;
            b.addEventListener('click', ()=>{
              const cur = parseInt(b.dataset.choiceIndex,10);
              const next = (cur + 1) % OPS.length;
              b.dataset.choiceIndex = next;
              b.textContent = OPS[next];
              b.classList.remove('correct','wrong');
            });
            rowEl.appendChild(b);
          }
        }
        board.appendChild(rowEl);
      }
    }

    const totalSlots = 4 * (7 - 1);
    const scoreLabel = document.getElementById('score');
    const checkBtn = document.getElementById('check');
    const shuffleBtn = document.getElementById('shuffle');
    const statusMessage = document.getElementById('statusMessage');
    const buddyEmojiEl = document.querySelector('[data-buddy-emoji]');
    const buddyDialogEl = document.querySelector('[data-buddy-dialog]');
    const hudScoreEl = document.querySelector('[data-hud-value="score"]');

    function setBuddy(emoji, text){
      if(buddyEmojiEl && emoji){ buddyEmojiEl.textContent = emoji; }
      if(buddyDialogEl && text){ buddyDialogEl.textContent = text; }
      if(window.mathgameShell && typeof window.mathgameShell.setBuddyMood === 'function'){
        window.mathgameShell.setBuddyMood(emoji, text);
      }
    }

    function syncHud(correct){
      const label = `Benar: ${correct}/${totalSlots}`;
      if(scoreLabel) scoreLabel.textContent = label;
      if(hudScoreEl) hudScoreEl.textContent = `${correct} / ${totalSlots}`;
      if(window.mathgameShell && typeof window.mathgameShell.updateHud === 'function'){
        window.mathgameShell.updateHud({ score: `${correct} / ${totalSlots}` });
      }
    }

    function checkAnswers(){
      let total = 0, correct = 0;
      document.querySelectorAll('.row').forEach(row=>{
        const ans = JSON.parse(row.dataset.answers);
        const blanks = Array.from(row.querySelectorAll('.blank'));
        total += ans.length;
        blanks.forEach((b,idx)=>{
          const idxChoice = parseInt(b.dataset.choiceIndex,10);
          const val = idxChoice >= 0 ? OPS[idxChoice] : '';
          const ok = val === ans[idx];
          b.classList.toggle('correct', ok);
          b.classList.toggle('wrong', !ok);
          if(ok) correct++;
        });
      });
      syncHud(correct);
      if(correct === total){
        statusMessage.textContent = 'Sempurna! Semua tanda sudah benar.';
        setBuddy('🎉', 'Hebat! Kamu membaca kode hewan dengan tepat.');
      } else if(correct > 0){
        statusMessage.textContent = `Kamu benar ${correct} dari ${total} tanda. Cek kotak merah ya.`;
        setBuddy('✨', 'Lumayan! Tinggal perbaiki tanda yang masih merah.');
      } else {
        statusMessage.textContent = 'Belum ada yang pas. Coba klik lagi dan cocokkan dengan kuncinya.';
        setBuddy('🤔', 'Lihat kunci hewan lagi, lalu coba ganti tandanya.');
      }
    }

    function bootstrap(){
      window._mapping = buildAnimalMapping();
      renderKey(_mapping);
      renderBoard(_mapping);
      document.querySelectorAll('.blank').forEach(b=>{ b.textContent = ''; b.dataset.choiceIndex = -1; b.classList.remove('correct','wrong'); });
      statusMessage.textContent = 'Klik tanda kosong untuk mengganti operator.';
      setBuddy('🦊', 'Tentukan tanda operasi dari setiap hewan ya!');
      syncHud(0);
    }

    checkBtn.addEventListener('click', checkAnswers);
    shuffleBtn.addEventListener('click', bootstrap);
    bootstrap();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="/elearn/manifest-lessons.js"></script>
  <script src="/elearn/userInfo.js"></script>
  <script src="/elearn/common/worksheet-submit.js"></script>
  <script>
    window.WORKSHEET_DEBUG = true;
    window.WORKSHEET_META = { course_id: "mathgame-basic" };
    const info = (typeof getUserInfo === "function") ? getUserInfo() : {};
    initWorksheetSubmit({
      muridUid: info.uid || "",
      cid: info.cid || "",
      namaAnak: info.nama || "",
      role: (info.role || "").toLowerCase()
    });
  </script>
  <script src="/elearn/common/calistung-navbar.js"></script>
</body>
</html>
