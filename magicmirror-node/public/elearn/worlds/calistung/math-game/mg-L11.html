<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Math-Game L11 • Operator Quest</title>
  <link rel="stylesheet" href="/elearn/worlds/calistung/math-game/mathgame-shell.css" />
  <style>
    .operator-stage {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .operator-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      background: rgba(122,124,251,0.08);
      border: 1px solid rgba(122,124,251,0.22);
      border-radius: 16px;
      padding: 14px 16px;
    }

    .operator-stats {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      font-weight: 700;
      color: rgba(232, 235, 255, 0.9);
    }

    .operator-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.18);
      font-size: 14px;
    }

    .operator-mode {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      color: rgba(186, 196, 255, 0.9);
    }

    .operator-mode input {
      accent-color: #7a7cfb;
      width: 18px;
      height: 18px;
    }

    .operator-timer {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.2);
      font-weight: 700;
    }

    .operator-container {
      display: grid;
      gap: 16px;
    }

    .card {
      background: linear-gradient(180deg, rgba(21,26,43,.95), rgba(21,26,43,.7));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 18px 36px rgba(9,10,20,0.42);
    }

    .q-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
      color: #e8ebff;
    }

    .q-title {
      font-weight: 800;
      letter-spacing: .3px;
    }

    .result {
      font-weight: 800;
      font-size: 18px;
    }

    .result.ok { color: #47d16c; }
    .result.bad { color: #ff6363; }
    .result.hidden { display: none; }

    .q-body {
      display: grid;
      grid-template-columns: 1fr auto 1fr auto 1fr;
      gap: 10px;
      align-items: center;
      justify-items: center;
      color: #e8ebff;
      font-weight: 800;
    }

    .box {
      min-width: 86px;
      width: 100%;
      text-align: center;
      padding: 14px 10px;
      border-radius: 12px;
      font-size: 22px;
      background: #0f1324;
      border: 1px solid rgba(255,255,255,.12);
    }

    .opsi {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-top: 12px;
    }

    .choice {
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 900;
      background: rgba(122,124,251,.16);
      border: 1px solid rgba(122,124,251,.35);
      color: #e8ebff;
      cursor: pointer;
      user-select: none;
      transition: transform .15s ease, filter .15s ease;
    }

    .choice:hover { filter: brightness(1.1); }
    .choice.selected {
      background: linear-gradient(135deg, #9a9cff, #7a7cfb);
      color: #0d0f1a;
      border-color: transparent;
      box-shadow: 0 6px 18px rgba(122,124,251,.35);
    }

    .footer-note {
      color: rgba(186, 196, 255, 0.9);
      font-size: 13px;
      text-align: center;
    }

    @media (max-width: 720px){
      .q-body { grid-template-columns: 1fr auto 1fr; }
      .box { min-width: 72px; font-size: 20px; }
      .operator-controls { flex-direction: column; align-items: flex-start; }
    }
  </style>
  <link rel="stylesheet" href="/elearn/worlds/calistung/buttons.css" />
</head>
<body class="mathgame-shell theme-neon" data-nav-badge="Calistung Math" data-nav-home-url="/elearn/worlds/calistung/index.html">
  <div class="shell-wrapper">
    <header class="shell-header">
      <div class="shell-header__title">
        <span class="shell-badge">Level 11</span>
        <h1 class="shell-title">Operator Quest — Buat Persamaan Jadi Benar!</h1>
        <p class="shell-subtitle">Pilih operator (+ − × ÷) agar kalimat matematika bernilai benar. Cek jawabanmu dan tantang diri dengan mode 60 detik!</p>
      </div>
      <div class="shell-hud">
        <div class="shell-pill">
          <span class="shell-pill-label">Skor</span>
          <span class="shell-pill-value" data-hud-value="score">0 / 8</span>
        </div>
        <div class="shell-pill">
          <span class="shell-pill-label">Percobaan</span>
          <span class="shell-pill-value" data-hud-value="attempts">0</span>
        </div>
        <div class="shell-pill">
          <span class="shell-pill-label">Sisa Waktu</span>
          <span class="shell-pill-value" data-hud-value="timer" data-hud-format="time">—</span>
        </div>
      </div>
    </header>

    <section class="mission-card">
      <h2>🎯 Misimu</h2>
      <p data-mission-text>Pilih operator yang tepat untuk setiap soal. Cek jawabanmu, atau aktifkan mode tantangan 60 detik untuk latihan cepat!</p>
    </section>

    <main class="mathgame-stage">
      <section class="stage-card stage-card--contrast operator-stage">
        <div class="operator-controls">
          <div class="operator-stats" aria-live="polite">
            <span class="operator-chip" id="countInfo">8 Soal</span>
            <span class="operator-chip">Skor: <span id="skor">0</span></span>
            <span class="operator-timer hidden" id="waktuChip">Sisa Waktu: <span id="waktu">60</span>s</span>
          </div>
          <label class="operator-mode"><input id="modeTantangan" type="checkbox"> Mode Tantangan 60s</label>
        </div>
        <div class="operator-container" id="container"></div>
        <div class="footer-note">Tips: ketuk lagi pilihan untuk membatalkan. Tekan Acak Soal kapan saja untuk mendapatkan set baru.</div>
      </section>
    </main>

    <section class="shell-action-bar" aria-label="Kontrol aksi">
      <button id="btnAcak" class="shell-button secondary" type="button">🔄 Acak Soal</button>
      <button id="btnPeriksa" class="shell-button" type="button">✅ Periksa Jawaban</button>
      <button id="btnReset" class="shell-button ghost" type="button">↺ Reset</button>
      <button id="btnSelesai" class="shell-button ghost" type="button">Selesai</button>
    </section>

    <aside class="buddy-widget" aria-label="Teman penyemangat">
      <div class="buddy-avatar" data-buddy-emoji aria-hidden="true">🤖</div>
      <div class="buddy-dialog" data-buddy-dialog>Pilih operator terbaik untuk setiap soal. Tantang mode 60 detik kalau sudah siap!</div>
    </aside>
  </div>
  <template id="qTemplate">
    <section class="card" data-qidx="">
      <div class="q-header">
        <div class="q-title">Soal <span class="num"></span></div>
        <div class="result hidden"></div>
      </div>
      <div class="q-body">
        <div class="box a">A</div>
        <div class="box op">?</div>
        <div class="box b">B</div>
        <div class="box eq">=</div>
        <div class="box c">C</div>
      </div>
      <div class="opsi" role="group" aria-label="Pilih operator">
        <div class="choice" data-val="+">+</div>
        <div class="choice" data-val="-">−</div>
        <div class="choice" data-val="×">×</div>
        <div class="choice" data-val="÷">÷</div>
      </div>
    </section>
  </template>
  <script src="/elearn/worlds/calistung/math-game/mathgame-shell.js"></script>
  <script>
    const container = document.getElementById('container');
    const btnAcak = document.getElementById('btnAcak');
    const btnPeriksa = document.getElementById('btnPeriksa');
    const btnReset = document.getElementById('btnReset');
    const countInfo = document.getElementById('countInfo');
    const skorEl = document.getElementById('skor');
    const modeTantangan = document.getElementById('modeTantangan');
    const waktuChip = document.getElementById('waktuChip');
    const waktuEl = document.getElementById('waktu');

    const hudScoreEl = document.querySelector('[data-hud-value="score"]');
    const hudAttemptsEl = document.querySelector('[data-hud-value="attempts"]');
    const hudTimerEl = document.querySelector('[data-hud-value="timer"]');
    const buddyEmojiEl = document.querySelector('[data-buddy-emoji]');
    const buddyDialogEl = document.querySelector('[data-buddy-dialog]');

    let soal = [];
    let jawaban = new Map();
    let terkunci = false;
    let timer = null;
    let attempts = 0;
    let lastScore = 0;
    let remainingSeconds = null;

    function setBuddy(emoji, text){
      if(buddyEmojiEl && emoji){ buddyEmojiEl.textContent = emoji; }
      if(buddyDialogEl && text){ buddyDialogEl.textContent = text; }
      if(window.mathgameShell && typeof window.mathgameShell.setBuddyMood === 'function'){
        window.mathgameShell.setBuddyMood(emoji, text);
      }
    }

    function syncHud(){
      const total = soal.length || 8;
      const scoreLabel = `${lastScore} / ${total}`;
      if(hudScoreEl) hudScoreEl.textContent = scoreLabel;
      if(hudAttemptsEl) hudAttemptsEl.textContent = attempts;
      if(window.mathgameShell && typeof window.mathgameShell.updateHud === 'function'){
        const payload = { score: scoreLabel, attempts };
        if(remainingSeconds === null) {
          payload.timer = '—';
        } else {
          payload.timer = remainingSeconds;
        }
        window.mathgameShell.updateHud(payload);
      }
      if(hudTimerEl) {
        if(remainingSeconds === null) {
          hudTimerEl.textContent = '—';
        } else {
          const seconds = Math.max(0, remainingSeconds);
          const mins = String(Math.floor(seconds / 60)).padStart(2,'0');
          const secs = String(seconds % 60).padStart(2,'0');
          hudTimerEl.textContent = `${mins}:${secs}`;
        }
      }
    }

    function rand(min, max){return Math.floor(Math.random() * (max-min+1)) + min}

    function buatSatuSoal(){
      const tipe = rand(0,3);
      let a,b,c,op;
      if(tipe===0){
        a = rand(1,30); b = rand(1,30); c = a + b; op = '+';
      } else if(tipe===1){
        c = rand(0,30); b = rand(0, c); a = c + b; op = '-';
      } else if(tipe===2){
        a = rand(2,12); b = rand(2,12); c = a * b; op = '×';
      } else {
        b = rand(2,12); c = rand(2,12); a = b * c; op = '÷';
      }
      return {a,b,c,op};
    }

    function generate(n=8){
      terkunci = false;
      clearInterval(timer);
      waktuChip.classList.add('hidden');
      skorEl.textContent = 0;
      jawaban.clear();
      soal = Array.from({length:n}, ()=>buatSatuSoal());
      countInfo.textContent = `${n} Soal`;
      attempts = 0;
      lastScore = 0;
      remainingSeconds = modeTantangan.checked ? 60 : null;
      render();
      syncHud();
      setBuddy('🤖', 'Pilih operator yang tepat agar persamaan jadi benar. Ayo mulai!');
      if(modeTantangan.checked){ mulaiChallenge(); }
    }

    function render(){
      container.innerHTML = '';
      const tpl = document.getElementById('qTemplate');
      soal.forEach((s, i)=>{
        const node = tpl.content.cloneNode(true);
        const sec = node.querySelector('section');
        sec.dataset.qidx = i;
        node.querySelector('.num').textContent = i+1;
        node.querySelector('.a').textContent = s.a;
        node.querySelector('.b').textContent = s.b;
        node.querySelector('.c').textContent = s.c;
        const opBox = node.querySelector('.op');
        opBox.textContent = jawaban.get(i) || '?';
        node.querySelectorAll('.choice').forEach(ch=>{
          const val = ch.dataset.val;
          if(val === jawaban.get(i)) ch.classList.add('selected');
          ch.addEventListener('click', ()=>{
            if(terkunci) return;
            if(jawaban.get(i) === val){
              jawaban.delete(i);
            } else {
              jawaban.set(i, val);
            }
            render();
          });
        });
        container.appendChild(node);
      });
    }

    function evalBenar(a,b,op){
      switch(op){
        case '+': return a+b;
        case '−':
        case '-': return a-b;
        case '×': return a*b;
        case '÷': return b!==0 ? a/b : NaN;
        default: return NaN;
      }
    }

    function periksa(){
      let benar = 0;
      terkunci = true;
      container.querySelectorAll('section.card').forEach((sec, i)=>{
        const s = soal[i];
        const dipilih = jawaban.get(i);
        const res = sec.querySelector('.result');
        const opBox = sec.querySelector('.op');
        res.classList.remove('hidden');
        if(!dipilih){
          res.textContent = 'Belum dijawab';
          res.className = 'result bad';
          opBox.textContent = '?';
          return;
        }
        opBox.textContent = dipilih;
        const nilai = evalBenar(s.a, s.b, dipilih);
        const ok = Math.abs(nilai - s.c) < 1e-9;
        if(ok){
          benar++;
          res.textContent = '✓ Benar';
          res.className = 'result ok';
        } else {
          res.textContent = `✗ Salah (jawaban: ${s.op})`;
          res.className = 'result bad';
        }
      });
      skorEl.textContent = `${benar}`;
      lastScore = benar;
      attempts += 1;
      if(benar === soal.length){
        setBuddy('🏆', 'Perfect! Semua operatormu tepat sasaran.');
      } else {
        setBuddy('🧐', 'Masih ada yang keliru. Coba cek lagi operatornya.');
      }
      syncHud();
      return benar;
    }

    function resetJawaban(){
      if(modeTantangan.checked) return;
      jawaban.clear();
      terkunci = false;
      skorEl.textContent = 0;
      attempts = 0;
      lastScore = 0;
      render();
      setBuddy('🔁', 'Jawaban dihapus. Isi lagi operator yang pas.');
      syncHud();
    }

    function mulaiChallenge(){
      clearInterval(timer);
      let sisa = 60;
      remainingSeconds = sisa;
      waktuEl.textContent = sisa;
      waktuChip.classList.remove('hidden');
      terkunci = false;
      jawaban.clear();
      skorEl.textContent = 0;
      attempts = 0;
      lastScore = 0;
      render();
      setBuddy('⚡', 'Tantangan dimulai! Kerjakan secepat mungkin sebelum waktunya habis.');
      syncHud();
      timer = setInterval(()=>{
        sisa--;
        remainingSeconds = sisa;
        waktuEl.textContent = sisa;
        syncHud();
        if(sisa<=0){
          clearInterval(timer);
          remainingSeconds = 0;
          terkunci = true;
          periksa();
          waktuChip.classList.add('hidden');
          setBuddy('⏱️', 'Waktu habis! Cek hasilmu dan coba lagi.');
          syncHud();
        }
      }, 1000);
    }

    btnAcak.addEventListener('click', ()=>{
      generate(8);
    });

    btnPeriksa.addEventListener('click', ()=>{
      const score = periksa();
      skorEl.animate([
        {transform:'scale(1)'}, {transform:'scale(1.2)'}, {transform:'scale(1)'}
      ], {duration:320, easing:'ease-out'});
    });

    btnReset.addEventListener('click', resetJawaban);

    modeTantangan.addEventListener('change', (e)=>{
      clearInterval(timer);
      if(e.target.checked){
        mulaiChallenge();
      } else {
        waktuChip.classList.add('hidden');
        remainingSeconds = null;
        terkunci = false;
        setBuddy('🤖', 'Mode tantangan dimatikan. Kerjakan santai saja.');
        syncHud();
      }
    });

    generate(8);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="/elearn/manifest-lessons.js"></script>
  <script src="/elearn/userInfo.js"></script>
  <script src="/elearn/common/worksheet-submit.js"></script>
  <script>
    window.WORKSHEET_DEBUG = true;
    window.WORKSHEET_META = { course_id: "mathgame-basic" };
    const info = (typeof getUserInfo === "function") ? getUserInfo() : {};
    initWorksheetSubmit({
      muridUid: info.uid || "",
      cid: info.cid || "",
      namaAnak: info.nama || "",
      role: (info.role || "").toLowerCase()
    });
  </script>
  <script src="/elearn/common/calistung-navbar.js"></script>
</body>
</html>
