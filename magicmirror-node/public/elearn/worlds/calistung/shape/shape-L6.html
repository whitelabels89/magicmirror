<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shape L6 – Triangle Paint</title>
  <link rel="stylesheet" href="./shape-shell.css" />
  <style>
    :root{
      --bg:#f6f8ff;--card:#ffffff;--ink:#0f172a;--muted:#64748b;--accent:#2563eb;
      --ok:#16a34a;--bad:#ef4444;--outline:#1f2937;
    }
    *{box-sizing:border-box}

    .shape-shell__subtitle{max-width:760px}

    .triangle-toolbar{display:flex;gap:14px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:16px}
    .palette{display:flex;gap:14px;flex-wrap:wrap;align-items:center;overflow-x:auto;padding-bottom:6px}
    .chip{width:170px;height:160px;border-radius:16px;border:2px solid #e5e7eb;cursor:pointer;box-shadow:0 4px 16px rgba(2,6,23,.08);background:#fff;display:grid;place-items:center;transition:transform .15s ease, box-shadow .15s ease}
    .chip.active{box-shadow:inset 0 0 0 3px #111827,0 6px 18px rgba(2,6,23,.08);transform:translateY(-2px)}
    .chipInner{width:160px;height:150px;display:grid;place-items:center}

    .triangle-actions{display:flex;gap:12px;flex-wrap:wrap}

    .canvasWrap{background:linear-gradient(180deg,#ffffff 0%,#f8fafc 100%);border:1px solid #e5e7eb;border-radius:20px;padding:12px;position:relative}
    svg{width:100%;height:min(72vh,720px);display:block;border-radius:16px;background:#fff}

    .hud{position:absolute;left:16px;top:16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .hud .shape-button{box-shadow:none;border:1px solid rgba(15,23,42,.15);background:rgba(255,255,255,.92);color:var(--ink)}
    .hud .shape-button.success{background:#22c55e;color:#052e16;border-color:transparent}

    .hint{font-size:14px;color:var(--muted);margin-top:12px}

    .tri{stroke:var(--outline);stroke-width:2;fill:#fff;transition:.2s}
    .tri.locked{stroke:var(--ok)}
    .tri.wrong{animation:shake 0.2s 2;stroke:var(--bad)!important}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-2px)}75%{transform:translateX(2px)}}

    .finish-bar { position: fixed; right: 16px; bottom: 24px; z-index: 1000; }
    @media (max-width: 520px) {
      .finish-bar { right: 12px; bottom: 18px; }
    }
  </style>

  <link rel="stylesheet" href="/elearn/worlds/calistung/buttons.css" />
</head>
<body class="shape-shell" style="--shape-accent:#2563eb; --shape-accent-dark:#1d4ed8; --shape-secondary-bg:#0f172a; --shape-badge-bg:linear-gradient(135deg,#60a5fa,#2563eb); --shape-badge-shadow:#1d4ed8; --shape-bg-radial-1:rgba(37,99,235,0.26); --shape-bg-radial-2:rgba(99,102,241,0.22); --shape-bg-base:#f6f8ff; --shape-bg-base-bottom:#e0e7ff;" data-nav-badge="Calistung Shape" data-nav-home-url="/elearn/worlds/calistung/shape/index.html">
  <div class="shape-game">
    <header class="shape-card shape-card--frost shape-shell__header">
      <span class="shape-shell__badge">Shape • Level 6</span>
      <h1 class="shape-shell__title">Triangle Paint</h1>
      <p class="shape-shell__subtitle">Warna sesuai contoh: setiap <b>ukuran</b> segitiga punya warna yang benar. Pilih warna, lalu klik segitiga untuk mewarnai.</p>
    </header>

    <section class="shape-card shape-card--frost shape-game__content">
      <div class="triangle-toolbar">
        <div class="palette" id="palette"></div>
        <div class="triangle-actions">
          <button class="shape-button secondary" id="btnShuffle" type="button">Acak Tata Letak</button>
          <button class="shape-button primary" id="btnCheck" type="button">Periksa Jawaban</button>
          <button class="shape-button ghost" id="btnReset" type="button">Reset</button>
        </div>
      </div>

      <div class="canvasWrap">
        <svg id="stage" viewBox="0 0 1000 650" role="img" aria-label="Bidang segitiga"></svg>
        <div class="hud">
          <button id="btnUndo" class="shape-button ghost small">Undo</button>
          <button id="btnEraser" class="shape-button ghost small">Eraser</button>
          <button id="btnPen" class="shape-button ghost small success">Pen</button>
        </div>
      </div>
      <div class="hint" id="status">Pilih warna di palet, lalu klik segitiga untuk mewarnai.</div>
      <div id="legend" class="legend" hidden></div>
    </section>
  </div>

<script>
(() => {
  const RULES = [
    { key:'XS', size:20, color:'#ef4444', label:'Kecil sekali = Merah'},
    { key:'S',  size:34, color:'#22c55e', label:'Kecil = Hijau'},
    { key:'M',  size:50, color:'#3b82f6', label:'Sedang = Biru'},
    { key:'L',  size:74, color:'#f59e0b', label:'Besar = Kuning'},
    { key:'XL', size:96, color:'#8b5cf6', label:'Sangat besar = Ungu'}
  ];
  const MAX_SIDE = Math.max(...RULES.map(r=>r.size));

  function makeMiniTriangle(side, color){
    const w=160, h=150;
    const pad = 8;
    const cx = w/2, cy = h/2 + 2;
    const s = side;
    const triH = Math.sqrt(3)/2 * s;
    const topY  = cy - triH/1.2;
    const baseY = cy + triH/1.8;
    const p1 = `${cx},${topY}`;
    const p2 = `${cx - s/2},${baseY}`;
    const p3 = `${cx + s/2},${baseY}`;

    const wrap = document.createElement('div');
    wrap.className='chipInner';
    wrap.innerHTML = `
      <svg viewBox="-${pad} -${pad} ${w + pad*2} ${h + pad*2}" aria-hidden="true">
        <polygon class="miniTri" points="${p1} ${p2} ${p3}" fill="${color}" />
      </svg>`;
    return wrap;
  }

  const stage = document.getElementById('stage');
  const palette = document.getElementById('palette');
  const legend = document.getElementById('legend');
  const statusEl = document.getElementById('status');
  const btnShuffle = document.getElementById('btnShuffle');
  const btnCheck = document.getElementById('btnCheck');
  const btnReset = document.getElementById('btnReset');

  let activeColor = RULES[0].color;
  const triangles = [];

  function buildLegend(){
    legend.innerHTML = '';
    RULES.forEach(r=>{
      const el = document.createElement('div');
      el.className = 'item';
      el.appendChild(makeMiniTriangle(r.size, r.color));
      legend.appendChild(el);
    });
  }

  function buildPalette(){
    palette.innerHTML='';
    RULES.forEach((r,i)=>{
      const chip = document.createElement('button');
      chip.type='button';
      chip.className='chip'+(i===0?' active':'');
      const box = document.createElement('div');
      box.className='chipInner';
      const mini = makeMiniTriangle(r.size, r.color);
      box.appendChild(mini);
      chip.appendChild(box);
      chip.title=r.label;
      chip.addEventListener('click',()=>{
        [...palette.children].forEach(c=>c.classList.remove('active'));
        chip.classList.add('active');
        activeColor = r.color;
        setStatus('Warna aktif dipilih. Sekarang klik segitiga.');
      });
      palette.appendChild(chip);
    });
  }

  function triPoints(cx, cy, side){
    const h = Math.sqrt(3)/2 * side;
    const x1 = cx,     y1 = cy - h/1.2;
    const x2 = cx - side/2, y2 = cy + h/1.8;
    const x3 = cx + side/2, y3 = cy + h/1.8;
    return `${x1},${y1} ${x2},${y2} ${x3},${y3}`;
  }

  function randomFrom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function buildBoard(){
    stage.innerHTML = '';
    triangles.length = 0;

    const cols = 7, rows = 4;
    const padding = 120;
    const w = 1000, h = 650;

    for(let r=0; r<rows; r++){
      for(let c=0; c<cols; c++){
        const rule = randomFrom(RULES);
        const cx = padding + c*((w-2*padding)/(cols-1)) + (Math.random()*18-9);
        const cy = padding + r*((h-2*padding)/(rows-1));
        const side = rule.size;

        const g = document.createElementNS('http://www.w3.org/2000/svg','g');
        const p = document.createElementNS('http://www.w3.org/2000/svg','polygon');
        p.setAttribute('points', triPoints(cx,cy,side));
        p.setAttribute('class','tri');
        p.dataset.key = rule.key;
        p.dataset.correct = rule.color;
        p.style.fill = '#fff';

        p.addEventListener('click', () => paintTriangle(p));
        g.appendChild(p);
        stage.appendChild(g);
        triangles.push({node:p, rule});
      }
    }
  }

  function paintTriangle(p){
    p.style.fill = activeColor;
    if(p.dataset.correct === activeColor){
      p.classList.add('locked');
      p.classList.remove('wrong');
    }else{
      p.classList.remove('locked');
      p.classList.add('wrong');
      setTimeout(()=>p.classList.remove('wrong'), 400);
    }
  }

  function shuffle(){
    [...stage.querySelectorAll('g')].forEach(g=>{
      const dx = (Math.random()*16-8);
      const dy = 0;
      g.setAttribute('transform',`translate(${dx},${dy})`);
    });
    setStatus('Tata letak diacak.');
  }

  function setStatus(msg){ statusEl.textContent = msg; }

  function checkAll(){
    let correct=0;
    triangles.forEach(({node})=>{
      const ok = node.style.fill === node.dataset.correct;
      node.classList.toggle('locked', ok);
      node.classList.toggle('wrong', !ok);
      if(ok) correct++;
    });
    const score = Math.round(100*correct/triangles.length);
    setStatus(`Skor: ${score}% • ${correct}/${triangles.length} segitiga sudah benar.`);
  }

  function resetAll(){
    triangles.forEach(({node})=>{node.style.fill='#fff';node.classList.remove('locked','wrong');});
    setStatus('Pilih warna lalu klik segitiga untuk mewarnai.');
  }

  // init
  // buildLegend(); // legend hidden
  buildPalette();
  buildBoard();

  btnShuffle.addEventListener('click', shuffle);
  btnCheck.addEventListener('click', checkAll);
  btnReset.addEventListener('click', resetAll);
})();
</script>

<div class="finish-bar"><button id="btnSelesai" class="shape-button success" type="button">Selesai</button></div>

<!-- Tambah html2canvas hanya jika belum ada di halaman -->
<script>if(!window.html2canvas){document.write('<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"><\/script>')}</script>

<!-- Tambah manifest & user info hanya jika belum ada -->
<script>window.__hasManifestLessons||(document.write('<script src="/elearn/manifest-lessons.js"><\/script>'),window.__hasManifestLessons=true);</script>
<script>window.__hasUserInfo||(document.write('<script src="/elearn/userInfo.js"><\/script>'),window.__hasUserInfo=true);</script>

<!-- Tambah worksheet-submit hanya jika belum ada -->
<script>window.__hasWorksheetSubmit||(document.write('<script src="/elearn/common/worksheet-submit.js"><\/script>'),window.__hasWorksheetSubmit=true);</script>

<script>
  window.WORKSHEET_DEBUG = true;

  ;(function ensureScreenshotRoot(){
    if (!document.getElementById('gameRoot') &&
        !document.getElementById('shapeBoard') &&
        !document.getElementById('canvasRoot')) {
      const wrap = document.createElement('div'); wrap.id = 'gameRoot';
      const bar = document.querySelector('.finish-bar');
      const bodyKids = Array.from(document.body.children).filter(n => n !== bar);
      bodyKids.forEach(n => wrap.appendChild(n));
      document.body.insertBefore(wrap, bar || null);
    }
  })();

  ;(function initSubmit(){
    const info = (typeof getUserInfo === "function") ? getUserInfo() : {};
    if (typeof initWorksheetSubmit === "function") {
      initWorksheetSubmit({
        muridUid: info.uid || "",
        cid: info.cid || "",
        namaAnak: info.nama || "",
        role: (info.role || "").toLowerCase(),
        screenshotSelectorPriority: ['#shapeCanvas', '#gameCanvas', '#canvasRoot', '#shapeBoard', '#gameRoot']
      });
    } else {
      console.warn("initWorksheetSubmit tidak ditemukan. Pastikan /elearn/common/worksheet-submit.js termuat.");
    }
  })();
</script>


<script src="/elearn/common/calistung-navbar.js"></script>
</body>
</html>
