<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shape-L2 â€“ Gambarkan Sesuai Petunjuk</title>
  <link rel="stylesheet" href="./shape-shell.css" />
  <style>
    :root{
      --bg:#f6fafc; --ink:#0f172a; --lane:#127b86; --card:#ffffff;
      --leaf:#f4b400; --spider:#7c3aed; --pumpkin:#f97316; --acorn:#8b5e3c;
      --candy:#7c4cff; --corn1:#fbbf24; --corn2:#fff; --corn3:#f59e0b; --apple:#ef4444; --stem:#15803d;
    }
    *{box-sizing:border-box}

    .sheet{width:100%;display:flex;flex-direction:column;gap:18px}

    .row{background:#e8f6f8;border-radius:18px;padding:14px;display:grid;grid-template-columns:1fr 96px;gap:12px;align-items:center}
    .pattern{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
    .slot{width:92px;height:92px;border:3px dashed #8aa;border-radius:12px;display:grid;place-items:center;background:#fff}

    .choices{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    .choice{width:64px;height:64px;border-radius:12px;background:#fff;display:grid;place-items:center;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.08);border:2px solid transparent;transition:transform .15s ease, box-shadow .15s ease}
    .choice.selected{border-color:#22c55e}
    .choice:hover{transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.12)}
    .slot.filled{border-style:solid}
    .slot.ok{border-color:#22c55e; box-shadow:0 0 0 3px rgba(34,197,94,.22)}
    .slot.wrong{border-color:#ef4444; box-shadow:0 0 0 3px rgba(239,68,68,.22)}
    .choice.correct{border-color:#22c55e; box-shadow:0 4px 14px rgba(34,197,94,.24)}
    .choice.wrong{border-color:#ef4444; box-shadow:0 4px 14px rgba(239,68,68,.2)}

    svg{width:60px;height:60px}
    .small svg{width:50px;height:50px}
    .emoji{font-size:48px; line-height:1;}
    .small .emoji{font-size:44px}

    @media (max-width:720px){
      .row{grid-template-columns:1fr}
      .row .slot{justify-self:center}
    }

    .finish-bar { position: fixed; right: 16px; bottom: 24px; z-index: 1000; }
    @media (max-width: 520px) {
      .finish-bar { right: 12px; bottom: 18px; }
    }
  </style>

  <link rel="stylesheet" href="/elearn/worlds/calistung/buttons.css" />
</head>
<body class="shape-shell" style="--shape-accent:#f97316; --shape-accent-dark:#c2410c; --shape-secondary-bg:#7c3aed; --shape-badge-bg:linear-gradient(135deg,#fb923c,#f97316); --shape-badge-shadow:#c2410c; --shape-bg-radial-1:rgba(249,115,22,0.24); --shape-bg-radial-2:rgba(124,58,237,0.22); --shape-bg-base:var(--bg); --shape-bg-base-bottom:#e0f2fe;" data-nav-badge="Calistung Shape" data-nav-home-url="/elearn/worlds/calistung/shape/index.html">
  <div class="shape-game">
    <header class="shape-card shape-card--frost shape-shell__header center">
      <span class="shape-shell__badge">Shape â€¢ Level 2</span>
      <h1 class="shape-shell__title">Gambar / Isi Sesuai Petunjuk</h1>
      <p class="shape-shell__subtitle">Pilih gambar yang tepat untuk melanjutkan pola pada kotak ungu di kanan.</p>
    </header>

    <section class="shape-card shape-card--frost shape-game__content">
      <section class="sheet" id="sheet"></section>
    </section>

    <section class="shape-card shape-card--compact shape-shell__hud hud">
      <span id="status" class="pill">Siap menebak pola âœ¨</span>
      <button id="shuffle" class="shape-button secondary">Acak Soal</button>
      <button id="check" class="shape-button primary">Periksa</button>
      <button id="reset" class="shape-button ghost">Reset</button>
    </section>
  </div>

<script>
(function(){
  const elSheet = document.getElementById('sheet');
  const statusEl = document.getElementById('status');
  const BTN = (id)=>document.getElementById(id);

  let rowsOrder = [];

  const ICON_KEYS = ['leaf','spider','pumpkin','acorn','candy','candycorn','apple'];

  // Icon factory
  const icons = {
    leaf: () => emoji('ðŸ‚'),
    spider: () => emoji('ðŸ•·ï¸'),
    pumpkin: () => emoji('ðŸŽƒ'),
    acorn: () => emoji('ðŸŒ°'),
    candy: () => emoji('ðŸ¬'),
    candycorn: () => emoji('ðŸ­'),
    apple: () => emoji('ðŸŽ')
  };

  function svgWrap(inner){
    const s = document.createElementNS('http://www.w3.org/2000/svg','svg');
    s.setAttribute('viewBox','0 0 100 100');
    s.innerHTML = inner; return s;
  }

  function emoji(char){
    const s = document.createElement('span');
    s.className = 'emoji';
    s.textContent = char;
    return s;
  }

  const ROW_BUILDERS = [
    function buildAlternating(){
      const [a,b] = pickDistinct(2);
      return {
        pattern:[a,b,a,b,a],
        answer:b,
        options: uniqueOptions([a,b])
      };
    },
    function buildTriplet(){
      const [a,b] = pickDistinct(2);
      return {
        pattern:[a,a,a,b,b,b],
        answer:a,
        options: uniqueOptions([a,b])
      };
    },
    function buildAlternatingSix(){
      const [a,b] = pickDistinct(2);
      return {
        pattern:[a,b,a,b,a,b],
        answer:a,
        options: uniqueOptions([a,b])
      };
    },
    function buildDoubleRepeat(){
      const [a,b] = pickDistinct(2);
      return {
        pattern:[a,b,b,a,b,b,a],
        answer:b,
        options: uniqueOptions([a,b])
      };
    }
  ];

  let rows = [];

  function pickRandom(exclude = []){
    const pool = ICON_KEYS.filter(k => !exclude.includes(k));
    if (!pool.length) return exclude[0] || ICON_KEYS[0];
    return pool[Math.floor(Math.random() * pool.length)];
  }

  function pickDistinct(count){
    const picked = [];
    while(picked.length < count){
      const next = pickRandom(picked);
      if(!next) break;
      picked.push(next);
    }
    return picked;
  }

  function uniqueOptions(base){
    const opts = [...base];
    while(opts.length < 3 && opts.length < ICON_KEYS.length){
      const next = pickRandom(opts);
      if(!opts.includes(next)) opts.push(next);
    }
    return opts;
  }

  function buildSheet({ regenerate = false } = {}){
    if (regenerate || rows.length === 0) {
      rows = ROW_BUILDERS.map(fn => fn());
    }
    elSheet.innerHTML = '';
    rowsOrder = rows.map((_, idx) => idx);
    shuffle(rowsOrder);

    rowsOrder.forEach((rowIdx)=>{
      const row = rows[rowIdx];
      const rowEl = div('row');
      const pat = div('pattern');
      row.pattern.forEach(k=> pat.appendChild(icon(k)));
      const slot = div('slot');
      slot.dataset.row = String(rowIdx);
      slot.dataset.need = row.answer;
      rowEl.append(pat, slot);

      const choices = div('choices');
      const opts = [...row.options];
      shuffle(opts).forEach(k=>{
        const c = div('choice small');
        c.dataset.key = k;
        c.dataset.row = String(rowIdx);
        c.appendChild(icon(k));
        c.addEventListener('click',()=>selectChoice(c, slot));
        choices.appendChild(c);
      });

      elSheet.appendChild(rowEl);
      elSheet.appendChild(choices);
    });
  }

  buildSheet({ regenerate: true });

  BTN('check').addEventListener('click', validate);
  BTN('shuffle').addEventListener('click', ()=>{
    buildSheet({ regenerate: true });
    statusEl.textContent = 'Soal diacak ðŸŽ²';
    statusEl.className = 'pill';
  });
  BTN('reset').addEventListener('click', resetAll);

  function selectChoice(choiceEl, slot){
    // mark selected for that row
    document.querySelectorAll(`.choice[data-row="${choiceEl.dataset.row}"]`).forEach(n=>n.classList.remove('selected'));
    choiceEl.classList.add('selected');
    slot.innerHTML = '';
    slot.appendChild(icon(choiceEl.dataset.key));
    slot.classList.add('filled');
    slot.dataset.choice = choiceEl.dataset.key;
    statusEl.textContent = 'Pilihan dimasukkan.'; statusEl.className = 'pill';
  }

  function validate(){
    let correct = 0;
    document.querySelectorAll('.slot').forEach(slot=>{
      const want = slot.dataset.need;
      const picked = slot.dataset.choice;
      const rowChoices = document.querySelectorAll(`.choice[data-row="${slot.dataset.row}"]`);
      rowChoices.forEach(c=>{
        c.classList.remove('correct','wrong');
        if(c.dataset.key === want){ c.classList.add('correct'); }
      });
      slot.classList.add('filled');
      slot.classList.remove('ok','wrong');
      if(picked === want){
        correct++;
        slot.classList.add('ok');
      }else{
        const wrong = Array.from(rowChoices).find(c=>c.dataset.key === picked);
        if(wrong) wrong.classList.add('wrong');
        slot.classList.add('wrong');
      }
    });

    if(correct === rows.length){
      statusEl.textContent = 'Asik! Semua benar ðŸŽ‰';
      statusEl.className = 'pill ok';
    }else{
      statusEl.textContent = 'Masih ada yang salah nih. Coba lagi yuk!';
      statusEl.className = 'pill bad';
    }
  }

  function resetAll(){
    document.querySelectorAll('.slot').forEach(slot=>{
      slot.innerHTML = '';
      slot.classList.remove('filled','ok','wrong');
      delete slot.dataset.choice;
    });
    document.querySelectorAll('.choice').forEach(c=>c.classList.remove('selected','correct','wrong'));
    statusEl.textContent = 'Diâ€‘reset. Lanjut!'; statusEl.className = 'pill';
  }

  // helpers
  function div(cls){ const d = document.createElement('div'); d.className = cls; return d; }
  function icon(key){
    const fn = icons[key];
    return fn ? fn() : svgWrap('');
  }
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}
    return arr;
  }
})();
</script>
<style>
  .finish-bar button { border: none; }
</style>

<div class="finish-bar"><button id="btnSelesai" class="shape-button success" type="button">Selesai</button></div>

<!-- Tambah html2canvas hanya jika belum ada di halaman -->
<script>if(!window.html2canvas){document.write('<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"><\/script>')}</script>

<!-- Tambah manifest & user info hanya jika belum ada -->
<script>window.__hasManifestLessons||(document.write('<script src="/elearn/manifest-lessons.js"><\/script>'),window.__hasManifestLessons=true);</script>
<script>window.__hasUserInfo||(document.write('<script src="/elearn/userInfo.js"><\/script>'),window.__hasUserInfo=true);</script>

<!-- Tambah worksheet-submit hanya jika belum ada -->
<script>window.__hasWorksheetSubmit||(document.write('<script src="/elearn/common/worksheet-submit.js"><\/script>'),window.__hasWorksheetSubmit=true);</script>

<script>
  window.WORKSHEET_DEBUG = true;

  // Cari elemen target screenshot (prioritas canvas bila ada)
  ;(function ensureScreenshotRoot(){
    if (!document.getElementById('gameRoot') &&
        !document.getElementById('shapeBoard') &&
        !document.getElementById('canvasRoot')) {
      // Bungkus seluruh isi body KECUALI finish-bar ke dalam #gameRoot
      const wrap = document.createElement('div'); wrap.id = 'gameRoot';
      const bar = document.querySelector('.finish-bar');
      const bodyKids = Array.from(document.body.children).filter(n => n !== bar);
      bodyKids.forEach(n => wrap.appendChild(n));
      document.body.insertBefore(wrap, bar || null);
    }
  })();

  // Init submitter
  ;(function initSubmit(){
    const info = (typeof getUserInfo === "function") ? getUserInfo() : {};
    if (typeof initWorksheetSubmit === "function") {
      initWorksheetSubmit({
        muridUid: info.uid || "",
        cid: info.cid || "",
        namaAnak: info.nama || "",
        role: (info.role || "").toLowerCase(),

        // Opsi opsional khusus Shape:
        // prioritas canvas screenshot jika ada:
        screenshotSelectorPriority: ['#shapeCanvas', '#gameCanvas', '#canvasRoot', '#shapeBoard', '#gameRoot']
      });
    } else {
      console.warn("initWorksheetSubmit tidak ditemukan. Pastikan /elearn/common/worksheet-submit.js termuat.");
    }
  })();
</script>


<script src="/elearn/common/calistung-navbar.js"></script>
</body>
</html>
