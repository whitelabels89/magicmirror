<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shape-L1 – Warnai Sesuai Petunjuk</title>
  <link rel="stylesheet" href="./shape-shell.css" />
  <style>
    :root{
      --bg:#f3f7fb; --teal:#0f8b94; --card:#ffffff; --ink:#0f172a;
      --heart:#ef4444; --pentagon:#16a34a; --star:#7c3aed; --circle:#fb923c;
      --lane:#127b86;
    }
    *{box-sizing:border-box}

    .board{
      margin:0;
      display:grid;
      gap:16px;
      grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
    }

    .lane{
      background:linear-gradient(180deg, #f9e9a9 0 74px, transparent 74px), var(--lane);
      border-radius:20px; padding:0 14px 14px; position:relative; overflow:hidden; min-height:520px;
      box-shadow:inset 0 8px 0 #fff6cc, 0 6px 18px rgba(14, 110, 118,.18);
    }
    .cap{ position:absolute; inset:0 0 auto 0; height:74px; display:grid; place-items:center; }
    .cap .icon{ display:flex; align-items:center; gap:8px; font-weight:900; font-size:20px; }
    .icon small{font-weight:800; font-size:18px; color:#0d3b3f}
    .cap .shape-badge{ width:28px; height:28px; display:inline-block; vertical-align:middle; }

    .stack{ margin-top:86px; display:flex; flex-direction:column; gap:14px; align-items:center; }
    .slot{
      width:86%; height:54px; border-radius:12px; background:rgba(255,255,255,.08);
      display:grid; place-items:center; position:relative;
    }
    .slot::before{content:""; position:absolute; inset:-2px; border-radius:14px; border:2px solid rgba(255,255,255,.12)}
    svg{ width:40px; height:40px; cursor:pointer; filter:drop-shadow(0 1px 0 rgba(0,0,0,.08)); }
    .ghost{ fill:#fff; opacity:.94; }

    @media (max-width:720px){
      .board{ grid-template-columns:repeat(2,1fr); }
    }

    .finish-bar { position: fixed; right: 16px; bottom: 24px; z-index: 1000; }
    @media (max-width: 520px) {
      .finish-bar { right: 12px; bottom: 18px; }
    }
  </style>

  <link rel="stylesheet" href="/elearn/worlds/calistung/buttons.css" />
</head>
<body class="shape-shell" style="--shape-accent:#0fb3c2; --shape-accent-dark:#0e6e76; --shape-secondary-bg:#0b2942; --shape-badge-bg:linear-gradient(135deg, #2ea6b4, #14b8a6); --shape-badge-shadow:#0e6e76; --shape-bg-radial-1:rgba(20,184,166,0.26); --shape-bg-radial-2:rgba(59,130,246,0.16); --shape-bg-base:var(--bg); --shape-bg-base-bottom:#dbeafe;" data-nav-badge="Calistung Shape" data-nav-home-url="/elearn/worlds/calistung/shape/index.html">
  <div class="shape-game">
    <header class="shape-card shape-card--frost shape-shell__header center">
      <span class="shape-shell__badge">Shape • Level 1</span>
      <h1 class="shape-shell__title">Warnai Sesuai Petunjuk</h1>
      <p class="shape-shell__subtitle">Klik bentuk untuk mewarnai. Isi jumlah yang diminta di bagian atas tiap kolom, lalu tekan <strong>Periksa</strong>.</p>
    </header>

    <section class="shape-card shape-card--frost shape-game__content">
      <main class="board" id="board"></main>
    </section>

    <section class="shape-card shape-card--compact shape-shell__hud hud">
      <span id="status" class="pill">Siap mewarnai ✨</span>
      <button id="check" class="shape-button primary">Periksa</button>
      <button id="reset" class="shape-button ghost">Reset</button>
    </section>
  </div>

<script>
(function(){
  const board = document.getElementById('board');
  const statusEl = document.getElementById('status');
  const BTN = (id)=>document.getElementById(id);

  // Konfigurasi kolom
  const lanes = [
    { key:'heart',   label:'♥', color:getCSS('--heart'),   target:7 },
    { key:'pentagon',label:'⬟', color:getCSS('--pentagon'),target:5 },
    { key:'star',    label:'★', color:getCSS('--star'),    target:4 },
    { key:'circle',  label:'●', color:getCSS('--circle'),  target:7 },
  ];

  // Render lanes
  lanes.forEach((ln)=>{
    const lane = h('section',{class:'lane', 'data-key':ln.key});
    // Cap / header
    const cap = h('div',{class:'cap'},
      h('div',{class:'icon'},
        shapeBadge(ln.key, ln.color),
        h('small',{}, String(ln.target))
      )
    );

    const stack = h('div',{class:'stack'});
    const SLOTS = 7; // tampilkan 7 slot pada setiap kolom seperti contoh
    for(let i=0;i<SLOTS;i++){
      const slot = h('div',{class:'slot'});
      const svg = drawShape(ln.key);
      svg.classList.add('ghost');
      svg.setAttribute('data-active','0');
      svg.addEventListener('click',()=>toggle(svg, ln.color));
      slot.appendChild(svg);
      stack.appendChild(slot);
    }

    lane.append(cap, stack);
    board.appendChild(lane);
  });

  BTN('check').addEventListener('click', validate);
  BTN('reset').addEventListener('click', resetAll);

  function toggle(svg, color){
    const on = svg.getAttribute('data-active') === '1';
    const node = svg.firstElementChild; // actual shape element
    if(on){
      svg.setAttribute('data-active','0');
      node.setAttribute('fill','#ffffff');
      svg.classList.add('ghost');
    }else{
      svg.setAttribute('data-active','1');
      node.setAttribute('fill', color);
      svg.classList.remove('ghost');
    }
    statusEl.textContent = 'Lanjutkan…';
    statusEl.className = 'pill';
  }

  function validate(){
    let allGood = true;
    document.querySelectorAll('.lane').forEach(lane=>{
      const key = lane.getAttribute('data-key');
      const rule = lanes.find(l=>l.key===key);
      const count = lane.querySelectorAll('svg[data-active="1"]').length;
      if(count === rule.target){
        lane.style.outline = '4px solid rgba(34,197,94,.6)';
        lane.style.outlineOffset = '-4px';
      }else{
        allGood = false;
        lane.style.outline = '4px solid rgba(239,68,68,.6)';
        lane.style.outlineOffset = '-4px';
      }
    });
    if(allGood){
      statusEl.textContent = 'Mantap! Semua sesuai petunjuk ✅';
      statusEl.className = 'pill ok';
      confettiLite();
    }else{
      statusEl.textContent = 'Masih ada yang belum pas. Coba lagi!';
      statusEl.className = 'pill bad';
    }
  }

  function resetAll(){
    document.querySelectorAll('svg').forEach(svg=>{
      svg.setAttribute('data-active','0');
      const node = svg.firstElementChild;
      if(node) node.setAttribute('fill','#ffffff');
      svg.classList.add('ghost');
    });
    document.querySelectorAll('.lane').forEach(l=>l.style.outline='none');
    statusEl.textContent = 'Di‑reset. Gas lagi!';
    statusEl.className = 'pill';
  }

  // Helpers
  function getCSS(varName){
    return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
  }
  function h(tag, attrs={}, ...kids){
    const el = document.createElement(tag);
    for(const k in attrs){ el.setAttribute(k, attrs[k]); }
    kids.forEach(k=> el.appendChild(typeof k === 'string' ? document.createTextNode(k) : k));
    return el;
  }

  function drawShape(kind){
    const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
    svg.setAttribute('viewBox','0 0 100 100');
    let node;
    switch(kind){
      case 'heart':{
        node = document.createElementNS(svg.namespaceURI,'path');
        node.setAttribute('d','M50 86 L16 52 C6 42 6 26 17 16 c9-8 23-7 31 2 8-9 22-10 31-2 11 10 11 26 1 36L50 86z');
        break;
      }
      case 'pentagon':{
        node = document.createElementNS(svg.namespaceURI,'polygon');
        node.setAttribute('points','50,5 95,38 78,92 22,92 5,38');
        break;
      }
      case 'star':{
        node = document.createElementNS(svg.namespaceURI,'path');
        node.setAttribute('d','M50 5 l14 28 31 4 -23 22 6 31 -28-15 -28 15 6-31 -23-22 31-4z');
        break;
      }
      default:{ // circle
        node = document.createElementNS(svg.namespaceURI,'circle');
        node.setAttribute('cx','50'); node.setAttribute('cy','50'); node.setAttribute('r','44');
      }
    }
    svg.appendChild(node);
    node.setAttribute('fill','#ffffff');
    return svg;
  }

  function shapeBadge(kind, color){
    const svg = drawShape(kind);
    svg.firstElementChild.setAttribute('fill', color);
    svg.classList.remove('ghost');
    svg.style.width = '28px'; svg.style.height = '28px'; svg.style.cursor='default';
    const wrap = h('span',{class:'shape-badge'});
    wrap.appendChild(svg);
    return wrap;
  }

  // Super simple confetti
  function confettiLite(){
    const wh = document.body.getBoundingClientRect();
    for(let i=0;i<24;i++){
      const p = document.createElement('div');
      p.style.position='fixed'; p.style.left=Math.random()*wh.width+'px'; p.style.top='-10px';
      p.style.width='8px'; p.style.height='12px'; p.style.borderRadius='2px';
      p.style.background=['#22c55e','#f97316','#06b6d4','#eab308','#a855f7'][i%5];
      p.style.pointerEvents='none'; p.style.zIndex=9999; p.style.transform=`rotate(${Math.random()*360}deg)`;
      document.body.appendChild(p);
      const dy = wh.height + 40;
      p.animate([{transform:p.style.transform, top:'-10px'},{transform:`${p.style.transform} translateX(${(Math.random()*80-40)}px)`, top:dy+'px'}],{duration:900+Math.random()*600, easing:'ease-in'}).onfinish=()=>p.remove();
    }
  }
})();
</script>
<style>
  .finish-bar button { border: none; }
</style>

<div class="finish-bar"><button id="btnSelesai" class="shape-button success" type="button">Selesai</button></div>

<!-- Tambah html2canvas hanya jika belum ada di halaman -->
<script>if(!window.html2canvas){document.write('<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"><\/script>')}</script>

<!-- Tambah manifest & user info hanya jika belum ada -->
<script>window.__hasManifestLessons||(document.write('<script src="/elearn/manifest-lessons.js"><\/script>'),window.__hasManifestLessons=true);</script>
<script>window.__hasUserInfo||(document.write('<script src="/elearn/userInfo.js"><\/script>'),window.__hasUserInfo=true);</script>

<!-- Tambah worksheet-submit hanya jika belum ada -->
<script>window.__hasWorksheetSubmit||(document.write('<script src="/elearn/common/worksheet-submit.js"><\/script>'),window.__hasWorksheetSubmit=true);</script>

<script>
  window.WORKSHEET_DEBUG = true;

  // Cari elemen target screenshot (prioritas canvas bila ada)
  ;(function ensureScreenshotRoot(){
    if (!document.getElementById('gameRoot') &&
        !document.getElementById('shapeBoard') &&
        !document.getElementById('canvasRoot')) {
      // Bungkus seluruh isi body KECUALI finish-bar ke dalam #gameRoot
      const wrap = document.createElement('div'); wrap.id = 'gameRoot';
      const bar = document.querySelector('.finish-bar');
      const bodyKids = Array.from(document.body.children).filter(n => n !== bar);
      bodyKids.forEach(n => wrap.appendChild(n));
      document.body.insertBefore(wrap, bar || null);
    }
  })();

  // Init submitter
  ;(function initSubmit(){
    const info = (typeof getUserInfo === "function") ? getUserInfo() : {};
    if (typeof initWorksheetSubmit === "function") {
      initWorksheetSubmit({
        muridUid: info.uid || "",
        cid: info.cid || "",
        namaAnak: info.nama || "",
        role: (info.role || "").toLowerCase(),

        // Opsi opsional khusus Shape:
        // prioritas canvas screenshot jika ada:
        screenshotSelectorPriority: ['#shapeCanvas', '#gameCanvas', '#canvasRoot', '#shapeBoard', '#gameRoot']
      });
    } else {
      console.warn("initWorksheetSubmit tidak ditemukan. Pastikan /elearn/common/worksheet-submit.js termuat.");
    }
  })();
</script>


<script src="/elearn/common/calistung-navbar.js"></script>
</body>
</html>
