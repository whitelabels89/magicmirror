<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shape L5 â€“ Warnai Sesuai Jumlah Ikan</title>
  <link rel="stylesheet" href="./shape-shell.css" />
  <style>
    :root{--bg:#0ea5e9;--panel:#ffffff;--ink:#0f172a;--good:#22c55e;--bad:#ef4444}
    *{box-sizing:border-box}

    .shape-shell__subtitle{max-width:760px}

    .aquarium{background:linear-gradient(180deg,#c7e8ff,#a5ddff);border:4px solid #94d2ff;border-radius:20px;padding:18px;display:grid;grid-template-columns:repeat(auto-fill,minmax(64px,1fr));gap:16px;box-shadow:0 16px 40px rgba(2,132,199,.18)}
    .fish{width:64px;height:40px}

    .board{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px;margin-top:20px}
    .card{display:grid;grid-template-columns:64px 1fr;align-items:center;border:2px dashed #cbd5e1;border-radius:16px;background:var(--panel);padding:14px;gap:12px;transition:box-shadow .2s,border-color .2s}
    .card.active{box-shadow:0 10px 30px rgba(2,132,199,.18);border-color:#60a5fa}
    .num{font-weight:900;font-size:28px;display:flex;align-items:center;justify-content:center;background:#f1f5f9;border-radius:14px;height:64px}
    .fish-slot{display:flex;align-items:center;justify-content:center;height:64px}
    .fish-slot svg{height:58px}

    .palette{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin:20px 0 12px}
    .swatch{width:44px;height:44px;border-radius:12px;border:2px solid rgba(0,0,0,.12);cursor:pointer;outline:none;transition:transform .15s ease, box-shadow .15s ease}
    .swatch:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(15,23,42,.16)}
    .swatch.selected{outline:4px solid #0ea5e9}

    .tools{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .toast{margin-top:12px;font-weight:700;color:var(--ink)}
    .toast.ok{color:var(--good)}
    .toast.nope{color:var(--bad)}

    .finish-bar { position: fixed; right: 16px; bottom: 24px; z-index: 1000; }
    @media (max-width: 520px) {
      .finish-bar { right: 12px; bottom: 18px; }
    }
  </style>

  <link rel="stylesheet" href="/elearn/worlds/calistung/buttons.css" />
</head>
<body class="shape-shell" style="--shape-accent:#0ea5e9; --shape-accent-dark:#0369a1; --shape-secondary-bg:#0f172a; --shape-badge-bg:linear-gradient(135deg,#38bdf8,#0ea5e9); --shape-badge-shadow:#0369a1; --shape-bg-radial-1:rgba(14,165,233,0.3); --shape-bg-radial-2:rgba(34,197,94,0.22); --shape-bg-base:#eaf7ff; --shape-bg-base-bottom:#dbeafe;" data-nav-badge="Calistung Shape" data-nav-home-url="/elearn/worlds/calistung/shape/index.html">
  <div class="shape-game">
    <header class="shape-card shape-card--frost shape-shell__header">
      <span class="shape-shell__badge">Shape â€¢ Level 5</span>
      <h1 class="shape-shell__title">Warnai Sesuai <b>Jumlah Ikan</b> (1â€“5)</h1>
      <p class="shape-shell__subtitle">Di akuarium ada ikan berwarna-warni. Tugasmu: warnai ikan di kartu angka sesuai warna yang jumlahnya sama dengan angka tersebut.</p>
    </header>

    <section class="shape-card shape-card--frost shape-game__content">
      <section class="aquarium" id="aquarium" aria-label="Akuarium ikan"></section>

      <section class="board" id="board" aria-label="Kartu angka 1-5"></section>

      <div class="palette" id="palette"></div>
      <div class="tools">
        <button class="shape-button primary" id="checkBtn">Periksa Jawaban</button>
        <button class="shape-button secondary" id="shuffleBtn">Acak Soal</button>
        <button class="shape-button ghost" id="resetBtn">Reset Warna</button>
      </div>
      <div class="toast" id="toast" role="status" aria-live="polite"></div>
    </section>
  </div>

  <template id="tpl-fish">
    <svg viewBox="0 0 100 60" class="fish" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <g>
        <path d="M55 8c-18 0-33 10-33 22s15 22 33 22c7 0 14-2 20-6l15 10V4L75 14c-6-4-13-6-20-6z" fill="currentColor"/>
        <circle cx="61" cy="26" r="3" fill="#0f172a"/>
      </g>
    </svg>
  </template>

  <template id="tpl-fish-outline">
    <svg viewBox="0 0 100 60" xmlns="http://www.w3.org/2000/svg" aria-label="Ikan untuk diwarnai">
      <g fill="none" stroke="#0f172a" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
        <path d="M55 8c-18 0-33 10-33 22s15 22 33 22c7 0 14-2 20-6l15 10V4L75 14c-6-4-13-6-20-6z"/>
        <circle cx="61" cy="26" r="3"/>
      </g>
    </svg>
  </template>

  <script>
    const COLORS = [
      '#0ea5e9',
      '#f59e0b',
      '#10b981',
      '#ef4444',
      '#a855f7'
    ];

    const aquariumEl = document.getElementById('aquarium');
    const boardEl = document.getElementById('board');
    const paletteEl = document.getElementById('palette');
    const toastEl = document.getElementById('toast');

    let colorMap = new Map();
    let answers = {};
    let selectedColor = null;

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}
      return arr;
    }

    function makeFish(color){
      const tpl = document.getElementById('tpl-fish');
      const node = tpl.content.firstElementChild.cloneNode(true);
      node.style.color = color;
      return node;
    }

    function makeOutline(color){
      const tpl = document.getElementById('tpl-fish-outline');
      const node = tpl.content.firstElementChild.cloneNode(true);
      node.style.color = color || 'transparent';
      return node;
    }

    function buildAquarium(){
      aquariumEl.innerHTML = '';
      colorMap.clear();
      const counts = shuffle([1,2,3,4,5].slice());
      const colorOrder = shuffle(COLORS.slice());
      for(let i=0;i<5;i++){
        colorMap.set(colorOrder[i], counts[i]);
      }
      const items = [];
      colorMap.forEach((count,color)=>{
        for(let i=0;i<count;i++) items.push(color);
      });
      shuffle(items).forEach(c=>{
        const f = makeFish(c);
        aquariumEl.appendChild(f);
      });
      buildPalette(Array.from(colorMap.keys()));
    }

    function buildPalette(colors){
      paletteEl.innerHTML = '';
      colors.forEach((color, idx)=>{
        const sw = document.createElement('button');
        sw.type='button';
        sw.className = 'swatch'+(idx===0?' selected':'');
        sw.style.background=color;
        sw.setAttribute('aria-label',`Pilih warna ${idx+1}`);
        sw.addEventListener('click',()=>{
          [...paletteEl.children].forEach(c=>c.classList.remove('selected'));
          sw.classList.add('selected');
          selectedColor = color;
          toastEl.textContent = 'Warna dipilih. Klik kartu angka ya!';
          toastEl.className = 'toast';
        });
        if(idx===0) selectedColor = color;
        paletteEl.appendChild(sw);
      });
    }

    function buildBoard(){
      boardEl.innerHTML = '';
      answers = {};
      for(let n=1;n<=5;n++){
        const card = document.createElement('button');
        card.type='button';
        card.className = 'card';
        card.dataset.n = String(n);
        const left = document.createElement('div');
        left.className = 'num';
        left.textContent = n;
        const right = document.createElement('div');
        right.className = 'fish-slot';
        right.appendChild(makeOutline());
        card.append(left,right);
        card.addEventListener('click',()=>{
          document.querySelectorAll('.card').forEach(c=>c.classList.remove('active'));
          card.classList.add('active');
          if(!selectedColor){ toastEl.textContent = 'Pilih warna dulu ya!'; toastEl.className = 'toast nope'; return; }
          answers[n] = selectedColor;
          right.innerHTML = '';
          right.appendChild(makeFish(selectedColor));
          toastEl.textContent = `Kartu ${n} sudah diwarnai.`;
          toastEl.className = 'toast ok';
        });
        boardEl.appendChild(card);
      }
    }

    function validate(){
      if(Object.keys(answers).length < 5){
        toastEl.textContent = 'Lengkapi semua kartu angka dulu yuk!';
        toastEl.className = 'toast nope';
        return;
      }
      let allCorrect = true;
      Object.entries(answers).forEach(([num,color])=>{
        const count = colorMap.get(color);
        if(count !== Number(num)){
          allCorrect = false;
        }
      });
      if(allCorrect){
        toastEl.textContent = 'Hebat! Semua warna sesuai jumlah ikan ðŸŽ‰';
        toastEl.className = 'toast ok';
      }else{
        toastEl.textContent = 'Masih ada yang salah nih. Coba cek lagi!';
        toastEl.className = 'toast nope';
      }
    }

    function resetBoard(){
      buildBoard();
      toastEl.textContent = 'Warna direset. Mulai lagi!';
      toastEl.className = 'toast';
    }

    document.getElementById('checkBtn').addEventListener('click', validate);
    document.getElementById('shuffleBtn').addEventListener('click',()=>{
      buildAquarium();
      resetBoard();
      toastEl.textContent = 'Akuarium diacak ulang!';
      toastEl.className = 'toast';
    });
    document.getElementById('resetBtn').addEventListener('click', resetBoard);

    buildAquarium();
    buildBoard();
  </script>

  <div class="finish-bar"><button id="btnSelesai" class="shape-button success" type="button">Selesai</button></div>

  <!-- Tambah html2canvas hanya jika belum ada di halaman -->
  <script>if(!window.html2canvas){document.write('<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"><\/script>')}</script>

  <!-- Tambah manifest & user info hanya jika belum ada -->
  <script>window.__hasManifestLessons||(document.write('<script src="/elearn/manifest-lessons.js"><\/script>'),window.__hasManifestLessons=true);</script>
  <script>window.__hasUserInfo||(document.write('<script src="/elearn/userInfo.js"><\/script>'),window.__hasUserInfo=true);</script>

  <!-- Tambah worksheet-submit hanya jika belum ada -->
  <script>window.__hasWorksheetSubmit||(document.write('<script src="/elearn/common/worksheet-submit.js"><\/script>'),window.__hasWorksheetSubmit=true);</script>

  <script>
    window.WORKSHEET_DEBUG = true;

    ;(function ensureScreenshotRoot(){
      if (!document.getElementById('gameRoot') &&
          !document.getElementById('shapeBoard') &&
          !document.getElementById('canvasRoot')) {
        const wrap = document.createElement('div'); wrap.id = 'gameRoot';
        const bar = document.querySelector('.finish-bar');
        const bodyKids = Array.from(document.body.children).filter(n => n !== bar);
        bodyKids.forEach(n => wrap.appendChild(n));
        document.body.insertBefore(wrap, bar || null);
      }
    })();

    ;(function initSubmit(){
      const info = (typeof getUserInfo === "function") ? getUserInfo() : {};
      if (typeof initWorksheetSubmit === "function") {
        initWorksheetSubmit({
          muridUid: info.uid || "",
          cid: info.cid || "",
          namaAnak: info.nama || "",
          role: (info.role || "").toLowerCase(),
          screenshotSelectorPriority: ['#shapeCanvas', '#gameCanvas', '#canvasRoot', '#shapeBoard', '#gameRoot']
        });
      } else {
        console.warn("initWorksheetSubmit tidak ditemukan. Pastikan /elearn/common/worksheet-submit.js termuat.");
      }
    })();
  </script>


<script src="/elearn/common/calistung-navbar.js"></script>
</body>
</html>
