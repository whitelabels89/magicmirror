<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Game Mewarnai Mobil</title>
    <link rel="stylesheet" href="/elearn/worlds/calistung/number/theme.css" />
<style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #f4f4f4;
      padding: 20px;
    }
    .color-code {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      gap: 15px;
    }
    .color-code div {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      font-size: 24px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
    }
    .mobil-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      max-width: 600px;
      margin: auto;
    }
    .mobil {
      position: relative;
    }
    .mobil img {
      width: 100%;
      height: auto;
    }
    .mobil .overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: transparent;
      pointer-events: none;
    }
    .mobil .color-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      mix-blend-mode: multiply;
      pointer-events: auto;
    }
    .mobil-outline {
      cursor: pointer;
      transition: background-color 0.3s;
      background-color: transparent;
      mix-blend-mode: multiply;
      opacity: 0;
    }
    img.colored {
      filter: none !important;
    }
    /* Lock page scrolling while brushing (touch/stylus) */
    body.brush-lock { touch-action: none; overscroll-behavior: none; }
    /* Canvas should not trigger touch gestures */
    canvas { touch-action: none; }
  </style>

  <link rel="stylesheet" href="/elearn/worlds/calistung/buttons.css" />
  <script defer src="/elearn/worlds/calistung/number/theme.js"></script>
</head>
<body id="worksheetRoot" data-course-id="numbers-basic" data-lesson-id="L2">
  <h2>Mewarnai Mobil</h2>
  <p>Warnailah gambar mobil sesuai dengan kode angka berikut ini!</p>

  <div class="color-code">
    <div style="background: red;" data-code="1">1</div>
    <div style="background: gold;" data-code="2">2</div>
    <div style="background: dodgerblue;" data-code="3">3</div>
    <div style="background: green;" data-code="4">4</div>
  </div>
  <button id="brushMode">üñåÔ∏è Mode Kuas</button>
  <button id="btnShuffle" class="clay-button ghost">üîÄ Acak Soal</button>
  <style>
    #brushMode {
      background: linear-gradient(to bottom, #ffcc70, #f79d65);
      border: 4px solid #f08a5d;
      border-radius: 12px;
      box-shadow: 0 4px #d76d3c;
      color: #4e342e;
      font-weight: bold;
      font-size: 18px;
      padding: 10px 20px;
      transition: all 0.1s ease-in-out;
      margin-bottom: 20px;
    }

    #brushMode:active {
      box-shadow: 0 2px #d76d3c;
      transform: translateY(2px);
    }
  </style>
<div class="mobil-container" id="mobilContainer">
    <!-- Mobil akan dirender di sini -->
  </div>

  <script>
    const colorMap = {
      1: "red",
      2: "gold",
      3: "dodgerblue",
      4: "green"
    };

    const mobilColorImages = {
      red: "/elearn/calistung/assets/shape/mobil-merah.png",
      gold: "/elearn/calistung/assets/shape/mobil-yellow.png",
      dodgerblue: "/elearn/calistung/assets/shape/mobil-blue.png",
      green: "/elearn/calistung/assets/shape/mobil-green.png"
    };

    let selectedColor = null;
    let brushActive = false;

function setBrushLock(on){
  if(on) document.body.classList.add('brush-lock');
  else document.body.classList.remove('brush-lock');
}

document.querySelectorAll(".color-code div").forEach((el) => {
  el.addEventListener("click", () => {
    selectedColor = colorMap[el.dataset.code];
    console.log("Selected color:", selectedColor);

    // Otomatis matikan mode kuas saat pilih warna angka
    brushActive = false;
    document.querySelectorAll("canvas").forEach(c => {
      c.style.pointerEvents = "none";
    });
    document.getElementById("brushMode").textContent = "üñåÔ∏è Mode Kuas";
    document.body.classList.remove('brush-lock');
  });
});

    const container = document.getElementById("mobilContainer");
    const shuffleBtn = document.getElementById("btnShuffle");
    const checkButton = document.getElementById("checkButton");
    const resultBox = document.getElementById("result");
    const ids = [1, 2, 3, 4];

    function shuffle(arr) {
      const next = [...arr];
      for (let i = next.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [next[i], next[j]] = [next[j], next[i]];
      }
      return next;
    }

    function resetFinishButton() {
      const btn = document.getElementById("btnSelesai") || document.querySelector('.finish-bar button');
      if (!btn) return;
      btn.disabled = true;
      btn.style.opacity = 0.5;
      btn.style.pointerEvents = 'none';
      btn.setAttribute('aria-disabled', 'true');
      btn.title = 'Selesaikan tugas dulu ya üòä';
    }

    function setupCanvas(canvas, wrapper) {
      const ctx = canvas.getContext("2d");
      let painting = false;

      const start = (e) => {
        painting = true;
        draw(e);
      };

      const end = () => {
        painting = false;
        ctx.beginPath();
      };

      const draw = (e) => {
        if (!painting || !selectedColor) return;
        const rect = canvas.getBoundingClientRect();
        const point = e.touches ? e.touches[0] : e;
        const x = point.clientX - rect.left;
        const y = point.clientY - rect.top;
        ctx.fillStyle = selectedColor;
        ctx.beginPath();
        ctx.arc(x, y, 8, 0, Math.PI * 2);
        ctx.fill();
        wrapper.setAttribute('data-color', selectedColor);
      };

      const startHandler = (e) => { if (brushActive) e.preventDefault(); start(e); };
      const endHandler = (e) => { if (brushActive) e.preventDefault(); end(); };
      const moveHandler = (e) => { if (brushActive) e.preventDefault(); draw(e); };

      canvas.addEventListener('mousedown', startHandler);
      canvas.addEventListener('mouseup', endHandler);
      canvas.addEventListener('mouseleave', endHandler);
      canvas.addEventListener('mousemove', draw);

      canvas.addEventListener('touchstart', startHandler, { passive: false });
      canvas.addEventListener('touchend', endHandler, { passive: false });
      canvas.addEventListener('touchcancel', endHandler, { passive: false });
      canvas.addEventListener('touchmove', moveHandler, { passive: false });
    }

    function createMobil(id) {
      const wrapper = document.createElement('div');
      wrapper.className = 'mobil';
      wrapper.dataset.id = String(id);
      wrapper.removeAttribute('data-color');

      const img = document.createElement('img');
      img.id = 'mobil-' + id;
      img.alt = 'Mobil';
      img.src = '/elearn/calistung/assets/shape/mobil.png';
      img.style.cursor = 'pointer';
      img.setAttribute('data-id', id);

      const label = document.createElement('div');
      label.textContent = id;
      label.style.position = 'absolute';
      label.style.top = '10px';
      label.style.left = '10px';
      label.style.fontSize = '36px';
      label.style.fontWeight = 'bold';
      label.style.color = 'black';
      label.style.zIndex = 20;
      wrapper.appendChild(label);

      img.addEventListener('click', () => {
        if (!selectedColor) return;
        const newSrc = mobilColorImages[selectedColor];
        if (newSrc) {
          img.src = newSrc;
          wrapper.setAttribute('data-color', selectedColor);
        }
      });

      wrapper.appendChild(img);

      const canvas = document.createElement('canvas');
      canvas.id = 'canvas-' + id;
      canvas.width = 300;
      canvas.height = 200;
      canvas.style.position = 'absolute';
      canvas.style.top = 0;
      canvas.style.left = 0;
      canvas.style.zIndex = 10;
      canvas.style.pointerEvents = brushActive ? 'auto' : 'none';
      setupCanvas(canvas, wrapper);
      wrapper.appendChild(canvas);

      return wrapper;
    }

    function renderCars(order) {
      container.innerHTML = '';
      order.forEach((id) => {
        container.appendChild(createMobil(id));
      });
      container.querySelectorAll('canvas').forEach((canvas) => {
        canvas.style.pointerEvents = brushActive ? 'auto' : 'none';
      });
      resultBox.textContent = '';
      resultBox.style.color = '';
      resetFinishButton();
    }

    function randomizeCars() {
      const order = shuffle(ids);
      renderCars(order);
    }

    randomizeCars();

      checkButton.addEventListener("click", () => {
  let correct = 0;

  document.querySelectorAll(".mobil").forEach((mobilDiv) => {
    // Ambil ID soal dari atribut data pada IMG
    const imgEl = mobilDiv.querySelector("img[data-id]");
    const id = parseInt(imgEl?.dataset.id || "", 10);
    const expectedColor = colorMap[id];

    // Warna yang diterapkan: utamakan atribut data-color (klik gambar),
    // jika kosong coba tebak dari img.src yang sudah berubah.
    let appliedColor = (mobilDiv.getAttribute("data-color") || "").trim().toLowerCase();

    if (!appliedColor && imgEl) {
      const imgSrc = imgEl.src; // absolute URL
      for (const [clr, url] of Object.entries(mobilColorImages)) {
        // Cocokkan bagian akhir path agar robust ke origin absolute
        if (imgSrc.endsWith(url)) {
          appliedColor = clr.toLowerCase();
          break;
        }
      }
    }

    const expected = (expectedColor || "").trim().toLowerCase();
    if (appliedColor && expected && appliedColor === expected) {
      correct++;
    }
  });

  if (correct === 4) {
    resultBox.textContent = "‚úÖ Semua warna sudah benar!";
    resultBox.style.color = "green";
  } else {
    resultBox.textContent = `‚ùå Masih ada ${4 - correct} yang salah, coba lagi ya!`;
    resultBox.style.color = "red";
  }
});

      document.getElementById("brushMode").addEventListener("click", () => {
        brushActive = !brushActive;
        container.querySelectorAll('canvas').forEach(c => {
          c.style.pointerEvents = brushActive ? "auto" : "none";
        });
        document.getElementById("brushMode").textContent = brushActive ? "üñåÔ∏è Mode Kuas (Aktif)" : "üñåÔ∏è Mode Kuas";
        setBrushLock(brushActive);
      });

    if (shuffleBtn) {
      shuffleBtn.addEventListener('click', () => {
        brushActive = false;
        document.getElementById("brushMode").textContent = "üñåÔ∏è Mode Kuas";
        document.body.classList.remove('brush-lock');
        selectedColor = null;
        randomizeCars();
      });
    }
  </script>
  <button id="checkButton" class="clay-button">Periksa Jawaban</button>
  <div id="result" style="margin-top: 15px; font-weight: bold;"></div>

  <style>
  .finish-bar { position: fixed; right: 16px; bottom: 16px; z-index: 1000; }
  #btnSelesai { background: #22c55e; color: #fff; border: none; cursor: pointer; padding: 12px 16px; border-radius: 12px; font-weight: 700; font-size: 16px; box-shadow: 0 6px 18px rgba(16, 185, 129, 0.4); }
  #btnSelesai:hover { filter: brightness(1.05); }
  #btnSelesai:active { transform: translateY(1px); }
  @media (max-width: 480px) {
    #btnSelesai { padding: 10px 14px; font-size: 15px; }
  }
</style>

<div class="finish-bar"><button id="btnSelesai" type="button">Selesai</button></div>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="/elearn/manifest-lessons.js"></script>
  <script src="/elearn/userInfo.js"></script>
  <script src="/elearn/common/worksheet-submit.js"></script>
  <script>
    window.WORKSHEET_DEBUG = true;
  window.WORKSHEET_META = { course_id: "numbers-basic" };
    const info = (typeof getUserInfo === 'function') ? getUserInfo() : {};
    const role = (info.role || '').toLowerCase();
    initWorksheetSubmit({
      muridUid: info.uid || '',
      cid: info.cid || '',
      namaAnak: info.nama || '',
      role: role
    });
  </script>
  <script>
  (function(){
    function findFinishBtn(){
      const all = Array.from(document.querySelectorAll('button, a'));
      const found = all.find(el => {
        const t = (el.textContent || '').toLowerCase().trim();
        return el.id === 'finishButton'
          || el.classList.contains('finish-button')
          || el.dataset?.role === 'finish'
          || t.includes('selesai');
      });
      return found || null;
    }
    function setDisabled(btn, disabled){
      if(!btn) return;
      btn.disabled = !!disabled;
      btn.style.opacity = disabled ? 0.5 : 1;
      btn.style.pointerEvents = disabled ? 'none' : 'auto';
      btn.setAttribute('aria-disabled', disabled ? 'true' : 'false');
      if (disabled) {
        btn.title = 'Selesaikan tugas dulu ya üòä';
      } else {
        btn.title = '';
      }
    }
    // Wait until finish button is injected by addFinishButton
    function init(){
      const btn = findFinishBtn();
      if (!btn) { setTimeout(init, 150); return; }
      // Start disabled like A1 flow (aktifkan setelah jawaban benar)
      setDisabled(btn, true);
      // Enable when all correct
      const checkBtn = document.getElementById('checkButton');
      const resultEl = document.getElementById('result');
      if (checkBtn) {
        checkBtn.addEventListener('click', () => {
          const txt = (resultEl && resultEl.textContent) ? resultEl.textContent : '';
          if (txt.includes('‚úÖ') || /semua warna sudah benar/i.test(txt)) {
            setDisabled(btn, false);
          }
        });
      }
    }
    init();
  })();
  </script>
</body>
</html>
