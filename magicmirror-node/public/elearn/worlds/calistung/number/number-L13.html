<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Number Maze – E2</title>
  <style>
    :root{
      --bg:#f8fafc; /* slate-50 */
      --ink:#0f172a; /* slate-900 */
      --accent:#2563eb; /* blue-600 */
      --accent-weak:#bfdbfe; /* blue-200 */
      --success:#16a34a; /* green-600 */
      --danger:#dc2626; /* red-600 */
      --ring: 3px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";color:var(--ink);background:var(--bg)}
    .wrap{max-width:960px;margin:0 auto;padding:24px}

    header{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    header h1{margin:0;font-size:clamp(22px,3.6vw,36px);letter-spacing:1px}
    .tag{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
    .tag button{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;background:white;box-shadow:0 1px 3px rgba(0,0,0,.08)}
    .tag button.primary{background:var(--accent);color:#fff}
    .tag button:disabled{opacity:.5;cursor:not-allowed}

    .board{margin-top:18px;background:white;border-radius:16px;box-shadow:0 6px 24px rgba(2,6,23,.08);padding:16px}
    .subtitle{margin:0 0 12px 0;font-weight:700;opacity:.85}

    /* grid */
    .grid{
      display:grid;
      grid-template-columns: repeat(var(--cols), minmax(54px,1fr));
      gap:10px;
      align-items:center;
      justify-items:center;
    }

    @media (max-width:560px){
      .grid{gap:8px}
    }

    .cell{
      width:100%;
      aspect-ratio:1/1; /* perfect circle container */
      display:grid;place-items:center;
      border-radius:999px; 
      background:#fff;
      border:2px solid #e5e7eb; /* gray-200 */
      position:relative;
      user-select:none;
      touch-action:manipulation; /* prevent scroll while tapping */
      transition:.15s ease;
    }
    .cell[data-type="start"]::before{
      content:"START";position:absolute;left:50%;top:10px;translate:-50% 0;background:#111;color:#fff;font-size:.65rem;font-weight:800;padding:.25rem .45rem;border-radius:6px;pointer-events:none;z-index:1}
    .cell[data-type="stop"]::before{
      content:"STOP";position:absolute;left:50%;bottom:10px;translate:-50% 0;background:var(--danger);color:#fff;font-size:.65rem;font-weight:800;padding:.25rem .45rem;border-radius:6px;pointer-events:none;z-index:1}
    .cell .num{font-weight:900;font-size:clamp(18px,3.4vw,28px)}
    .cell[data-one="true"]{border-color:#e5e7eb} /* samakan tampilan sebelum diklik */
    .cell[data-disabled="true"]{opacity:.4;pointer-events:none}

    .cell.selected{border-color:var(--accent-weak);outline:var(--ring) solid var(--accent);outline-offset:2px;background:linear-gradient(180deg,#fff, #eef6ff)}
    .cell.selected .num{color:var(--accent)}

    .hud{display:flex;align-items:center;gap:12px;margin-top:14px;flex-wrap:wrap}
    .chip{background:#fff;border:1px solid #e5e7eb;border-radius:999px;padding:8px 12px;font-weight:700}
    .chip.ok{border-color:var(--success);color:var(--success)}
    .chip.err{border-color:var(--danger);color:var(--danger)}

    footer{margin-top:10px;opacity:.6;font-size:.85rem;text-align:center}
  </style>

  <link rel="stylesheet" href="/elearn/worlds/calistung/buttons.css" />
</head>
<body>
  <div class="wrap">
    <header>
      <h1>NUMBER MAZE – Level E2</h1>
      <div class="tag">
        <button id="btn-new" title="Buat maze baru">Maze Baru</button>
        <button id="btn-reset">Reset Pilihan</button>
        <button id="btn-check" class="primary">Periksa</button>
      </div>
    </header>

    <div class="board">
      <p class="subtitle">Instruksi: Warnai (klik/ketuk) hanya angka <strong id="target-num">?</strong> untuk membentuk jalur dari START ke STOP.</p>
      <div id="grid" class="grid"></div>
      <div class="hud">
        <span class="chip" id="status">Siap bermain.</span>
        <span class="chip">Tips: Klik salah → klik lagi untuk batal.</span>
      </div>
    </div>

    <footer>
      © Queen's Academy – E2 Number Maze (versi game). Desain responsif, touch-friendly.
    </footer>
  </div>

  <script>
    // ====== Config
    const ROWS = 8; // ganti jika ingin grid lebih besar
    const COLS = 8;
    const EXTRA_FAKE_PROB = 0.15; // peluang angka target palsu sebagai pengalih
    const TARGET_MIN = 1;
    const TARGET_MAX = 9; // biar satu digit

    const gridEl = document.getElementById('grid');
    const statusEl = document.getElementById('status');
    const btnNew = document.getElementById('btn-new');
    const btnReset = document.getElementById('btn-reset');
    const btnCheck = document.getElementById('btn-check');
    const targetSpan = document.getElementById('target-num');

    let cells = []; // matrix of objects {r,c,val,el,selected,isTarget}
    let pathCoords = []; // koor jalur benar
    let TARGET = 1; // diacak tiap maze

    function rand(min, max){return Math.floor(Math.random()*(max-min+1))+min}

    function carvePath(){
      // Buat jalur dari (0,0) ke (ROWS-1,COLS-1) bergerak kanan/bawah
      const path = [{r:0,c:0}];
      let r = 0, c = 0;
      while(r < ROWS-1 || c < COLS-1){
        const moves = [];
        if(r < ROWS-1) moves.push('D');
        if(c < COLS-1) moves.push('R');
        const move = moves[rand(0, moves.length-1)];
        if(move==='D') r++; else c++;
        path.push({r,c});
      }
      return path;
    }

    function init(){
      gridEl.style.setProperty('--cols', COLS);
      gridEl.innerHTML = '';
      cells = [];
      pathCoords = carvePath();

      // Generate random target number for this maze
      TARGET = rand(TARGET_MIN, TARGET_MAX);
      targetSpan.textContent = TARGET;

      // Make quick lookup for path positions
      const key = p=> `${p.r},${p.c}`;
      const pathSet = new Set(pathCoords.map(key));

      for(let r=0;r<ROWS;r++){
        const row = [];
        for(let c=0;c<COLS;c++){
          const el = document.createElement('button');
          el.className = 'cell';
          el.setAttribute('aria-pressed','false');
          el.type = 'button';

          const isStart = (r===0 && c===0);
          const isStop  = (r===ROWS-1 && c===COLS-1);
          if(isStart) el.dataset.type = 'start';
          if(isStop)  el.dataset.type = 'stop';

          let isPath = pathSet.has(`${r},${c}`);
          let isTarget = false;
          let val;
          if(isPath){
            val = TARGET;
            isTarget = true;
          }else{
            // Decoy: with some probability, make a fake target
            if(Math.random() < EXTRA_FAKE_PROB){
              val = TARGET;
              isTarget = true;
            }else{
              do {
                val = rand(2,20);
              } while(val === TARGET);
              isTarget = false;
            }
          }
          el.dataset.one = isTarget ? 'true' : 'false';
          el.innerHTML = `<span class="num">${val}</span>`;

          el.addEventListener('click', ()=> toggleCell(r,c));
          el.addEventListener('touchend', (e)=>{ e.preventDefault(); toggleCell(r,c); }, {passive:false});

          gridEl.appendChild(el);
          row.push({r,c,val,el,selected:false,isTarget});
        }
        cells.push(row);
      }
      status(
        `Siap. Cari angka ${TARGET} dari START ke STOP!`
      );
    }

    function toggleCell(r,c){
      const cell = cells[r][c];
      if(cell.val !== TARGET) { // bukan angka target
        flash(cell.el, 'err');
        status(`Hanya angka ${TARGET} yang valid.`, true);
        return;
      }
      cell.selected = !cell.selected;
      cell.el.classList.toggle('selected', cell.selected);
      cell.el.setAttribute('aria-pressed', String(cell.selected));
    }

    function neighbors(r,c){
      const result = [];
      if(r>0) result.push({r:r-1,c});
      if(r<ROWS-1) result.push({r:r+1,c});
      if(c>0) result.push({r,c:c-1});
      if(c<COLS-1) result.push({r,c:c+1});
      return result;
    }

    function checkWin(){
      // BFS pada sel yang dipilih (dan bernilai TARGET) dari start ke stop
      const start = cells[0][0];
      const goal  = cells[ROWS-1][COLS-1];
      if(!start.selected || !goal.selected){
        status('Pastikan START dan STOP ikut diseleksi.', true); return false;
      }
      const visited = new Set();
      const q = [{r:0,c:0}];
      const key = (p)=> `${p.r},${p.c}`;
      visited.add(key(q[0]));
      while(q.length){
        const cur = q.shift();
        if(cur.r===ROWS-1 && cur.c===COLS-1){
          return true;
        }
        for(const nb of neighbors(cur.r,cur.c)){
          const cell = cells[nb.r][nb.c];
          if(cell.selected && cell.val===TARGET){
            const k = key(nb);
            if(!visited.has(k)){
              visited.add(k); q.push(nb);
            }
          }
        }
      }
      return false;
    }

    function status(msg, isErr=false){
      statusEl.textContent = msg;
      statusEl.className = 'chip' + (isErr ? ' err' : '');
      if(!isErr) statusEl.classList.add('ok');
      setTimeout(()=>{ statusEl.className='chip'; }, 1600);
    }

    function flash(el, type){
      const cls = type==='err' ? 'outline: var(--ring) solid var(--danger); outline-offset:2px;' : 'outline: var(--ring) solid var(--success); outline-offset:2px;';
      const prev = el.getAttribute('style')||'';
      el.setAttribute('style', prev + cls);
      setTimeout(()=> el.setAttribute('style', prev), 250);
    }

    // Buttons
    btnNew.addEventListener('click', init);
    btnReset.addEventListener('click', ()=>{
      for(const row of cells){
        for(const cell of row){
          cell.selected=false; cell.el.classList.remove('selected'); cell.el.setAttribute('aria-pressed','false');
        }
      }
      status('Pilihan direset.');
    });

    btnCheck.addEventListener('click', ()=>{
      const ok = checkWin();
      if(ok){
        status('Mantap! Jalur benar 🎉');
        // kunci papan (opsional)
        for(const row of cells){ for(const c of row){ c.el.dataset.disabled = 'true'; } }
      }else{
        status('Belum tersambung dari START ke STOP. Coba lagi!', true);
      }
    });

    // Inisialisasi
    init();
  </script>

<style>
  .finish-bar { position: fixed; right: 16px; bottom: 16px; z-index: 1000; }
  #btnSelesai { background: #22c55e; color: #fff; border: none; cursor: pointer; padding: 12px 16px; border-radius: 12px; font-weight: 700; font-size: 16px; box-shadow: 0 6px 18px rgba(16, 185, 129, 0.4); }
  #btnSelesai:hover { filter: brightness(1.05); }
  #btnSelesai:active { transform: translateY(1px); }
  @media (max-width: 480px) {
    #btnSelesai { padding: 10px 14px; font-size: 15px; }
  }
</style>

<div class="finish-bar"><button id="btnSelesai" type="button">Selesai</button></div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="/elearn/manifest-lessons.js"></script>
<script src="/elearn/userInfo.js"></script>
<script src="/elearn/common/worksheet-submit.js"></script>
<script>
  // Debug log
  window.WORKSHEET_DEBUG = true;
  window.WORKSHEET_META = { course_id: "numbers-basic" };

  // Ambil info user dari localStorage via userInfo.js
  const info = (typeof getUserInfo === 'function') ? getUserInfo() : {};
  const role = (info.role || '').toLowerCase();

  initWorksheetSubmit({
    muridUid: info.uid || '',
    cid: info.cid || '',
    namaAnak: info.nama || '',
    role: role
  });
</script>

</body>
</html>
