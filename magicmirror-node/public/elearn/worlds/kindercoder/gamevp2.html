<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KinderCoder ‚Äì Game VP 2</title>
  <style>
    html,body,canvas{ cursor:url('/elearn/models/ts-up/UI/Pointers/01.png') 0 0, auto }
  :root{
    --bg:#1b1716; --panel:#2a2422; --paper:#f6e8c8; --ink:#3b2e19;
    --accent:#fbbf24; --ok:#22c55e; --bad:#ef4444; --grid:52px;
  }
  *{box-sizing:border-box} html,body{height:100%;margin:0;background:var(--bg);color:#eee;font-family:system-ui,Segoe UI,Roboto,Arial}
  .hud{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:#3a302c;border-bottom:2px solid #000}
  .hud .tag{background:#6b4f2e;padding:4px 10px;border-radius:999px;font-weight:700;margin-left:8px}
  .hud .tag.done{background:var(--ok)} .hud .tag.fail{background:var(--bad)}
  .hud .btns{display:flex;gap:8px;align-items:center}
  button{border:none;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  #btnRun{background:#f59e0b;color:#1b1307} #btnStep{background:#60a5fa} #btnReset{background:#64748b}
  .wrap{display:grid;grid-template-columns:1fr 420px;gap:10px;height:calc(100vh - 62px);padding:10px}
  /* BOARD */
  #board{position:relative;background:#2b2522;border:2px solid #000;border-radius:14px;overflow:hidden;display:grid;place-content:center}
  .grid{position:relative;display:grid;grid-template-columns:repeat(var(--cols), var(--grid));grid-template-rows:repeat(var(--rows), var(--grid));gap:0; padding:12px}
  .cell{width:var(--grid);height:var(--grid);position:relative}
  .wall{background:
      radial-gradient(60% 60% at 30% 30%, #4b3f38 0, #3a312c 55%, #322a26 56%),
      linear-gradient(45deg,#3b312c,#29221e);}
  .floor{background:
      linear-gradient(135deg,#3b332e 0,#2d2622 100%);
      box-shadow:inset 0 2px 0 rgba(255,255,255,.04), inset 0 -2px 0 rgba(0,0,0,.3)}
  .spike:before{
    content:""; position:absolute; inset:13px 16px;
    background:
      conic-gradient(from 0deg,#84ccff 0 10%,transparent 10% 100%),
      conic-gradient(from 180deg,#84ccff 0 10%,transparent 10% 100%);
    mask:
      radial-gradient(12px 12px at 50% 0,#000 98%,transparent 100%) top/100% 50% no-repeat,
      radial-gradient(12px 12px at 50% 100%,#000 98%,transparent 100%) bottom/100% 50% no-repeat;
    filter:drop-shadow(0 0 4px #60a5fa);
  }
  .gem:before{
    content:""; position:absolute; inset:10px;
    background:radial-gradient(circle at 30% 30%,#a7f3d0 0,#34d399 40%,#059669 70%,#064e3b 100%);
    clip-path:polygon(50% 0, 85% 25%, 85% 70%, 50% 100%, 15% 70%, 15% 25%);
    box-shadow:0 0 8px #34d399, 0 0 18px #34d39980;
  }
  /* HERO */
  .hero{position:absolute;width:var(--grid);height:var(--grid);transition:transform .22s linear; z-index:3}
  .hero .body{
    position:absolute; inset:10px; border-radius:10px;
    background:radial-gradient(circle at 30% 30%,#ffb78a 0,#e66c3e 35%,#7a341a 80%);
    box-shadow:0 0 6px #0008,inset 0 0 8px #0007;
  }
  .hero .hair{
    position:absolute; left:14px; top:-2px; width:26px; height:26px; border-radius:18px 18px 2px 18px;
    background:linear-gradient(#ff7a18,#ff4d00);
    box-shadow:0 3px 0 #0005;
  }
  .pulse{position:absolute; inset:0;border-radius:8px;box-shadow:0 0 12px #ef444455;animation:pulse 1.2s infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 #ef444455}100%{box-shadow:0 0 30px 18px #ef444400}}
  /* EDITOR */
  #editor{display:flex;flex-direction:column;gap:8px}
  .paper{position:relative;background:var(--paper);border-radius:14px;border:2px solid #1e1a17;flex:1;overflow:hidden}
  .gutter{position:absolute;left:0;top:0;bottom:0;width:40px;background:#eadbb5;border-right:2px solid #d8c392;color:#6b4e2e;text-align:right;padding:12px 6px;line-height:24px;white-space:pre}
  textarea{position:absolute;left:40px;right:0;top:0;bottom:0;width:calc(100% - 40px);border:0;background:transparent;color:var(--ink);font:600 16px/24px ui-monospace,Menlo,Consolas,monospace;padding:12px;outline:none;tab-size:2;resize:none}
  .api{background:#201c19;border:2px solid #000;border-radius:12px;padding:10px 12px;font-size:13px}
  .api code{background:#342d28;padding:2px 6px;border-radius:6px}
  .log{background:#201c19;border:2px solid #000;border-radius:12px;padding:10px 12px;font-size:14px;min-height:44px}
  /* AUTOCOMPLETE */
  .ac { position:absolute; z-index:5; background:#fffbe9; color:#2b2115;
        border:2px solid #d8c392; border-radius:10px; box-shadow:0 8px 24px #0006;
        padding:6px 0; font:600 16px/24px ui-monospace,Menlo,Consolas,monospace;
        display:none; min-width:260px; }
  .ac .hint { font:700 12px/18px system-ui; color:#6b4e2e; padding:2px 12px 6px }
  .ac .item { padding:6px 12px; cursor:pointer; }
  .ac .item b{color:#2563eb}
  .ac .item.active { background:#e8d7ac; }
  /* Ghost suggestion */
  .ghost{ position:absolute; z-index:4; color:#6b4e2e; opacity:.45; pointer-events:none; font:600 16px/24px ui-monospace,Menlo,Consolas,monospace; display:none; }
  /* Responsive */
  @media (max-width: 980px){ .wrap{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="hud">
    <div><strong>üó∫Ô∏è Penjara Kithgard</strong> ‚Äî Kumpulkan permata.
      <span id="goal" class="tag">BELUM SELESAI</span>
    </div>
    <div class="btns">
      <button id="btnRun">JALANKAN</button>
      <button id="btnStep">LANGKAH</button>
      <button id="btnReset">RESET</button>
      <label style="font-size:13px">Kecepatan
        <input type="range" id="speed" min="80" max="600" value="240" />
      </label>
    </div>
  </div>

  <div class="wrap">
    <div id="board">
      <div id="grid" class="grid"></div>
      <div id="hero" class="hero" aria-label="hero">
        <div class="hair"></div>
        <div class="body"></div>
      </div>
    </div>

    <div id="editor">
      <div class="paper">
        <pre id="gutter" class="gutter">1
2
3
4
5</pre>
        <textarea id="code" spellcheck="false"></textarea>
        <div id="ac" class="ac" role="listbox" aria-label="autocomplete">
          <div class="hint">tekan enter</div>
        </div>
        <div id="ghost" class="ghost"></div>
      </div>
      <div class="api">
        <b>Fungsi tersedia:</b>
        <code>hero.moveUp(steps)</code>,
        <code>hero.moveDown(steps)</code>,
        <code>hero.moveLeft(steps)</code>,
        <code>hero.moveRight(steps)</code>
        ‚Äî <i>steps</i> opsional (default 1). Gunakan tanda <code>#</code> untuk komentar.
      </div>
      <div id="logger" class="log"></div>
    </div>
  </div>

<script>
/* ========= Level =========
   # = dinding, . = lantai, ^ = duri (bahaya), G = permata, S = start */
const level = [
  "##############",
  "#S..^....^...#",
  "#............#",
  "#..^^..^.....#",
  "#......^..G..#",
  "#............#",
  "##############"
];
// Grid size
const rows = level.length;
const cols = level[0].length;
document.querySelector(':root').style.setProperty('--rows', rows);
document.querySelector(':root').style.setProperty('--cols', cols);

const gridEl = document.getElementById('grid');
gridEl.style.setProperty('--rows', rows);
gridEl.style.setProperty('--cols', cols);

let start = {r:1,c:1}, goal = {r:4,c:10};
const spikes = new Set();

function key(r,c){return r+','+c;}
function buildGrid(){
  gridEl.innerHTML = '';
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const ch = level[r][c];
      const cell = document.createElement('div'); cell.className='cell';
      if(ch==='#'){ cell.classList.add('wall'); }
      else{
        cell.classList.add('floor');
        if(ch==='^'){ cell.classList.add('spike'); spikes.add(key(r,c)); }
        if(ch==='G'){ cell.classList.add('gem'); goal={r,c}; }
        if(ch==='S'){ start={r,c}; }
      }
      gridEl.appendChild(cell);
    }
  }
}
buildGrid();

const heroEl = document.getElementById('hero');
const boardEl = document.getElementById('board');
const logger = document.getElementById('logger');
const goalTag = document.getElementById('goal');

let pos = {...start};
function placeHero(){
  const size = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--grid'));
  heroEl.style.transform = `translate(${(pos.c)*size + 12}px, ${(pos.r)*size + 12}px)`;
}
placeHero();

/* ========= Editor ========= */
const codeEl = document.getElementById('code');
const gutterEl = document.getElementById('gutter');
codeEl.value =
`# Bergerak menuju permata.
# Jangan sentuh duri!
# Ketik kode di bawah lalu klik JALANKAN.
hero.moveRight(5)
hero.moveDown(3)
hero.moveRight(3)
hero.moveDown(1)
`;

function syncGutter(){
  const lines = codeEl.value.split('\n').length;
  gutterEl.textContent = Array.from({length:lines}, (_,i)=>i+1).join('\n');
}
codeEl.addEventListener('input', syncGutter);
syncGutter();

/* ========= Autocomplete ========= */
const AC_ITEMS = [
  {label:'hero.moveUp()', insert:'hero.moveUp()'},
  {label:'hero.moveDown()', insert:'hero.moveDown()'},
  {label:'hero.moveLeft()', insert:'hero.moveLeft()'},
  {label:'hero.moveRight()', insert:'hero.moveRight()'}
];
const acBox = document.getElementById('ac');
const ghostEl = document.getElementById('ghost');
let acIndex = 0, acVisible = false;

function showGhost(text,leftPx,topPx){
  if(!text){ hideGhost(); return; }
  ghostEl.textContent = text;
  ghostEl.style.left = leftPx + 'px';
  ghostEl.style.top  = (topPx-24) + 'px'; // tepat di baris caret
  ghostEl.style.display = 'block';
}
function hideGhost(){ ghostEl.style.display='none'; }

function showAC(items, leftPx, topPx){
  acBox.style.left = leftPx + 'px';
  acBox.style.top  = topPx  + 'px';
  acBox.innerHTML = '<div class="hint">tekan enter</div>' + items.map((it,i)=>(
    `<div class="item ${i===0?'active':''}" data-i="${i}"><b>hero</b>.${it.label.split('.')[1]}</div>`
  )).join('');
  acIndex = 0; acVisible = true; acBox.style.display = 'block';
}
function hideAC(){ acVisible=false; acBox.style.display='none'; }
function currentToken(){
  const pos = codeEl.selectionStart;
  const upTo = codeEl.value.slice(0,pos);
  const lineStart = upTo.lastIndexOf('\n')+1;
  const token = upTo.slice(lineStart).trim();
  return { token, lineStart, caretPos: pos };
}
function measureXY(){
  // Hitung posisi caret relatif ke .paper agar dropdown menempel editor
  const upTo = codeEl.value.slice(0, codeEl.selectionStart);
  const line = upTo.split('\n').length - 1;
  const colText = upTo.slice(upTo.lastIndexOf('\n')+1);
  // mirror untuk lebar teks
  const mirror = document.createElement('span');
  mirror.style.visibility='hidden';
  mirror.style.position='absolute';
  mirror.style.whiteSpace='pre';
  mirror.style.font= getComputedStyle(codeEl).font;
  mirror.textContent = colText.replace(/ /g,'\u00a0');
  document.body.appendChild(mirror);
  const w = mirror.getBoundingClientRect().width; mirror.remove();
  // offset padding textarea: left 12px, top 12px, gutter 40px, line-height 24px
  const left = codeEl.getBoundingClientRect().left + window.scrollX + 40 + 12 + w;
  const top  = codeEl.getBoundingClientRect().top  + window.scrollY + 12 + (line+1)*24;
  const paperRect = codeEl.parentElement.getBoundingClientRect();
  return { left: left-paperRect.left, top: top-paperRect.top };
}
function refreshAC(){
  const {token} = currentToken();
  // token bisa kosong (baris baru) ‚Üí tampilkan semua opsi
  let items = [];
  if(token==='' || token===undefined){ items = AC_ITEMS.slice(); }
  else{
    // dukung pola: "hero.", "hero.mo", atau "mo", "moveR" (fuzzy ringan)
    const t = token.toLowerCase();
    items = AC_ITEMS.filter(it=>{
      const s = it.insert.toLowerCase();
      return s.includes(t) || s.replace('hero.','').startsWith(t) || ('hero.'+t).startsWith(s.slice(0,6));
    });
  }
  if(items.length===0){ hideAC(); hideGhost(); return; }
  const {left,top} = measureXY();
  showAC(items,left,top);
  // Ghost suggestion: sisa teks dari kandidat pertama
  const first = items[0].insert;
  const tkn = (token||'');
  let remainder = '';
  if(first.toLowerCase().startsWith(tkn.toLowerCase())){
    remainder = first.slice(tkn.length);
  }else if(tkn==='' ){ remainder = first; }
  showGhost(remainder,left,top);
}
codeEl.addEventListener('keyup', (e)=>{
  if(['ArrowUp','ArrowDown','Enter','Tab','Escape'].includes(e.key)) return;
  refreshAC();
  if(!acVisible) hideGhost();
});
codeEl.addEventListener('click', ()=>{
  refreshAC();
  if(!acVisible) hideGhost();
});
codeEl.addEventListener('blur', ()=>{ setTimeout(()=>{ hideAC(); hideGhost(); },100); });

codeEl.addEventListener('keydown', (e)=>{
  if(!acVisible) return;
  if(e.key==='ArrowDown'){ e.preventDefault(); acIndex=(acIndex+1)%acBox.querySelectorAll('.item').length; setActive(); }
  else if(e.key==='ArrowUp'){ e.preventDefault(); acIndex=(acIndex-1+acBox.querySelectorAll('.item').length)%acBox.querySelectorAll('.item').length; setActive(); }
  else if(e.key==='Enter' || e.key==='Tab' || e.key==='ArrowRight'){ e.preventDefault(); applyAC(); }
  else if(e.key==='Escape'){ hideAC(); hideGhost(); }
});
function setActive(){
  acBox.querySelectorAll('.item').forEach((el,i)=>el.classList.toggle('active', i===acIndex));
  // Ghost update based on selected item
  const active = acBox.querySelectorAll('.item')[acIndex];
  if(active){
    const label = AC_ITEMS[acIndex].insert;
    const {token} = currentToken();
    const {left,top} = measureXY();
    const tkn = (token||'');
    let remainder = '';
    if(label.toLowerCase().startsWith(tkn.toLowerCase())) remainder = label.slice(tkn.length);
    else remainder = label;
    showGhost(remainder,left,top);
  }
}
function applyAC(){
  const item = AC_ITEMS[acIndex];
  const {token, lineStart} = currentToken();
  const segment = codeEl.value.slice(lineStart);
  const tokIndex = segment.indexOf(token);
  const insertAt = lineStart + (tokIndex >= 0 ? tokIndex : 0);
  codeEl.value = codeEl.value.slice(0, insertAt) + item.insert + codeEl.value.slice(insertAt + token.length);
  const newPosInsideParens = insertAt + item.insert.indexOf('(') + 1;
  codeEl.selectionStart = codeEl.selectionEnd = newPosInsideParens;
  hideAC(); hideGhost(); syncGutter();
}
acBox.addEventListener('mousedown', (e)=>{
  const row = e.target.closest('.item'); if(!row) return;
  acIndex = +row.dataset.i; applyAC(); codeEl.focus();
});

/* ========= Parser ========= */
function parse(){
  const lines = codeEl.value.split('\n');
  const cmds = [];
  const rx = /^hero\.move(Up|Down|Left|Right)\s*\(\s*(\d+)?\s*\)\s*;?\s*$/i;
  for(let i=0;i<lines.length;i++){
    const raw = lines[i].trim();
    if(!raw || raw.startsWith('#')) continue;
    const m = raw.match(rx);
    if(!m){
      throw new Error(`Baris ${i+1}: perintah tidak dikenali ‚Üí ‚Äú${raw}‚Äù.`);
    }
    const dir = m[1].toLowerCase();
    const steps = Math.max(1, parseInt(m[2]||'1',10));
    for(let s=0;s<steps;s++) cmds.push(dir);
  }
  if(cmds.length===0) throw new Error('Tidak ada perintah yang bisa dijalankan.');
  return cmds;
}

/* ========= Mesin Eksekusi ========= */
let queue = [], running=false, timer=null;
function log(msg,type='info'){
  logger.innerHTML = (type==='err' ? '‚ùå ' : type==='ok' ? '‚úÖ ' : 'üí° ') + msg;
}
function cellAt(r,c){
  if(r<0||c<0||r>=rows||c>=cols) return '#';
  return level[r][c];
}
function step(dir){
  const d = {up:[-1,0], down:[1,0], left:[0,-1], right:[0,1]}[dir];
  const nr = pos.r + d[0], nc = pos.c + d[1];
  if(cellAt(nr,nc)==='#'){ log('‚ò†Ô∏è Nabrak dinding. Gerak dibatalkan.', 'err'); return false; }
  pos = {r:nr,c:nc}; placeHero();
  const k = key(pos.r,pos.c);
  if(spikes.has(k)){ fail('Aduh, kena duri!'); return 'fail'; }
  if(pos.r===goal.r && pos.c===goal.c){ win(); return 'win'; }
  return true;
}
function runNext(){
  if(queue.length===0){ running=false; unlockEditor(); log('Selesai menjalankan perintah.'); return; }
  const dir = queue.shift();
  const spd = +document.getElementById('speed').value;
  const result = step(dir);
  if(result==='fail' || result==='win'){ queue.length=0; running=false; unlockEditor(); return; }
  timer = setTimeout(runNext, spd);
}
function runAll(){
  if(running) return;
  try{
    queue = parse();
    lockEditor(); running=true; log('Menjalankan perintah‚Ä¶');
    runNext();
  }catch(e){ log(e.message,'err'); }
}
function runOne(){
  if(running) return;
  try{
    const cmds = parse();
    queue = [cmds[0]];
    lockEditor(); running=true;
    runNext();
  }catch(e){ log(e.message,'err'); }
}
function reset(){
  clearTimeout(timer); running=false; queue.length=0; unlockEditor();
  pos = {...start}; placeHero(); goalTag.textContent='BELUM SELESAI'; goalTag.className='tag';
  log('Di-reset. Coba lagi!');
}
function win(){
  goalTag.textContent = 'SELESAI'; goalTag.className = 'tag done';
  log('Permata didapat! Keren üòé','ok');
}
function fail(msg){
  goalTag.textContent = 'GAGAL'; goalTag.className = 'tag fail';
  log(msg,'err');
}

/* ========= UI ========= */
function lockEditor(){ codeEl.disabled = true; codeEl.style.opacity=.75; }
function unlockEditor(){ codeEl.disabled = false; codeEl.style.opacity=1; }

document.getElementById('btnRun').addEventListener('click', runAll);
document.getElementById('btnStep').addEventListener('click', runOne);
document.getElementById('btnReset').addEventListener('click', reset);

// Penempatan awal hero saat resize (agar offset pas)
new ResizeObserver(()=>placeHero()).observe(gridEl);
</script>
</body>
</html>
