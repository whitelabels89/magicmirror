<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Points & Rewards ‚Äì Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="prefetch" href="/elearn/sidebar-mod.html" as="fetch" crossorigin>
  <script>
    document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'light');
  </script>
  <style>
    /* ===== Theme tokens (match other mod pages) ===== */
    :root {
      --sidebar-width: 230px;
      --primary: #2c3e50;
      --primary-light: #ecf0f1;
      --card-bg: #fff;
      --card-radius: 14px;
      --shadow: 0 2px 8px rgba(0,0,0,0.04);
      --gray: #f5f7fa;
      --font-main: 'Inter', sans-serif;
      --text-main: #222;
      --text-muted: #6b7280;
    }
    [data-theme='dark'] {
      --primary: #131313;
      --primary-light: #1c1c1c;
      --card-bg: #1e1e1e;
      --gray: #2a2a2a;
      --text-main: #f5f5f5;
      --text-muted: #aaa;
      --card-radius: 14px;
    }
    [data-theme='dark'] body { background: #121212; color: var(--text-main); }
    [data-theme='dark'] .card, [data-theme='dark'] .table-card { background: var(--card-bg); color: var(--text-main); box-shadow: 0 0 15px rgba(0,255,255,0.12), 0 0 30px rgba(255,0,255,0.06); border: 1px solid rgba(255,255,255,0.06); }
    [data-theme='dark'] table th { background: #2a2f3a; color: #e0e7ff; }
    [data-theme='dark'] th, [data-theme='dark'] td { color: #cdd8f7; }
    [data-theme='dark'] input, [data-theme='dark'] button, [data-theme='dark'] select { color: var(--text-main); }

    /* ===== Layout ===== */
    body { margin: 0; font-family: var(--font-main); background: var(--gray); color: var(--text-main); }
    .dashboard-layout { display: flex; min-height: 100vh; }
    .main-content { flex: 1; padding: 36px 40px; display: flex; flex-direction: column; gap: 24px; overflow-x: hidden; }

    /* Header */
    .header-row { display:flex; align-items:center; justify-content:space-between; gap:12px; width:100%; }
    .header-welcome { font-weight: 800; font-size: 2rem; background: linear-gradient(90deg, #ff3c3c, #ff7272); background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: .3px; }
    .header-theme-btn { background:none; border:none; cursor:pointer; font-size:1.4rem; line-height:1; display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:8px; color: inherit; }

    /* Cards */
    .cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px; }
    .card { background: var(--card-bg); border-radius: var(--card-radius); box-shadow: var(--shadow); padding: 22px 20px; display:flex; flex-direction:column; gap:14px; }
    .card h2 { margin: 0; font-size: 1.12rem; color: var(--primary); font-weight: 700; }

    /* Form row */
    .row { display:flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .row label { font-size: .95rem; color: var(--text-muted); }
    input[type="date"], input[type="text"], select { padding: 9px 12px; border-radius: 7px; border: 1px solid #dde1ef; background: #f7fafd; font-size: .98rem; }
    [data-theme='dark'] input[type="date"], [data-theme='dark'] input[type="text"], [data-theme='dark'] select { background:#292929; border-color:#444; }

    button.btn { padding: 9px 14px; border-radius: 8px; background: var(--primary); color: #fff; border: none; cursor: pointer; font-size: .98rem; transition: background .13s; }
    button.btn:hover { background: #2445a7; }

    /* Table card */
    .table-card { background: var(--card-bg); border-radius: var(--card-radius); box-shadow: var(--shadow); padding: 22px 20px; overflow-x:auto; }
    table { width: 100%; border-collapse: collapse; font-size: .98rem; background: transparent; }
    th, td { padding: 9px 12px; border-bottom: 1px solid #f0f0f0; text-align: left; }
    th { background: var(--primary-light); color: #233b6c; font-weight: 600; }
    tr:last-child td { border-bottom: none; }

    .muted { color: var(--text-muted); }

    @media (max-width: 1100px) { .main-content { padding: 28px 14px; } .cards { grid-template-columns: 1fr; } }
  </style>
  <link rel="stylesheet" href="/elearn/sidebar-mod.css">
  <!-- Firebase compat (keep for token fallback if parent not initialized) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script>
    try { if (!firebase.apps.length && window.firebaseConfig) { firebase.initializeApp(window.firebaseConfig); } } catch(e){}
  </script>
  <script>
    // Robust Firebase initializer for standalone usage
    (function ensureFirebaseApp(){
      try {
        if (firebase?.apps?.length) return; // already initialized
        let cfg = window.firebaseConfig || null;
        // Try to read config from parent (same-origin)
        if (!cfg && window.parent && window.parent !== window) {
          try { cfg = window.parent.firebaseConfig || (window.parent.firebase?.apps?.length ? window.parent.firebase.app().options : null); } catch(_){}
        }
        // Try localStorage cache
        if (!cfg) {
          try { const raw = localStorage.getItem('firebase_config_json'); if (raw) cfg = JSON.parse(raw); } catch(_){}
        }
        // If found, init and cache
        if (cfg) {
          try { firebase.initializeApp(cfg); localStorage.setItem('firebase_config_json', JSON.stringify(cfg)); } catch(e){ /* ignore duplicate init */ }
        }
      } catch(_){}
    })();
  </script>
</head>
<body>
  <div class="dashboard-layout">
    <!-- Sidebar placeholder + loader (same mechanism as other mod pages) -->
    <div id="sidebar-placeholder"></div>
    <script>
      (function() {
        try {
          const cached = localStorage.getItem('sidebar_mod_html_v2');
          const ph = document.getElementById('sidebar-placeholder');
          if (cached && ph && !document.getElementById('sidebar-container')) {
            ph.outerHTML = cached;
          }
        } catch (e) {}
      })();
    </script>
    <script type="module">
      import { loadSidebar } from '/elearn/sidebar-init.js';
      loadSidebar();
    </script>
    <script>
      window.addEventListener('DOMContentLoaded', () => {
        fetch('/elearn/sidebar-mod.html', { cache: 'no-store' })
          .then(res => res.text())
          .then(html => {
            try { localStorage.setItem('sidebar_mod_html_v2', html); } catch (e) {}
            const sc = document.getElementById('sidebar-container');
            const hasSidebar = !!sc;
            const hasToggle = hasSidebar && !!document.querySelector('#sidebar-container .sidebar-toggle, #sidebar-container [data-role="sidebar-toggle"], #sidebar-container #sidebar-toggle');
            if (!hasSidebar) {
              const ph = document.getElementById('sidebar-placeholder');
              if (ph) ph.outerHTML = html;
            } else if (!hasToggle) {
              sc.outerHTML = html;
            }
          })
          .catch(err => console.error('Sidebar fallback error (points-monitor):', err));
      });
    </script>

    <main class="main-content">
      <!-- Header -->
      <section>
        <div class="header-row">
          <div class="header-welcome">üèÜ Points & Rewards</div>
          <button id="theme-toggle-btn" aria-label="Toggle theme" class="header-theme-btn">
            <i id="theme-icon" class="fas fa-sun"></i>
          </button>
        </div>
      </section>

      <!-- Cards: Summary & Search -->
      <section class="cards">
        <div class="card">
          <h2>Summary</h2>
          <div class="row">
            <label>Dari: <input type="date" id="from-date"></label>
            <label>Sampai: <input type="date" id="to-date"></label>
            <button id="load-summary" class="btn">Load</button>
            <button id="export-csv" class="btn"><i class="fas fa-file-csv" style="margin-right:6px"></i>Export CSV</button>
          </div>
          <p id="global-total" class="muted" style="margin: 4px 0 0 0;"></p>
        </div>
        <div class="card">
          <h2>Find User</h2>
          <div class="row">
            <input type="text" id="uid-input" placeholder="uid" style="flex:1; min-width:180px" />
            <button id="search-user" class="btn"><i class="fas fa-search" style="margin-right:6px"></i>Cari</button>
          </div>
          <div id="user-result" class="muted" style="margin-top:10px"></div>
        </div>
      </section>

      <!-- Table: Per-course breakdown -->
      <section>
        <div class="table-card">
          <h2>Breakdown by Course</h2>
          <table id="summary-table">
            <thead><tr><th>course_id</th><th>total_points</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script>
  // ===== Theme toggle (match other mod pages) =====
  function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme') || 'light';
    const next = current === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
    updateThemeIcon();
    const sidebar = document.getElementById('sidebar-container');
    if (sidebar) {
      if (next === 'dark') sidebar.classList.add('dark-theme');
      else sidebar.classList.remove('dark-theme');
    }
  }
  function updateThemeIcon() {
    const icon = document.getElementById('theme-icon');
    if (!icon) return;
    const current = document.documentElement.getAttribute('data-theme') || 'light';
    icon.className = current === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
  }
  document.addEventListener('DOMContentLoaded', () => {
    const currentTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', currentTheme);
    updateThemeIcon();
    document.getElementById('theme-toggle-btn').addEventListener('click', toggleTheme);
    if (currentTheme === 'dark') document.getElementById('sidebar-container')?.classList.add('dark-theme');
  });

  // ===== Existing app logic (preserved) =====
  let lastSummary = null;
  let lastUser = null;

  async function authFetch(url, options = {}) {
    // 1) Prefer parent.authFetch if present and not this function
    if (typeof window !== 'undefined' && window.parent && window.parent !== window) {
      const paf = window.parent.authFetch;
      if (typeof paf === 'function' && paf !== authFetch) {
        return paf(url, options);
      }
    }
    // 2) Try token from parent Firebase (same-origin)
    try {
      if (window.parent && window.parent !== window && window.parent.firebase?.auth) {
        const cu = window.parent.firebase.auth().currentUser;
        if (cu) {
          const token = await cu.getIdToken(true);
          const headers = Object.assign({}, options.headers || {}, { Authorization: 'Bearer ' + token });
          return fetch(url, Object.assign({}, options, { headers }));
        }
      }
    } catch(e) {
      console.warn('authFetch parent token failed:', e);
    }
    // 3) Try local Firebase token
    try {
      if (window.firebase?.auth && firebase.auth().currentUser) {
        const token = await firebase.auth().currentUser.getIdToken(true);
        const headers = Object.assign({}, options.headers || {}, { Authorization: 'Bearer ' + token });
        return fetch(url, Object.assign({}, options, { headers }));
      }
    } catch (e) {
      console.warn('authFetch token attach failed:', e);
    }
    // 4) Fallback: plain fetch (may 401)
    return fetch(url, options);
  }

  // set default tanggal = hari ini
  (function setDefaultDates(){ const t=new Date(); const iso=t.toISOString().slice(0,10); document.getElementById('from-date').value=iso; document.getElementById('to-date').value=iso; })();

  document.getElementById('load-summary').addEventListener('click', async () => {
    const from = document.getElementById('from-date').value;
    const to = document.getElementById('to-date').value;
    const res = await authFetch(`/api/mod/points/summary?from=${from}&to=${to}`);
    let data = {};
    try {
      data = await res.json();
    } catch(_) {
      const txt = await res.text().catch(()=> '');
      console.error('Invalid JSON from summary:', txt);
      alert('Gagal memuat summary (invalid response).');
      return;
    }
    lastSummary = data;
    document.getElementById('global-total').textContent = 'Total Poin Global: ' + (data.total_points || 0);
    const tbody = document.querySelector('#summary-table tbody');
    tbody.innerHTML = '';
    const courses = data.per_course || data.courses || {};
    Object.keys(courses).forEach(cid => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${cid}</td><td>${courses[cid]}</td>`;
      tbody.appendChild(tr);
    });
  });

  document.getElementById('search-user').addEventListener('click', async () => {
    const uid = document.getElementById('uid-input').value.trim();
    if (!uid) return;
    const res = await authFetch(`/api/mod/points/user/${encodeURIComponent(uid)}`);
    let data = {};
    try {
      data = await res.json();
    } catch(_) {
      const txt = await res.text().catch(()=> '');
      console.error('Invalid JSON from user lookup:', txt);
      alert('Gagal memuat data (invalid response).');
      return;
    }
    if (res.status === 403) { alert('Akses ditolak. Anda bukan moderator/admin.'); return; }
    if (!res.ok) { alert('Gagal memuat data.'); return; }
    lastUser = data;
    const wrap = document.getElementById('user-result');
    wrap.innerHTML = '';
    if (data && data.stats) {
      const u = data.stats;
      const courses = u.courses || {};
      let html = '<div class="mini-card">';
      html += '<div style="font-weight:700;margin-bottom:6px">' + (u.display_name || u.uid) + '</div>';
      html += '<div class="muted" style="margin-bottom:8px">Total: ' + (u.total_points || 0) + '</div>';
      html += '<ul style="margin:0;padding-left:18px">';
      Object.keys(courses).forEach(cid => { html += `<li>${cid}: ${courses[cid]}</li>`; });
      html += '</ul>';
      if (Array.isArray(data.logs)) {
        html += '<div style="font-weight:700;margin-top:10px">Log Terbaru</div><ul style="margin:6px 0 0 18px">';
        data.logs.slice(0,20).forEach(l => {
          const ts = l.claimed_at?.seconds ? new Date(l.claimed_at.seconds*1000) : new Date(l.claimed_at);
          html += `<li>${l.course_id}/${l.lesson_id} - ${l.points} (${ts.toLocaleDateString('id-ID')})</li>`;
        });
        html += '</ul>';
      }
      html += '</div>';
      // ensure visual container
      if (!wrap.closest('.card')) {
        wrap.classList.remove('muted');
      }
      wrap.innerHTML = html;
    }
  });

  document.getElementById('export-csv').addEventListener('click', () => {
    let csv = 'type,course_id,lesson_id,points,uid,claimed_at\n';
    if (lastSummary) {
      const courses = lastSummary.per_course || lastSummary.courses || {};
      Object.keys(courses).forEach(cid => { csv += `summary,${cid},,${courses[cid]},,,\n`; });
      csv += `summary_total,, ,${lastSummary.total_points},,,\n`;
    }
    if (lastUser && Array.isArray(lastUser.logs) && lastUser.stats) {
      lastUser.logs.forEach(l => {
        const date = l.claimed_at?.seconds ? new Date(l.claimed_at.seconds*1000).toISOString() : l.claimed_at;
        csv += `user_log,${l.course_id},${l.lesson_id},${l.points},${lastUser.stats.uid},${date}\n`;
      });
    }
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'points.csv'; a.click(); URL.revokeObjectURL(url);
  });
  </script>
</body>
</html>
