<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QC Face Consultant</title>
    <link href="https://fonts.googleapis.com/css2?family=Forum&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
    :root{
      --bg:#0f2b29;
      --glass:#0b2a27cc;
      --glass-strong:#0b2a27f0;
      --neon:#7CFF7C;
      --neon2:#00F5D4;
      --accent:#FFB703;
      --danger:#ff6b6b;
      --soft:#e0e0e0;
      --orb-left: 50%;
      --orb-top: 48%;
    }
    /* Animated aurora background */
    body::before, body::after{
      content:"";
      position:fixed; inset:-25vh -25vw; /* extend beyond edges to avoid lines */
      background: radial-gradient(60% 40% at 10% 15%, rgba(0,255,200,.12), transparent 60%),
                  radial-gradient(40% 35% at 85% 80%, rgba(100,255,0,.10), transparent 60%),
                  radial-gradient(50% 50% at 50% 50%, rgba(0,160,255,.08), transparent 70%);
      filter: blur(40px);
      animation: drift 18s ease-in-out infinite alternate;
      pointer-events: none;
      z-index: -2;
    }
    body::after{ animation-duration: 28s; transform: scaleX(-1); }
    @keyframes drift{
      0%{ transform: translateY(-2%) scale(1.05);}
      100%{ transform: translateY(2%) scale(0.98);}
    }
    .glass{
      background: var(--glass);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 10px 30px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.05) inset;
      border-radius: 18px;
    }
    .neon{
      text-shadow: 0 0 12px var(--neon), 0 0 24px color-mix(in oklab, var(--neon), #000 60%);
    }
    .ring-glow{
      box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset, 0 0 40px rgba(124,255,124,.28), 0 10px 30px rgba(0,0,0,.4);
    }
    .btn{
      background: linear-gradient(135deg, var(--neon2), var(--neon));
      color:#052a27; font-weight:700; letter-spacing:.3px;
      border:none; border-radius:14px; padding:14px 22px; cursor:pointer;
      box-shadow: 0 10px 24px rgba(0, 255, 200, .25);
      transition: transform .18s ease, box-shadow .18s ease, opacity .2s ease;
    }
    .btn:hover{ transform: translateY(-2px); box-shadow:0 14px 28px rgba(0, 255, 200, .35);}
    .btn.secondary{
      background: linear-gradient(135deg, #243f3d, #0f2b29);
      color:#d7fff1; border:1px solid rgba(124,255,124,.25);
    }
    .btn.danger{ background: linear-gradient(135deg, #ff6b6b, #ff9f7b); color:#fff;}
    /* HUD */
    .hud{
      position:fixed; top:14px; left:14px; right:14px; display:flex; align-items:center; justify-content:space-between; z-index:999;
    }
    .brand{
      display:flex; align-items:center; gap:10px; padding:10px 14px; border-radius:14px;
      color:#d9fff3; font-weight:700; letter-spacing:.6px; text-transform:uppercase;
      background: linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
    }
    .brand .dot{ width:10px; height:10px; border-radius:50%; background:var(--neon); box-shadow:0 0 12px var(--neon);}
    .clock{
      color:#eafffb; font-weight:700; font-size:1.2rem; padding:10px 14px; border-radius:14px;
      background: linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); letter-spacing:.5px;
    }
    .hud-right{ display:flex; align-items:center; gap:8px; }
    .hidden-block{ display:none !important; }
    /* Camera / Mirror area */
    #camera-wrapper{
      position: relative;
      width: 520px; max-width: 92%;
      border-radius: 24px; overflow: hidden;
      background: #021614;
      border:1px solid rgba(255,255,255,.08);
    }
    #camera-wrapper.mirrored video,
    #camera-wrapper.mirrored img#camera-placeholder{ transform: scaleX(-1); }
    #camera-wrapper::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(124,255,124,.06), transparent 40%, transparent 60%, rgba(0,245,212,.06)),
                  repeating-linear-gradient( to bottom, rgba(255,255,255,.06), rgba(255,255,255,.06) 1px, transparent 2px, transparent 4px);
      mix-blend-mode: screen; pointer-events:none;
    }
    /* Controls dock */
    .controls{
      position: fixed; left: 50%; bottom: 56px; transform: translateX(-50%);
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:center;
      margin:0; z-index: 4;
    }
    /* Controls dock toggle */
    .controls-toggle{
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      z-index: 5; width: 34px; height: 34px; border-radius: 999px;
      border:1px solid rgba(233,196,106,.35);
      background: linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      color:#eafbf6; display:grid; place-items:center; cursor:pointer;
      box-shadow:0 8px 22px rgba(0,0,0,.35);
    }
    .blackout-exit{
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 1px solid rgba(233,196,106,.45);
      background: linear-gradient(135deg, rgba(255,255,255,.18), rgba(255,255,255,.04));
      color:#fdf8e6;
      display:grid;
      place-items:center;
      font-size:1.05rem;
      cursor:pointer;
      box-shadow:0 10px 26px rgba(0,0,0,.45);
      opacity:0;
      pointer-events:none;
      transition: opacity .25s ease, transform .25s ease;
      z-index:10000;
    }
    .blackout-exit:hover{ transform: translateY(-2px); }
    .blackout-exit:focus-visible{ outline:2px solid var(--accent); outline-offset:3px; }
    .blackout-exit.is-visible{
      opacity:1;
      pointer-events:auto;
    }
    body.manual-blackout .blackout-exit{
      opacity:1;
      pointer-events:auto;
    }
    .manual-blackout-hidden{
      display:none !important;
    }
    .controls.hidden{ opacity:0; pointer-events:none; transform: translate(-50%, 12px); }
    .controls{ transition: opacity .22s ease, transform .22s ease; }
    body.idle-blackout .controls-toggle{ opacity:0; pointer-events:none; }
    @media (max-width: 768px){
      .controls{ bottom: 64px; gap:8px; }
      .controls .btn{ padding:12px 18px; font-size:.95rem; }
    }
    /* Hide controls during idle */
    body.idle-blackout .controls{ opacity:0 !important; pointer-events:none !important; }
    .caption{
      color:#cffff0; font-size:.95rem; opacity:.9;
    }
/* === Pin caption to bottom of viewport === */
.caption{
  position: fixed;
  left: 50%; bottom: 12px; transform: translateX(-50%);
  margin: 0 !important; padding: 6px 10px; border-radius: 10px;
  background: linear-gradient(180deg, rgba(10,40,37,.65), rgba(10,40,37,.35));
  border: 1px solid rgba(233,196,106,.25);
  box-shadow: 0 8px 24px rgba(0,0,0,.35);
  z-index: 3; pointer-events: none; /* don’t block clicks */
}
@media (max-width: 768px){ .caption{ bottom: 8px; font-size: .9rem; } }
/* Hide caption during idle */
body.idle-blackout .caption{ opacity: 0 !important; }

/* Inline caption variant (not fixed to viewport) */
.caption-inline{
  color:#cffff0; font-size:.95rem; opacity:.9;
  position: static; left:auto; bottom:auto; transform:none;
  margin-top:8px; padding:0; background:transparent; border:none; box-shadow:none;
}
/* App suggestion responsive */
#app-suggest .btn{ padding:10px 16px; }
@media (max-width: 480px){
  #app-suggest{ padding:10px; }
}
    /* Main container refinement */
    #container{
      gap: 16px;
    }
    /* Greeting card restyle */
    #greetings .shell{
      display:flex; flex-direction:row; align-items:center; justify-content:space-between; gap:40px; flex-wrap:wrap;
    }
    #greetings .shell.glass{ background: var(--glass-strong); }
    #greetings h1{ font-size: 2.6rem; color: #caffea; margin:0 0 12px; font-family:'Forum', cursive; }
    #greetings p{ color:#d9fff3; }
    /* Recommendation panel glass look */
    #recommendation{
      background: linear-gradient(180deg, rgba(10,40,37,.92), rgba(10,40,37,.86));
      border:1px solid rgba(255,255,255,.08);
      color:#eafffb;
    }
    #recommendation h2{ color: var(--accent); }
    /* Footer lightbox small improvements */
    #lightbox{ backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    /* Make fonts larger for mirror readability */
    body{ font-size: 17px; color:#eafaf6; }
    #status{ color: var(--neon); }

    .navbar-menu.open {
        display: flex;
    }
    html, body {
        height: 100%;
        margin: 0;
        background: radial-gradient(1200px 600px at 50% -10%, #133d39 0%, #0f2b29 60%, #0a1f1d 100%);
        background-repeat: no-repeat;
        background-attachment: fixed; /* prevent seam when fullscreen */
        font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        overflow-y: auto;
        color: #333;
    }


    #container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 30px;
        gap: 16px;
    }

        h1 {
            color: #00b4d8;
            margin-bottom: 20px;
        }

        #status {
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 600;
            color: #06d6a0;
            text-shadow: 0 0 6px #06d6a080;
        }

        #photo {
            width: 280px;
            height: auto;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            background: #fff;
            padding: 10px;
        }

        #recommendation {
            max-width: 85%;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            color: #333;
            display: none;
        }

        #recommendation h2 {
            color: #ff6b6b;
            margin-bottom: 10px;
        }

        #capture-button {
            background: linear-gradient(to right, #00b4d8, #0077b6);
            color: white;
            border: none;
            padding: 16px 36px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0, 119, 182, 0.4);
            transition: all 0.3s ease;
        }

        #capture-button:hover {
            background: #0096c7;
            box-shadow: 0 10px 25px rgba(0, 119, 182, 0.5);
            transform: translateY(-3px);
        }

        #gallery {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 30px;
            margin-bottom: 40px;
            gap: 15px;
        }

        #gallery img {
            width: 120px;
            height: auto;
            border-radius: 12px;
            background: #ffffffcc;
            padding: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease;
        }

        #gallery img:hover {
            transform: scale(1.05);
        }
        .loading {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #00ff99;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin-top: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Mini spinner for WA button */
        .mini-spinner{
          width:16px; height:16px; border:2px solid rgba(255,255,255,.55);
          border-top-color: transparent; border-radius:50%;
          display:inline-block; margin-right:8px; vertical-align:-3px;
          animation: spin 0.9s linear infinite;
        }
        .fade-in {
            animation: fadeIn 1s ease forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in-stagger {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInStagger 0.6s ease-out forwards;
        }

        @keyframes fadeInStagger {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            #photo {
                width: 90%;
            }
            #gallery img {
                width: 90px;
                margin: 8px;
            }
            #capture-button {
                padding: 14px 28px;
                font-size: 1.1rem;
            }
        }

        .gallery-card {
            background: #ffffffcc;
            padding: 10px;
            margin: 8px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .gallery-card:hover {
            transform: scale(1.08);
            box-shadow: 0 8px 25px rgba(0, 180, 216, 0.6);
            background: #f0faff;
        }

        .gallery-card img {
            width: 120px;
            height: auto;
            border-radius: 12px;
            display: block;
            transition: transform 0.3s ease;
        }

        .gallery-card.is-active {
            outline: 2px solid var(--accent);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.12), 0 16px 32px rgba(0, 0, 0, 0.45);
            transform: translateY(-6px);
        }

        .gallery-card.is-active img {
            transform: scale(1.05);
        }

        /* === Hair Color Panel (UI block for hair recolor controls) === */
        #hair-color-panel {
            display: none;
            margin-top: 16px;
            padding: 18px;
            gap: 14px;
            color: #eafbf6;
        }

        #hair-color-panel .hair-panel-top {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            gap: 18px;
        }

        #hair-color-panel .hair-panel-heading {
            flex: 1 1 220px;
        }

        #hair-color-panel .hair-title {
            font-weight: 700;
            font-size: 1.15rem;
            color: var(--accent);
            margin-bottom: 4px;
        }

        #hair-color-panel .hair-status {
            font-size: 0.86rem;
            opacity: 0.85;
            color: #cffff0;
            transition: color 0.2s ease;
        }

        #hair-color-panel .hair-status[data-state="busy"] {
            color: #ffdd57;
        }

        #hair-color-panel .hair-status[data-state="error"] {
            color: var(--danger);
        }

        #hair-color-panel .hair-preview-wrap {
            flex: 0 0 auto;
        }

        #hair-preview {
            display: none;
            width: 180px;
            max-width: 100%;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        #hair-color-panel .hair-swatches {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 14px;
        }

        .hair-color-swatch {
            width: 46px;
            height: 46px;
            border-radius: 14px;
            border: 2px solid rgba(255, 255, 255, 0.16);
            cursor: pointer;
            position: relative;
            transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
            background-size: cover;
        }

        .hair-color-swatch::after {
            content: attr(data-label);
            position: absolute;
            left: 50%;
            top: calc(100% + 6px);
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: #eafbf6;
            white-space: nowrap;
            pointer-events: none;
        }

        .hair-color-swatch.is-active {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.25), 0 12px 24px rgba(0, 0, 0, 0.45);
            transform: translateY(-3px);
        }

        #hair-color-panel .hair-controls {
            display: flex;
            flex-direction: column;
            gap: 14px;
            margin-top: 12px;
        }

        #hair-color-panel .hair-strength {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        #hair-color-panel .hair-strength label {
            font-size: 0.9rem;
            color: #cffff0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #hair-strength {
            width: 100%;
            accent-color: var(--accent);
        }

        #hair-color-panel .hair-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        #hair-color-panel button.hair-custom-btn {
            padding: 10px 16px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.06));
            color: #f4fff8;
            border: 1px solid rgba(255, 255, 255, 0.18);
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        #hair-color-panel button.hair-custom-btn:hover {
            transform: translateY(-1px);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.18), rgba(255, 255, 255, 0.1));
        }

        #hair-color-panel button.hair-custom-btn.is-active {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.25), 0 12px 24px rgba(0, 0, 0, 0.45);
        }

        #hair-color-panel.is-busy {
            opacity: 0.72;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            #hair-color-panel .hair-panel-top {
                flex-direction: column;
                align-items: stretch;
            }

            #hair-preview {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }
            #status {
                font-size: 1rem;
            }
            #capture-button {
                width: 80%;
                font-size: 1rem;
                padding: 14px;
            }
            #gallery {
                gap: 8px;
            }
        }

        header nav a:hover {
            color: #ffdd57;
        }

        header {
            position: sticky;
            top: 0;
            z-index: 999;
        }

        header nav a {
            scroll-behavior: smooth;
        }
    /* === AI Avatar Orb === */
    /* Motion wrapper to allow eye-follow without fighting the inner animations */
    #ai-avatar { --tx: 0px; --ty: 0px; }
    #ai-avatar .orb-motion{
      width:100%; height:100%;
      transform: translate(var(--tx), var(--ty));
      transition: transform 120ms ease-out;
    }
    /* Lock orb perfectly at center (no drift/eye-follow) */
    #ai-avatar.lock-center .orb-motion{ transform: translate(0,0) !important; }
    #ai-avatar.lock-center .orb-wrap{ animation: none !important; }
    /* Disable any motion when user is dragging the orb */
    #ai-avatar.dragging .orb-motion{ transition: none !important; transform: translate(var(--tx), var(--ty)) !important; }
    #ai-avatar.dragging .orb-wrap{ animation: none !important; }
    #ai-avatar{
      --intensity: .4; /* default glow/volume strength */
      position: fixed;
      left: var(--orb-left);
      top: var(--orb-top);
      right: auto;
      bottom: auto;
      transform: translate(-50%, -50%);
      z-index: 998;
      width: 160px; height: 160px; pointer-events: auto; cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: none; /* enable smooth drag on touch */
    }
    /* Ensure inner elements don't steal events */
    #ai-avatar *{ pointer-events: none; }
    @media (max-width: 768px){ #ai-avatar{ width:120px; height:120px; right:14px; bottom:18px; } }
    #ai-avatar .orb-wrap{
      position:relative; width:100%; height:100%;
      filter: drop-shadow(0 12px 28px rgba(0,0,0,.5))
              drop-shadow(0 0 calc(12px + 30px * var(--intensity)) rgba(124,255,124,.25));
    }
    #ai-avatar .halo{
      position:absolute; inset:-12%; border-radius:50%;
      background: conic-gradient(from 0deg, rgba(124,255,124,.0), rgba(124,255,124,.35), rgba(0,245,212,.35), rgba(124,255,124,.0));
      animation: spin 10s linear infinite;
      filter: blur(8px) saturate(1.2);
    }
    #ai-avatar .core{
      position:absolute; inset:0; border-radius:50%; overflow:hidden;
      background: radial-gradient(circle at 50% 52%, rgba(124,255,124,.6), rgba(0,245,212,.4) 35%, rgba(10,40,37,.8) 62%, rgba(5,22,20,1) 80%);
      box-shadow: inset 0 0 calc(40px + 40px * var(--intensity)) rgba(124,255,124,.35),
                  inset 0 0 calc(80px + 60px * var(--intensity)) rgba(0,245,212,.25);
      animation: breathe 3.2s ease-in-out infinite;
    }
    /* === Orb live cam embed === */
    #ai-avatar .core #orb-cam,
    #ai-avatar .core #orb-placeholder{
      position:absolute; inset:0;
      width:100%; height:100%;
      border-radius:50%;
      object-fit: cover;
      display:block;
    }
    /* Make orb-cam video crystal clear, no overlay/grid/hologram */
    #ai-avatar .core #orb-cam{
      filter: none !important;
      mix-blend-mode: normal !important;
      background: none !important;
    }
    /* Mirrored orb-cam if #ai-avatar has .mirrored */
    #ai-avatar.mirrored .core #orb-cam {
      transform: scaleX(-1);
    }
    /* show video when camera on; otherwise show placeholder */
    #ai-avatar .core #orb-cam{ display:none; }
    body.camera-on #ai-avatar .core #orb-cam{ display:block; }
    body.camera-on #ai-avatar .core #orb-placeholder{ display:none; }
    /* hide hologram texture when live cam active */
    body.camera-on #ai-avatar .holo-head{ display:none; }

    /* Hide main camera video when camera is on (leave only orb) */
    body.camera-on #camera-wrapper{ display: none !important; }
    /* === Orb: Hologram Head texture (ultra‑luxe) === */
    #ai-avatar .holo-head{
      position:absolute; inset:8%;
      background: url('/holo-head.png') center/contain no-repeat;
      mix-blend-mode: screen; opacity:.95;
      filter: hue-rotate(160deg) saturate(1.25) brightness(1.15) contrast(1.05);
      transform: translate(calc(var(--tx, 0px) * .35), calc(var(--ty, 0px) * .35));
      will-change: transform, opacity;
      animation: headBreathe 6s ease-in-out infinite;
    }
    #ai-avatar .holo-head::before{
      content:""; position:absolute; inset:-2%; pointer-events:none;
      background:
        repeating-linear-gradient(to bottom, rgba(124,255,178,.10) 0 1px, transparent 1px 3px),
        radial-gradient(120% 100% at 50% 10%, rgba(124,255,178,.18), transparent 60%);
      mix-blend-mode: screen; opacity:.45;
      animation: scanY 7s linear infinite;
    }
    #ai-avatar .holo-head::after{
      content:""; position:absolute; inset:-8%; pointer-events:none;
      background: linear-gradient(115deg, transparent 35%, rgba(124,255,178,.28) 50%, transparent 65%);
      background-size: 220% 220%;
      mix-blend-mode: screen; opacity:.35;
      animation: sweep 4.8s ease-in-out infinite;
    }
    @keyframes headBreathe{ 0%,100%{ filter: hue-rotate(160deg) saturate(1.2) brightness(1.08); } 50%{ filter: hue-rotate(160deg) saturate(1.35) brightness(1.18);} }
    @keyframes scanY{ 0%{ transform: translateY(0); } 100%{ transform: translateY(-10%);} }
    @keyframes sweep{ 0%,100%{ background-position: 120% 0; } 50%{ background-position: -20% 100%; } }

    @media (prefers-reduced-motion: reduce){
      #ai-avatar .holo-head, #ai-avatar .holo-head::before, #ai-avatar .holo-head::after{ animation: none !important; }
    }
    #ai-avatar .noise{
      position:absolute; inset:-10%; filter: contrast(140%) brightness(130%);
      mix-blend-mode: screen; opacity:.55; pointer-events:none;
      /* Mask the SVG noise into a perfect circle so no more square */
      -webkit-mask: radial-gradient(circle at 50% 50%, #000 64%, transparent 66%);
      mask: radial-gradient(circle at 50% 50%, #000 64%, transparent 66%);
      animation: rotateNoise 22s linear infinite;
    }
    @keyframes rotateNoise { to{ transform: rotate(360deg);} }
    /* Emissive pulse rings */
    #ai-avatar .pulse{
      position:absolute; inset:10%; border-radius:50%;
      border: 2px dashed rgba(0,245,212,.55);
      box-shadow: 0 0 18px rgba(0,245,212,.25) inset;
      animation: ripple 3.6s ease-in-out infinite;
      pointer-events:none;
    }
    #ai-avatar .pulse::after{
      content:""; position:absolute; inset:-6%; border-radius:50%;
      border: 1px solid rgba(124,255,124,.5);
    }
    #ai-avatar .pulse2{ inset:22%; border-style: solid; border-width: 1.5px; opacity:.7; animation-duration: 4.4s; }
    #ai-avatar.thinking .pulse{ animation-duration: 1.8s; }
    #ai-avatar.thinking .pulse2{ animation-duration: 2.2s; }
    @keyframes ripple{
      0%,100%{ transform: scale(0.95); opacity:.7; }
      50%{ transform: scale(1.05); opacity:1; }
    }
    /* Spiral lines */
    #ai-avatar svg.spiral{ position:absolute; inset:0; }
    #ai-avatar .spiral-path{ stroke: rgba(124,255,124,.7); stroke-width: 1.5; fill: none; stroke-linecap: round; }
    #ai-avatar .spiral-path.alt{ stroke: rgba(0,245,212,.65); stroke-dasharray: 3 6; }
    /* Thinking state intensifies */
    #ai-avatar.thinking .core{ animation-duration: 1.6s; box-shadow: inset 0 0 60px rgba(124,255,124,.55), inset 0 0 120px rgba(0,245,212,.45), 0 0 34px rgba(124,255,124,.25);} 
    #ai-avatar.thinking .halo{ animation-duration: 4s; filter: blur(10px) saturate(1.5); }
    #ai-avatar.thinking .spiral-path{ stroke-width: 2.2; }
    /* Wandering movement */
    #ai-avatar .orb-wrap{ animation: driftXY 14s ease-in-out infinite alternate; }
    #ai-avatar.thinking .orb-wrap{ animation-duration: 7s; }
    /* Keyframes */
    @keyframes breathe{ 0%,100%{ transform: scale(0.98);} 50%{ transform: scale(1.03);} }
    @keyframes spin{ to{ transform: rotate(360deg);} }
    @keyframes driftXY{ 0%{ transform: translate3d(0,0,0) rotate(0deg);}  50%{ transform: translate3d(-6px,-4px,0) rotate(1deg);} 100%{ transform: translate3d(4px,6px,0) rotate(-1deg);} }

      /* === AI Chat Panel === */
  #ai-chat{ position:fixed; right:22px; bottom:200px; width:320px; max-height:60vh; z-index:999; display:none; }
  #ai-chat .chat-wrap{ border-radius:16px; overflow:hidden; }
  #ai-chat .chat-box{ background: var(--glass-strong); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border:1px solid rgba(255,255,255,.08); box-shadow: 0 10px 30px rgba(0,0,0,.35); display:flex; flex-direction:column; height:100%; }
  #ai-chat .msgs{ padding:12px; display:flex; flex-direction:column; gap:10px; max-height:40vh; overflow:auto; }
  #ai-chat .msg{ padding:10px 12px; border-radius:12px; line-height:1.4; font-size:.95rem; color:#eafffb; width:fit-content; max-width:85%; box-shadow:0 2px 10px rgba(0,0,0,.25); }
  #ai-chat .msg.user{ margin-left:auto; background: linear-gradient(135deg, #1f514a, #0f2b29); border:1px solid rgba(124,255,124,.25); }
  #ai-chat .msg.bot{ background: linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.04)); border:1px solid rgba(255,255,255,.08); }
  #ai-chat .composer{ display:flex; gap:8px; padding:10px; border-top:1px solid rgba(255,255,255,.08); }
  #ai-chat input[type="text"]{ flex:1; background: rgba(255,255,255,.1); color:#eafffb; border:1px solid rgba(255,255,255,.18); border-radius:10px; padding:10px 12px; outline:none; }
  #ai-chat button.send{ padding:10px 14px; border-radius:10px; border:1px solid rgba(124,255,124,.3); background: linear-gradient(135deg, var(--neon2), var(--neon)); color:#062b28; font-weight:700; cursor:pointer; }
  #ai-chat .header{ display:flex; align-items:center; justify-content:space-between; padding:8px 12px; background: rgba(0,0,0,.25); border-bottom:1px solid rgba(255,255,255,.08); color:#d9fff3; font-weight:700; }
  #ai-chat .close{ background:transparent; border:none; color:#d9fff3; font-weight:700; cursor:pointer; }
  @media (max-width: 768px){ #ai-chat{ right:14px; width:80vw; bottom:160px; } }

  /* === Voice input styles === */
  /* === Chat open state (robust toggle) === */
  body.chat-open #ai-chat{ display:block !important; }
  body.chat-open #ai-avatar{ --tx:0px; --ty:0px; }
  body.chat-open #ai-avatar .orb-motion{ transform: translate(0,0) !important; transition: none !important; }
  body.chat-open #ai-avatar .orb-wrap{ animation: none !important; }
  #ai-chat button.mic{ padding:10px 12px; border-radius:10px; border:1px solid rgba(124,255,124,.3); background: linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.06)); color:#eafffb; font-weight:700; cursor:pointer; }
  #ai-chat button.mic.listening{ background: linear-gradient(135deg, #ff7b7b, #ffb3a3); color:#1b1b1b; box-shadow:0 0 18px rgba(255,120,120,.5); }
  /* Orb listening visuals */
  #ai-avatar.listening .halo{ animation-duration: 3s; filter: blur(12px) saturate(1.6); }
  #ai-avatar.listening .pulse{ border-color: rgba(255,120,120,.7); }
  #ai-avatar.listening .pulse2{ border-color: rgba(255,180,160,.8); }

    /* === Idle Blackout Mode === */
  body, #container, #navbar, #footer-placeholder, .hud, #lightbox, #greetings, #recommendation, #gallery, #camera-wrapper, .controls, .caption {
    transition: opacity .6s ease, filter .6s ease;
  }
  body.idle-blackout {
    background: #000 !important;
  }
  body.idle-blackout::before,
  body.idle-blackout::after {
    opacity: 0 !important;
    transition: opacity .6s ease;
  }
  body.idle-blackout .hud,
  body.idle-blackout #navbar,
  body.idle-blackout #footer-placeholder,
  body.idle-blackout #container,
  body.idle-blackout #lightbox,
  body.idle-blackout #greetings {
    opacity: 0 !important;
    pointer-events: none !important;
  }
  body.manual-blackout {
    background: #000 !important;
  }
  body.manual-blackout::before,
  body.manual-blackout::after {
    opacity: 0 !important;
  }
  body.manual-blackout #ai-avatar {
    display: none !important;
  }
  body.manual-blackout #holo-embed {
    opacity: 0 !important;
    pointer-events: none !important;
  }
  body.manual-blackout .mm-ui,
  body.manual-blackout .hud,
  body.manual-blackout #navbar,
  body.manual-blackout #footer-placeholder,
  body.manual-blackout #lightbox,
  body.manual-blackout #vc-toast,
  body.manual-blackout #ai-chat,
  body.manual-blackout #lux-particles,
  body.manual-blackout #controls-toggle,
  body.manual-blackout #vc-toggle {
    opacity: 0 !important;
    pointer-events: none !important;
  }
  /* Keep only orb visible and centered with gentle patrol */
  body.idle-blackout #ai-avatar {
    --tx: 0px; --ty: 0px; /* neutralize eye-follow while idle */
    left: 50% !important; top: 50% !important; right: auto !important; bottom: auto !important;
    transform: translate(-50%, -50%);
    z-index: 9999;
  }
  body.idle-blackout #ai-avatar .orb-motion {
    animation: centerWander 8s ease-in-out infinite alternate;
  }
  @keyframes centerWander {
    0%   { transform: translate(-12px, -8px); }
    50%  { transform: translate(14px, 10px); }
    100% { transform: translate(-6px, 12px); }
  }



/* === Premium theme overrides — high‑tech, elegant (non‑destructive) === */
:root{
  --bg:#0a1918;            /* deeper obsidian teal */
  --glass:#0a2321cc;       /* darker glass */
  --glass-strong:#0a2321f2;
  --neon:#7CFFB2;          /* cooler mint neon */
  --neon2:#36E1C6;         /* cyan‑mint blend */
  --accent:#E9C46A;        /* champagne gold */
  --accent-soft:#f3e5ab80; /* soft gold for lines */
  --ink:#dff9f3;           /* premium text */
}

/* Deeper vignette + subtle scanlines for high‑tech vibe */
html, body{
  background:
    radial-gradient(1200px 520px at 50% -12%, #133a35 0%, #0f2523 52%, #081514 100%),
    radial-gradient(600px 260px at 8% 10%, rgba(54,225,198,.08), transparent 65%),
    radial-gradient(800px 320px at 92% 88%, rgba(124,255,178,.06), transparent 70%);
  color: var(--ink);
}
/* Aurora brightness a bit calmer (premium feel) */
body::before, body::after{ filter: blur(48px) saturate(1.05) brightness(.95); opacity:.85; }

/* Diamond‑cut glass cards */
.glass{
  background: linear-gradient(180deg, var(--glass) 0%, color-mix(in oklab, var(--glass), #000 6%) 100%) padding-box,
              linear-gradient(135deg, rgba(255,255,255,.16), rgba(255,255,255,.02)) border-box;
  border: 1px solid transparent;
  box-shadow: 0 14px 38px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.05) inset,
              0 1px 0 rgba(255,255,255,.06) inset, 0 -1px 0 rgba(0,0,0,.35) inset;
}

/* Premium heading & text tone */
h1{ color:#dff9f3; letter-spacing:.6px; text-shadow:0 0 24px rgba(54,225,198,.18); }
#status{ color: var(--neon); text-shadow:0 0 10px color-mix(in oklab, var(--neon), #000 70%); }

/* Camera frame: chamfer glow + gradient stroke */
#camera-wrapper{
  background: #021614;
  box-shadow: 0 18px 50px rgba(0,0,0,.55), 0 0 0 1px rgba(255,255,255,.06) inset;
  border-radius: 26px;
  border: 1px solid transparent;
  background-image:
    linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0)) ,
    radial-gradient(120% 120% at 0% 0%, rgba(233,196,106,.22), rgba(54,225,198,.14), rgba(0,0,0,0));
  background-origin: border-box;
  background-clip: padding-box, border-box;
}
#camera-wrapper::after{ mix-blend-mode: screen; opacity:.75; }

/* Buttons: pill with subtle gloss and micro‑interaction */
.btn{
  border-radius: 999px;
  padding: 14px 24px;
  box-shadow: 0 10px 28px rgba(54,225,198,.25), 0 2px 0 rgba(255,255,255,.08) inset;
  position: relative; overflow: hidden;
}
.btn::before{
  content:""; position:absolute; inset:0; pointer-events:none;
  background: linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,0));
  opacity:.25;
}
.btn:hover{ transform: translateY(-2px) scale(1.01); box-shadow:0 16px 32px rgba(54,225,198,.32); }
.btn.secondary{ background: linear-gradient(180deg, #163532, #0a2321); color:#dff9f3; border:1px solid rgba(124,255,178,.22); }

/* HUD brand: understated gold tick and cleaner tone */
.brand{ color:#eafbf6; border:1px solid rgba(255,255,255,.10); }
.brand .dot{ background: var(--accent); box-shadow:0 0 10px var(--accent); }
.clock{ color:#eafbf6; border:1px solid rgba(255,255,255,.10); }

/* Recommendation panel: premium stripe and typography */
#recommendation{
  background: linear-gradient(180deg, rgba(8,33,31,.92), rgba(8,33,31,.86)) padding-box,
              linear-gradient(90deg, rgba(233,196,106,.45), rgba(54,225,198,.35)) border-box;
  border: 1px solid transparent; border-radius: 18px;
}
#recommendation h2{ color: var(--accent); letter-spacing:.3px; text-shadow:0 0 18px rgba(233,196,106,.25); }
#rec-content{ color:#eafbf6; }

/* Chat panel polish */
#ai-chat .chat-box{ box-shadow: 0 14px 38px rgba(0,0,0,.5); }
#ai-chat .msg.bot{ background: linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); }
#ai-chat .msg.user{ background: linear-gradient(135deg, #173e39, #0a2321); }

/* Lightbox polish */
#lightbox{ background: radial-gradient(1200px 520px at 50% 50%, rgba(0,0,0,.72), rgba(0,0,0,.85)); }
#lightbox img{ box-shadow: 0 18px 60px rgba(0,0,0,.6), 0 0 0 1px rgba(255,255,255,.08) inset; }

/* Finer transitions for overall UI */
*{ transition: background-color .28s ease, color .28s ease, box-shadow .28s ease, border-color .28s ease; }

html, body{
  background:
    radial-gradient(1600px 720px at 50% -15%, #112c2a 0%, #0a1918 60%, #050c0b 100%),
    linear-gradient(135deg, rgba(233,196,106,.05) 0%, rgba(54,225,198,.05) 100%);
}
body::before, body::after{
  filter: blur(60px) saturate(1.2) brightness(.9);
  opacity: .95;
}

/* Micro‑grid & parallax lines */
body::after{
  background-image:
    repeating-linear-gradient(0deg, rgba(255,255,255,.04) 0, transparent 2px),
    repeating-linear-gradient(90deg, rgba(255,255,255,.04) 0, transparent 2px);
  mask: linear-gradient(to bottom, rgba(0,0,0,.6), transparent);
  -webkit-mask: linear-gradient(to bottom, rgba(0,0,0,.6), transparent);
  animation: gridShift 40s linear infinite;
}
@keyframes gridShift{ to{ transform: translateY(40px); } }

/* Glass ultra‑cut */
.glass{
  border-radius: 22px;
  border: 1px solid rgba(233,196,106,.25);
  box-shadow: 0 18px 48px rgba(0,0,0,.55),
              0 0 0 1px rgba(255,255,255,.08) inset,
              0 1px 0 rgba(255,255,255,.12) inset,
              0 -1px 0 rgba(0,0,0,.5) inset;
}

/* Golden glow headings */
h1{
  background: linear-gradient(90deg, #e9c46a, #7cffb2);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 0 0 20px rgba(233,196,106,.35);
}

/* Luxury buttons */
.btn{
  background: linear-gradient(135deg, #36e1c6, #7cffb2);
  border:1px solid rgba(233,196,106,.3);
}
.btn.secondary{
  background: linear-gradient(135deg, #102724, #0a1918);
  border:1px solid rgba(233,196,106,.25);
}
.btn:hover{ filter: brightness(1.1); }

/* Recommendation ultra stripe */
#recommendation{
  border:1px solid rgba(233,196,106,.35);
  background: linear-gradient(180deg, rgba(8,33,31,.95), rgba(8,33,31,.9)) padding-box,
              linear-gradient(90deg, rgba(233,196,106,.35), rgba(54,225,198,.25)) border-box;
  box-shadow: 0 16px 44px rgba(0,0,0,.55);
}

/* === Ultra‑Luxe: Particle Shimmer (gold dust) === */
#lux-particles{ position:fixed; inset:0; pointer-events:none; z-index: 1; opacity:.65; transition: opacity .4s ease; }
.idle-blackout #lux-particles{ opacity:0; }
#lux-particles .p{ position:absolute; width:6px; height:6px; border-radius:50%;
  background: radial-gradient(circle, rgba(233,196,106,.95) 0%, rgba(233,196,106,.5) 45%, rgba(233,196,106,0) 70%);
  box-shadow: 0 0 6px rgba(233,196,106,.55), 0 0 16px rgba(124,255,178,.25);
  filter: saturate(1.1) brightness(1.1);
  animation: dustFloat var(--dur,18s) linear var(--delay,0s) infinite,
             dustTwinkle 2.4s ease-in-out calc(var(--delay,0s) * .5) infinite;
  transform: translate3d(0,0,0);
}
#lux-particles .p.tiny{ width:3px; height:3px; box-shadow:0 0 4px rgba(233,196,106,.45), 0 0 10px rgba(124,255,178,.2); }
#lux-particles .p.mid{ width:8px; height:8px; }
#lux-particles .p.big{ width:10px; height:10px; box-shadow:0 0 8px rgba(233,196,106,.6), 0 0 18px rgba(124,255,178,.28); }

@keyframes dustFloat{
  0%{ transform: translate3d(0, 104vh, 0); opacity:0; }
  6%{ opacity:.9; }
  92%{ opacity:.85; }
  100%{ transform: translate3d( var(--sx,0px), -12vh, 0); opacity:0; }
}
@keyframes dustTwinkle{ 0%,100%{ opacity:.9; } 50%{ opacity:.6; } }

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce){
  #lux-particles{ display:none; }
}

    /* === Hologram Head Embed (model.html) === */
    #holo-embed { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
    #holo-embed iframe { width: 100%; height: 100%; border: 0; display: block; background: transparent; pointer-events: none; }
    /* Keep MagicMirror UI clickable above the embed */
    .mm-ui { position: relative; z-index: 2; }

    /* === Camera area visibility === */
    #camera-wrapper{ position: relative; display:none; }
    body.camera-on #camera-wrapper{ display:block; }

    /* video above, placeholder behind; placeholder only when camera is OFF */
    #camera-preview{ position: relative; z-index: 1; display: none; }
    #camera-placeholder{
      position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover;
      z-index: 0; pointer-events: none; opacity: 1; transition: opacity .25s ease;
    }
    /* Saat kamera ON: tampilkan video, sembunyikan gambar cermin */
    body.camera-on #camera-placeholder{ opacity: 0; }
    /* === Clean HUD: hide dev toggles === */
    .hud-toggles, #toggle-navbar, #toggle-footer, #toggle-heartbeat{ display:none !important; }
    /* === Voice Command Toggle (tiny) === */
    .vc-toggle{
      position: fixed; right: 56px; bottom: 16px; z-index: 6;
      width: 34px; height: 34px; border-radius: 999px; cursor: pointer;
      border:1px solid rgba(233,196,106,.35);
      background: linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      color:#eafbf6; display:grid; place-items:center;
      box-shadow:0 8px 22px rgba(0,0,0,.35);
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .vc-toggle:hover{ transform: translateY(-1px); }
    .vc-toggle[aria-pressed="true"]{
      border-color: rgba(197,143,255,.7);
      box-shadow:0 0 0 1px rgba(197,143,255,.35) inset, 0 0 16px rgba(197,143,255,.35), 0 8px 22px rgba(0,0,0,.35);
    }
    .vc-toast{
      position:fixed; right: 56px; bottom: 56px; z-index: 7;
      background:#0b1f1d; color:#dff9f3; border:1px solid #2b4946; border-radius:10px;
      padding:8px 10px; font:600 12px system-ui; opacity:0; transform:translateY(6px);
      transition:opacity .18s ease, transform .18s ease;
    }
    .vc-toast.show{ opacity:.96; transform:translateY(0); }
    .vc-armed{ outline: 2px solid rgba(197,143,255,.6); outline-offset: 2px; }
    </style>

</head>
    <body>
    <div id="holo-embed" aria-hidden="false">
      <iframe src="/model.html?m=6&autoListen=1" title="Hologram Head"></iframe>
    </div>
    <script>
      (function(){
        const frame = document.querySelector('#holo-embed iframe');
        if(!frame) return;
        function setModel6(){
          try {
            frame.contentWindow.postMessage({ type:'setModel', key:'6' }, '*');
            frame.contentWindow.postMessage({ type:'autoListen', enabled:true }, '*');
          } catch(_){}
        }
        // Try once after load and again after 1s as a fallback
        frame.addEventListener('load', ()=>{ setTimeout(setModel6, 150); setTimeout(setModel6, 1200); });
      })();
    </script>
        <div class="hud">
          <div class="brand"><span class="dot"></span> QC Magic Mirror <span class="neon">AI</span></div>
          <div class="hud-right">
            <div class="clock" id="hud-clock">--:--</div>
          </div>
        </div>
        
        <div id="lux-particles" aria-hidden="true"></div>
    <section id="greetings" class="mm-ui" style="display:none; flex-direction:column; align-items:center; justify-content:center; padding:40px 20px; background: transparent; text-align:center;">
        <div class="shell glass ring-glow" style="border-radius:26px; padding:42px 28px; max-width:1000px; width:92%;">
            <div style="flex: 1; min-width: 280px; text-align: left;">
                <h1 style="font-size: 3rem; color: #ffd700; margin-bottom: 20px; font-family: 'Forum', cursive;">Your Personal AI Beauty Stylist Awaits</h1>
                <p style="max-width: 680px; font-size: 1.2rem; color: #e0e0e0; line-height: 1.6;">Temui Stylist Pribadimu hari ini! QC Magic Mirror menghadirkan konsultasi kecantikan berbasis AI yang personal, ramah, dan dirancang khusus untuk menemukan gaya terbaikmu. Dapatkan pengalaman premium seolah memiliki konsultan kecantikan pribadi di tiap kunjunganmu.</p>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center;">
                <img src="/eve_stylist.png" alt="Eve AI Stylist" style="width: 140px; margin-bottom: 20px; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                <div id="chat-bubble" style="background: #ffffffcc; color: #333; padding: 10px 18px; border-radius: 20px; margin-bottom: 20px; font-size: 1rem; max-width: 320px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; visibility: hidden; transition: opacity 1s ease;">
                    Hello! Welcome to your personal beauty journey with QC Magic Mirror ✨
                </div>
            </div>
        </div>
    </section>
    <div id="container" class="mm-ui">
        <div id="camera-wrapper" class="mirrored ring-glow" style="margin-bottom:24px;">
            <img id="camera-placeholder" src="/magic_mirror.png" style="width: 100%; display: block;">
            <video id="camera-preview" autoplay playsinline muted style="width: 100%; display: none;"></video>
        </div>
        <div class="controls">
          <button id="toggle-camera-button" class="btn secondary">Turn On Magic Mirror</button>
          <button id="capture-button" class="btn">Analyze Style</button>
          <button id="flip-mirror" class="btn secondary" title="Flip preview horizontally">Flip Mirror</button>
          <button id="fullscreen" class="btn secondary" title="Fullscreen mode">Fullscreen</button>
          <button id="blackout-button" class="btn danger" type="button" title="Gelapkan seluruh layar">Gelapkan Layar</button>
        </div>
        <button id="controls-toggle" class="controls-toggle" aria-pressed="true" title="Hide controls">▾</button>
        <button id="vc-toggle" class="vc-toggle" aria-pressed="false" title="Enable voice command">🎙️</button>
    <div id="vc-toast" class="vc-toast" style="display:none;">Say: “Hey Mirror…”</div>
    <button id="blackout-exit" class="blackout-exit" type="button" title="Kembalikan tampilan" aria-label="Kembalikan tampilan" aria-hidden="true" tabindex="-1">☀️</button>
    <script>
// === Voice Command: Hey Mirror → (camera on) → commands (mulai analisa/analyze) ===
(function(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  const vcBtn = document.getElementById('vc-toggle');
  const toastEl = document.getElementById('vc-toast');
  const analyzeBtn = document.getElementById('capture-button');
  const camBtn = document.getElementById('toggle-camera-button');
  const videoEl = document.getElementById('camera-preview');
  const fsBtn = document.getElementById('fullscreen');

  if(!vcBtn || !toastEl){ return; }

  // Toast helper
  function vcToast(msg, dur){
    if(!toastEl) return;
    toastEl.textContent = msg || 'Say: “Hey Mirror…”';
    toastEl.style.display = 'block';
    toastEl.classList.add('show');
    if(dur){ setTimeout(()=>{ toastEl.classList.remove('show'); }, dur); }
  }
  window.vcToast = window.vcToast || vcToast; // expose for other scripts

  // Recognition state
  let rec = null;
  let listening = false;
  let armed = false; // after hotword
  let lastHotwordAt = 0;

  function setArmed(on){
    armed = !!on;
    document.body.classList.toggle('vc-armed', armed);
    if(armed){ vcToast('🎤 Listening… ucapkan "mulai analisa"', 1600); }
  }

  function ensureRec(){
    if(rec || !(SR)) return rec;
    rec = new SR();
    rec.lang = 'id-ID';
    rec.continuous = true; // keep running
    rec.interimResults = true;

    rec.onresult = (e)=>{
      let finalTxt = '';
      for(let i = e.resultIndex || 0; i < e.results.length; i++){
        const r = e.results[i];
        const txt = r[0] && r[0].transcript ? r[0].transcript.toLowerCase() : '';
        if(!txt) continue;
        // Hotword: "hey mirror" / "hei miror" / common variants
        if(/\b(hey|hei|hai)\s+mir+r?or\b/.test(txt)){
          const now = Date.now();
          if(now - lastHotwordAt < 1200){ continue; }
          lastHotwordAt = now;
          // Turn camera ON immediately as requested
          if(!document.body.classList.contains('camera-on')){ camBtn?.click(); }
          setArmed(true);
          vcToast('✅ Hey Mirror — kamera siap. Ucap: "mulai analisa"', 1800);
          try {
            window.ttsSpeak && window.ttsSpeak("Hello, I am ready. Please say analyze to begin.", { rate:0.97, pitch:1.08 });
          } catch(_) {}
          try{ window.showAppSuggest && window.showAppSuggest(); }catch(_){ }
          continue;
        }
        // Command: matikan kamera / stop (turn off live cam)
        if (/\b(matikan\s+kamera|stop)\b/.test(txt)) {
          if (document.body.classList.contains('camera-on')) {
            if (typeof stopCamera === 'function') stopCamera();
            vcToast('📷 Kamera dimatikan.', 1200);
          }
          continue;
        }
        // Command: hidupkan kamera / start (turn on live cam)
        if (/\b(hidupkan\s+kamera|start)\b/.test(txt)) {
          if (!document.body.classList.contains('camera-on')) {
            if (typeof startCamera === 'function') startCamera();
            vcToast('📷 Kamera dinyalakan.', 1200);
          }
          continue;
        }
        // Command: fullscreen
        if (/\bfullscreen\b/.test(txt)) {
          (fsBtn || document.getElementById('fullscreen'))?.click();
          vcToast('⛶ Fullscreen toggle', 1000);
          continue;
        }
        // Command: buka/nonton/open/watch Netflix
        if (armed && (/(buka|nonton|tonton|open|watch)\s+netflix\b/.test(txt) || /\bnetflix\b/.test(txt))) {
          try{ window.openApp && window.openApp('netflix'); }catch(_){ }
          setArmed(false);
          continue;
        }

        // Command: buka/dengarkan/putar/open/listen/play Spotify
        if (armed && (/(buka|dengarkan|dengerin|putar|mainkan|open|listen|play)\s+spotify\b/.test(txt) || /\bspotify\b/.test(txt))) {
          try{ window.openApp && window.openApp('spotify'); }catch(_){ }
          setArmed(false);
          continue;
        }
        // Command: matikan mic (stop voice recognition)
        if (/\b(matik(?:an)?\s+(mic|mikrofon)|mute(?:\s+mic)?|nonaktifkan\s+mic)\b/.test(txt)) {
          stop();
          vcToast('🎙️ Mic dimatikan.', 1200);
          continue;
        }
        // Command: hidupkan mic (start/restart voice recognition)
        if (/\b(hidup(?:kan)?\s+(mic|mikrofon)|aktifkan\s+mic|unmute(?:\s+mic)?)\b/.test(txt)) {
          start();
          vcToast('🎙️ Mic dinyalakan.', 1200);
          continue;
        }
        // Command: mulai analisa / analyze
        if(armed && (/mulai\s+analisa/.test(txt) || /analy[sz]e/.test(txt))){
          // Ensure camera on & click Analyze (even if disabled)
          const doClick = ()=>{
            if(window.__pageBusy){ vcToast('⏳ Masih memproses…', 900); return; }
            try{
              if(analyzeBtn){
                const wasDisabled = !!analyzeBtn.disabled;
                if(wasDisabled) analyzeBtn.disabled = false;
                analyzeBtn.click();
                if(wasDisabled) analyzeBtn.disabled = true;
                vcToast('🔎 Analyze…', 900);
              }
            }catch(_){ /* ignore */ }
          };
          if(!document.body.classList.contains('camera-on')){
            camBtn?.click();
            const onReady = ()=> setTimeout(doClick, 150);
            if(videoEl && videoEl.readyState >= 2){ onReady(); }
            else { videoEl?.addEventListener('loadeddata', onReady, { once:true }); }
          }else{
            doClick();
          }
          setArmed(false);
        }
      }
    };
    rec.onerror = (e)=>{ console.warn('VoiceCmd error:', e.error); stop(); vcToast('🎙️ Mic error. Coba klik lagi.', 1400); };
    rec.onend = ()=>{ if(listening){ try{ rec.start(); }catch(_){ /* will retry on toggle */ } } };
    return rec;
  }

  function start(){
    if(!SR){ alert('Browser belum mendukung Voice Command. Coba Chrome/Edge terbaru.'); return; }
    if(listening) return;
    try{
      ensureRec();
      rec.start();
      try{ localStorage.setItem('vcAuto','1'); }catch(_){ }
      listening = true;
      vcBtn.setAttribute('aria-pressed','true');
      vcBtn.classList.add('listening');
      vcToast('🎧 Listening aktif — ucapkan: "Hey Mirror"', 1600);
      // --- TTS greeting on mic/listening start ---
      try{
        window.ttsSpeak && window.ttsSpeak('Voice command is now active. Say: Hey Mirror.', { rate:0.97, pitch:1.08 });
      }catch(_){ }
      // --- end TTS greeting ---
    }catch(err){ console.error('VC start failed', err); vcToast('Mic ditolak? Klik izinkan.', 1600); }
  }
  function stop(){
    listening = false;
    setArmed(false);
    try{ rec && rec.stop(); }catch(_){}
    vcBtn.setAttribute('aria-pressed','false');
    vcBtn.classList.remove('listening');
    toastEl.classList.remove('show');
  }

  // Toggle button
  vcBtn.addEventListener('click', ()=>{ listening ? stop() : start(); });
  // Keyboard shortcut: Shift+M to toggle
  document.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='m' && e.shiftKey){ e.preventDefault(); listening ? stop() : start(); }});

  // Optional: auto-arm after first click of mic permission on page (UX sugar)
  // No auto-start without gesture due to browser policies.

  // === Auto-arming: if user previously allowed mic, start on first gesture of the session ===
  (function(){
    let prev = null;
    try{ prev = localStorage.getItem('vcAuto'); }catch(_){ prev = null; }
    // Show gentle prompt at load
    if(prev === '1'){
      vcToast('🎙️ Klik/tap sekali untuk aktifkan mic. Ucap: "Hey Mirror"', 2400);
      const onFirstGesture = ()=>{ try{ start(); }catch(_){}; window.removeEventListener('pointerdown', onFirstGesture); window.removeEventListener('keydown', onFirstGesture); };
      window.addEventListener('pointerdown', onFirstGesture, { once:true });
      window.addEventListener('keydown', onFirstGesture, { once:true });
    }else{
      vcToast('🎙️ Aktifkan mic sekali. Setelah itu auto‑listening.', 2200);
    }
  })();
})();
    </script>
        <div id="tip-caption" class="caption">Tip: posisi wajah sejajar kamera. Preview otomatis <strong>mirror</strong> agar natural di cermin.</div>
        <h1></h1>
        <div id="status">Waiting Analyze...</div>
        <img id="photo" src="" style="display:none; max-width: 300px; margin-top: 20px;" />
        <!-- Added waiting box and error msg here -->
        <div id="generate-waiting-box" style="display: none; text-align: center; margin-top: 16px;">
            <div id="loading" class="loading" style="margin: auto;"></div>
            <div id="countdown-timer" style="font-size: 1rem; color: #ffdd57; margin-top: 12px;"></div>
            <div id="funbits" class="caption-inline" style="display:none; margin-top: 8px; color:#cffff0;"></div>
        </div>
        <div id="replicate-error-msg" style="display: none; color: #ff6b6b; margin-top: 20px; font-weight: 600; text-align: center;">
          ⚠️ Maaf, saat ini fitur visualisasi AI sedang terkena batas limit karena tingginya traffic visitor. Silakan coba kembali dalam beberapa menit. 🙏
        </div>
        <div id="recommendation" class="glass" style="display:none;">
            <div id="visual-loading" class="loading" style="display: none;"></div>
            <h2>Rekomendasi Gaya Rambut</h2>
            <p id="rec-content"></p>
        </div>
        <!-- Hair Color Panel UI — Hair recoloring presets + preview -->
        <div id="hair-color-panel" class="glass">
          <div class="hair-panel-top">
            <div class="hair-panel-heading">
              <div class="hair-title">Hair Color</div>
              <div id="hair-color-status" class="hair-status" data-state="ready">Ready</div>
            </div>
            <div class="hair-preview-wrap">
              <img id="hair-preview" alt="Hair color preview" decoding="async" />
            </div>
          </div>
          <div class="hair-controls">
            <div id="hair-color-swatches" class="hair-swatches" role="group" aria-label="Hair color presets">
              <button type="button" class="hair-color-swatch" data-hex="#8A7E72" data-label="Ash Brown" aria-label="Ash Brown" style="background:#8A7E72;"></button>
              <button type="button" class="hair-color-swatch" data-hex="#E6A3A1" data-label="Rose Gold" aria-label="Rose Gold" style="background:#E6A3A1;"></button>
              <button type="button" class="hair-color-swatch" data-hex="#70193D" data-label="Burgundy" aria-label="Burgundy" style="background:#70193D;"></button>
              <button type="button" class="hair-color-swatch" data-hex="#2F8F9D" data-label="Blue Teal" aria-label="Blue Teal" style="background:#2F8F9D;"></button>
              <button type="button" class="hair-color-swatch" data-hex="#EAEAEA" data-label="Platinum" aria-label="Platinum" style="background:#EAEAEA;"></button>
              <button type="button" class="hair-color-swatch" data-hex="#4C2A85" data-label="Dark Violet" aria-label="Dark Violet" style="background:#4C2A85;"></button>
            </div>
            <div class="hair-footer">
              <button type="button" id="hair-color-custom" class="hair-custom-btn">Custom…</button>
              <div class="hair-strength">
                <label for="hair-strength">Strength <span id="hair-strength-value">0.80</span></label>
                <input type="range" id="hair-strength" min="0" max="1" step="0.05" value="0.8" />
              </div>
            </div>
            <input type="color" id="hair-color-picker" value="#8A7E72" style="display:none;" aria-label="Pick custom hair color" />
          </div>
        </div>
        <!-- WhatsApp Share UI -->
        <div id="wa-share" class="glass" style="display:none; margin-top:12px; padding:12px;">
          <div style="font-weight:700; color: var(--accent); margin-bottom:8px;">Kirim hasil ke WhatsApp</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            <input id="wa-phone" type="tel" inputmode="numeric" placeholder="Nomor WhatsApp (contoh: 62812xxxx)"
                   style="flex:1; min-width:220px; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08); color:#eafffb;"/>
            <button id="wa-send" class="btn" type="button">Kirim WhatsApp</button>
          </div>
          <div id="wa-hint" class="caption-inline">
            Nomor <b>harus</b> diawali <b>62</b> dan hanya berisi angka.
          </div>
        </div>
        <!-- App Suggestion: Netflix / Spotify -->
        <div id="app-suggest" class="glass" style="display:none; margin-top:12px; padding:12px; align-items:center;">
          <div style="font-weight:700; color: var(--accent); margin-bottom:8px;">Mau hiburan sambil menunggu?</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            <button id="btn-netflix" class="btn secondary" type="button" title="Buka Netflix">Watch on Netflix</button>
            <button id="btn-spotify" class="btn secondary" type="button" title="Buka Spotify">Listen on Spotify</button>
            <div class="caption-inline" style="margin-left:auto;">
              Ucapkan: <b>"buka netflix"</b> atau <b>"buka spotify"</b>
            </div>
          </div>
        </div>
        <script>
        // === WhatsApp helpers (global) ===
        function buildWhatsAppSummary(){
          const rec = (document.getElementById('rec-content')?.innerText || '').trim();
          const fs  = (document.getElementById('fld-face-shape')?.innerText || '-').trim();
          const skinHex = (document.getElementById('fld-skin-hex')?.innerText || '').replace('HEX: ','').trim();
          const undertone = (document.getElementById('fld-skin-ud')?.innerText || '').trim();
          const conf = (document.getElementById('fld-confidence')?.innerText || '').trim();
          const imgs = Array.from(document.querySelectorAll('#gallery img')).slice(0,4).map(img=> img.src);
          let msg = `✨ QC Magic Mirror — Hasil Analisa\n\n`+
                    `• Face Shape: ${fs}\n`+
                    (skinHex? `• Skin Tone: ${skinHex}\n` : '')+
                    (undertone? `• ${undertone}\n` : '')+
                    (conf? `• Confidence: ${conf}\n` : '')+
                    `\n💇 Rekomendasi:\n${rec || '-'}\n`;
          if(imgs.length){
            msg += `\n📸 Visualisasi AI:`;
            imgs.forEach((u,i)=>{ msg += `\n${i+1}. ${u}`; });
          }
          msg += `\n\n— dikirim otomatis dari QC Magic Mirror`;
          return { text: msg, images: imgs };
        }

        function setWaSending(on){
          const btn = document.getElementById('wa-send');
          if(!btn) return;
          if(on){
            btn.disabled = true;
            if(!btn.dataset.prevHtml){ btn.dataset.prevHtml = btn.innerHTML; }
            btn.innerHTML = '<span class="mini-spinner"></span>Mengirim...';
            btn.style.opacity = '0.7';
            btn.style.cursor = 'wait';
          }else{
            btn.disabled = false;
            if(btn.dataset.prevHtml){ btn.innerHTML = btn.dataset.prevHtml; }
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
          }
        }

window.addEventListener('DOMContentLoaded', ()=>{
  const btn = document.getElementById('wa-send');
  if(!btn) return;
  btn.addEventListener('click', async ()=>{
    const inp = document.getElementById('wa-phone');
    const raw = (inp?.value || '').trim();
    if(!raw){ alert('Masukkan nomor WhatsApp dulu ya.'); inp && inp.focus && inp.focus(); return; }
    const digits = raw.replace(/\s+/g, '');
    if(!/^\d+$/.test(digits)){ alert('Nomor hanya boleh angka (tanpa spasi/tanda).'); inp && inp.focus && inp.focus(); return; }
    if(!digits.startsWith('62')){ alert('Nomor harus diawali 62 (contoh: 62812xxxx).'); inp && inp.focus && inp.focus(); return; }
    const number = digits; // already validated
    const { text } = buildWhatsAppSummary();
    // Allow sending WhatsApp even if analysis is still generating faces
    setWaSending(true);
    try{
      const res = await fetch('/send-whatsapp', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ number, message: text })
      });
      const out = await res.json().catch(()=>({ ok:false }));
      console.log('WA resp:', out);
      if(res.ok && out && out.ok){
        try{ window.vcToast && window.vcToast('✅ Terkirim ke WhatsApp.', 1400);}catch(_){ }
      }else{
        alert('Gagal mengirim WhatsApp. Cek server atau device Whacenter.');
      }
    }catch(err){
      console.error('WA send error', err);
      alert('Gagal mengirim WhatsApp.');
    }finally{
      setWaSending(false);
    }
  });

  // === App open helpers ===
  function openApp(app){
    const map = {
      netflix: 'https://www.netflix.com/browse',
      spotify: 'https://open.spotify.com/'
    };
    const url = map[app];
    if(!url) return;
    try{ window.vcToast && window.vcToast(`Membuka ${app.charAt(0).toUpperCase()+app.slice(1)}…`, 1400);}catch(_){ }
    // 🔊 Custom TTS feedback in English for a premium feel
    try{
      if(window.ttsSpeak){
        const appName = app === 'netflix' ? 'Netflix' : (app === 'spotify' ? 'Spotify' : app);
        window.ttsSpeak(`Opening ${appName} for you...`, { rate: 0.98, pitch: 1.02 });
      }
    }catch(_){ }
    window.open(url, '_blank', 'noopener');
  }
  window.openApp = openApp; // expose globally

  function showAppSuggest(){
    const el = document.getElementById('app-suggest');
    if(el){ el.style.display = 'block'; }
  }
  window.showAppSuggest = showAppSuggest;

  // Wire buttons
  const bN = document.getElementById('btn-netflix');
  const bS = document.getElementById('btn-spotify');
  bN && bN.addEventListener('click', ()=> openApp('netflix'));
  bS && bS.addEventListener('click', ()=> openApp('spotify'));
});
        </script>
        <script>
        // === Hair Color Panel Controller (hair recolor UI + backend integration) ===
        (function(){
          const panel = document.getElementById('hair-color-panel');
          if(!panel) return;
          const statusEl = document.getElementById('hair-color-status');
          const preview = document.getElementById('hair-preview');
          const swatchWrap = document.getElementById('hair-color-swatches');
          const customBtn = document.getElementById('hair-color-custom');
          const customPicker = document.getElementById('hair-color-picker');
          const strength = document.getElementById('hair-strength');
          const strengthValue = document.getElementById('hair-strength-value');
          let panelVisible = false;
          let busy = false;
          let baseOriginal = null;
          let allowAutoBase = true;
          let activeGalleryCard = null;

          function updateStrengthLabel(){
            if(!strength || !strengthValue) return;
            const val = parseFloat(strength.value || '0');
            strengthValue.textContent = val.toFixed(2);
          }

          function setStatus(text, state, detail){
            if(!statusEl) return;
            const st = state || 'ready';
            statusEl.textContent = text;
            statusEl.dataset.state = st;
            if(detail){ statusEl.title = detail; }
            else { statusEl.removeAttribute('title'); }
          }

          function setBusy(on){
            busy = !!on;
            panel.classList.toggle('is-busy', busy);
            if(swatchWrap){
              swatchWrap.querySelectorAll('button').forEach(btn => { btn.disabled = busy; });
            }
            if(customBtn) customBtn.disabled = busy;
            if(strength) strength.disabled = busy;
          }

          function ensureVisible(){
            if(panelVisible) return;
            panel.style.display = 'block';
            panelVisible = true;
          }

          function hidePanel(){
            panel.style.display = 'none';
            panelVisible = false;
          }

          function highlightColorButton(btn){
            if(!swatchWrap) return;
            swatchWrap.querySelectorAll('.hair-color-swatch').forEach(el => el.classList.remove('is-active'));
            if(btn){
              btn.classList.add('is-active');
              if(customBtn) customBtn.classList.remove('is-active');
            }
          }

          function setCustomActive(hex){
            highlightColorButton(null);
            if(customBtn){
              customBtn.classList.add('is-active');
              if(hex) customBtn.dataset.hex = hex;
            }
            if(customPicker && hex && /^#[0-9A-F]{6}$/i.test(hex)){
              customPicker.value = hex;
            }
          }

          function highlightGalleryCard(card){
            if(activeGalleryCard === card) return;
            if(activeGalleryCard) activeGalleryCard.classList.remove('is-active');
            activeGalleryCard = card || null;
            if(activeGalleryCard) activeGalleryCard.classList.add('is-active');
          }

          function resetPanel(){
            baseOriginal = null;
            allowAutoBase = true;
            setBusy(false);
            hidePanel();
            setStatus('Ready', 'ready');
            if(preview){
              preview.removeAttribute('src');
              preview.style.display = 'none';
            }
            highlightColorButton(null);
            if(customBtn) customBtn.classList.remove('is-active');
            if(strength){
              const initial = strength.getAttribute('value');
              if(initial != null) strength.value = initial;
              updateStrengthLabel();
            }
            highlightGalleryCard(null);
          }

          async function imageElementToDataUrl(img){
            return new Promise((resolve, reject) => {
              if(!img){ reject(new Error('Image element missing')); return; }
              const finalize = () => {
                try{
                  const canvas = document.createElement('canvas');
                  const w = img.naturalWidth || img.width;
                  const h = img.naturalHeight || img.height;
                  if(!w || !h) throw new Error('Empty image dimensions');
                  canvas.width = w;
                  canvas.height = h;
                  const ctx = canvas.getContext('2d');
                  ctx.drawImage(img, 0, 0, w, h);
                  resolve(canvas.toDataURL('image/jpeg', 0.98));
                }catch(err){
                  const src = img.currentSrc || img.src;
                  if(!src){ reject(err); return; }
                  fetch(new URL(src, window.location.href), { cache: 'no-store', mode: 'cors', credentials: 'omit' })
                    .then(resp => {
                      if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
                      return resp.blob();
                    })
                    .then(blob => new Promise((resolveBlob, rejectBlob) => {
                      const reader = new FileReader();
                      reader.onloadend = () => resolveBlob(reader.result);
                      reader.onerror = () => rejectBlob(reader.error || new Error('Failed to read blob'));
                      reader.readAsDataURL(blob);
                    }))
                    .then(resolve)
                    .catch(reject);
                }
              };
              if(!img.complete || !img.naturalWidth){
                img.addEventListener('load', () => finalize(), { once:true });
                img.addEventListener('error', () => reject(new Error('Image failed to load')), { once:true });
                return;
              }
              finalize();
            });
          }

          async function setBaseFromImage(img, opts){
            const options = opts || {};
            if(options.auto && !allowAutoBase && baseOriginal){
              return;
            }
            try{
              const dataUrl = await imageElementToDataUrl(img);
              const base64 = dataUrl.replace(/^data:image\/\w+;base64,/, '');
              if(!base64) throw new Error('Base64 kosong');
              baseOriginal = base64;
              if(preview){
                preview.src = dataUrl;
                preview.style.display = 'block';
                preview.dataset.sourceLabel = options.label || '';
              }
              ensureVisible();
              setStatus('Ready', 'ready');
              highlightGalleryCard(img && img.closest('.gallery-card'));
              if(options.auto){ allowAutoBase = false; }
            }catch(err){
              console.warn('hair preview error', err);
              if(!baseOriginal){
                setStatus('Error', 'error', err.message || 'Gagal menyiapkan foto dasar');
              }
            }
          }

          async function applyHairColor(hex){
            const rawHex = (hex || '').toString().trim();
            if(!rawHex) return;
            if(!baseOriginal){
              setStatus('Error', 'error', 'Belum ada foto yang siap diwarnai');
              return;
            }
            if(busy) return;
            const normalized = rawHex.startsWith('#') ? rawHex : `#${rawHex}`;
            const hexValid = /^#([0-9a-fA-F]{6})$/.test(normalized);
            if(!hexValid){
              setStatus('Error', 'error', 'Format warna tidak valid');
              return;
            }
            const payload = {
              imageBase64: baseOriginal,
              hex: normalized.toUpperCase(),
              strength: Math.max(0, Math.min(1, parseFloat(strength?.value ?? '0') || 0))
            };
            setStatus('Applying…', 'busy');
            setBusy(true);
            try{
              const res = await fetch('/api/hair-color', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
              const data = await res.json().catch(() => null);
              if(!res.ok){
                const message = data && (data.error || data.message) ? (data.error || data.message) : `HTTP ${res.status}`;
                throw new Error(message);
              }
              if(!data || !data.imageOutBase64){
                throw new Error('Response tidak valid dari server');
              }
              const output = `data:image/jpeg;base64,${data.imageOutBase64}`;
              if(preview){
                preview.src = output;
                preview.style.display = 'block';
              }
              setStatus('Ready', 'ready');
            }catch(err){
              console.error('hair color failed', err);
              setStatus('Error', 'error', err.message || 'Gagal menerapkan warna');
            }finally{
              setBusy(false);
            }
          }

          if(strength){
            strength.addEventListener('input', updateStrengthLabel);
            updateStrengthLabel();
          }

          if(swatchWrap){
            swatchWrap.addEventListener('click', (event) => {
              const btn = event.target.closest('.hair-color-swatch');
              if(!btn || busy) return;
              const hex = btn.dataset.hex;
              if(!hex) return;
              highlightColorButton(btn);
              applyHairColor(hex);
            });
          }

          if(customBtn && customPicker){
            customBtn.addEventListener('click', () => {
              if(busy) return;
              customPicker.click();
            });
            customPicker.addEventListener('change', () => {
              const hex = customPicker.value;
              if(!hex) return;
              setCustomActive(hex);
              applyHairColor(hex);
            });
            customPicker.addEventListener('input', () => {
              if(document.activeElement === customPicker){
                const hex = customPicker.value;
                if(hex) setCustomActive(hex);
              }
            });
          }

          window.__hairPanelController = {
            reset: resetPanel,
            prepareForGallery: () => {
              baseOriginal = null;
              allowAutoBase = true;
              setBusy(false);
              hidePanel();
              setStatus('Ready', 'ready');
              if(preview){
                preview.removeAttribute('src');
                preview.style.display = 'none';
              }
              highlightColorButton(null);
              if(customBtn) customBtn.classList.remove('is-active');
              highlightGalleryCard(null);
            },
            setBaseFromImage: (img, opts) => setBaseFromImage(img, opts),
            isVisible: () => panelVisible
          };
        })();
        </script>
        <!-- Detailed Analysis (Face Mesh + Skin Tone) -->
        <div id="analysis-detail" class="glass" style="display:none; margin-top:16px; padding:16px;">
          <h2 style="margin:0 0 10px; color: var(--accent);">Analisis Detail</h2>
          <div id="analysis-summary" style="margin-bottom:8px; color:#eafbf6;"></div>
          <div style="display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:12px;">
            <div class="glass" style="padding:12px;">
              <div style="font-weight:700; color:#e9c46a; margin-bottom:6px;">Face Shape</div>
              <div id="fld-face-shape">-</div>
              <div id="fld-face-metrics" style="opacity:.9; font-size:.92rem; margin-top:4px;"></div>
            </div>
            <div class="glass" style="padding:12px;">
              <div style="font-weight:700; color:#e9c46a; margin-bottom:6px;">Skin Tone</div>
              <div id="fld-skin-hex">-</div>
              <div id="fld-skin-ud" style="opacity:.9; font-size:.92rem; margin-top:4px;"></div>
              <div id="fld-skin-swatches" style="display:flex; gap:6px; margin-top:8px;"></div>
            </div>
            <div class="glass" style="padding:12px;">
              <div style="font-weight:700; color:#e9c46a; margin-bottom:6px;">Confidence</div>
              <div id="fld-confidence">-</div>
              <div id="fld-notes" style="opacity:.9; font-size:.92rem; margin-top:4px;"></div>
            </div>
          </div>
        </div>
        <div id="waiting-replicate" style="display:none; font-size: 1rem; color: #ffdd57; margin-top: 10px;">
          ✨ Sedang memproses visualisasi gaya rambut AI... Harap tunggu hasilnya tampil di bawah, Estimasi 2 menit.
        </div>
        <div id="gallery" style="display: flex; flex-wrap: wrap; justify-content: center; margin-top: 20px;"></div>
    </div>
    

    <div id="lightbox" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter: blur(8px); justify-content:center; align-items:center; z-index:9999;">
        <img id="lightbox-img" src="" style="max-width:90%; max-height:90%; border-radius:12px;">
    </div>

    <script>
    window.addEventListener('DOMContentLoaded', () => {
        const toggleBtn = document.getElementById('toggle-camera-button');
        const orbCam = document.getElementById('orb-cam');
        const orbPh  = document.getElementById('orb-placeholder');
        let stream = null;
        function getCaptureVideo(){
            const vOrb = document.getElementById('orb-cam');
            const vMain = document.getElementById('camera-preview');
            // Prefer orb cam if it has a stream
            if (vOrb && vOrb.srcObject) return vOrb;
            return vMain;
        }
        function ensureVideoReady(video, timeoutMs = 2000){
            return new Promise((resolve)=>{
                if (video && video.readyState >= 2 && video.videoWidth && video.videoHeight){ return resolve(true); }
                let done = false;
                const onReady = ()=>{ if(!done){ done = true; resolve(true); } };
                try{ video && video.addEventListener('loadeddata', onReady, { once:true }); }catch(_){ resolve(true); }
                setTimeout(()=>{ if(!done){ done = true; resolve(true); } }, timeoutMs);
            });
        }
        // expose helpers globally for other scripts
        window.getCaptureVideo = getCaptureVideo;
        window.ensureVideoReady = ensureVideoReady;

        function startCamera() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
                .then(function(s) {
                    stream = s;
                    const video = document.getElementById('camera-preview');
                    const placeholder = document.getElementById('camera-placeholder');
                    video.srcObject = stream;
                    try{
                      const _p = video.play && video.play();
                      if (_p && typeof _p.catch === 'function') { _p.catch(()=>{}); }
                    }catch(_){ }
                    if (orbCam) {
                      orbCam.srcObject = stream;
                      try{
                        const _p2 = orbCam.play && orbCam.play();
                        if (_p2 && typeof _p2.catch === 'function') { _p2.catch(()=>{}); }
                      }catch(_){ }
                      orbCam.style.display = 'block';
                    }
                    if (orbPh)  { orbPh.style.display = 'none'; }
                    video.style.display = 'block';
                    document.body.classList.add('camera-on');
                    toggleBtn.innerText = "Turn Off Magic Mirror";
                    updateCaptureButton();
                })
                .catch(function(error) {
                    console.error('🚫 Tidak bisa mengakses kamera:', error.name, error.message);
                    alert('⚠️ Kamera tidak dapat diakses. Pastikan kamu memberi izin di browser.');
                });
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            const video = document.getElementById('camera-preview');
            const placeholder = document.getElementById('camera-placeholder');
            try{ orbCam && orbCam.pause && orbCam.pause(); }catch(_){}
            if (orbCam) { try{ orbCam.srcObject = null; }catch(_){} orbCam.style.display = 'none'; }
            if (orbPh)  { orbPh.style.display = 'block'; }
            try{ video && video.pause && video.pause(); }catch(_){}
            video.style.display = 'none';
            document.body.classList.remove('camera-on');
            toggleBtn.innerText = "Turn On Magic Mirror";
            updateCaptureButton();
        }

        // Set initial button text to "Turn On Camera" (redundant if set in HTML, but ensures correct state)
        toggleBtn.innerText = "Turn On Magic Mirror";

        toggleBtn.addEventListener('click', () => {
            if (stream) {
                stopCamera();
            } else {
                startCamera();
            }
        });

        // Camera will NOT start automatically on page load.
        // startCamera(); // Removed to prevent auto-start
        updateCaptureButton();
    });
    </script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const sessionId = `${Date.now()}_${Math.floor(Math.random() * 100000)}`;
        window.sessionId = sessionId;
        const socket = io('https://queensacademy.id');
        // Global flags for face generation lifecycle
        window.__facesShown = false;           // becomes true once any face image is displayed
        window.__genCountdownInterval = null;  // countdown interval ref
        let connected = false;
        // Fun facts / jokes while waiting
        window.__funbitsInterval = null;
        window.__funbitsIndex = 0;
        const FUNBITS = [
          'Fun Fact: Rambut manusia tumbuh rata-rata 1–1.5 cm per bulan.',
          'Fun Fact: Kuku tangan tumbuh 2× lebih cepat dari kuku kaki.',
          'Fun Fact: Setiap orang rata-rata punya 100.000–150.000 helai rambut di kepala.',
          'Fun Fact: Tekstur rambut ditentukan bentuk folikel; bulat → lurus, oval → ikal/keriting.',
          'Fun Fact: Rambut sehat bisa meregang hingga 30% saat basah.',
        ];
        function showFunbit(){
          const box = document.getElementById('funbits');
          if(!box || !FUNBITS.length) return;
          const idx = (window.__funbitsIndex++) % FUNBITS.length;
          box.textContent = FUNBITS[idx];
        }
        function startFunbits(){
          const box = document.getElementById('funbits');
          if(!box) return;
          box.style.display = 'block';
          showFunbit();
          if(window.__funbitsInterval) { clearInterval(window.__funbitsInterval); }
          window.__funbitsInterval = setInterval(showFunbit, 12000);
        }
        function stopFunbits(){
          const box = document.getElementById('funbits');
          if(box) box.style.display = 'none';
          if(window.__funbitsInterval){ clearInterval(window.__funbitsInterval); window.__funbitsInterval = null; }
        }
        // Busy/Abort management
        window.__pageBusy = window.__pageBusy || false;
        window.__analyzeAbort = null;
        function setBusy(on){
          window.__pageBusy = !!on;
          const btn = document.getElementById('capture-button');
          if(btn){
            const isConnected = !!connected;
            btn.disabled = on || !isConnected;
            btn.style.cursor = on ? 'wait' : (isConnected ? 'pointer' : 'not-allowed');
            btn.style.opacity = on ? '0.6' : (isConnected ? '1' : '0.5');
          }
        }
        // (getStream helper removed - no longer used)
        const captureBtn = document.getElementById('capture-button');
        function setStatus(msg, color) {
            const status = document.getElementById('status');
            status.innerText = msg;
            if (color) status.style.color = color;
            else status.style.color = '#00ff99';
        }
        function updateCaptureButton() {
            const busy = !!window.__pageBusy;
            if (connected && !busy) {
                captureBtn.disabled = false;
                captureBtn.style.opacity = '1';
                captureBtn.style.cursor = 'pointer';
            } else {
                captureBtn.disabled = true;
                captureBtn.style.opacity = busy ? '0.6' : '0.5';
                captureBtn.style.cursor = busy ? 'wait' : 'not-allowed';
            }
        }


document.getElementById('capture-button').addEventListener('click', async () => {
    if(window.__pageBusy){ try{ window.vcToast && window.vcToast('⏳ Masih memproses…', 900); }catch(_){} return; }
    setBusy(true); // mark busy
    // create abort controller for this request
    try{ if(window.__analyzeAbort){ window.__analyzeAbort.abort(); } }catch(_){}
    const __ctrl = (typeof AbortController !== 'undefined') ? new AbortController() : null;
    window.__analyzeAbort = __ctrl;
    try{ window.__hairPanelController && window.__hairPanelController.reset(); }catch(_){ }
            const video = window.getCaptureVideo ? window.getCaptureVideo() : document.getElementById('camera-preview');
            if(window.ensureVideoReady){ await window.ensureVideoReady(video, 2200); }
            const vw = video && video.videoWidth ? video.videoWidth : 640;
            const vh = video && video.videoHeight ? video.videoHeight : 480;
            const canvas = document.createElement('canvas');
            canvas.width = vw;
            canvas.height = vh;
            const ctx = canvas.getContext('2d');
            // Draw frame to canvas (account for mirrored preview so backend gets true orientation)
            const isMirrored = document.getElementById('camera-wrapper')?.classList.contains('mirrored') || document.getElementById('ai-avatar')?.classList.contains('mirrored');
            if(isMirrored){
              ctx.translate(canvas.width, 0);
              ctx.scale(-1, 1);
            }
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            if(isMirrored){
              ctx.setTransform(1,0,0,1,0,0); // reset for safety
            }
            // Simple brightness stats to distinguish very dark vs full black frame
            function getFrameStats(ctx, w, h){
              const step = 8; // sample every 8px for speed
              const img = ctx.getImageData(0,0,w,h).data;
              let sum=0, sum2=0, n=0;
              for(let y=0; y<h; y+=step){
                for(let x=0; x<w; x+=step){
                  const i = (y*w + x) * 4;
                  const r=img[i], g=img[i+1], b=img[i+2];
                  const l = 0.2126*r + 0.7152*g + 0.0722*b; // luminance
                  sum += l; sum2 += l*l; n++;
                }
              }
              const mean = sum/n; const varc = (sum2/n) - (mean*mean); const std = Math.sqrt(Math.max(0,varc));
              return { mean, std };
            }
            try{
              const stats = getFrameStats(ctx, canvas.width, canvas.height);
              window.__frameTooDark = stats.mean < 22; // redup (tetap lanjut analisa)
              window.__frameBlack   = (stats.mean < 4) && (stats.std < 2); // hampir full hitam
            }catch(_){ window.__frameTooDark = false; window.__frameBlack = false; }

            const base64Photo = canvas.toDataURL('image/jpeg').replace(/^data:image\/jpeg;base64,/, '');

            setStatus('🔍 Menganalisis wajah...', '#fff700');
            if (window.__frameTooDark && !window.__frameBlack) {
              setStatus('💡 Pencahayaan kurang — hasil tetap diproses, mungkin kurang akurat.', '#ffdd57');
            }
            document.getElementById('loading').style.display = 'block';
            // ✅ Spinner awal rekomendasi tetap dipertahankan
            document.getElementById('recommendation').style.display = 'none';
            document.getElementById('gallery').innerHTML = '';
            // Hide analysis detail panel when starting new analysis
            const detail = document.getElementById('analysis-detail');
            if(detail){ detail.style.display = 'none'; }
            document.getElementById('waiting-replicate').style.display = 'none';
            // Reset face generation state & hide WA box
            window.__facesShown = false;
            if (window.__genCountdownInterval) { clearInterval(window.__genCountdownInterval); window.__genCountdownInterval = null; }
            const waBoxInitial = document.getElementById('wa-share'); if (waBoxInitial) waBoxInitial.style.display = 'none';
            document.getElementById('countdown-timer').innerText = '';

            const startTimestamp = Math.floor(Date.now() / 1000);
            console.log("📤 Mengirim foto ke backend... start_timestamp:", startTimestamp);
            fetch('https://qc-magicmirror-api.onrender.com/run', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ photo: base64Photo, session_id: sessionId, analyze_mode: 'pro', include_mesh: true, include_skin_metrics: true }),
                signal: __ctrl ? __ctrl.signal : undefined
            })
            .then(response => response.json())
            .then(data => {
                console.log('✅ Respon AI:', data);
                if (data.status === 'pending') {
                    console.log("🕒 Status pending diterima. start_timestamp:", data.start_timestamp || 'N/A');
                }

                if (data.status === 'done') {
                    document.getElementById('rec-content').innerText = data.recommendation || 'Tidak ada rekomendasi.';
                    document.getElementById('recommendation').style.display = 'block';
                    setStatus('✅ Rekomendasi siap!', '#00ff99');

                    if (data.faces && data.faces.length > 0) {
                        try{ window.__hairPanelController && window.__hairPanelController.prepareForGallery(); }catch(_){ }
                        const gallery = document.getElementById('gallery');
                        data.faces.forEach((url, index) => {
                            const card = document.createElement('div');
                            card.className = 'gallery-card fade-in-stagger';
                            card.style.animationDelay = `${index * 0.2}s`;
                            const img = document.createElement('img');
                            img.crossOrigin = 'anonymous';
                            img.decoding = 'async';
                            img.loading = 'lazy';
                            img.src = url.startsWith('http') ? url : `https://qc-magicmirror-api.onrender.com${url}`;
                            const label = `Face ${index + 1}`;
                            img.alt = label;
                            img.dataset.faceLabel = label;
                            img.addEventListener('load', () => {
                                try{ window.__hairPanelController && window.__hairPanelController.setBaseFromImage(img, { label, auto: true }); }
                                catch(_){ }
                            }, { once: true });
                            card.appendChild(img);
                            gallery.appendChild(card);
                        });
                        setTimeout(() => {
                            gallery.scrollIntoView({ behavior: 'smooth' });
                        }, 300);
                    }
                    // ⬇️ Render detailed analysis if provided
                    if (data.analysis) {
                      try { renderAnalysis(data.analysis); } catch(_) {}
                    }
                    // ⬇️ Ganti: hide pending status when done
                    document.getElementById('waiting-replicate').style.display = 'none';
                    document.getElementById('generate-waiting-box').style.display = 'none';
                    document.getElementById('visual-loading').style.display = 'none';
                    document.getElementById('countdown-timer').innerText = '';
                    if (window.__genCountdownInterval) { clearInterval(window.__genCountdownInterval); window.__genCountdownInterval = null; }
                } else {
                    setStatus('⚠️ Gagal: ' + (data.error || 'Tidak terdeteksi wajah.'), 'orange');
                }
            })
            .catch(err => {
                if (err && err.name === 'AbortError') {
                    setStatus('⛔ Dibatalkan.', 'orange');
                    document.getElementById('generate-waiting-box').style.display = 'none';
                    document.getElementById('replicate-error-msg').style.display = 'none';
                    setBusy(false);
                    return;
                }
                console.error('❌ Error fetch:', err);
                setStatus('❌ Gagal mengirim ke server.', 'red');
                document.getElementById('replicate-error-msg').style.display = 'block';
            })
            .finally(() => {
                document.getElementById('loading').style.display = 'none';
                // Failsafe: auto-clear busy if nothing arrives within 3 minutes
                clearTimeout(window.__busyTimeout);
                window.__busyTimeout = setTimeout(()=>{ setBusy(false); }, 180000);
            });
        });

        socket.on('connect', () => {
            connected = true;
            setBusy(false);
            setStatus('Standby, Turn on Magic Mirror', '#00ff99');
            document.getElementById('loading').style.display = 'none';
            updateCaptureButton();
            socket.emit('join', { session_id: sessionId });
            console.log("🔐 Session ID dikirim ke server:", sessionId);
        });
socket.on('ai_result', (data) => {
    console.log('🧠 Rekomendasi AI diterima.');
    const recommendation = document.getElementById('recommendation');
    const recContent = document.getElementById('rec-content');
    recContent.innerText = data.recommendationText || data.recommendation;
    recommendation.style.display = 'block';
    // WA share UI: show when recommendation appears
    const waBox = document.getElementById('wa-share');
    if (waBox) waBox.style.display = 'block';
    recommendation.classList.add('fade-in');
    try{ window.showAppSuggest && window.showAppSuggest(); }catch(_){ }
    document.getElementById('loading').style.display = 'none';
    setStatus('✅ Recommendation', '#00ff99');
    document.getElementById('waiting-replicate').style.display = 'block';
    try{ startFunbits(); }catch(_){ }
    // ⬇️ Render detailed analysis from socket if available
    if (data.analysis) {
      try { renderAnalysis(data.analysis); } catch(_) {}
    }
    const detail = document.getElementById('analysis-detail'); if(detail && detail.querySelector('#fld-face-shape').textContent !== '-') detail.style.display = 'block';
    // keep __pageBusy = true here; faces may still be generating
});
socket.on('generated_faces', (data) => {
    if (data.session_id && data.session_id !== sessionId) return; // ⛔ Abaikan jika bukan untuk sesi ini
    console.log('🖼️ Generated faces diterima.');
    console.log("⏳ start_timestamp:", data.start_timestamp);
    const gallery = document.getElementById('gallery');
    const statusEl = document.getElementById('status');
    const loadingEl = document.getElementById('loading');
    const waitingEl = document.getElementById('waiting-replicate');

    const validFaces = (data.faces || []).filter(url => url && url.trim() !== '');

    // ✅ Tampilkan pesan status dari backend
    if (data.message) {
        statusEl.innerText = data.message;
        statusEl.style.color = '#ffdd57';
    }

    // ⏳ Countdown dan spinner hanya saat status === 'pending'
    if (data.status === 'pending' && data.start_timestamp && validFaces.length === 0 && !window.__facesShown) {
        document.getElementById('generate-waiting-box').style.display = 'block';
        const countdownTarget = data.start_timestamp + 120;
        waitingEl.style.display = 'block';
        document.getElementById('visual-loading').style.display = 'block';
        try{ window.showAppSuggest && window.showAppSuggest(); }catch(_){ }
        try{ startFunbits(); }catch(_){ }

        if (window.__genCountdownInterval) { clearInterval(window.__genCountdownInterval); }
        const updateCountdown = () => {
            const now = Math.floor(Date.now() / 1000);
            const remaining = countdownTarget - now;
            if (remaining <= 0) {
                waitingEl.innerText = "⏳ Hampir selesai... harap tunggu.";
                loadingEl.style.display = 'none';
                document.getElementById('visual-loading').style.display = 'none';
                document.getElementById('countdown-timer').innerText = '';
                // Do not hide waitingEl yet, let it display the message
                if (window.__genCountdownInterval) { clearInterval(window.__genCountdownInterval); window.__genCountdownInterval = null; }
            } else {
                document.getElementById('countdown-timer').innerText = `✨ Visualisasi akan tampil dalam ${remaining} detik...`;
            }
        };
        updateCountdown();
        window.__genCountdownInterval = setInterval(updateCountdown, 1000);

        // ✅ Spinner awal rekomendasi tetap dipertahankan
        loadingEl.style.display = 'block';
        // Do NOT hide loadingEl or waitingEl here; only after countdown ends or faces shown
    }

    // 🎨 Kalau ada hasil wajah, tampilkan ke galeri
    if (validFaces.length > 0) {
        // Mark that faces are shown; stop any countdown
        window.__facesShown = true;
        if (window.__genCountdownInterval) { clearInterval(window.__genCountdownInterval); window.__genCountdownInterval = null; }
        gallery.innerHTML = '';
        try{ window.__hairPanelController && window.__hairPanelController.prepareForGallery(); }catch(_){ }
        validFaces.forEach((url, index) => {
            const card = document.createElement('div');
            card.className = 'gallery-card fade-in-stagger';
            card.style.animationDelay = `${index * 0.2}s`;
            const img = document.createElement('img');
            img.crossOrigin = 'anonymous';
            img.decoding = 'async';
            img.loading = 'lazy';
            img.src = url;
            const label = `Face ${index + 1}`;
            img.alt = label;
            img.dataset.faceLabel = label;
            img.addEventListener('load', () => {
                try{ window.__hairPanelController && window.__hairPanelController.setBaseFromImage(img, { label, auto: true }); }
                catch(_){ }
            }, { once: true });
            card.appendChild(img);
            gallery.appendChild(card);
        });
        setTimeout(() => {
            gallery.scrollIntoView({ behavior: 'smooth' });
        }, 300);
        loadingEl.style.display = 'none';
        waitingEl.style.display = 'none';
        document.getElementById('visual-loading').style.display = 'none';
        document.getElementById('countdown-timer').innerText = '';
        document.getElementById('generate-waiting-box').style.display = 'none';
        document.getElementById('replicate-error-msg').style.display = 'none';
        // Now it's safe to show WhatsApp share UI
        const waBox = document.getElementById('wa-share');
        if (waBox) waBox.style.display = 'block';
        // Ensure any leftover waiting text is cleared
        waitingEl.innerText = '';
        document.getElementById('countdown-timer').innerText = '';
        document.getElementById('waiting-replicate').style.display = 'none';
        try{ stopFunbits(); }catch(_){ }
        document.getElementById('generate-waiting-box').style.display = 'none';
        document.getElementById('countdown-timer').innerText = '';
        setBusy(false);
        clearTimeout(window.__busyTimeout);
        try{ window.__analyzeAbort = null; }catch(_){ }
    }

    // Error/limit handling
    if (data.status === 'error' || (data.message && data.message.toLowerCase().includes('limit'))) {
        if (window.__genCountdownInterval) { clearInterval(window.__genCountdownInterval); window.__genCountdownInterval = null; }
        document.getElementById('replicate-error-msg').style.display = 'block';
        document.getElementById('generate-waiting-box').style.display = 'none';
        document.getElementById('waiting-replicate').style.display = 'none';
        try{ stopFunbits(); }catch(_){ }
        document.getElementById('countdown-timer').innerText = '';
        if (window.__genCountdownInterval) { clearInterval(window.__genCountdownInterval); window.__genCountdownInterval = null; }
        setBusy(false);
        clearTimeout(window.__busyTimeout);
        try{ window.__analyzeAbort = null; }catch(_){ }
    }
});

// --- Detailed Analysis Renderer ---
function normalizeConfidence(a){
  let c = (a && (a.confidence ?? a.score ?? a.confidence_pct ?? a.confidence_percent ?? a.prob ?? a.probability ?? (a.metrics && a.metrics.confidence)));
  if (c == null) return null;
  let n = Number(c);
  if (!isFinite(n)) return null;
  if (n <= 1) return n * 100;       // 0..1 → percent
  if (n <= 100) return n;           // already percent
  return Math.min(100, Math.max(0, n));
}
function renderAnalysis(analysis){
  const wrap = document.getElementById('analysis-detail');
  if(!wrap) return;
  // Read values safely with defaults
  const faceShape = analysis.face_shape || analysis.shape || '-';
  const ratios = analysis.ratios || {};
  const angles = analysis.angles || {};
  const metrics = analysis.metrics || {};
  const mesh = analysis.mesh || {};
  const skin = analysis.skin || analysis.skin_tone || {};
  // const conf = (analysis.confidence != null) ? analysis.confidence : (analysis.score || null);
  const confPct = normalizeConfidence(analysis);

  // Face section
  const faceTxt = [];
  if (ratios.wh_ratio) faceTxt.push(`W/H ratio: ${Number(ratios.wh_ratio).toFixed(2)}`);
  if (metrics.cheekbone_prominence) faceTxt.push(`Cheekbone: ${Number(metrics.cheekbone_prominence).toFixed(2)}`);
  if (angles.jaw_deg) faceTxt.push(`Jaw angle: ${Number(angles.jaw_deg).toFixed(1)}°`);
  if (metrics.forehead_width) faceTxt.push(`Forehead width: ${Math.round(metrics.forehead_width)} px`);
  if (metrics.chin_length) faceTxt.push(`Chin length: ${Math.round(metrics.chin_length)} px`);
  if (mesh.points || mesh.points_count) faceTxt.push(`Mesh pts: ${mesh.points_count || mesh.points?.length || '-'}`);

  document.getElementById('fld-face-shape').textContent = String(faceShape).toUpperCase();
  document.getElementById('fld-face-metrics').textContent = faceTxt.join(' · ');

  // Skin section
  const hex = skin.hex || (skin.rgb ? `#${skin.rgb.map(v=>v.toString(16).padStart(2,'0')).join('')}` : null) || '-';
  const undertone = skin.undertone || skin.tone || '-';
  const season = skin.season || skin.palette || null;
  const cie = skin.lab || skin.oklab || null;
  const mi = skin.melanin_index || null;
  document.getElementById('fld-skin-hex').textContent = `HEX: ${hex}`;
  const udParts = [ `Undertone: ${undertone}` ];
  if (season) udParts.push(`Palette: ${season}`);
  if (cie) udParts.push(`CIELAB: ${Array.isArray(cie)? cie.map(n=>Number(n).toFixed(1)).join(', '): typeof cie==='object'? Object.values(cie).map(n=>Number(n).toFixed(1)).join(', ') : cie}`);
  if (mi!=null) udParts.push(`Melanin idx: ${Number(mi).toFixed(2)}`);
  document.getElementById('fld-skin-ud').textContent = udParts.join(' · ');

  // Swatches (base + 3 suggestions if provided)
  const sw = document.getElementById('fld-skin-swatches');
  if (sw) {
    sw.innerHTML = '';
    const addSw = (color)=>{ if(!color) return; const d=document.createElement('div'); d.style.width='22px'; d.style.height='22px'; d.style.borderRadius='6px'; d.style.border='1px solid rgba(255,255,255,.2)'; d.style.boxShadow='0 2px 8px rgba(0,0,0,.35)'; d.style.background=color; sw.appendChild(d); };
    addSw(hex && hex!=='-'? hex : null);
    const pals = (skin.suggested_hex || skin.suggested || []).slice(0,3);
    pals.forEach(c=> addSw(c));
  }

  // Confidence + notes
  document.getElementById('fld-confidence').textContent = (confPct != null) ? `${Math.round(confPct)}%` : '—';
  const notes = analysis.notes || (analysis.flags ? Object.keys(analysis.flags).filter(k=>analysis.flags[k]).join(', ') : '');
  document.getElementById('fld-notes').textContent = notes || '';

  // Summary line
  const sum = document.getElementById('analysis-summary');
  if (sum) {
    const fs = String(faceShape).toUpperCase();
    const ud = String(undertone).toLowerCase();
    sum.textContent = `Deteksi wajah: ${fs} · Undertone: ${ud}${season? ' · Palet: '+season: ''}`;
  }

  // Show card
  wrap.style.display = 'block';
}


        // Lightbox for gallery images + bridge to hair color selector
        (function(){
            const galleryEl = document.getElementById('gallery');
            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightbox-img');
            if(!galleryEl) return;
            galleryEl.addEventListener('click', (e) => {
                if (!(e.target && e.target.tagName === 'IMG')) return;
                const img = e.target;
                const label = img.dataset.faceLabel || img.alt || '';
                try{ window.__hairPanelController && window.__hairPanelController.setBaseFromImage(img, { label, auto: false }); }
                catch(_){ }
                const hairVisible = !!(window.__hairPanelController && window.__hairPanelController.isVisible && window.__hairPanelController.isVisible());
                if (hairVisible && e.detail < 2) {
                    e.preventDefault();
                    return;
                }
                if (lightboxImg && lightbox) {
                    lightboxImg.src = img.src;
                    lightbox.style.display = 'flex';
                }
            });
        })();

        document.getElementById('lightbox').addEventListener('click', () => {
            document.getElementById('lightbox').style.display = 'none';
        });
        socket.on('disconnect', () => {
            connected = false;
            setStatus('⚡ Koneksi terputus. Klik Turn On Magic Mirror lagi jika diperlukan.', 'red');
            document.getElementById('loading').style.display = 'none';
            updateCaptureButton();
        });

        // When camera toggled, update the button too
        document.getElementById('toggle-camera-button').addEventListener('click', () => {
            setTimeout(updateCaptureButton, 500); // slight delay to ensure stream state updated
        });
    </script>
    <script>
// Warn on browser back/close/reload while analysis is in progress
(function(){
  function shouldBlock(){
    if (window.__pageBusy) return true;
    const loading = document.getElementById('loading');
    const waiting = document.getElementById('generate-waiting-box');
    const thinking = document.getElementById('ai-avatar')?.classList.contains('thinking');
    // also consider visible spinners/queues as busy
    const isLoading = !!(loading && loading.style.display !== 'none');
    const isWaiting = !!(waiting && waiting.style.display !== 'none');
    return isLoading || isWaiting || thinking;
  }
  window.addEventListener('beforeunload', function (e) {
    try{ window.__analyzeAbort && window.__analyzeAbort.abort(); }catch(_){ }
    if (!shouldBlock()) return;
    const msg = 'Proses masih berjalan. Jika kamu menutup/keluar halaman, progres bisa hilang dan harus mengulang.';
    e.preventDefault();
    e.returnValue = msg; // Required for Chrome/Edge/Firefox
    return msg;
  });
})();
    </script>
    <script>
    // HUD Clock
    (function clockTick(){
      const el = document.getElementById('hud-clock');
      if(!el) return;
      const d = new Date();
      const fmt = new Intl.DateTimeFormat(undefined,{hour:'2-digit', minute:'2-digit'});
      el.textContent = fmt.format(d);
      setTimeout(clockTick, 10000);
    })();
    // Flip mirror toggle
    (function(){
      const wrap = document.getElementById('camera-wrapper');
      const orb = document.getElementById('ai-avatar');
      const btn = document.getElementById('flip-mirror');
      if(btn && wrap && orb){
        btn.addEventListener('click', ()=>{
          wrap.classList.toggle('mirrored');
          orb.classList.toggle('mirrored');
        });
      }
    })();
    // Fullscreen toggle
    (function(){
      const btn = document.getElementById('fullscreen');
      if(!btn) return;
      btn.addEventListener('click', ()=>{
        const el = document.documentElement;
        if (!document.fullscreenElement){
          (el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen).call(el);
        } else {
          (document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen).call(document);
        }
      });
    })();
    // Manual blackout toggle
    (function(){
      const blackoutBtn = document.getElementById('blackout-button');
      const exitBtn = document.getElementById('blackout-exit');
      if(!blackoutBtn || !exitBtn) return;
      const body = document.body;
      if(exitBtn.parentElement !== body){
        try{ body.appendChild(exitBtn); }catch(_){ /* ignore append issues */ }
      }
      let restoreIdle = false;
      let previousFocus = null;

      function toggleManualHidden(on){
        const targets = ['ai-avatar', 'holo-embed'].map((id)=>{
          const el = document.getElementById(id);
          return el ? el : null;
        }).filter(Boolean);
        targets.forEach((el)=>{
          if(on){
            if(!el.dataset.manualBlackoutAria){
              el.dataset.manualBlackoutAria = el.getAttribute('aria-hidden') ?? '';
            }
          }
          el.classList.toggle('manual-blackout-hidden', on);
          const prev = el.dataset.manualBlackoutAria;
          if(on){
            el.setAttribute('aria-hidden', 'true');
          } else if(prev !== undefined){
            if(prev === ''){
              el.removeAttribute('aria-hidden');
            } else {
              el.setAttribute('aria-hidden', prev);
            }
            delete el.dataset.manualBlackoutAria;
          }
        });
      }

      function enter(){
        if(body.classList.contains('manual-blackout')) return;
        restoreIdle = !body.classList.contains('idle-blackout');
        body.classList.add('manual-blackout');
        body.classList.add('idle-blackout');
        previousFocus = document.activeElement instanceof HTMLElement ? document.activeElement : null;
        toggleManualHidden(true);
        exitBtn.classList.add('is-visible');
        exitBtn.setAttribute('aria-hidden', 'false');
        exitBtn.setAttribute('tabindex', '0');
        requestAnimationFrame(()=>{
          try{ exitBtn.focus({ preventScroll: true }); }
          catch(_){ try{ exitBtn.focus(); }catch(__){} }
        });
      }
      function exit(){
        if(!body.classList.contains('manual-blackout')) return;
        body.classList.remove('manual-blackout');
        if(restoreIdle){
          body.classList.remove('idle-blackout');
        }
        restoreIdle = false;
        toggleManualHidden(false);
        exitBtn.classList.remove('is-visible');
        exitBtn.setAttribute('aria-hidden', 'true');
        exitBtn.setAttribute('tabindex', '-1');
        if(previousFocus && previousFocus.isConnected && previousFocus !== document.body){
          try{ previousFocus.focus({ preventScroll: true }); }
          catch(_){ try{ previousFocus.focus(); }catch(__){} }
        }
        previousFocus = null;
      }
      blackoutBtn.addEventListener('click', ()=>{
        if(body.classList.contains('manual-blackout')){
          exit();
        } else {
          enter();
        }
      });
      exitBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        exit();
      });
      exitBtn.addEventListener('keydown', (e)=>{
        if((e.key === 'Enter' || e.key === ' ') && body.classList.contains('manual-blackout')){
          e.preventDefault();
          exit();
        }
      });
      document.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape'){
          exit();
        }
      });
    })();
    </script>
    <script>
    // Controls show/hide toggle + persist
    (function(){
      const dock = document.querySelector('.controls');
      const tgl = document.getElementById('controls-toggle');
      if(!dock || !tgl) return;
      function sync(on){
        dock.classList.toggle('hidden', !on);
        tgl.setAttribute('aria-pressed', on? 'true':'false');
        tgl.title = on? 'Hide controls':'Show controls';
        tgl.textContent = on? '▾' : '▴';
        try{ localStorage.setItem('controlsVisible', on? '1':'0'); }catch(_){ }
      }
      let vis = false;
      try{
        const saved = localStorage.getItem('controlsVisible');
        if(saved === '1') vis = true; // only show if explicitly saved ON
      }catch(_){ /* keep default false */ }
      sync(vis);
      tgl.addEventListener('click', ()=>{ vis = !vis; sync(vis); });
      // Also collapse auto when entering idle blackout, expand on exit
      const obs = new MutationObserver(()=>{
        const idle = document.body.classList.contains('idle-blackout');
        if(idle){ sync(false); }
      });
      obs.observe(document.body, { attributes:true, attributeFilter:['class'] });
    })();
    </script>
    <script>
    // Auto-hide tip caption after ~10s on first load
    (function(){
      const cap = document.getElementById('tip-caption');
      if(!cap) return;
      // show now (in case CSS ever changes), then fade out later
      cap.style.opacity = '1';
      setTimeout(()=>{
        cap.style.transition = 'opacity .4s ease';
        cap.style.opacity = '0';
        cap.style.pointerEvents = 'none';
        setTimeout(()=>{ cap.style.display = 'none'; }, 500);
      }, 10000); // 10s
    })();
    </script>
    <!-- AI Avatar Orb -->
    <div id="ai-avatar" class="lock-center" aria-hidden="true">
      <div class="orb-motion">
        <div class="orb-wrap">
          <div class="halo"></div>
          <div class="core">
            <video id="orb-cam" autoplay playsinline muted style="display:none;"></video>
            <img id="orb-placeholder" src="/magic_mirror.png" alt="Mirror" />
            <div class="holo-head" aria-hidden="true"></div>
          </div>
          <div class="pulse"></div>
          <div class="pulse pulse2"></div>
          <!-- SVG noise using feTurbulence for organic life -->
          <svg class="noise" width="120%" height="120%" viewBox="0 0 100 100" preserveAspectRatio="none">
            <filter id="noiseFilter">
              <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" seed="8"/>
              <feColorMatrix type="saturate" values="0"/>
            </filter>
            <rect width="100" height="100" filter="url(#noiseFilter)"></rect>
          </svg>
          <!-- Abstract spiral overlay -->
          <svg class="spiral" viewBox="0 0 200 200">
            <defs>
              <radialGradient id="glow" cx="50%" cy="50%" r="50%">
                <stop offset="0%" stop-color="rgba(255,255,255,.9)"/>
                <stop offset="60%" stop-color="rgba(124,255,124,.25)"/>
                <stop offset="100%" stop-color="rgba(0,0,0,0)"/>
              </radialGradient>
            </defs>
            <circle cx="100" cy="100" r="70" fill="url(#glow)" opacity="0.35"/>
            <!-- Two parametric spirals -->
            <path class="spiral-path" d="M100,100
              m0,-70
              c20,0 35,15 35,35
              s-15,35 -35,35
              s-35,-15 -35,-35
              s15,-35 35,-35
              M100,100 c10,0 18,8 18,18 s-8,18 -18,18 s-18,-8 -18,-18 s8,-18 18,-18"/>
            <path class="spiral-path alt" d="M100,35 C140,35 165,60 165,100 S140,165 100,165 35,140 35,100 60,35 100,35
              M100,55 C128,55 145,72 145,100 S128,145 100,145 55,128 55,100 72,55 100,55"/>
          </svg>
        </div>
      </div>
    </div>

    <!-- AI Chat Panel -->
    <div id="ai-chat">
      <div class="chat-wrap glass chat-box">
        <div class="header">AI Assistant <button class="close" id="ai-chat-close">×</button></div>
        <div class="msgs" id="ai-chat-msgs">
          <div class="msg bot">Hi! I’m your AI beauty stylist. Ask me anything ✨</div>
        </div>
        <form class="composer" id="ai-chat-form">
          <input type="text" id="ai-chat-input" placeholder="Ask me anything..." autocomplete="off" />
          <button class="mic" type="button" id="ai-voice-btn" title="Tahan untuk bicara / klik untuk toggle">🎤</button>
          <button class="send" type="submit">Kirim</button>
        </form>
      </div>
    </div>

    <script>
    (function(){
      const body = document.body;
      const orb = document.getElementById('ai-avatar');
      const chat = document.getElementById('ai-chat');
      const closeBtn = document.getElementById('ai-chat-close');
      const input = document.getElementById('ai-chat-input');
      if(!orb || !chat) return;

      let dragging = false, moved = false, suppressClick = false;
      let recentered = false;
      let startX = 0, startY = 0, startLeft = 0, startTop = 0;
      const CLICK_THRESHOLD = 6; // px

      // === Global Pro Voice TTS (female) — Step 1 ===
      (function(){
        function pickVoice(){
          const synth = window.speechSynthesis;
          if(!synth) return null;
          const voices = synth.getVoices ? synth.getVoices() : [];
          if(!voices || !voices.length) return null;
          const prefs = [
            'Google UK English Female',
            'Google US English',
            'Samantha','Victoria','Serena','Moira', // macOS
            'Allison','Ava','Susan',
            'English (United Kingdom)','en-GB'
          ];
          const byName = (n)=> voices.find(v=> v && v.name && v.name.toLowerCase().includes(n.toLowerCase()));
          for(const p of prefs){ const v = byName(p); if(v) return v; }
          const en = voices.find(v=> /^en(?:-|_|\b)/i.test(v.lang || ''));
          return en || voices[0] || null;
        }
        window.ttsSpeak = function(text, opts){
          try{
            const synth = window.speechSynthesis;
            if(!synth || typeof window.SpeechSynthesisUtterance === 'undefined') return null;
            const u = new SpeechSynthesisUtterance(String(text || ''));
            const v = pickVoice();
            if(v) u.voice = v;
            u.lang   = (v && v.lang) || (opts && opts.lang) || 'en-US';
            u.rate   = (opts && opts.rate  != null) ? opts.rate  : 0.97; // natural
            u.pitch  = (opts && opts.pitch != null) ? opts.pitch : 1.10; // female-ish
            u.volume = (opts && opts.volume!= null) ? opts.volume: 1;
            try{ synth.cancel(); }catch(_){ }
            try{ synth.resume && synth.resume(); }catch(_){ }
            synth.speak(u);
            return u;
          }catch(_){ return null; }
        };
        // Warm up voices list for some browsers
        try{ window.speechSynthesis && window.speechSynthesis.getVoices(); }catch(_){ }
        if(window.speechSynthesis){
          window.speechSynthesis.onvoiceschanged = ()=>{ try{ window.speechSynthesis.getVoices(); }catch(_){ } };
        }
      })();
      // === TTS: speak greeting on first open (requires a user gesture) ===
      const TTS = {
        greeted: false,
        speakGreeting() {
          if (this.greeted) return;
          ttsSpeak("Hi! I am your AI beauty stylist. Ask me anything.");
          this.greeted = true;
        }
      };

      function recenterOrb(){
        const root = document.documentElement;
        const l = getComputedStyle(root).getPropertyValue('--orb-left').trim() || '50%';
        const t = getComputedStyle(root).getPropertyValue('--orb-top').trim()  || '50%';
        orb.style.right = 'auto';
        orb.style.bottom = 'auto';
        orb.style.left = l;
        orb.style.top  = t;
        orb.style.transform = 'translate(-50%, -50%)';
      }

      function openChat(){ body.classList.add('chat-open'); try{ input && input.focus(); }catch(_){} }
      function closeChat(){ body.classList.remove('chat-open'); }
      function isOpen(){ return body.classList.contains('chat-open'); }

      // Center orb on initial load if not moved yet
      if(!moved && !recentered){ recenterOrb(); recentered = true; }

      function onClick(e){
        if(suppressClick){ suppressClick = false; return; }
        if(dragging) return; // ignore click while dragging
        if(isOpen()){
          closeChat();
        } else {
          openChat();
          // Speak once on first open after a user gesture (click)
          TTS.speakGreeting();
        }
      }

      function onPointerDown(e){
        if(e.button !== undefined && e.button !== 0) return; // primary only
        dragging = true; moved = false;
        const rect = orb.getBoundingClientRect();
        startLeft = rect.left; startTop = rect.top;
        startX = e.clientX; startY = e.clientY;
        // switch to absolute placement for smooth drag
        orb.style.right = 'auto';
        orb.style.bottom = 'auto';
        orb.style.left = `${startLeft}px`;
        orb.style.top  = `${startTop}px`;
        // disable center-translate during free drag
        orb.style.transform = 'translate(0,0)';
        try{ orb.setPointerCapture && orb.setPointerCapture(e.pointerId); }catch(_){}
      }

      function onPointerMove(e){
        if(!dragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        if(!moved && (Math.abs(dx) > CLICK_THRESHOLD || Math.abs(dy) > CLICK_THRESHOLD)) moved = true;
        orb.style.left = `${startLeft + dx}px`;
        orb.style.top  = `${startTop  + dy}px`;
      }

      function onPointerUp(e){
        if(!dragging) return;
        dragging = false;
        try{ orb.releasePointerCapture && orb.releasePointerCapture(e.pointerId); }catch(_){}
        if(moved){
          // prevent the trailing click after a drag
          suppressClick = true; setTimeout(()=> suppressClick = false, 150);
          orb.dataset.moved = '1';
        }
      }

      orb.addEventListener('pointerdown', onPointerDown);
      window.addEventListener('pointermove', onPointerMove);
      window.addEventListener('pointerup', onPointerUp);
      orb.addEventListener('click', onClick);

      if(closeBtn){ closeBtn.addEventListener('click', (e)=>{ e.preventDefault(); closeChat(); }); }
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeChat(); });

      // Recenter orb on window resize if not moved
      window.addEventListener('resize', ()=>{ if(!orb.dataset.moved){ recenterOrb(); } });
    })();
    </script>